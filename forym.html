<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–î–®–í | –§–û–†–£–ú</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{--p:#22c55e;--p-g:rgba(34,197,94,0.4);--p-d:#16a34a;--p-l:rgba(34,197,94,0.1);--a:#f97316;--bg:#0a0a0a;--bg-c:#141414;--bg-h:#1e1e1e;--bg-e:#1a1a1a;--b:#252525;--b-l:#333;--t:#e5e5e5;--t-s:#888;--t-m:#555;--d:#ef4444;--w:#eab308;--i:#3b82f6}
*{box-sizing:border-box;margin:0;padding:0;-webkit-user-select:none;user-select:none}
body{background:var(--bg);color:var(--t);font-family:'Inter',sans-serif;font-size:14px;line-height:1.5;min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
.main-nav{background:linear-gradient(180deg,var(--bg-c) 0%,var(--bg) 100%);border-bottom:1px solid var(--b);padding:0 20px;position:sticky;top:0;z-index:100}
.nav-container{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:60px}
.nav-brand{display:flex;align-items:center;gap:12px;text-decoration:none}
.nav-logo{width:40px;height:40px;background:linear-gradient(135deg,var(--p),var(--p-d));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:#000;box-shadow:0 0 30px rgba(34,197,94,0.2)}
.nav-title{font-size:18px;font-weight:800;color:var(--t);letter-spacing:1px}.nav-title span{color:var(--p)}
.nav-links{display:flex;align-items:center;gap:5px;background:var(--bg-h);padding:5px;border-radius:12px;border:1px solid var(--b)}
.nav-link{display:flex;align-items:center;gap:8px;padding:10px 16px;color:var(--t-s);text-decoration:none;font-size:13px;font-weight:500;border-radius:8px;transition:all .2s}
.nav-link:hover{color:var(--t);background:var(--bg-e)}.nav-link.active{color:var(--p);background:var(--p-l)}
.user-profile-btn{display:flex;align-items:center;gap:10px;padding:6px 12px 6px 6px;background:var(--bg-h);border:1px solid var(--b);border-radius:30px;cursor:pointer;transition:.2s}
.user-profile-btn:hover{background:var(--bg-e);border-color:var(--p)}
.user-avatar-nav{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--a));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#000;overflow:hidden}
.user-avatar-nav img{width:100%;height:100%;object-fit:cover}
.user-info-nav{display:flex;flex-direction:column;align-items:flex-start}
.user-name-nav{font-size:12px;font-weight:600;color:var(--t)}.user-role-nav{font-size:10px;color:var(--p);text-transform:uppercase;font-weight:600}
.breadcrumb-bar{background:var(--bg-c);border-bottom:1px solid var(--b);padding:12px 20px;display:none;animation:fadeIn .3s}
.breadcrumb-bar.show{display:block}
.breadcrumb-container{max-width:1400px;margin:0 auto;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.breadcrumb-link{color:var(--t-s);text-decoration:none;padding:5px 12px;background:var(--bg-h);border-radius:6px;transition:.2s;display:flex;align-items:center;gap:6px;font-size:13px}
.breadcrumb-link:hover{background:var(--bg-e);color:var(--p)}.breadcrumb-sep{color:var(--t-m);font-size:12px}.breadcrumb-cur{color:var(--t);font-weight:500;font-size:13px}
.container{max-width:1200px;margin:0 auto;padding:25px 20px}
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;gap:20px;flex-wrap:wrap;animation:slideUp .4s}
.page-title-section{display:flex;align-items:center;gap:15px}
.page-icon{width:50px;height:50px;background:linear-gradient(135deg,var(--p),var(--p-d));border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 0 30px rgba(34,197,94,0.2)}
.page-title-text h1{font-size:24px;font-weight:700;margin-bottom:2px}.page-title-text p{font-size:13px;color:var(--t-s)}
.page-actions{display:flex;gap:10px;align-items:center}
.btn{padding:10px 20px;border-radius:10px;border:none;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;transition:.25s;white-space:nowrap}
.btn-primary{background:linear-gradient(135deg,var(--p),var(--p-d));color:#000;box-shadow:0 4px 15px rgba(34,197,94,0.3)}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(34,197,94,0.4)}
.btn-secondary{background:var(--bg-h);color:var(--t);border:1px solid var(--b)}.btn-secondary:hover{background:var(--bg-e);border-color:var(--p)}
.btn-icon{width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;background:var(--bg-h);border:1px solid var(--b);border-radius:10px;color:var(--t-s);cursor:pointer;font-size:16px;transition:.2s}
.btn-icon:hover{background:var(--bg-e);color:var(--p);border-color:var(--p)}.btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
.search-box{position:relative;max-width:280px;flex:1}
.search-box input{width:100%;padding:10px 15px 10px 42px;background:var(--bg-h);border:1px solid var(--b);border-radius:10px;color:var(--t);font-size:13px;outline:none;transition:.2s;-webkit-user-select:text;user-select:text}
.search-box input:focus{border-color:var(--p);box-shadow:0 0 0 3px rgba(34,197,94,0.1)}
.search-box::before{content:'üîç';position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:14px;opacity:.5}
.categories-list{display:flex;flex-direction:column;gap:0;background:var(--bg-c);border:1px solid var(--b);border-radius:12px;overflow:hidden}
.category-row{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg-c);cursor:pointer;transition:all .15s;border-bottom:1px solid var(--b)}
.category-row:last-child{border-bottom:none}
.category-row:hover{background:var(--bg-h)}
.category-row-icon{width:36px;height:36px;background:var(--bg-h);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;transition:.2s}
.category-row:hover .category-row-icon{background:var(--p-l);transform:scale(1.05)}
.category-row-content{flex:1;min-width:0}
.category-row-title{font-weight:600;font-size:14px;margin-bottom:1px;transition:.15s}
.category-row:hover .category-row-title{color:var(--p)}
.category-row-desc{font-size:12px;color:var(--t-s);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.category-row-stats{display:flex;gap:20px;flex-shrink:0}
.category-row-stat{text-align:center;min-width:50px}
.category-row-stat-value{font-size:14px;font-weight:700;color:var(--t)}
.category-row-stat-label{font-size:10px;color:var(--t-m);text-transform:uppercase}
.category-row-arrow{font-size:14px;color:var(--t-m);transition:.2s;flex-shrink:0}
.category-row:hover .category-row-arrow{color:var(--p);transform:translateX(3px)}
.topics-container{background:var(--bg-c);border:1px solid var(--b);border-radius:12px;overflow:hidden}
.topics-header{display:grid;grid-template-columns:1fr 80px 120px;padding:12px 16px;background:var(--bg-h);border-bottom:1px solid var(--b);font-size:11px;font-weight:700;text-transform:uppercase;color:var(--t-s);letter-spacing:.5px}
.topic-row{display:grid;grid-template-columns:1fr 80px 120px;padding:12px 16px;border-bottom:1px solid var(--b);align-items:center;transition:all .15s;cursor:pointer}
.topic-row:last-child{border-bottom:none}.topic-row:hover{background:var(--bg-h)}
/* Drag & Drop —Å—Ç–∏–ª–∏ */
.topic-row.dragging{opacity:0.5;background:var(--bg-e);border:2px dashed var(--p)}
.topic-row.drag-over{border-top:3px solid var(--p);background:var(--p-l)}
.topic-row .drag-handle{cursor:grab;padding:4px 8px;margin-right:8px;color:var(--t-m);font-size:12px;opacity:0;transition:.2s}
.topic-row:hover .drag-handle{opacity:1}
.topic-row .drag-handle:active{cursor:grabbing}
.topic-main{display:flex;align-items:flex-start;gap:8px;min-width:0}
.topic-status-indicator{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0;box-shadow:0 0 8px currentColor}
.topic-status-indicator.open{background:var(--p);color:var(--p)}.topic-status-indicator.closed{background:var(--d);color:var(--d)}.topic-status-indicator.pinned{background:var(--w);color:var(--w)}
.topic-content-wrap{min-width:0;flex:1}.topic-badges{display:flex;gap:5px;margin-bottom:4px;flex-wrap:wrap}
.badge{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:600;text-transform:uppercase}
.badge-pinned{background:rgba(234,179,8,0.15);color:var(--w)}.badge-guide{background:rgba(59,130,246,0.15);color:var(--i)}.badge-closed{background:rgba(239,68,68,0.15);color:var(--d)}.badge-locked{background:rgba(100,100,100,0.15);color:#888}
.topic-title{font-weight:600;font-size:13px;margin-bottom:3px;transition:.15s}.topic-row:hover .topic-title{color:var(--p)}
.topic-meta{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--t-s)}
.topic-author-mini{display:flex;align-items:center;gap:5px}
.topic-author-avatar{width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--a));display:flex;align-items:center;justify-content:center;font-size:7px;font-weight:700;color:#000}
.topic-cell{text-align:center;font-size:13px;color:var(--t-s)}.topic-cell-count{font-weight:700;color:var(--t);font-size:14px}
.topic-date-cell{text-align:right;font-size:11px;color:var(--t-s)}
.topic-view{display:none}.topic-view.active{display:block;animation:fadeIn .4s}
.topic-hero{background:linear-gradient(180deg,var(--bg-c) 0%,var(--bg) 100%);border:1px solid var(--b);border-radius:16px;padding:25px;margin-bottom:20px;position:relative;overflow:hidden}
.topic-hero::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(135deg,var(--p),var(--p-d))}
.topic-hero-badges{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.topic-hero-title{font-size:22px;font-weight:800;margin-bottom:12px;line-height:1.3}
.topic-hero-meta{display:flex;align-items:center;gap:15px;flex-wrap:wrap}
.topic-meta-item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--t-s)}.topic-meta-item span{color:var(--t)}
.topic-author-card{display:flex;align-items:center;gap:8px;padding:6px 12px 6px 6px;background:var(--bg-h);border-radius:20px}
.topic-author-avatar-big{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--a));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#000;overflow:hidden}
.topic-author-avatar-big img{width:100%;height:100%;object-fit:cover}
.topic-admin-panel{display:none;margin-top:15px;padding-top:15px;border-top:1px solid var(--b)}.topic-admin-panel.show{display:block}
.admin-controls{display:flex;gap:8px;flex-wrap:wrap}
.admin-controls .btn{padding:8px 14px;font-size:12px}
.posts-section{margin-bottom:20px}.posts-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.posts-section-title{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px}
.posts-count{background:var(--p-l);color:var(--p);padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600}
.posts-list{display:flex;flex-direction:column;gap:12px}
.post-card{background:var(--bg-c);border:1px solid var(--b);border-radius:12px;overflow:hidden;transition:.2s}
.post-card:hover{border-color:#333}
.post-card.original{border-color:var(--p);box-shadow:0 0 20px rgba(34,197,94,0.1)}
.post-card.original::before{content:'–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –ø–æ—Å—Ç';display:block;padding:6px 12px;background:var(--p-l);color:var(--p);font-size:10px;font-weight:600;text-transform:uppercase}
.post-header{display:flex;align-items:center;gap:10px;padding:12px 15px;background:rgba(255,255,255,0.02);border-bottom:1px solid var(--b)}
.post-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--a));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#000;overflow:hidden}
.post-avatar img{width:100%;height:100%;object-fit:cover}
.post-author-info{flex:1;min-width:0}.post-author-top{display:flex;align-items:center;gap:8px;margin-bottom:2px}
.post-author-name{font-weight:600;font-size:13px}
.post-author-role{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:600;text-transform:uppercase}
.post-author-role.admin{background:rgba(239,68,68,0.15);color:var(--d)}.post-author-role.instructor{background:rgba(249,115,22,0.15);color:var(--a)}.post-author-role.member{background:rgba(59,130,246,0.15);color:var(--i)}
.post-num{font-size:10px;color:var(--t-m)}.post-date{font-size:11px;color:var(--t-s);text-align:right}
.post-content{padding:15px;font-size:14px;line-height:1.7;-webkit-user-select:text;user-select:text}
.post-content img{max-width:100%;border-radius:8px;margin:10px 0}.post-content a{color:var(--p)}
.post-content blockquote{border-left:3px solid var(--p);padding:12px 15px;margin:12px 0;background:rgba(34,197,94,0.05);border-radius:0 8px 8px 0}
.post-footer{display:flex;gap:8px;padding:10px 15px;background:rgba(0,0,0,0.2);border-top:1px solid var(--b)}
.post-action-btn{display:flex;align-items:center;gap:5px;padding:6px 12px;background:var(--bg-h);border:1px solid var(--b);border-radius:6px;font-size:11px;color:var(--t-s);cursor:pointer;transition:.2s}
.post-action-btn:hover{background:var(--bg-e);color:var(--t)}.post-action-btn.liked{background:var(--p-l);border-color:var(--p);color:var(--p)}
.reply-section{background:var(--bg-c);border:1px solid var(--b);border-radius:12px;overflow:hidden}.reply-section.disabled{opacity:.5;pointer-events:none}
.reply-header{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;background:var(--bg-h);border-bottom:1px solid var(--b)}
.reply-title{font-weight:600;font-size:13px;display:flex;align-items:center;gap:8px}
/* –ü–æ–ª–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä */
.editor-toolbar{display:flex;flex-wrap:wrap;gap:3px;padding:10px 12px;background:rgba(0,0,0,0.3);border-bottom:1px solid var(--b);align-items:center}
.toolbar-group{display:flex;gap:2px}
.toolbar-divider{width:1px;height:20px;background:var(--b);margin:0 8px}
.toolbar-btn{width:30px;height:30px;border:none;background:var(--bg-h);color:var(--t-s);cursor:pointer;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;transition:.15s}
.toolbar-btn:hover{background:var(--bg-e);color:var(--t)}.toolbar-btn.active{background:var(--p);color:#000}
.toolbar-select{height:30px;padding:0 8px;background:var(--bg-h);border:1px solid var(--b);border-radius:6px;color:var(--t);font-size:11px;cursor:pointer}
.toolbar-color{width:30px;height:30px;padding:3px;background:var(--bg-h);border:1px solid var(--b);border-radius:6px;cursor:pointer}
.editor-content{min-height:120px;max-height:300px;overflow-y:auto;padding:12px 15px;outline:none;font-size:13px;line-height:1.6;-webkit-user-select:text;user-select:text}
.editor-content:empty::before{content:attr(data-placeholder);color:var(--t-m)}
.editor-footer{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(0,0,0,0.2);border-top:1px solid var(--b);gap:12px;flex-wrap:wrap}
.attach-btn{display:flex;align-items:center;gap:5px;padding:6px 12px;background:var(--bg-h);border:1px dashed var(--b);border-radius:6px;color:var(--t-s);font-size:11px;cursor:pointer;transition:.2s}
.attach-btn:hover{border-color:var(--p);color:var(--p)}.attach-btn input{display:none}
.profile-header{text-align:center;padding-bottom:15px;border-bottom:1px solid var(--b);margin-bottom:15px}
.profile-avatar-container{position:relative;width:80px;height:80px;margin:0 auto 12px}
.profile-avatar-big{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--a));display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700;color:#000;overflow:hidden;border:3px solid var(--b)}
.profile-avatar-big img{width:100%;height:100%;object-fit:cover}
.profile-avatar-edit{position:absolute;bottom:0;right:0;width:28px;height:28px;background:var(--p);border:2px solid var(--bg-c);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;transition:.2s}
.profile-avatar-edit:hover{transform:scale(1.1)}.profile-avatar-edit input{display:none}
.profile-name-display{font-size:18px;font-weight:700;margin-bottom:4px}
.profile-role-badge{display:inline-block;padding:4px 12px;border-radius:15px;font-size:11px;font-weight:600;text-transform:uppercase}
.profile-role-badge.admin{background:rgba(239,68,68,0.15);color:var(--d)}.profile-role-badge.instructor{background:rgba(249,115,22,0.15);color:var(--a)}.profile-role-badge.member{background:rgba(59,130,246,0.15);color:var(--i)}
.profile-stats{display:flex;justify-content:center;gap:25px;margin-top:15px}
.profile-stat{text-align:center}.profile-stat-value{font-size:20px;font-weight:800;color:var(--p)}.profile-stat-label{font-size:10px;color:var(--t-s);text-transform:uppercase}
.profile-form{display:flex;flex-direction:column;gap:12px}
.empty-state{text-align:center;padding:50px 20px;color:var(--t-s)}.empty-icon{font-size:40px;margin-bottom:15px;opacity:.3}
.empty-title{font-size:16px;font-weight:700;color:var(--t);margin-bottom:8px}.empty-text{font-size:12px;margin-bottom:20px;max-width:280px;margin-left:auto;margin-right:auto}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(5px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.active{display:flex;animation:fadeIn .2s}
.modal{background:var(--bg-c);border:1px solid var(--b);border-radius:16px;width:100%;max-width:480px;max-height:90vh;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,0.5);animation:scaleIn .3s}.modal.large{max-width:700px}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:15px 20px;border-bottom:1px solid var(--b);background:var(--bg-h)}
.modal-title{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}
.modal-close{width:32px;height:32px;background:var(--bg-h);border:1px solid var(--b);border-radius:8px;color:var(--t-s);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s}
.modal-close:hover{background:var(--d);border-color:var(--d);color:#fff}
.modal-body{padding:20px;overflow-y:auto;max-height:calc(90vh - 130px)}
.modal-footer{display:flex;justify-content:flex-end;gap:8px;padding:15px 20px;border-top:1px solid var(--b);background:rgba(0,0,0,0.2)}
.form-group{margin-bottom:15px}.form-label{display:block;font-size:11px;font-weight:600;color:var(--t-s);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;padding:10px 12px;background:var(--bg-h);border:1px solid var(--b);border-radius:8px;color:var(--t);font-size:13px;outline:none;transition:.2s;-webkit-user-select:text;user-select:text}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--p);box-shadow:0 0 0 3px rgba(34,197,94,0.1)}
.form-textarea{min-height:80px;resize:vertical;font-family:inherit}
.form-check{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-h);border-radius:8px;cursor:pointer;font-size:13px;transition:.2s}
.form-check:hover{background:var(--bg-e)}.form-check input{accent-color:var(--p);width:16px;height:16px}
.emoji-grid{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px}
.emoji-btn{width:32px;height:32px;border:none;background:var(--bg-h);border-radius:6px;font-size:14px;cursor:pointer;transition:.15s}.emoji-btn:hover{background:var(--bg-e);transform:scale(1.15)}
.dropdown{position:relative}.dropdown-menu{position:absolute;top:calc(100% + 5px);right:0;background:var(--bg-c);border:1px solid var(--b);border-radius:10px;min-width:160px;padding:6px;z-index:50;display:none;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
.dropdown-menu.open{display:block;animation:scaleIn .2s}
.dropdown-item{display:flex;align-items:center;gap:8px;padding:8px 12px;font-size:12px;color:var(--t-s);cursor:pointer;border-radius:6px;transition:.15s}
.dropdown-item:hover{background:var(--bg-h);color:var(--t)}.dropdown-item.danger:hover{background:rgba(239,68,68,0.15);color:var(--d)}
.toast-container{position:fixed;bottom:20px;right:20px;z-index:300;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--bg-c);border:1px solid var(--b);border-left:3px solid var(--p);padding:12px 16px;border-radius:10px;font-size:13px;box-shadow:0 8px 30px rgba(0,0,0,0.5);animation:toastIn .3s;display:flex;align-items:center;gap:8px}
.toast.error{border-left-color:var(--d)}.toast-icon{font-size:16px}
@keyframes toastIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
@keyframes spin{to{transform:rotate(360deg)}}
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-c);border-top:1px solid var(--b);padding:6px 12px;z-index:100}
.mobile-nav-items{display:flex;justify-content:space-around;align-items:center}
.mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 10px;color:var(--t-s);text-decoration:none;font-size:9px;border-radius:8px;transition:.2s}
.mobile-nav-item:hover,.mobile-nav-item.active{color:var(--p);background:var(--p-l)}.mobile-nav-item .icon{font-size:18px}
.context-menu{position:fixed;background:var(--bg-c);border:1px solid var(--b);border-radius:10px;min-width:180px;padding:6px;z-index:500;box-shadow:0 8px 30px rgba(0,0,0,0.7);display:none;animation:scaleIn .15s}
.context-menu.show{display:block}
.context-menu-item{display:flex;align-items:center;gap:8px;padding:8px 12px;font-size:12px;color:var(--t-s);cursor:pointer;border-radius:6px;transition:.15s}
.context-menu-item:hover{background:var(--bg-h);color:var(--t)}
.context-menu-item.danger{color:var(--d)}.context-menu-item.danger:hover{background:rgba(239,68,68,0.15)}
.context-menu-divider{height:1px;background:var(--b);margin:4px 0}
.loader{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:50px 20px;gap:15px}
.loader-spinner{width:32px;height:32px;border:3px solid var(--b);border-top-color:var(--p);border-radius:50%;animation:spin .8s linear infinite}
.loader-text{color:var(--t-s);font-size:13px}
@media(max-width:768px){.container{padding:15px 12px}.topics-header{display:none}.topic-row{grid-template-columns:1fr;gap:8px}.topic-cell,.topic-date-cell{display:none}.page-header{flex-direction:column;align-items:stretch;gap:15px}.page-title-section{gap:12px}.page-icon{width:40px;height:40px;font-size:20px}.page-title-text h1{font-size:20px}.search-box{max-width:none;width:100%;order:-1}.user-info-nav{display:none}.topic-hero{padding:20px}.topic-hero-title{font-size:18px}.mobile-nav{display:block}body{padding-bottom:60px}.toolbar-divider{display:none}.nav-links{display:none}.category-row{flex-wrap:wrap}.category-row-stats{width:100%;justify-content:flex-start;gap:15px;padding-top:8px;margin-top:8px;border-top:1px solid var(--b)}.category-row-arrow{display:none}.topic-row .drag-handle{display:none}}
@media(max-width:480px){.main-nav{padding:0 12px}.nav-container{height:55px}.nav-logo{width:35px;height:35px;font-size:16px}.nav-title{font-size:15px}.btn{padding:8px 14px;font-size:12px}.category-row{padding:10px 12px}.category-row-icon{width:32px;height:32px;font-size:16px}.toolbar-btn{width:26px;height:26px;font-size:11px}}
</style>
</head>
<body>
<div class="toast-container" id="toastContainer"></div>
<div class="context-menu" id="contextMenu">
<div class="context-menu-item" id="ctxOpen"><span>üìÇ</span> –í—ñ–¥–∫—Ä–∏—Ç–∏</div>
<div class="context-menu-item" id="ctxCopyLink"><span>üîó</span> –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</div>
<div class="context-menu-divider"></div>
<div class="context-menu-item" id="ctxEdit"><span>‚úèÔ∏è</span> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</div>
<div class="context-menu-item" id="ctxDelete"><span>üóëÔ∏è</span> –í–∏–¥–∞–ª–∏—Ç–∏</div>
</div>

<nav class="main-nav">
<div class="nav-container">
<a href="cabinet.html" class="nav-brand"><div class="nav-logo">–î</div><div class="nav-title">–î–®–í <span>–§–û–†–£–ú</span></div></a>
<div class="nav-links">
<a href="cabinet.html" class="nav-link"><span>üè†</span><span>–ì–æ–ª–æ–≤–Ω–∞</span></a>
<a href="forym.html" class="nav-link active"><span>üí¨</span><span>–§–æ—Ä—É–º</span></a>
</div>
<div class="nav-right">
<button class="user-profile-btn" onclick="openProfileModal()">
<div class="user-avatar-nav" id="userAvatarNav">?</div>
<div class="user-info-nav"><div class="user-name-nav" id="userNameNav">...</div><div class="user-role-nav" id="userRoleNav">‚Äî</div></div>
</button>
</div>
</div>
</nav>

<nav class="mobile-nav">
<div class="mobile-nav-items">
<a href="cabinet.html" class="mobile-nav-item"><span class="icon">üè†</span><span>–ì–æ–ª–æ–≤–Ω–∞</span></a>
<a href="forym.html" class="mobile-nav-item active"><span class="icon">üí¨</span><span>–§–æ—Ä—É–º</span></a>
<a href="#" class="mobile-nav-item" onclick="openProfileModal();return false;"><span class="icon">üë§</span><span>–ü—Ä–æ—Ñ—ñ–ª—å</span></a>
</div>
</nav>

<div class="breadcrumb-bar" id="breadcrumbBar"><div class="breadcrumb-container" id="breadcrumbContent"></div></div>

<div class="container">
<div id="categoriesView">
<div class="page-header">
<div class="page-title-section"><div class="page-icon">üìÇ</div><div class="page-title-text"><h1>–§–æ—Ä—É–º</h1><p>–û–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–¥—ñ–ª –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Ç–µ–º</p></div></div>
<div class="page-actions">
<div class="search-box"><input type="text" placeholder="–ü–æ—à—É–∫..." id="searchCategories" oninput="filterCategories()"></div>
<button class="btn-icon" id="addCategoryBtn" style="display:none" onclick="openCategoryModal()" title="–î–æ–¥–∞—Ç–∏ —Ä–æ–∑–¥—ñ–ª">‚ûï</button>
</div>
</div>
<div class="categories-list" id="categoriesList"><div class="loader"><div class="loader-spinner"></div><div class="loader-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div></div>
</div>

<div id="topicsView" style="display:none">
<div class="page-header">
<div class="page-title-section"><div class="page-icon" id="currentCategoryIconBig">üìÅ</div><div class="page-title-text"><h1 id="currentCategoryTitleBig">–†–æ–∑–¥—ñ–ª</h1><p id="currentCategoryDescBig">–¢–µ–º–∏</p></div></div>
<div class="page-actions">
<div class="search-box"><input type="text" placeholder="–ü–æ—à—É–∫ —Ç–µ–º..." id="searchTopics" oninput="filterTopics()"></div>
<button class="btn btn-primary" onclick="openTopicModal()">‚ûï –ù–æ–≤–∞ —Ç–µ–º–∞</button>
<div class="dropdown" id="categorySettings" style="display:none">
<button class="btn-icon" onclick="toggleCategoryMenu()">‚öôÔ∏è</button>
<div class="dropdown-menu" id="categoryMenu">
<div class="dropdown-item" onclick="editCategory()">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</div>
<div class="dropdown-item danger" onclick="deleteCategory()">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</div>
</div>
</div>
</div>
</div>
<div class="topics-container">
<div class="topics-header"><div>–¢–µ–º–∞</div><div style="text-align:center">–í—ñ–¥–ø.</div><div style="text-align:right">–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</div></div>
<div id="topicsList"><div class="loader"><div class="loader-spinner"></div><div class="loader-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div></div>
</div>
</div>

<div id="topicView" class="topic-view">
<div class="topic-hero">
<div class="topic-hero-badges" id="topicBadges"></div>
<h1 class="topic-hero-title" id="topicTitle">–¢–µ–º–∞</h1>
<div class="topic-hero-meta" id="topicMeta"></div>
<div class="topic-admin-panel" id="topicAdminPanel">
<div class="admin-controls">
<button class="btn btn-secondary" id="btnPin" onclick="togglePin()">üìå –ó–∞–∫—Ä—ñ–ø–∏—Ç–∏</button>
<button class="btn btn-secondary" id="btnClose" onclick="toggleClose()">üîí –ó–∞–∫—Ä–∏—Ç–∏</button>
<button class="btn btn-secondary" id="btnLock" onclick="toggleLock()">üîá –ë–ª–æ–∫—É–≤–∞—Ç–∏</button>
<button class="btn btn-secondary" onclick="editTopic()">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
<button class="btn btn-danger" onclick="deleteTopic()">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
</div>
</div>
</div>
<div class="posts-section">
<div class="posts-section-header"><div class="posts-section-title">üí¨ –û–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è <span class="posts-count" id="postsCount">0</span></div></div>
<div class="posts-list" id="postsList"><div class="loader"><div class="loader-spinner"></div><div class="loader-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div></div>
</div>
<div class="reply-section" id="replySection">
<div class="reply-header"><div class="reply-title"><span>‚úçÔ∏è</span><span id="replyTitleText">–ù–∞–ø–∏—Å–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</span></div></div>
<div class="editor">
<!-- –ü–û–õ–ù–´–ô –¢–£–õ–ë–ê–† -->
<div class="editor-toolbar">
<div class="toolbar-group">
<button class="toolbar-btn" onclick="execCmd('bold')" title="–ñ–∏—Ä–Ω–∏–π"><b>B</b></button>
<button class="toolbar-btn" onclick="execCmd('italic')" title="–ö—É—Ä—Å–∏–≤"><i>I</i></button>
<button class="toolbar-btn" onclick="execCmd('underline')" title="–ü—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–∏–π"><u>U</u></button>
<button class="toolbar-btn" onclick="execCmd('strikeThrough')" title="–ó–∞–∫—Ä–µ—Å–ª–µ–Ω–∏–π"><s>S</s></button>
</div>
<div class="toolbar-divider"></div>
<select class="toolbar-select" onchange="applyFont(this.value)" title="–®—Ä–∏—Ñ—Ç">
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
<option value="Arial">Arial</option>
<option value="Georgia">Georgia</option>
</select>
<select class="toolbar-select" onchange="applySize(this.value)" title="–†–æ–∑–º—ñ—Ä">
<option value="1">–ú—ñ–Ω</option>
<option value="2">–ú–∞–ª–∏–π</option>
<option value="3" selected>–ù–æ—Ä–º</option>
<option value="4">–°–µ—Ä–µ–¥–Ω—ñ–π</option>
<option value="5">–í–µ–ª–∏–∫–∏–π</option>
</select>
<input type="color" class="toolbar-color" value="#ffffff" onchange="applyColor(this.value)" title="–ö–æ–ª—ñ—Ä">
<div class="toolbar-divider"></div>
<div class="toolbar-group">
<button class="toolbar-btn" onclick="execCmd('justifyLeft')" title="–ü–æ –ª—ñ–≤–æ–º—É">‚¨Ö</button>
<button class="toolbar-btn" onclick="execCmd('justifyCenter')" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É">‚Üî</button>
<button class="toolbar-btn" onclick="execCmd('justifyRight')" title="–ü–æ –ø—Ä–∞–≤–æ–º—É">‚û°</button>
</div>
<div class="toolbar-divider"></div>
<div class="toolbar-group">
<button class="toolbar-btn" onclick="execCmd('insertUnorderedList')" title="–°–ø–∏—Å–æ–∫">‚Ä¢</button>
<button class="toolbar-btn" onclick="execCmd('insertOrderedList')" title="–ù—É–º–µ—Ä–∞—Ü—ñ—è">1.</button>
<button class="toolbar-btn" onclick="insertQuote()" title="–¶–∏—Ç–∞—Ç–∞">‚ùù</button>
<button class="toolbar-btn" onclick="openLinkModal()" title="–ü–æ—Å–∏–ª–∞–Ω–Ω—è">üîó</button>
</div>
</div>
<div class="editor-content" id="replyEditor" contenteditable="true" data-placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å..."></div>
<div class="editor-footer">
<label class="attach-btn">üì∑ –§–æ—Ç–æ<input type="file" accept="image/*" onchange="insertImage(this)"></label>
<button class="btn btn-primary" onclick="submitReply()">üì§ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
</div>
</div>
</div>
</div>
</div>

<div class="modal-overlay" id="categoryModal">
<div class="modal">
<div class="modal-header"><h3 class="modal-title"><span>üìÅ</span><span id="categoryModalTitle">–ù–æ–≤–∏–π —Ä–æ–∑–¥—ñ–ª</span></h3><button class="modal-close" onclick="closeCategoryModal()">‚úï</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">–ù–∞–∑–≤–∞</label><input type="text" class="form-input" id="catName" placeholder="–ù–∞–∑–≤–∞ —Ä–æ–∑–¥—ñ–ª—É"></div>
<div class="form-group"><label class="form-label">–Ü–∫–æ–Ω–∫–∞</label><input type="text" class="form-input" id="catIcon" placeholder="üìÅ" maxlength="2" style="width:70px">
<div class="emoji-grid"><button class="emoji-btn" onclick="pickEmoji('üìö')">üìö</button><button class="emoji-btn" onclick="pickEmoji('üì¢')">üì¢</button><button class="emoji-btn" onclick="pickEmoji('üí°')">üí°</button><button class="emoji-btn" onclick="pickEmoji('üéÆ')">üéÆ</button><button class="emoji-btn" onclick="pickEmoji('‚öîÔ∏è')">‚öîÔ∏è</button><button class="emoji-btn" onclick="pickEmoji('üèÜ')">üèÜ</button><button class="emoji-btn" onclick="pickEmoji('‚ùì')">‚ùì</button><button class="emoji-btn" onclick="pickEmoji('üìù')">üìù</button><button class="emoji-btn" onclick="pickEmoji('üîß')">üîß</button><button class="emoji-btn" onclick="pickEmoji('üéØ')">üéØ</button></div>
</div>
<div class="form-group"><label class="form-label">–û–ø–∏—Å</label><input type="text" class="form-input" id="catDesc" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å"></div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeCategoryModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button class="btn btn-primary" onclick="saveCategory()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button></div>
</div>
</div>

<div class="modal-overlay" id="topicModal">
<div class="modal large">
<div class="modal-header"><h3 class="modal-title"><span>üìù</span><span id="topicModalTitle">–ù–æ–≤–∞ —Ç–µ–º–∞</span></h3><button class="modal-close" onclick="closeTopicModal()">‚úï</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input type="text" class="form-input" id="newTopicTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–º–∏"></div>
<div class="form-group"><label class="form-label">–†–æ–∑–¥—ñ–ª</label><select class="form-select" id="newTopicCategory"></select></div>
<div class="form-group"><label class="form-label">–í–º—ñ—Å—Ç</label>
<div style="border:1px solid var(--b);border-radius:10px;overflow:hidden">
<!-- –ü–û–õ–ù–´–ô –¢–£–õ–ë–ê–† –í –ú–û–î–ê–õ–ö–ï -->
<div class="editor-toolbar">
<div class="toolbar-group">
<button class="toolbar-btn" onclick="execCmdModal('bold')"><b>B</b></button>
<button class="toolbar-btn" onclick="execCmdModal('italic')"><i>I</i></button>
<button class="toolbar-btn" onclick="execCmdModal('underline')"><u>U</u></button>
<button class="toolbar-btn" onclick="execCmdModal('strikeThrough')"><s>S</s></button>
</div>
<div class="toolbar-divider"></div>
<select class="toolbar-select" onchange="applyFontModal(this.value)">
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
<option value="Arial">Arial</option>
</select>
<select class="toolbar-select" onchange="applySizeModal(this.value)">
<option value="2">–ú–∞–ª–∏–π</option>
<option value="3" selected>–ù–æ—Ä–º</option>
<option value="4">–°–µ—Ä–µ–¥–Ω—ñ–π</option>
<option value="5">–í–µ–ª–∏–∫–∏–π</option>
</select>
<input type="color" class="toolbar-color" value="#ffffff" onchange="applyColorModal(this.value)">
<div class="toolbar-divider"></div>
<div class="toolbar-group">
<button class="toolbar-btn" onclick="execCmdModal('justifyLeft')">‚¨Ö</button>
<button class="toolbar-btn" onclick="execCmdModal('justifyCenter')">‚Üî</button>
<button class="toolbar-btn" onclick="execCmdModal('justifyRight')">‚û°</button>
</div>
<div class="toolbar-divider"></div>
<div class="toolbar-group">
<button class="toolbar-btn" onclick="execCmdModal('insertUnorderedList')">‚Ä¢</button>
<button class="toolbar-btn" onclick="execCmdModal('insertOrderedList')">1.</button>
<button class="toolbar-btn" onclick="insertQuoteModal()">‚ùù</button>
<button class="toolbar-btn" onclick="openLinkModalFor('modal')">üîó</button>
</div>
</div>
<div class="editor-content" id="newTopicEditor" contenteditable="true" data-placeholder="–í–º—ñ—Å—Ç —Ç–µ–º–∏..." style="min-height:150px"></div>
<div class="editor-footer"><label class="attach-btn">üì∑ –§–æ—Ç–æ<input type="file" accept="image/*" onchange="insertImageModal(this)"></label></div>
</div>
</div>
<div id="topicOptionsAdmin" style="display:none"><div style="display:flex;gap:10px;flex-wrap:wrap">
<label class="form-check" style="flex:1;min-width:140px"><input type="checkbox" id="newTopicPinned"><span>üìå –ó–∞–∫—Ä—ñ–ø–∏—Ç–∏</span></label>
<label class="form-check" style="flex:1;min-width:140px"><input type="checkbox" id="newTopicGuide"><span>üìò –ì–∞–π–¥</span></label>
</div></div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeTopicModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button class="btn btn-primary" onclick="saveTopic()">üì§ –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button></div>
</div>
</div>

<div class="modal-overlay" id="linkModal">
<div class="modal" style="max-width:400px">
<div class="modal-header"><h3 class="modal-title">üîó –í—Å—Ç–∞–≤–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</h3><button class="modal-close" onclick="closeLinkModal()">‚úï</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">URL –∞–¥—Ä–µ—Å–∞</label><input type="url" class="form-input" id="linkUrl" placeholder="https://example.com"></div>
<div class="form-group"><label class="form-label">–¢–µ–∫—Å—Ç –ø–æ—Å–∏–ª–∞–Ω–Ω—è</label><input type="text" class="form-input" id="linkText" placeholder="–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —Ç—É—Ç"></div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeLinkModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button class="btn btn-primary" onclick="insertLink()">üîó –í—Å—Ç–∞–≤–∏—Ç–∏</button></div>
</div>
</div>

<div class="modal-overlay" id="profileModal">
<div class="modal">
<div class="modal-header"><h3 class="modal-title">üë§ –ü—Ä–æ—Ñ—ñ–ª—å</h3><button class="modal-close" onclick="closeProfileModal()">‚úï</button></div>
<div class="modal-body">
<div class="profile-header">
<div class="profile-avatar-container"><div class="profile-avatar-big" id="profileAvatarBig">?</div><label class="profile-avatar-edit">üì∑<input type="file" accept="image/*" onchange="uploadAvatar(this)"></label></div>
<div class="profile-name-display" id="profileNameDisplay">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</div>
<div class="profile-role-badge" id="profileRoleBadge">member</div>
<div class="profile-stats">
<div class="profile-stat"><div class="profile-stat-value" id="profileTopicsCount">0</div><div class="profile-stat-label">–¢–µ–º</div></div>
<div class="profile-stat"><div class="profile-stat-value" id="profilePostsCount">0</div><div class="profile-stat-label">–í—ñ–¥–ø.</div></div>
<div class="profile-stat"><div class="profile-stat-value" id="profileLikesCount">0</div><div class="profile-stat-label">–õ–∞–π–∫—ñ–≤</div></div>
</div>
</div>
<div class="profile-form">
<div class="form-group"><label class="form-label">–Ü–º'—è</label><input type="text" class="form-input" id="profileNameInput" placeholder="–í–∞—à–µ —ñ–º'—è"></div>
<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="profileEmailInput" disabled></div>
<div class="form-group"><label class="form-label">–ü—Ä–æ —Å–µ–±–µ</label><textarea class="form-input form-textarea" id="profileBioInput" placeholder="..."></textarea></div>
</div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeProfileModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button class="btn btn-primary" onclick="saveProfile()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button></div>
</div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import{getAuth,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import{getFirestore,doc,getDoc,updateDoc,collection,onSnapshot,query,orderBy,addDoc,serverTimestamp,getDocs,deleteDoc,where}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
const app=initializeApp({apiKey:"AIzaSyATUpLUHSp1VbyxkJXhMS-2R71zNOBGC00",authDomain:"dsv-gta.firebaseapp.com",projectId:"dsv-gta",storageBucket:"dsv-gta.firebasestorage.app",messagingSenderId:"661591588818",appId:"1:661591588818:web:a8e8dca3d061447e24d20b"});
const auth=getAuth(app),db=getFirestore(app);
let user=null,userData=null,categories=[],topics=[],currentCategoryId=null,currentTopicId=null,currentTopicData=null,editingCategoryId=null,editingTopicId=null,linkTarget='reply',postsUnsubscribe=null,contextTarget={type:null,id:null},modalMouseDownTarget=null;
let draggedTopicId=null;

const notify=(m,t='success')=>{const i={success:'‚úÖ',error:'‚ùå'};const e=document.createElement('div');e.className=`toast ${t}`;e.innerHTML=`<span class="toast-icon">${i[t]||'üì¢'}</span><span>${m}</span>`;document.getElementById('toastContainer').appendChild(e);setTimeout(()=>e.remove(),4000)};
const getInitials=n=>{if(!n)return'?';const p=n.trim().split(' ');return p.length>=2?(p[0][0]+p[1][0]).toUpperCase():n.substring(0,2).toUpperCase()};
const formatDate=ts=>{if(!ts)return'';const d=new Date(ts.seconds?ts.seconds*1000:ts),now=new Date(),diff=now-d;if(diff<60000)return'–©–æ–π–Ω–æ';if(diff<3600000)return`${Math.floor(diff/60000)}—Ö–≤`;if(diff<86400000)return`${Math.floor(diff/3600000)}–≥–æ–¥`;if(diff<604800000)return`${Math.floor(diff/86400000)}–¥`;return d.toLocaleDateString('uk-UA',{day:'2-digit',month:'short'})};
const isAdmin=()=>userData&&userData.role==='admin';
const isInstructor=()=>userData&&userData.role==='instructor';
const updateUserAvatars=()=>{const av=userData?.avatar,ini=getInitials(userData?.name);document.querySelectorAll('#userAvatarNav,#profileAvatarBig').forEach(el=>{el.innerHTML=av?`<img src="${av}">`:ini})};
const updateBreadcrumb=items=>{const bar=document.getElementById('breadcrumbBar'),c=document.getElementById('breadcrumbContent');if(!items||!items.length){bar.classList.remove('show');return}bar.classList.add('show');c.innerHTML=items.map((it,i)=>i===items.length-1?`<span class="breadcrumb-cur">${it.label}</span>`:`<a href="#" class="breadcrumb-link" onclick="${it.action};return false;">${it.icon||''}${it.label}</a><span class="breadcrumb-sep">‚Ä∫</span>`).join('')};
document.addEventListener('contextmenu',e=>e.preventDefault());
const ctx=document.getElementById('contextMenu');
const showCtx=(e,type,id)=>{e.preventDefault();contextTarget={type,id};ctx.style.left=Math.min(e.pageX,innerWidth-200)+'px';ctx.style.top=Math.min(e.pageY,innerHeight-180)+'px';ctx.classList.add('show');document.getElementById('ctxEdit').style.display=isAdmin()?'flex':'none';document.getElementById('ctxDelete').style.display=isAdmin()?'flex':'none'};
document.addEventListener('click',()=>ctx.classList.remove('show'));
document.getElementById('ctxOpen').onclick=()=>{if(contextTarget.type==='category')openCategory(contextTarget.id);else openTopic(contextTarget.id);ctx.classList.remove('show')};
document.getElementById('ctxCopyLink').onclick=()=>{const base=location.origin+location.pathname;navigator.clipboard.writeText(contextTarget.type==='topic'?`${base}?topic=${contextTarget.id}`:`${base}?category=${contextTarget.id}`).then(()=>notify('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!')).catch(()=>notify('–ü–æ–º–∏–ª–∫–∞','error'));ctx.classList.remove('show')};
document.getElementById('ctxEdit').onclick=()=>{if(contextTarget.type==='category'){currentCategoryId=contextTarget.id;editCategory()}else{openTopic(contextTarget.id).then(()=>editTopic())}ctx.classList.remove('show')};
document.getElementById('ctxDelete').onclick=()=>{if(contextTarget.type==='category'){currentCategoryId=contextTarget.id;deleteCategory()}else{currentTopicId=contextTarget.id;deleteTopic()}ctx.classList.remove('show')};
const checkUrl=()=>{const p=new URLSearchParams(location.search);if(p.get('topic'))setTimeout(()=>openTopic(p.get('topic')),500);else if(p.get('category'))setTimeout(()=>openCategory(p.get('category')),500)};
onAuthStateChanged(auth,async u=>{if(!u){location.href="index.html";return}user=u;const s=await getDoc(doc(db,"users",u.uid));userData=s.exists()?s.data():{name:'User',role:'member'};document.getElementById('userNameNav').textContent=userData.name;document.getElementById('userRoleNav').textContent=userData.role.toUpperCase();updateUserAvatars();if(isAdmin()){document.getElementById('addCategoryBtn').style.display='flex';document.getElementById('topicOptionsAdmin').style.display='block'}loadCategories();loadTopics();checkUrl()});

function loadCategories(){onSnapshot(collection(db,"forum_categories"),s=>{categories=[];s.forEach(d=>categories.push({id:d.id,...d.data()}));renderCategories();updateCategorySelect()})}
function renderCategories(){const search=document.getElementById('searchCategories')?.value.toLowerCase()||'';const f=categories.filter(c=>c.name.toLowerCase().includes(search));if(!f.length){document.getElementById('categoriesList').innerHTML=`<div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-title">–†–æ–∑–¥—ñ–ª—ñ–≤ –Ω–µ–º–∞—î</div></div>`;return}document.getElementById('categoriesList').innerHTML=f.map(c=>{const tc=topics.filter(t=>t.categoryId===c.id).length,pc=topics.filter(t=>t.categoryId===c.id).reduce((s,t)=>s+(t.repliesCount||0),0);return`<div class="category-row" onclick="openCategory('${c.id}')" oncontextmenu="showCtxCat(event,'${c.id}')"><div class="category-row-icon">${c.icon||'üìÅ'}</div><div class="category-row-content"><div class="category-row-title">${c.name}</div><div class="category-row-desc">${c.description||''}</div></div><div class="category-row-stats"><div class="category-row-stat"><div class="category-row-stat-value">${tc}</div><div class="category-row-stat-label">–¢–µ–º</div></div><div class="category-row-stat"><div class="category-row-stat-value">${pc}</div><div class="category-row-stat-label">–ü–æ—Å—Ç.</div></div></div><div class="category-row-arrow">‚Ä∫</div></div>`}).join('')}
window.filterCategories=()=>renderCategories();
window.showCtxCat=(e,id)=>showCtx(e,'category',id);
window.showCtxTop=(e,id)=>{e.stopPropagation();showCtx(e,'topic',id)};

window.openCategory=id=>{currentCategoryId=id;const c=categories.find(x=>x.id===id);if(!c)return;document.getElementById('categoriesView').style.display='none';document.getElementById('topicsView').style.display='block';document.getElementById('topicView').classList.remove('active');document.getElementById('currentCategoryIconBig').textContent=c.icon||'üìÅ';document.getElementById('currentCategoryTitleBig').textContent=c.name;document.getElementById('currentCategoryDescBig').textContent=c.description||'–¢–µ–º–∏';if(isAdmin())document.getElementById('categorySettings').style.display='block';updateBreadcrumb([{label:'–§–æ—Ä—É–º',action:'showCategories()'},{label:c.name}]);renderTopics()};
window.showCategories=()=>{document.getElementById('categoriesView').style.display='block';document.getElementById('topicsView').style.display='none';document.getElementById('topicView').classList.remove('active');currentCategoryId=null;currentTopicId=null;updateBreadcrumb(null);if(postsUnsubscribe)postsUnsubscribe()};
window.backToTopics=()=>{document.getElementById('topicView').classList.remove('active');document.getElementById('topicsView').style.display='block';currentTopicId=null;const c=categories.find(x=>x.id===currentCategoryId);if(c)updateBreadcrumb([{label:'–§–æ—Ä—É–º',action:'showCategories()'},{label:c.name}]);if(postsUnsubscribe)postsUnsubscribe()};
function updateCategorySelect(){const s=document.getElementById('newTopicCategory');if(!s)return;s.innerHTML=categories.map(c=>`<option value="${c.id}">${c.icon||'üìÅ'} ${c.name}</option>`).join('');if(currentCategoryId)s.value=currentCategoryId}
window.toggleCategoryMenu=()=>document.getElementById('categoryMenu').classList.toggle('open');
window.openCategoryModal=(id=null)=>{editingCategoryId=id;if(id){const c=categories.find(x=>x.id===id);document.getElementById('catName').value=c.name;document.getElementById('catIcon').value=c.icon||'';document.getElementById('catDesc').value=c.description||'';document.getElementById('categoryModalTitle').textContent='–†–µ–¥–∞–≥—É–≤–∞—Ç–∏'}else{document.getElementById('catName').value='';document.getElementById('catIcon').value='';document.getElementById('catDesc').value='';document.getElementById('categoryModalTitle').textContent='–ù–æ–≤–∏–π —Ä–æ–∑–¥—ñ–ª'}document.getElementById('categoryModal').classList.add('active')};
window.closeCategoryModal=()=>{document.getElementById('categoryModal').classList.remove('active');editingCategoryId=null};
window.pickEmoji=e=>document.getElementById('catIcon').value=e;
window.saveCategory=async()=>{const name=document.getElementById('catName').value.trim(),icon=document.getElementById('catIcon').value.trim()||'üìÅ',description=document.getElementById('catDesc').value.trim();if(!name)return notify('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É','error');try{if(editingCategoryId){await updateDoc(doc(db,"forum_categories",editingCategoryId),{name,icon,description});notify('–û–Ω–æ–≤–ª–µ–Ω–æ!')}else{await addDoc(collection(db,"forum_categories"),{name,icon,description,createdAt:serverTimestamp()});notify('–°—Ç–≤–æ—Ä–µ–Ω–æ!')}closeCategoryModal()}catch(e){notify(e.message,'error')}};
window.editCategory=()=>{document.getElementById('categoryMenu').classList.remove('open');openCategoryModal(currentCategoryId)};
window.deleteCategory=async()=>{if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–æ–∑–¥—ñ–ª?'))return;document.getElementById('categoryMenu').classList.remove('open');try{for(const t of topics.filter(x=>x.categoryId===currentCategoryId)){const p=await getDocs(query(collection(db,"forum_posts"),where("topicId","==",t.id)));for(const d of p.docs)await deleteDoc(doc(db,"forum_posts",d.id));await deleteDoc(doc(db,"forum_topics",t.id))}await deleteDoc(doc(db,"forum_categories",currentCategoryId));notify('–í–∏–¥–∞–ª–µ–Ω–æ!');showCategories()}catch(e){notify(e.message,'error')}};

function loadTopics(){onSnapshot(collection(db,"forum_topics"),s=>{topics=[];s.forEach(d=>topics.push({id:d.id,...d.data()}));topics.sort((a,b)=>{if(b.pinned&&!a.pinned)return 1;if(a.pinned&&!b.pinned)return -1;if(a.order!==undefined&&b.order!==undefined)return a.order-b.order;const ta=a.createdAt?.seconds||0,tb=b.createdAt?.seconds||0;return tb-ta});renderTopics();renderCategories()})}

function renderTopics(){if(!currentCategoryId)return;const search=document.getElementById('searchTopics')?.value.toLowerCase()||'';let f=topics.filter(t=>t.categoryId===currentCategoryId);if(search)f=f.filter(t=>t.title.toLowerCase().includes(search));if(!f.length){document.getElementById('topicsList').innerHTML=`<div class="empty-state"><div class="empty-icon">üìù</div><div class="empty-title">–¢–µ–º –Ω–µ–º–∞—î</div><button class="btn btn-primary" onclick="openTopicModal()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</button></div>`;return}
document.getElementById('topicsList').innerHTML=f.map((t,idx)=>{let b='';if(t.pinned)b+='<span class="badge badge-pinned">üìå</span>';if(t.isGuide)b+='<span class="badge badge-guide">üìò</span>';if(t.status==='closed')b+='<span class="badge badge-closed">üîí</span>';if(t.locked)b+='<span class="badge badge-locked">üîá</span>';
return`<div class="topic-row" draggable="${isAdmin()?'true':'false'}" data-id="${t.id}" data-idx="${idx}" onclick="openTopic('${t.id}')" oncontextmenu="showCtxTop(event,'${t.id}')" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)" ondragend="dragEnd(event)">
${isAdmin()?'<span class="drag-handle">‚ò∞</span>':''}
<div class="topic-main">
<div class="topic-status-indicator ${t.pinned?'pinned':t.status==='closed'?'closed':'open'}"></div>
<div class="topic-content-wrap">${b?`<div class="topic-badges">${b}</div>`:''}<div class="topic-title">${t.title}</div><div class="topic-meta"><div class="topic-author-mini"><div class="topic-author-avatar">${getInitials(t.authorName)}</div><span>${t.authorName||''}</span></div></div></div>
</div>
<div class="topic-cell"><div class="topic-cell-count">${t.repliesCount||0}</div></div>
<div class="topic-date-cell">${formatDate(t.lastActivity||t.createdAt)}</div>
</div>`}).join('')}

// Drag & Drop handlers
window.dragStart=e=>{if(!isAdmin())return;draggedTopicId=e.target.dataset.id;e.target.classList.add('dragging');e.dataTransfer.effectAllowed='move'};
window.dragOver=e=>{e.preventDefault();if(!isAdmin()||!draggedTopicId)return;const row=e.target.closest('.topic-row');if(row&&row.dataset.id!==draggedTopicId){row.classList.add('drag-over')}};
window.dragLeave=e=>{const row=e.target.closest('.topic-row');if(row)row.classList.remove('drag-over')};
window.drop=async e=>{e.preventDefault();if(!isAdmin()||!draggedTopicId)return;const targetRow=e.target.closest('.topic-row');if(!targetRow||targetRow.dataset.id===draggedTopicId)return;targetRow.classList.remove('drag-over');
const draggedIdx=topics.findIndex(t=>t.id===draggedTopicId);const targetIdx=topics.findIndex(t=>t.id===targetRow.dataset.id);if(draggedIdx===-1||targetIdx===-1)return;
const [moved]=topics.splice(draggedIdx,1);topics.splice(targetIdx,0,moved);
try{for(let i=0;i<topics.length;i++){if(topics[i].categoryId===currentCategoryId){await updateDoc(doc(db,"forum_topics",topics[i].id),{order:i})}}notify('–ü–æ—Ä—è–¥–æ–∫ –∑–º—ñ–Ω–µ–Ω–æ!')}catch(err){notify(err.message,'error')}
draggedTopicId=null;renderTopics()};
window.dragEnd=e=>{e.target.classList.remove('dragging');document.querySelectorAll('.topic-row').forEach(r=>r.classList.remove('drag-over'));draggedTopicId=null};

window.filterTopics=()=>renderTopics();
window.openTopicModal=()=>{if(!categories.length)return notify('–°—Ç–≤–æ—Ä—ñ—Ç—å —Ä–æ–∑–¥—ñ–ª','error');document.getElementById('newTopicTitle').value='';document.getElementById('newTopicEditor').innerHTML='';document.getElementById('newTopicPinned').checked=false;document.getElementById('newTopicGuide').checked=false;document.getElementById('topicModalTitle').textContent='–ù–æ–≤–∞ —Ç–µ–º–∞';updateCategorySelect();editingTopicId=null;document.getElementById('topicModal').classList.add('active')};
window.closeTopicModal=()=>document.getElementById('topicModal').classList.remove('active');
window.saveTopic=async()=>{const title=document.getElementById('newTopicTitle').value.trim(),categoryId=document.getElementById('newTopicCategory').value,content=document.getElementById('newTopicEditor').innerHTML.trim(),pinned=document.getElementById('newTopicPinned').checked&&isAdmin(),isGuide=document.getElementById('newTopicGuide').checked&&isAdmin();if(!title)return notify('–ó–∞–≥–æ–ª–æ–≤–æ–∫','error');if(!content||content==='<br>')return notify('–í–º—ñ—Å—Ç','error');try{if(editingTopicId){await updateDoc(doc(db,"forum_topics",editingTopicId),{title,categoryId,content,pinned,isGuide,updatedAt:serverTimestamp()});const p=await getDocs(query(collection(db,"forum_posts"),where("topicId","==",editingTopicId),where("isOriginal","==",true)));if(!p.empty)await updateDoc(doc(db,"forum_posts",p.docs[0].id),{content});notify('–û–Ω–æ–≤–ª–µ–Ω–æ!');closeTopicModal();openTopic(editingTopicId)}else{const maxOrder=topics.filter(t=>t.categoryId===categoryId).length;const r=await addDoc(collection(db,"forum_topics"),{title,categoryId,content,pinned,isGuide,status:'open',locked:false,authorId:user.uid,authorName:userData.name,authorRole:userData.role,authorAvatar:userData.avatar||null,repliesCount:0,order:maxOrder,createdAt:serverTimestamp(),lastActivity:serverTimestamp()});await addDoc(collection(db,"forum_posts"),{topicId:r.id,content,isOriginal:true,authorId:user.uid,authorName:userData.name,authorRole:userData.role,authorAvatar:userData.avatar||null,likes:[],createdAt:serverTimestamp()});notify('–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!');closeTopicModal();setTimeout(()=>openTopic(r.id),300)}}catch(e){notify(e.message,'error')}};

window.openTopic=async id=>{currentTopicId=id;const s=await getDoc(doc(db,"forum_topics",id));if(!s.exists())return notify('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ','error');currentTopicData={id,...s.data()};document.getElementById('topicsView').style.display='none';document.getElementById('topicView').classList.add('active');document.getElementById('topicTitle').textContent=currentTopicData.title;let b='';if(currentTopicData.pinned)b+='<span class="badge badge-pinned">üìå</span>';if(currentTopicData.isGuide)b+='<span class="badge badge-guide">üìò</span>';if(currentTopicData.status==='closed')b+='<span class="badge badge-closed">üîí</span>';if(currentTopicData.locked)b+='<span class="badge badge-locked">üîá</span>';document.getElementById('topicBadges').innerHTML=b;const c=categories.find(x=>x.id===currentTopicData.categoryId);document.getElementById('topicMeta').innerHTML=`<div class="topic-author-card"><div class="topic-author-avatar-big">${currentTopicData.authorAvatar?`<img src="${currentTopicData.authorAvatar}">`:(getInitials(currentTopicData.authorName))}</div><span style="font-weight:600;font-size:13px">${currentTopicData.authorName}</span></div><div class="topic-meta-item">üìÇ ${c?.name||''}</div><div class="topic-meta-item">üìÖ ${formatDate(currentTopicData.createdAt)}</div>`;updateBreadcrumb([{label:'–§–æ—Ä—É–º',action:'showCategories()'},{label:c?.name||'',action:'backToTopics()'},{label:currentTopicData.title.length>25?currentTopicData.title.substring(0,25)+'...':currentTopicData.title}]);const own=currentTopicData.authorId===user.uid,panel=document.getElementById('topicAdminPanel');if(isAdmin()||(isInstructor()&&own)||own){panel.classList.add('show');updateTopicButtons()}else panel.classList.remove('show');const rs=document.getElementById('replySection'),rt=document.getElementById('replyTitleText');if(currentTopicData.locked){rs.classList.add('disabled');rt.textContent='–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ'}else if(currentTopicData.status==='closed'){rs.classList.add('disabled');rt.textContent='–ó–∞–∫—Ä–∏—Ç–æ'}else{rs.classList.remove('disabled');rt.textContent='–ù–∞–ø–∏—Å–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å'}loadPosts()};
function updateTopicButtons(){document.getElementById('btnPin').innerHTML=currentTopicData.pinned?'üìå –í—ñ–¥–∫—Ä—ñ–ø–∏—Ç–∏':'üìå –ó–∞–∫—Ä—ñ–ø–∏—Ç–∏';document.getElementById('btnClose').innerHTML=currentTopicData.status==='closed'?'üîì –í—ñ–¥–∫—Ä–∏—Ç–∏':'üîí –ó–∞–∫—Ä–∏—Ç–∏';document.getElementById('btnLock').innerHTML=currentTopicData.locked?'üîä –†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏':'üîá –ë–ª–æ–∫—É–≤–∞—Ç–∏'}
window.togglePin=async()=>{if(!isAdmin())return;await updateDoc(doc(db,"forum_topics",currentTopicId),{pinned:!currentTopicData.pinned});currentTopicData.pinned=!currentTopicData.pinned;updateTopicButtons();notify(currentTopicData.pinned?'–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ!':'–í—ñ–¥–∫—Ä—ñ–ø–ª–µ–Ω–æ!')};
window.toggleClose=async()=>{const n=currentTopicData.status==='closed'?'open':'closed';await updateDoc(doc(db,"forum_topics",currentTopicId),{status:n});currentTopicData.status=n;updateTopicButtons();openTopic(currentTopicId);notify(n==='closed'?'–ó–∞–∫—Ä–∏—Ç–æ!':'–í—ñ–¥–∫—Ä–∏—Ç–æ!')};
window.toggleLock=async()=>{await updateDoc(doc(db,"forum_topics",currentTopicId),{locked:!currentTopicData.locked});currentTopicData.locked=!currentTopicData.locked;updateTopicButtons();openTopic(currentTopicId);notify(currentTopicData.locked?'–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ!':'–†–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ!')};
window.editTopic=()=>{editingTopicId=currentTopicId;document.getElementById('newTopicTitle').value=currentTopicData.title;document.getElementById('newTopicCategory').value=currentTopicData.categoryId;document.getElementById('newTopicEditor').innerHTML=currentTopicData.content;document.getElementById('newTopicPinned').checked=currentTopicData.pinned||false;document.getElementById('newTopicGuide').checked=currentTopicData.isGuide||false;document.getElementById('topicModalTitle').textContent='–†–µ–¥–∞–≥—É–≤–∞—Ç–∏';document.getElementById('topicModal').classList.add('active')};
window.deleteTopic=async()=>{if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏?'))return;try{const p=await getDocs(query(collection(db,"forum_posts"),where("topicId","==",currentTopicId)));for(const d of p.docs)await deleteDoc(doc(db,"forum_posts",d.id));await deleteDoc(doc(db,"forum_topics",currentTopicId));notify('–í–∏–¥–∞–ª–µ–Ω–æ!');backToTopics()}catch(e){notify(e.message,'error')}};

function loadPosts(){if(postsUnsubscribe)postsUnsubscribe();document.getElementById('postsList').innerHTML='<div class="loader"><div class="loader-spinner"></div><div class="loader-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>';postsUnsubscribe=onSnapshot(query(collection(db,"forum_posts"),where("topicId","==",currentTopicId)),s=>{const p=[];s.forEach(d=>p.push({id:d.id,...d.data()}));p.sort((a,b)=>(a.createdAt?.seconds||0)-(b.createdAt?.seconds||0));renderPosts(p)},e=>{document.getElementById('postsList').innerHTML=`<div class="empty-state"><div class="empty-icon">‚ùå</div><div class="empty-title">–ü–æ–º–∏–ª–∫–∞</div></div>`})}
function renderPosts(posts){document.getElementById('postsCount').textContent=posts.length;if(!posts.length){document.getElementById('postsList').innerHTML=`<div class="empty-state"><div class="empty-icon">üí¨</div><div class="empty-title">–ù–µ–º–∞—î</div></div>`;return}document.getElementById('postsList').innerHTML=posts.map((p,i)=>{const rc=p.authorRole==='admin'?'admin':p.authorRole==='instructor'?'instructor':'member';const liked=p.likes&&p.likes.includes(user.uid);const canE=p.authorId===user.uid||isAdmin();return`<div class="post-card ${p.isOriginal?'original':''}"><div class="post-header"><div class="post-avatar">${p.authorAvatar?`<img src="${p.authorAvatar}">`:(getInitials(p.authorName))}</div><div class="post-author-info"><div class="post-author-top"><span class="post-author-name">${p.authorName||''}</span><span class="post-author-role ${rc}">${p.authorRole||''}</span></div><div class="post-num">#${i+1}</div></div><div class="post-date">${formatDate(p.createdAt)}</div>${canE&&!p.isOriginal?`<div class="dropdown"><button class="btn-icon" onclick="togglePM('${p.id}')" style="width:28px;height:28px;font-size:14px">‚ãÆ</button><div class="dropdown-menu" id="pm_${p.id}"><div class="dropdown-item danger" onclick="deletePost('${p.id}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</div></div></div>`:''}</div><div class="post-content">${p.content}</div><div class="post-footer"><button class="post-action-btn ${liked?'liked':''}" onclick="toggleLike('${p.id}')">üëç ${p.likes?.length||0}</button><button class="post-action-btn" onclick="quotePost('${p.authorName}')">üí¨</button></div></div>`}).join('')}
window.togglePM=id=>{document.querySelectorAll('.dropdown-menu').forEach(m=>{if(m.id!==`pm_${id}`)m.classList.remove('open')});document.getElementById(`pm_${id}`)?.classList.toggle('open')};
window.toggleLike=async id=>{const r=doc(db,"forum_posts",id);const s=await getDoc(r);if(!s.exists())return;let l=s.data().likes||[];if(l.includes(user.uid))l=l.filter(x=>x!==user.uid);else l.push(user.uid);await updateDoc(r,{likes:l})};
window.deletePost=async id=>{if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏?'))return;await deleteDoc(doc(db,"forum_posts",id));await updateDoc(doc(db,"forum_topics",currentTopicId),{repliesCount:Math.max(0,(currentTopicData.repliesCount||0)-1)});notify('–í–∏–¥–∞–ª–µ–Ω–æ!')};
window.quotePost=a=>{const e=document.getElementById('replyEditor');e.innerHTML=`<blockquote><b>${a}:</b> ...</blockquote><p></p>`+e.innerHTML;e.focus();document.getElementById('replySection').scrollIntoView({behavior:'smooth'})};
window.submitReply=async()=>{const e=document.getElementById('replyEditor');const c=e.innerHTML.trim();if(!c||c==='<br>')return notify('–ù–∞–ø–∏—à—ñ—Ç—å','error');if(currentTopicData.locked||currentTopicData.status==='closed')return;try{await addDoc(collection(db,"forum_posts"),{topicId:currentTopicId,content:c,isOriginal:false,authorId:user.uid,authorName:userData.name,authorRole:userData.role,authorAvatar:userData.avatar||null,likes:[],createdAt:serverTimestamp()});await updateDoc(doc(db,"forum_topics",currentTopicId),{repliesCount:(currentTopicData.repliesCount||0)+1,lastActivity:serverTimestamp()});e.innerHTML='';notify('–ù–∞–¥—ñ—Å–ª–∞–Ω–æ!')}catch(err){notify(err.message,'error')}};

// Editor commands - –ü–û–õ–ù–´–ï
window.execCmd=c=>{document.getElementById('replyEditor').focus();document.execCommand(c,false,null)};
window.execCmdModal=c=>{document.getElementById('newTopicEditor').focus();document.execCommand(c,false,null)};
window.applyFont=f=>{document.getElementById('replyEditor').focus();document.execCommand('fontName',false,f)};
window.applyFontModal=f=>{document.getElementById('newTopicEditor').focus();document.execCommand('fontName',false,f)};
window.applySize=s=>{document.getElementById('replyEditor').focus();document.execCommand('fontSize',false,s)};
window.applySizeModal=s=>{document.getElementById('newTopicEditor').focus();document.execCommand('fontSize',false,s)};
window.applyColor=c=>{document.getElementById('replyEditor').focus();document.execCommand('foreColor',false,c)};
window.applyColorModal=c=>{document.getElementById('newTopicEditor').focus();document.execCommand('foreColor',false,c)};
window.insertQuote=()=>{document.getElementById('replyEditor').focus();document.execCommand('insertHTML',false,'<blockquote>–¶–∏—Ç–∞—Ç–∞...</blockquote><p></p>')};
window.insertQuoteModal=()=>{document.getElementById('newTopicEditor').focus();document.execCommand('insertHTML',false,'<blockquote>–¶–∏—Ç–∞—Ç–∞...</blockquote><p></p>')};
window.openLinkModal=()=>{linkTarget='reply';document.getElementById('linkUrl').value='';document.getElementById('linkText').value='';document.getElementById('linkModal').classList.add('active')};
window.openLinkModalFor=t=>{linkTarget=t;document.getElementById('linkUrl').value='';document.getElementById('linkText').value='';document.getElementById('linkModal').classList.add('active')};
window.closeLinkModal=()=>document.getElementById('linkModal').classList.remove('active');
window.insertLink=()=>{const u=document.getElementById('linkUrl').value.trim(),t=document.getElementById('linkText').value.trim()||u;if(!u)return notify('URL','error');document.getElementById(linkTarget==='modal'?'newTopicEditor':'replyEditor').focus();document.execCommand('insertHTML',false,`<a href="${u}" target="_blank">${t}</a>`);closeLinkModal()};
window.insertImage=i=>{if(!i.files?.[0])return;const f=i.files[0];if(f.size>5e6){notify('>5MB','error');i.value='';return}const r=new FileReader();r.onload=e=>{document.getElementById('replyEditor').focus();document.execCommand('insertHTML',false,`<img src="${e.target.result}" style="max-width:100%;border-radius:8px;margin:8px 0">`)};r.readAsDataURL(f);i.value=''};
window.insertImageModal=i=>{if(!i.files?.[0])return;const f=i.files[0];if(f.size>5e6){notify('>5MB','error');i.value='';return}const r=new FileReader();r.onload=e=>{document.getElementById('newTopicEditor').focus();document.execCommand('insertHTML',false,`<img src="${e.target.result}" style="max-width:100%;border-radius:8px;margin:8px 0">`)};r.readAsDataURL(f);i.value=''};

window.openProfileModal=async()=>{if(!user)return;document.getElementById('profileNameInput').value=userData.name||'';document.getElementById('profileEmailInput').value=user.email||'';document.getElementById('profileBioInput').value=userData.bio||'';document.getElementById('profileNameDisplay').textContent=userData.name||'';const rb=document.getElementById('profileRoleBadge');rb.textContent=userData.role||'member';rb.className=`profile-role-badge ${userData.role||'member'}`;document.getElementById('profileAvatarBig').innerHTML=userData.avatar?`<img src="${userData.avatar}">`:getInitials(userData.name);document.getElementById('profileTopicsCount').textContent=topics.filter(t=>t.authorId===user.uid).length;let pc=0,lc=0;try{const ps=await getDocs(query(collection(db,"forum_posts"),where("authorId","==",user.uid)));pc=ps.size;ps.forEach(d=>lc+=(d.data().likes?.length||0))}catch{}document.getElementById('profilePostsCount').textContent=pc;document.getElementById('profileLikesCount').textContent=lc;document.getElementById('profileModal').classList.add('active')};
window.closeProfileModal=()=>document.getElementById('profileModal').classList.remove('active');
window.uploadAvatar=i=>{if(!i.files?.[0])return;const f=i.files[0];if(f.size>2e6){notify('>2MB','error');i.value='';return}const r=new FileReader();r.onload=e=>{userData.avatar=e.target.result;document.getElementById('profileAvatarBig').innerHTML=`<img src="${e.target.result}">`;updateUserAvatars()};r.readAsDataURL(f);i.value=''};
window.saveProfile=async()=>{const n=document.getElementById('profileNameInput').value.trim(),b=document.getElementById('profileBioInput').value.trim();if(!n||n.length<2)return notify("–Ü–º'—è",'error');try{await updateDoc(doc(db,"users",user.uid),{name:n,bio:b,avatar:userData.avatar||null});userData.name=n;userData.bio=b;document.getElementById('userNameNav').textContent=n;document.getElementById('profileNameDisplay').textContent=n;updateUserAvatars();notify('–ó–±–µ—Ä–µ–∂–µ–Ω–æ!');closeProfileModal()}catch(e){notify(e.message,'error')}};

document.addEventListener('click',e=>{if(!e.target.closest('.dropdown'))document.querySelectorAll('.dropdown-menu').forEach(m=>m.classList.remove('open'))});
document.querySelectorAll('.modal-overlay').forEach(o=>{o.addEventListener('mousedown',e=>modalMouseDownTarget=e.target);o.addEventListener('mouseup',e=>{if(e.target===o&&modalMouseDownTarget===o)o.classList.remove('active');modalMouseDownTarget=null})});
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal-overlay.active').forEach(m=>m.classList.remove('active'))});
</script>
</body>
</html>
