<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–î–®–í | –§–û–†–£–ú</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{--p:#22c55e;--p-g:rgba(34,197,94,0.4);--p-d:#16a34a;--p-l:rgba(34,197,94,0.1);--a:#f97316;--bg:#0a0a0a;--bg-c:#141414;--bg-h:#1e1e1e;--bg-e:#1a1a1a;--b:#252525;--b-l:#333;--t:#e5e5e5;--t-s:#888;--t-m:#555;--d:#ef4444;--w:#eab308;--i:#3b82f6}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--t);font-family:'Inter',sans-serif;font-size:14px;line-height:1.5;min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
.main-nav{background:linear-gradient(180deg,var(--bg-c) 0%,var(--bg) 100%);border-bottom:1px solid var(--b);padding:0 20px;position:sticky;top:0;z-index:100}
.nav-container{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:60px}
.nav-brand{display:flex;align-items:center;gap:12px;text-decoration:none}
.nav-logo{width:40px;height:40px;background:linear-gradient(135deg,var(--p),var(--p-d));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:#000;box-shadow:0 0 30px rgba(34,197,94,0.2)}
.nav-title{font-size:18px;font-weight:800;color:var(--t);letter-spacing:1px}.nav-title span{color:var(--p)}
.nav-links{display:flex;align-items:center;gap:5px;background:var(--bg-h);padding:5px;border-radius:12px;border:1px solid var(--b)}
.nav-link{display:flex;align-items:center;gap:8px;padding:10px 16px;color:var(--t-s);text-decoration:none;font-size:13px;font-weight:500;border-radius:8px;transition:.2s}
.nav-link:hover{color:var(--t);background:var(--bg-e)}.nav-link.active{color:var(--p);background:var(--p-l)}
.user-profile-btn{display:flex;align-items:center;gap:10px;padding:6px 12px 6px 6px;background:var(--bg-h);border:1px solid var(--b);border-radius:30px;cursor:pointer;transition:.2s}
.user-profile-btn:hover{background:var(--bg-e);border-color:var(--p)}
.user-avatar-nav{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--a));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#000;overflow:hidden}
.user-avatar-nav img{width:100%;height:100%;object-fit:cover}
.user-info-nav{display:flex;flex-direction:column;align-items:flex-start}
.user-name-nav{font-size:12px;font-weight:600;color:var(--t)}.user-role-nav{font-size:10px;color:var(--p);text-transform:uppercase;font-weight:600}
.breadcrumb-bar{background:var(--bg-c);border-bottom:1px solid var(--b);padding:12px 20px;display:none}
.breadcrumb-bar.show{display:block}
.breadcrumb-container{max-width:1400px;margin:0 auto;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.breadcrumb-link{color:var(--t-s);text-decoration:none;padding:5px 12px;background:var(--bg-h);border-radius:6px;transition:.2s;display:flex;align-items:center;gap:6px;font-size:13px}
.breadcrumb-link:hover{background:var(--bg-e);color:var(--p)}.breadcrumb-sep{color:var(--t-m);font-size:12px}.breadcrumb-cur{color:var(--t);font-weight:500;font-size:13px}
.container{max-width:1200px;margin:0 auto;padding:25px 20px}
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:25px;gap:20px;flex-wrap:wrap}
.page-title-section{display:flex;align-items:center;gap:15px}
.page-icon{width:50px;height:50px;background:linear-gradient(135deg,var(--p),var(--p-d));border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 0 30px rgba(34,197,94,0.2)}
.page-title-text h1{font-size:24px;font-weight:700;margin-bottom:2px}.page-title-text p{font-size:13px;color:var(--t-s)}
.page-actions{display:flex;gap:10px;align-items:center}
.btn{padding:10px 20px;border-radius:10px;border:none;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;transition:.25s;white-space:nowrap}
.btn-primary{background:linear-gradient(135deg,var(--p),var(--p-d));color:#000;box-shadow:0 4px 15px rgba(34,197,94,0.3)}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(34,197,94,0.4)}
.btn-secondary{background:var(--bg-h);color:var(--t);border:1px solid var(--b)}.btn-secondary:hover{background:var(--bg-e);border-color:var(--p)}
.btn-icon{width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;background:var(--bg-h);border:1px solid var(--b);border-radius:10px;color:var(--t-s);cursor:pointer;font-size:16px;transition:.2s}
.btn-icon:hover{background:var(--bg-e);color:var(--p);border-color:var(--p)}.btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
.search-box{position:relative;max-width:280px;flex:1}
.search-box input{width:100%;padding:10px 15px 10px 42px;background:var(--bg-h);border:1px solid var(--b);border-radius:10px;color:var(--t);font-size:13px;outline:none;transition:.2s}
.search-box input:focus{border-color:var(--p);box-shadow:0 0 0 3px rgba(34,197,94,0.1)}
.search-box::before{content:'üîç';position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:14px;opacity:.5}
.categories-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:15px}
.category-card{background:var(--bg-c);border:1px solid var(--b);border-radius:16px;padding:20px;cursor:pointer;transition:.3s;position:relative;overflow:hidden}
.category-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(135deg,var(--p),var(--p-d));opacity:0;transition:.3s}
.category-card:hover{transform:translateY(-4px);border-color:var(--p);box-shadow:0 8px 40px rgba(0,0,0,0.5),0 0 30px rgba(34,197,94,0.2)}.category-card:hover::before{opacity:1}
.category-header{display:flex;align-items:center;gap:15px;margin-bottom:12px}
.category-icon{width:48px;height:48px;background:var(--bg-h);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;transition:.3s}
.category-card:hover .category-icon{background:var(--p-l);transform:scale(1.1)}
.category-info{flex:1;min-width:0}.category-name{font-weight:700;font-size:16px;margin-bottom:4px}.category-desc{font-size:12px;color:var(--t-s)}
.category-stats-row{display:flex;gap:20px;padding-top:15px;border-top:1px solid var(--b)}
.category-stat{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--t-s)}.category-stat-value{font-weight:700;color:var(--t)}
.topics-container{background:var(--bg-c);border:1px solid var(--b);border-radius:16px;overflow:hidden}
.topics-header{display:grid;grid-template-columns:1fr 100px 140px;padding:15px 20px;background:linear-gradient(180deg,var(--bg-h) 0%,var(--bg-c) 100%);border-bottom:1px solid var(--b);font-size:11px;font-weight:700;text-transform:uppercase;color:var(--t-s);letter-spacing:.5px}
.topic-row{display:grid;grid-template-columns:1fr 100px 140px;padding:16px 20px;border-bottom:1px solid var(--b);align-items:center;transition:.2s;cursor:pointer}
.topic-row:last-child{border-bottom:none}.topic-row:hover{background:var(--bg-h)}
.topic-main{display:flex;align-items:flex-start;gap:12px;min-width:0}
.topic-status-indicator{width:10px;height:10px;border-radius:50%;margin-top:6px;flex-shrink:0;box-shadow:0 0 10px currentColor}
.topic-status-indicator.open{background:var(--p);color:var(--p)}.topic-status-indicator.closed{background:var(--d);color:var(--d)}.topic-status-indicator.pinned{background:var(--w);color:var(--w)}
.topic-content-wrap{min-width:0;flex:1}.topic-badges{display:flex;gap:6px;margin-bottom:6px;flex-wrap:wrap}
.badge{font-size:10px;padding:3px 8px;border-radius:5px;font-weight:600;text-transform:uppercase}
.badge-pinned{background:rgba(234,179,8,0.15);color:var(--w)}.badge-guide{background:rgba(59,130,246,0.15);color:var(--i)}.badge-closed{background:rgba(239,68,68,0.15);color:var(--d)}.badge-locked{background:rgba(100,100,100,0.15);color:#888}
.topic-title{font-weight:600;font-size:14px;margin-bottom:5px;transition:.2s}.topic-row:hover .topic-title{color:var(--p)}
.topic-meta{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--t-s)}
.topic-author-mini{display:flex;align-items:center;gap:6px}
.topic-author-avatar{width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--a));display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:#000}
.topic-cell{text-align:center;font-size:13px;color:var(--t-s)}.topic-cell-count{font-weight:700;color:var(--t);font-size:15px}
.topic-date-cell{text-align:right;font-size:12px;color:var(--t-s)}
.topic-view{display:none}.topic-view.active{display:block}
.topic-hero{background:linear-gradient(180deg,var(--bg-c) 0%,var(--bg) 100%);border:1px solid var(--b);border-radius:20px;padding:30px;margin-bottom:20px;position:relative;overflow:hidden}
.topic-hero::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(135deg,var(--p),var(--p-d))}
.topic-hero-badges{display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap}
.topic-hero-title{font-size:28px;font-weight:800;margin-bottom:15px;line-height:1.3}
.topic-hero-meta{display:flex;align-items:center;gap:20px;flex-wrap:wrap}
.topic-meta-item{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--t-s)}.topic-meta-item span{color:var(--t)}
.topic-author-card{display:flex;align-items:center;gap:10px;padding:8px 15px 8px 8px;background:var(--bg-h);border-radius:30px}
.topic-author-avatar-big{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--a));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#000;overflow:hidden}
.topic-author-avatar-big img{width:100%;height:100%;object-fit:cover}
.topic-admin-panel{display:none;margin-top:20px;padding-top:20px;border-top:1px solid var(--b)}.topic-admin-panel.show{display:block}
.admin-controls{display:flex;gap:10px;flex-wrap:wrap}
.posts-section{margin-bottom:25px}.posts-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:15px}
.posts-section-title{font-size:16px;font-weight:700;display:flex;align-items:center;gap:10px}
.posts-count{background:var(--p-l);color:var(--p);padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
.posts-list{display:flex;flex-direction:column;gap:15px}
.post-card{background:var(--bg-c);border:1px solid var(--b);border-radius:16px;overflow:hidden;transition:.2s}.post-card:hover{border-color:#333}
.post-card.original{border-color:var(--p);box-shadow:0 0 30px rgba(34,197,94,0.1)}
.post-card.original::before{content:'–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –ø–æ—Å—Ç';display:block;padding:8px 15px;background:var(--p-l);color:var(--p);font-size:11px;font-weight:600;text-transform:uppercase}
.post-header{display:flex;align-items:center;gap:12px;padding:15px 20px;background:linear-gradient(180deg,rgba(255,255,255,0.02) 0%,transparent 100%);border-bottom:1px solid var(--b)}
.post-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--a));display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#000;overflow:hidden}
.post-avatar img{width:100%;height:100%;object-fit:cover}
.post-author-info{flex:1;min-width:0}.post-author-top{display:flex;align-items:center;gap:10px;margin-bottom:3px}
.post-author-name{font-weight:600;font-size:14px}
.post-author-role{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600;text-transform:uppercase}
.post-author-role.admin{background:rgba(239,68,68,0.15);color:var(--d)}.post-author-role.instructor{background:rgba(249,115,22,0.15);color:var(--a)}.post-author-role.member{background:rgba(59,130,246,0.15);color:var(--i)}
.post-num{font-size:11px;color:var(--t-m)}.post-date{font-size:12px;color:var(--t-s);text-align:right}
.post-content{padding:20px;font-size:14px;line-height:1.8}
.post-content img{max-width:100%;border-radius:10px;margin:12px 0}.post-content a{color:var(--p)}
.post-content blockquote{border-left:4px solid var(--p);padding:15px 20px;margin:15px 0;background:rgba(34,197,94,0.05);border-radius:0 10px 10px 0}
.post-footer{display:flex;gap:10px;padding:12px 20px;background:rgba(0,0,0,0.2);border-top:1px solid var(--b)}
.post-action-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--bg-h);border:1px solid var(--b);border-radius:8px;font-size:12px;color:var(--t-s);cursor:pointer;transition:.2s}
.post-action-btn:hover{background:var(--bg-e);color:var(--t)}.post-action-btn.liked{background:var(--p-l);border-color:var(--p);color:var(--p)}
.reply-section{background:var(--bg-c);border:1px solid var(--b);border-radius:16px;overflow:hidden}.reply-section.disabled{opacity:.5;pointer-events:none}
.reply-header{display:flex;align-items:center;justify-content:space-between;padding:15px 20px;background:linear-gradient(180deg,var(--bg-h) 0%,var(--bg-c) 100%);border-bottom:1px solid var(--b)}
.reply-title{font-weight:600;font-size:14px;display:flex;align-items:center;gap:10px}
.editor-toolbar{display:flex;flex-wrap:wrap;gap:4px;padding:10px 15px;background:rgba(0,0,0,0.3);border-bottom:1px solid var(--b)}
.toolbar-group{display:flex;gap:3px}.toolbar-divider{width:1px;background:var(--b);margin:0 8px}
.toolbar-btn{width:32px;height:32px;border:none;background:var(--bg-h);color:var(--t-s);cursor:pointer;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;transition:.15s}
.toolbar-btn:hover{background:var(--bg-e);color:var(--t)}.toolbar-btn.active{background:var(--p);color:#000}
.toolbar-select{height:32px;padding:0 10px;background:var(--bg-h);border:1px solid var(--b);border-radius:6px;color:var(--t);font-size:12px;cursor:pointer}
.toolbar-color{width:32px;height:32px;padding:4px;background:var(--bg-h);border:1px solid var(--b);border-radius:6px;cursor:pointer}
.editor-content{min-height:150px;max-height:350px;overflow-y:auto;padding:15px 20px;outline:none;font-size:14px;line-height:1.7}
.editor-content:empty::before{content:attr(data-placeholder);color:var(--t-m)}
.editor-footer{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;background:rgba(0,0,0,0.2);border-top:1px solid var(--b);gap:15px;flex-wrap:wrap}
.attach-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--bg-h);border:1px dashed var(--b);border-radius:8px;color:var(--t-s);font-size:12px;cursor:pointer;transition:.2s}
.attach-btn:hover{border-color:var(--p);color:var(--p)}.attach-btn input{display:none}
.profile-header{text-align:center;padding-bottom:20px;border-bottom:1px solid var(--b);margin-bottom:20px}
.profile-avatar-container{position:relative;width:100px;height:100px;margin:0 auto 15px}
.profile-avatar-big{width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--a));display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:700;color:#000;overflow:hidden;border:3px solid var(--b)}
.profile-avatar-big img{width:100%;height:100%;object-fit:cover}
.profile-avatar-edit{position:absolute;bottom:0;right:0;width:32px;height:32px;background:var(--p);border:2px solid var(--bg-c);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:.2s}
.profile-avatar-edit:hover{transform:scale(1.1)}.profile-avatar-edit input{display:none}
.profile-name-display{font-size:22px;font-weight:700;margin-bottom:5px}
.profile-role-badge{display:inline-block;padding:5px 15px;border-radius:20px;font-size:12px;font-weight:600;text-transform:uppercase}
.profile-role-badge.admin{background:rgba(239,68,68,0.15);color:var(--d)}.profile-role-badge.instructor{background:rgba(249,115,22,0.15);color:var(--a)}.profile-role-badge.member{background:rgba(59,130,246,0.15);color:var(--i)}
.profile-stats{display:flex;justify-content:center;gap:30px;margin-top:20px}
.profile-stat{text-align:center}.profile-stat-value{font-size:24px;font-weight:800;color:var(--p)}.profile-stat-label{font-size:11px;color:var(--t-s);text-transform:uppercase}
.profile-form{display:flex;flex-direction:column;gap:15px}
.empty-state{text-align:center;padding:60px 20px;color:var(--t-s)}.empty-icon{font-size:50px;margin-bottom:20px;opacity:.3}
.empty-title{font-size:18px;font-weight:700;color:var(--t);margin-bottom:10px}.empty-text{font-size:13px;margin-bottom:25px;max-width:300px;margin-left:auto;margin-right:auto}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(5px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.active{display:flex}
.modal{background:var(--bg-c);border:1px solid var(--b);border-radius:20px;width:100%;max-width:500px;max-height:90vh;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,0.5)}.modal.large{max-width:800px}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 25px;border-bottom:1px solid var(--b);background:linear-gradient(180deg,var(--bg-h) 0%,var(--bg-c) 100%)}
.modal-title{font-size:18px;font-weight:700;display:flex;align-items:center;gap:10px}
.modal-close{width:36px;height:36px;background:var(--bg-h);border:1px solid var(--b);border-radius:10px;color:var(--t-s);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s}
.modal-close:hover{background:var(--d);border-color:var(--d);color:#fff}
.modal-body{padding:25px;overflow-y:auto;max-height:calc(90vh - 150px)}
.modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:20px 25px;border-top:1px solid var(--b);background:rgba(0,0,0,0.2)}
.form-group{margin-bottom:18px}.form-label{display:block;font-size:12px;font-weight:600;color:var(--t-s);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.form-input,.form-select,.form-textarea{width:100%;padding:12px 15px;background:var(--bg-h);border:1px solid var(--b);border-radius:10px;color:var(--t);font-size:14px;outline:none;transition:.2s}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--p);box-shadow:0 0 0 3px rgba(34,197,94,0.1)}
.form-textarea{min-height:100px;resize:vertical;font-family:inherit}
.form-check{display:flex;align-items:center;gap:12px;padding:12px 15px;background:var(--bg-h);border-radius:10px;cursor:pointer;font-size:14px;transition:.2s}
.form-check:hover{background:var(--bg-e)}.form-check input{accent-color:var(--p);width:18px;height:18px}
.emoji-grid{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
.emoji-btn{width:36px;height:36px;border:none;background:var(--bg-h);border-radius:8px;font-size:16px;cursor:pointer;transition:.15s}.emoji-btn:hover{background:var(--bg-e);transform:scale(1.15)}
.dropdown{position:relative}.dropdown-menu{position:absolute;top:calc(100% + 5px);right:0;background:var(--bg-c);border:1px solid var(--b);border-radius:12px;min-width:180px;padding:8px;z-index:50;display:none;box-shadow:0 8px 40px rgba(0,0,0,0.5)}
.dropdown-menu.open{display:block}
.dropdown-item{display:flex;align-items:center;gap:10px;padding:10px 14px;font-size:13px;color:var(--t-s);cursor:pointer;border-radius:8px;transition:.15s}
.dropdown-item:hover{background:var(--bg-h);color:var(--t)}.dropdown-item.danger:hover{background:rgba(239,68,68,0.15);color:var(--d)}
.toast-container{position:fixed;bottom:20px;right:20px;z-index:300;display:flex;flex-direction:column;gap:10px}
.toast{background:var(--bg-c);border:1px solid var(--b);border-left:4px solid var(--p);padding:15px 20px;border-radius:12px;font-size:14px;box-shadow:0 8px 40px rgba(0,0,0,0.5);animation:toastIn .3s;display:flex;align-items:center;gap:10px}
.toast.error{border-left-color:var(--d)}.toast-icon{font-size:18px}
@keyframes toastIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-c);border-top:1px solid var(--b);padding:8px 15px;z-index:100}
.mobile-nav-items{display:flex;justify-content:space-around;align-items:center}
.mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 12px;color:var(--t-s);text-decoration:none;font-size:10px;border-radius:10px;transition:.2s}
.mobile-nav-item:hover,.mobile-nav-item.active{color:var(--p);background:var(--p-l)}.mobile-nav-item .icon{font-size:20px}
@media(max-width:900px){.nav-links{display:none}.categories-grid{grid-template-columns:1fr}}
@media(max-width:768px){.container{padding:15px}.topics-header{display:none}.topic-row{grid-template-columns:1fr;gap:10px}.topic-cell,.topic-date-cell{display:none}.page-header{flex-direction:column;align-items:stretch}.search-box{max-width:none;width:100%;order:-1}.user-info-nav{display:none}.topic-hero{padding:20px}.topic-hero-title{font-size:20px}.mobile-nav{display:block}body{padding-bottom:70px}.toolbar-divider{display:none}}
@media(max-width:480px){.main-nav{padding:0 12px}.nav-container{height:55px}.nav-logo{width:35px;height:35px;font-size:16px}.nav-title{font-size:15px}.page-title-text h1{font-size:18px}.page-icon{width:40px;height:40px;font-size:18px}.btn{padding:10px 16px;font-size:12px}.category-card{padding:15px}.category-icon{width:40px;height:40px;font-size:18px}.toolbar-btn{width:28px;height:28px;font-size:11px}}
</style>
</head>
<body>
<div class="toast-container" id="toastContainer"></div>

<nav class="main-nav">
<div class="nav-container">
<a href="cabinet.html" class="nav-brand"><div class="nav-logo">–î</div><div class="nav-title">–î–®–í <span>–§–û–†–£–ú</span></div></a>
<div class="nav-links">
<a href="cabinet.html" class="nav-link"><span>üè†</span><span>–ì–æ–ª–æ–≤–Ω–∞</span></a>
<a href="forym.html" class="nav-link active"><span>üí¨</span><span>–§–æ—Ä—É–º</span></a>
<a href="#" class="nav-link" onclick="showCategories();return false;"><span>üìÇ</span><span>–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</span></a>
</div>
<div class="nav-right">
<button class="user-profile-btn" onclick="openProfileModal()">
<div class="user-avatar-nav" id="userAvatarNav">?</div>
<div class="user-info-nav"><div class="user-name-nav" id="userNameNav">...</div><div class="user-role-nav" id="userRoleNav">‚Äî</div></div>
</button>
</div>
</div>
</nav>

<nav class="mobile-nav">
<div class="mobile-nav-items">
<a href="cabinet.html" class="mobile-nav-item"><span class="icon">üè†</span><span>–ì–æ–ª–æ–≤–Ω–∞</span></a>
<a href="#" class="mobile-nav-item active" onclick="showCategories();return false;"><span class="icon">üìÇ</span><span>–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</span></a>
<a href="forym.html" class="mobile-nav-item"><span class="icon">üí¨</span><span>–§–æ—Ä—É–º</span></a>
<a href="#" class="mobile-nav-item" onclick="openProfileModal();return false;"><span class="icon">üë§</span><span>–ü—Ä–æ—Ñ—ñ–ª—å</span></a>
</div>
</nav>

<div class="breadcrumb-bar" id="breadcrumbBar"><div class="breadcrumb-container" id="breadcrumbContent"></div></div>

<div class="container">
<div id="categoriesView">
<div class="page-header">
<div class="page-title-section"><div class="page-icon">üìÇ</div><div class="page-title-text"><h1>–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó —Ñ–æ—Ä—É–º—É</h1><p>–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Ç–µ–º</p></div></div>
<div class="page-actions">
<div class="search-box"><input type="text" placeholder="–ü–æ—à—É–∫ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π..." id="searchCategories" oninput="filterCategories()"></div>
<button class="btn-icon" id="addCategoryBtn" style="display:none" onclick="openCategoryModal()" title="–î–æ–¥–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é">‚ûï</button>
</div>
</div>
<div class="categories-grid" id="categoriesList"><div class="empty-state"><div class="empty-icon">‚è≥</div><div class="empty-title">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div></div>
</div>

<div id="topicsView" style="display:none">
<div class="page-header">
<div class="page-title-section"><div class="page-icon" id="currentCategoryIconBig">üìÅ</div><div class="page-title-text"><h1 id="currentCategoryTitleBig">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</h1><p id="currentCategoryDescBig">–¢–µ–º–∏ —Ü—ñ—î—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</p></div></div>
<div class="page-actions">
<div class="search-box"><input type="text" placeholder="–ü–æ—à—É–∫ —Ç–µ–º..." id="searchTopics" oninput="filterTopics()"></div>
<button class="btn btn-primary" onclick="openTopicModal()">‚ûï –ù–æ–≤–∞ —Ç–µ–º–∞</button>
<div class="dropdown" id="categorySettings" style="display:none">
<button class="btn-icon" onclick="toggleCategoryMenu()">‚öôÔ∏è</button>
<div class="dropdown-menu" id="categoryMenu">
<div class="dropdown-item" onclick="editCategory()">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</div>
<div class="dropdown-item danger" onclick="deleteCategory()">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</div>
</div>
</div>
</div>
</div>
<div class="topics-container" id="topicsTable">
<div class="topics-header"><div>–¢–µ–º–∞</div><div style="text-align:center">–í—ñ–¥–ø–æ–≤—ñ–¥—ñ</div><div style="text-align:right">–û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</div></div>
<div id="topicsList"></div>
</div>
</div>

<div id="topicView" class="topic-view">
<div class="topic-hero">
<div class="topic-hero-badges" id="topicBadges"></div>
<h1 class="topic-hero-title" id="topicTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–º–∏</h1>
<div class="topic-hero-meta" id="topicMeta"></div>
<div class="topic-admin-panel" id="topicAdminPanel">
<div class="admin-controls">
<button class="btn btn-secondary" id="btnPin" onclick="togglePin()">üìå –ó–∞–∫—Ä—ñ–ø–∏—Ç–∏</button>
<button class="btn btn-secondary" id="btnClose" onclick="toggleClose()">üîí –ó–∞–∫—Ä–∏—Ç–∏</button>
<button class="btn btn-secondary" id="btnLock" onclick="toggleLock()">üîá –ë–ª–æ–∫—É–≤–∞—Ç–∏</button>
<button class="btn btn-secondary" onclick="editTopic()">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
<button class="btn btn-danger" onclick="deleteTopic()">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
</div>
</div>
</div>
<div class="posts-section">
<div class="posts-section-header"><div class="posts-section-title">üí¨ –û–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è <span class="posts-count" id="postsCount">0</span></div></div>
<div class="posts-list" id="postsList"></div>
</div>
<div class="reply-section" id="replySection">
<div class="reply-header"><div class="reply-title"><span>‚úçÔ∏è</span><span id="replyTitleText">–ù–∞–ø–∏—Å–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</span></div></div>
<div class="editor">
<div class="editor-toolbar">
<div class="toolbar-group">
<button class="toolbar-btn" onclick="execCmd('bold')"><b>B</b></button>
<button class="toolbar-btn" onclick="execCmd('italic')"><i>I</i></button>
<button class="toolbar-btn" onclick="execCmd('underline')"><u>U</u></button>
<button class="toolbar-btn" onclick="execCmd('strikeThrough')"><s>S</s></button>
</div>
<div class="toolbar-divider"></div>
<select class="toolbar-select" onchange="applyFont(this.value)"><option value="Inter">Inter</option><option value="Roboto">Roboto</option><option value="Montserrat">Montserrat</option></select>
<select class="toolbar-select" onchange="applySize(this.value)"><option value="2">–ú–∞–ª–∏–π</option><option value="3" selected>–ù–æ—Ä–º</option><option value="4">–°–µ—Ä–µ–¥–Ω—ñ–π</option><option value="5">–í–µ–ª–∏–∫–∏–π</option></select>
<input type="color" class="toolbar-color" value="#ffffff" onchange="applyColor(this.value)">
<div class="toolbar-divider"></div>
<div class="toolbar-group">
<button class="toolbar-btn" onclick="execCmd('justifyLeft')">‚¨Ö</button>
<button class="toolbar-btn" onclick="execCmd('justifyCenter')">‚Üî</button>
<button class="toolbar-btn" onclick="execCmd('justifyRight')">‚û°</button>
</div>
<div class="toolbar-divider"></div>
<div class="toolbar-group">
<button class="toolbar-btn" onclick="execCmd('insertUnorderedList')">‚Ä¢</button>
<button class="toolbar-btn" onclick="execCmd('insertOrderedList')">1.</button>
<button class="toolbar-btn" onclick="insertQuote()">‚ùù</button>
<button class="toolbar-btn" onclick="openLinkModal()">üîó</button>
</div>
</div>
<div class="editor-content" id="replyEditor" contenteditable="true" data-placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –≤–∞—à—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Ç—É—Ç..."></div>
<div class="editor-footer">
<label class="attach-btn">üì∑ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ<input type="file" accept="image/*" onchange="insertImage(this)"></label>
<button class="btn btn-primary" onclick="submitReply()">üì§ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
</div>
</div>
</div>
</div>
</div>

<div class="modal-overlay" id="categoryModal">
<div class="modal">
<div class="modal-header"><h3 class="modal-title"><span>üìÅ</span><span id="categoryModalTitle">–ù–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è</span></h3><button class="modal-close" onclick="closeCategoryModal()">‚úï</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label><input type="text" class="form-input" id="catName" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É"></div>
<div class="form-group"><label class="form-label">–Ü–∫–æ–Ω–∫–∞</label><input type="text" class="form-input" id="catIcon" placeholder="üìÅ" maxlength="2" style="width:80px">
<div class="emoji-grid"><button class="emoji-btn" onclick="pickEmoji('üìö')">üìö</button><button class="emoji-btn" onclick="pickEmoji('üì¢')">üì¢</button><button class="emoji-btn" onclick="pickEmoji('üí°')">üí°</button><button class="emoji-btn" onclick="pickEmoji('üéÆ')">üéÆ</button><button class="emoji-btn" onclick="pickEmoji('‚öîÔ∏è')">‚öîÔ∏è</button><button class="emoji-btn" onclick="pickEmoji('üèÜ')">üèÜ</button><button class="emoji-btn" onclick="pickEmoji('‚ùì')">‚ùì</button><button class="emoji-btn" onclick="pickEmoji('üìù')">üìù</button><button class="emoji-btn" onclick="pickEmoji('üîß')">üîß</button><button class="emoji-btn" onclick="pickEmoji('üéØ')">üéØ</button><button class="emoji-btn" onclick="pickEmoji('üî•')">üî•</button><button class="emoji-btn" onclick="pickEmoji('‚≠ê')">‚≠ê</button></div>
</div>
<div class="form-group"><label class="form-label">–û–ø–∏—Å</label><input type="text" class="form-input" id="catDesc" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó"></div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeCategoryModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button class="btn btn-primary" onclick="saveCategory()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button></div>
</div>
</div>

<div class="modal-overlay" id="topicModal">
<div class="modal large">
<div class="modal-header"><h3 class="modal-title"><span>üìù</span><span id="topicModalTitle">–ù–æ–≤–∞ —Ç–µ–º–∞</span></h3><button class="modal-close" onclick="closeTopicModal()">‚úï</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–º–∏</label><input type="text" class="form-input" id="newTopicTitle" placeholder="–í–≤–µ–¥—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫"></div>
<div class="form-group"><label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label><select class="form-select" id="newTopicCategory"></select></div>
<div class="form-group"><label class="form-label">–í–º—ñ—Å—Ç</label>
<div style="border:1px solid var(--b);border-radius:12px;overflow:hidden">
<div class="editor-toolbar">
<button class="toolbar-btn" onclick="execCmdModal('bold')"><b>B</b></button>
<button class="toolbar-btn" onclick="execCmdModal('italic')"><i>I</i></button>
<button class="toolbar-btn" onclick="execCmdModal('underline')"><u>U</u></button>
<div class="toolbar-divider"></div>
<select class="toolbar-select" onchange="applyFontModal(this.value)"><option value="Inter">Inter</option><option value="Roboto">Roboto</option><option value="Montserrat">Montserrat</option></select>
<select class="toolbar-select" onchange="applySizeModal(this.value)"><option value="2">–ú–∞–ª–∏–π</option><option value="3" selected>–ù–æ—Ä–º</option><option value="4">–°–µ—Ä–µ–¥–Ω—ñ–π</option><option value="5">–í–µ–ª–∏–∫–∏–π</option></select>
<input type="color" class="toolbar-color" value="#ffffff" onchange="applyColorModal(this.value)">
<div class="toolbar-divider"></div>
<button class="toolbar-btn" onclick="insertQuoteModal()">‚ùù</button>
<button class="toolbar-btn" onclick="openLinkModalFor('modal')">üîó</button>
</div>
<div class="editor-content" id="newTopicEditor" contenteditable="true" data-placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –≤–º—ñ—Å—Ç —Ç–µ–º–∏..." style="min-height:180px"></div>
<div class="editor-footer"><label class="attach-btn">üì∑ –§–æ—Ç–æ<input type="file" accept="image/*" onchange="insertImageModal(this)"></label></div>
</div>
</div>
<div id="topicOptionsAdmin" style="display:none"><div style="display:flex;gap:12px;flex-wrap:wrap">
<label class="form-check" style="flex:1;min-width:150px"><input type="checkbox" id="newTopicPinned"><span>üìå –ó–∞–∫—Ä—ñ–ø–∏—Ç–∏</span></label>
<label class="form-check" style="flex:1;min-width:150px"><input type="checkbox" id="newTopicGuide"><span>üìò –ì–∞–π–¥</span></label>
</div></div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeTopicModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button class="btn btn-primary" onclick="saveTopic()">üì§ –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button></div>
</div>
</div>

<div class="modal-overlay" id="linkModal">
<div class="modal" style="max-width:420px">
<div class="modal-header"><h3 class="modal-title">üîó –í—Å—Ç–∞–≤–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</h3><button class="modal-close" onclick="closeLinkModal()">‚úï</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">URL</label><input type="url" class="form-input" id="linkUrl" placeholder="https://example.com"></div>
<div class="form-group"><label class="form-label">–¢–µ–∫—Å—Ç</label><input type="text" class="form-input" id="linkText" placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å–∏–ª–∞–Ω–Ω—è"></div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeLinkModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button class="btn btn-primary" onclick="insertLink()">üîó –í—Å—Ç–∞–≤–∏—Ç–∏</button></div>
</div>
</div>

<div class="modal-overlay" id="profileModal">
<div class="modal">
<div class="modal-header"><h3 class="modal-title">üë§ –ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</h3><button class="modal-close" onclick="closeProfileModal()">‚úï</button></div>
<div class="modal-body">
<div class="profile-header">
<div class="profile-avatar-container"><div class="profile-avatar-big" id="profileAvatarBig">?</div><label class="profile-avatar-edit">üì∑<input type="file" accept="image/*" onchange="uploadAvatar(this)"></label></div>
<div class="profile-name-display" id="profileNameDisplay">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</div>
<div class="profile-role-badge" id="profileRoleBadge">member</div>
<div class="profile-stats">
<div class="profile-stat"><div class="profile-stat-value" id="profileTopicsCount">0</div><div class="profile-stat-label">–¢–µ–º</div></div>
<div class="profile-stat"><div class="profile-stat-value" id="profilePostsCount">0</div><div class="profile-stat-label">–í—ñ–¥–ø–æ–≤—ñ–¥–µ–π</div></div>
<div class="profile-stat"><div class="profile-stat-value" id="profileLikesCount">0</div><div class="profile-stat-label">–õ–∞–π–∫—ñ–≤</div></div>
</div>
</div>
<div class="profile-form">
<div class="form-group"><label class="form-label">–Ü–º'—è / –ù—ñ–∫–Ω–µ–π–º</label><input type="text" class="form-input" id="profileNameInput" placeholder="–í–∞—à–µ —ñ–º'—è"></div>
<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="profileEmailInput" disabled></div>
<div class="form-group"><label class="form-label">–ü—Ä–æ —Å–µ–±–µ</label><textarea class="form-input form-textarea" id="profileBioInput" placeholder="–†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Å–µ–±–µ..."></textarea></div>
</div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeProfileModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button class="btn btn-primary" onclick="saveProfile()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button></div>
</div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import{getAuth,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import{getFirestore,doc,getDoc,updateDoc,collection,onSnapshot,query,orderBy,addDoc,serverTimestamp,getDocs,deleteDoc,where}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const app=initializeApp({apiKey:"AIzaSyATUpLUHSp1VbyxkJXhMS-2R71zNOBGC00",authDomain:"dsv-gta.firebaseapp.com",projectId:"dsv-gta",storageBucket:"dsv-gta.firebasestorage.app",messagingSenderId:"661591588818",appId:"1:661591588818:web:a8e8dca3d061447e24d20b"});
const auth=getAuth(app),db=getFirestore(app);
let user=null,userData=null,categories=[],topics=[],currentCategoryId=null,currentTopicId=null,currentTopicData=null,editingCategoryId=null,editingTopicId=null,linkTarget='reply',postsUnsubscribe=null;

const notify=(msg,type='success')=>{const icons={success:'‚úÖ',error:'‚ùå',warning:'‚ö†Ô∏è'};const t=document.createElement('div');t.className=`toast ${type}`;t.innerHTML=`<span class="toast-icon">${icons[type]||'üì¢'}</span><span>${msg}</span>`;document.getElementById('toastContainer').appendChild(t);setTimeout(()=>t.remove(),4000)};
const getInitials=n=>{if(!n)return'?';const p=n.trim().split(' ');return p.length>=2?(p[0][0]+p[1][0]).toUpperCase():n.substring(0,2).toUpperCase()};
const formatDate=ts=>{if(!ts)return'';const d=new Date(ts.seconds*1000),now=new Date(),diff=now-d;if(diff<60000)return'–©–æ–π–Ω–æ';if(diff<3600000)return`${Math.floor(diff/60000)} —Ö–≤ —Ç–æ–º—É`;if(diff<86400000)return`${Math.floor(diff/3600000)} –≥–æ–¥ —Ç–æ–º—É`;if(diff<604800000)return`${Math.floor(diff/86400000)} –¥–Ω —Ç–æ–º—É`;return d.toLocaleDateString('uk-UA',{day:'2-digit',month:'short',year:'numeric'})};
const formatDateShort=ts=>{if(!ts)return'';return new Date(ts.seconds*1000).toLocaleDateString('uk-UA',{day:'2-digit',month:'short'})};
const isAdmin=()=>userData&&userData.role==='admin';
const isInstructor=()=>userData&&userData.role==='instructor';
const updateUserAvatars=()=>{const av=userData?.avatar,ini=getInitials(userData?.name);document.querySelectorAll('#userAvatarNav,#profileAvatarBig').forEach(el=>{el.innerHTML=av?`<img src="${av}" alt="">`:ini})};
const updateBreadcrumb=items=>{const bar=document.getElementById('breadcrumbBar'),content=document.getElementById('breadcrumbContent');if(!items||!items.length){bar.classList.remove('show');return}bar.classList.add('show');content.innerHTML=items.map((item,i)=>i===items.length-1?`<span class="breadcrumb-cur">${item.label}</span>`:`<a href="#" class="breadcrumb-link" onclick="${item.action};return false;">${item.icon?`<span>${item.icon}</span>`:''}${item.label}</a><span class="breadcrumb-sep">‚Ä∫</span>`).join('')};

onAuthStateChanged(auth,async u=>{if(!u){window.location.href="index.html";return}user=u;const snap=await getDoc(doc(db,"users",u.uid));userData=snap.exists()?snap.data():{name:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',role:'member'};document.getElementById('userNameNav').textContent=userData.name;document.getElementById('userRoleNav').textContent=userData.role.toUpperCase();updateUserAvatars();if(isAdmin()){document.getElementById('addCategoryBtn').style.display='flex';document.getElementById('topicOptionsAdmin').style.display='block'}loadCategories();loadTopics()});

function loadCategories(){onSnapshot(collection(db,"forum_categories"),snap=>{categories=[];snap.forEach(d=>categories.push({id:d.id,...d.data()}));renderCategories();updateCategorySelect()})}
function renderCategories(){const search=document.getElementById('searchCategories')?.value.toLowerCase()||'';const filtered=categories.filter(c=>c.name.toLowerCase().includes(search));if(!filtered.length){document.getElementById('categoriesList').innerHTML=`<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üì≠</div><div class="empty-title">–ö–∞—Ç–µ–≥–æ—Ä—ñ–π —â–µ –Ω–µ–º–∞—î</div><div class="empty-text">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–∏–≤ –∂–æ–¥–Ω–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</div></div>`;return}document.getElementById('categoriesList').innerHTML=filtered.map(cat=>{const tc=topics.filter(t=>t.categoryId===cat.id).length,pc=topics.filter(t=>t.categoryId===cat.id).reduce((s,t)=>s+(t.repliesCount||0),0);return`<div class="category-card" onclick="openCategory('${cat.id}')"><div class="category-header"><div class="category-icon">${cat.icon||'üìÅ'}</div><div class="category-info"><div class="category-name">${cat.name}</div><div class="category-desc">${cat.description||'–ë–µ–∑ –æ–ø–∏—Å—É'}</div></div></div><div class="category-stats-row"><div class="category-stat"><span>üìù</span><span class="category-stat-value">${tc}</span><span>—Ç–µ–º</span></div><div class="category-stat"><span>üí¨</span><span class="category-stat-value">${pc}</span><span>–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</span></div></div></div>`}).join('')}
window.filterCategories=()=>renderCategories();

window.openCategory=id=>{currentCategoryId=id;const cat=categories.find(c=>c.id===id);if(!cat)return;document.getElementById('categoriesView').style.display='none';document.getElementById('topicsView').style.display='block';document.getElementById('topicView').classList.remove('active');document.getElementById('currentCategoryIconBig').textContent=cat.icon||'üìÅ';document.getElementById('currentCategoryTitleBig').textContent=cat.name;document.getElementById('currentCategoryDescBig').textContent=cat.description||'–¢–µ–º–∏ —Ü—ñ—î—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó';if(isAdmin())document.getElementById('categorySettings').style.display='block';updateBreadcrumb([{label:'–§–æ—Ä—É–º',icon:'üè†',action:'showCategories()'},{label:cat.name}]);renderTopics()};
window.showCategories=()=>{document.getElementById('categoriesView').style.display='block';document.getElementById('topicsView').style.display='none';document.getElementById('topicView').classList.remove('active');currentCategoryId=null;currentTopicId=null;updateBreadcrumb(null);if(postsUnsubscribe){postsUnsubscribe();postsUnsubscribe=null}};
window.backToTopics=()=>{document.getElementById('topicView').classList.remove('active');document.getElementById('topicsView').style.display='block';currentTopicId=null;const cat=categories.find(c=>c.id===currentCategoryId);if(cat)updateBreadcrumb([{label:'–§–æ—Ä—É–º',icon:'üè†',action:'showCategories()'},{label:cat.name}]);if(postsUnsubscribe){postsUnsubscribe();postsUnsubscribe=null}};
function updateCategorySelect(){const sel=document.getElementById('newTopicCategory');if(!sel)return;sel.innerHTML=categories.map(c=>`<option value="${c.id}">${c.icon||'üìÅ'} ${c.name}</option>`).join('');if(currentCategoryId)sel.value=currentCategoryId}
window.toggleCategoryMenu=()=>document.getElementById('categoryMenu').classList.toggle('open');
window.openCategoryModal=(editId=null)=>{editingCategoryId=editId;if(editId){const cat=categories.find(c=>c.id===editId);document.getElementById('catName').value=cat.name;document.getElementById('catIcon').value=cat.icon||'';document.getElementById('catDesc').value=cat.description||'';document.getElementById('categoryModalTitle').textContent='–†–µ–¥–∞–≥—É–≤–∞—Ç–∏'}else{document.getElementById('catName').value='';document.getElementById('catIcon').value='';document.getElementById('catDesc').value='';document.getElementById('categoryModalTitle').textContent='–ù–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è'}document.getElementById('categoryModal').classList.add('active')};
window.closeCategoryModal=()=>{document.getElementById('categoryModal').classList.remove('active');editingCategoryId=null};
window.pickEmoji=e=>document.getElementById('catIcon').value=e;
window.saveCategory=async()=>{const name=document.getElementById('catName').value.trim(),icon=document.getElementById('catIcon').value.trim()||'üìÅ',description=document.getElementById('catDesc').value.trim();if(!name)return notify('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É','error');try{if(editingCategoryId){await updateDoc(doc(db,"forum_categories",editingCategoryId),{name,icon,description});notify('–û–Ω–æ–≤–ª–µ–Ω–æ!')}else{await addDoc(collection(db,"forum_categories"),{name,icon,description,createdAt:serverTimestamp()});notify('–°—Ç–≤–æ—Ä–µ–Ω–æ!')}closeCategoryModal()}catch(e){notify(e.message,'error')}};
window.editCategory=()=>{document.getElementById('categoryMenu').classList.remove('open');openCategoryModal(currentCategoryId)};
window.deleteCategory=async()=>{if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –∑ —É—Å—ñ–º–∞ —Ç–µ–º–∞–º–∏?'))return;document.getElementById('categoryMenu').classList.remove('open');try{const toDelete=topics.filter(t=>t.categoryId===currentCategoryId);for(const t of toDelete){const posts=await getDocs(query(collection(db,"forum_posts"),where("topicId","==",t.id)));for(const p of posts.docs)await deleteDoc(doc(db,"forum_posts",p.id));await deleteDoc(doc(db,"forum_topics",t.id))}await deleteDoc(doc(db,"forum_categories",currentCategoryId));notify('–í–∏–¥–∞–ª–µ–Ω–æ!');showCategories()}catch(e){notify(e.message,'error')}};

function loadTopics(){onSnapshot(query(collection(db,"forum_topics"),orderBy("createdAt","desc")),snap=>{topics=[];snap.forEach(d=>topics.push({id:d.id,...d.data()}));topics.sort((a,b)=>(b.pinned?1:0)-(a.pinned?1:0));renderTopics();renderCategories()})}
function renderTopics(){if(!currentCategoryId)return;const search=document.getElementById('searchTopics')?.value.toLowerCase()||'';let filtered=topics.filter(t=>t.categoryId===currentCategoryId);if(search)filtered=filtered.filter(t=>t.title.toLowerCase().includes(search));if(!filtered.length){document.getElementById('topicsList').innerHTML=`<div class="empty-state"><div class="empty-icon">üìù</div><div class="empty-title">–¢–µ–º —â–µ –Ω–µ–º–∞—î</div><div class="empty-text">–ë—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º ‚Äî —Å—Ç–≤–æ—Ä—ñ—Ç—å —Ç–µ–º—É!</div><button class="btn btn-primary" onclick="openTopicModal()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–µ–º—É</button></div>`;return}document.getElementById('topicsList').innerHTML=filtered.map(t=>{let badges='';if(t.pinned)badges+='<span class="badge badge-pinned">üìå</span>';if(t.isGuide)badges+='<span class="badge badge-guide">üìò</span>';if(t.status==='closed')badges+='<span class="badge badge-closed">üîí</span>';if(t.locked)badges+='<span class="badge badge-locked">üîá</span>';return`<div class="topic-row" onclick="openTopic('${t.id}')"><div class="topic-main"><div class="topic-status-indicator ${t.pinned?'pinned':t.status==='closed'?'closed':'open'}"></div><div class="topic-content-wrap">${badges?`<div class="topic-badges">${badges}</div>`:''}<div class="topic-title">${t.title}</div><div class="topic-meta"><div class="topic-author-mini"><div class="topic-author-avatar">${getInitials(t.authorName)}</div><span>${t.authorName||'–ê–Ω–æ–Ω—ñ–º'}</span></div><span>‚Ä¢</span><span>${formatDateShort(t.createdAt)}</span></div></div></div><div class="topic-cell"><div class="topic-cell-count">${t.repliesCount||0}</div></div><div class="topic-date-cell">${formatDate(t.lastActivity||t.createdAt)}</div></div>`}).join('')}
window.filterTopics=()=>renderTopics();

window.openTopicModal=()=>{if(!categories.length)return notify('–°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é','error');document.getElementById('newTopicTitle').value='';document.getElementById('newTopicEditor').innerHTML='';document.getElementById('newTopicPinned').checked=false;document.getElementById('newTopicGuide').checked=false;document.getElementById('topicModalTitle').textContent='–ù–æ–≤–∞ —Ç–µ–º–∞';updateCategorySelect();editingTopicId=null;document.getElementById('topicModal').classList.add('active')};
window.closeTopicModal=()=>document.getElementById('topicModal').classList.remove('active');
window.saveTopic=async()=>{const title=document.getElementById('newTopicTitle').value.trim(),categoryId=document.getElementById('newTopicCategory').value,content=document.getElementById('newTopicEditor').innerHTML.trim(),pinned=document.getElementById('newTopicPinned').checked&&isAdmin(),isGuide=document.getElementById('newTopicGuide').checked&&isAdmin();if(!title)return notify('–í–≤–µ–¥—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫','error');if(!content||content==='<br>')return notify('–í–≤–µ–¥—ñ—Ç—å –≤–º—ñ—Å—Ç','error');const tempDiv=document.createElement('div');tempDiv.innerHTML=content;const preview=tempDiv.textContent.substring(0,150);try{if(editingTopicId){await updateDoc(doc(db,"forum_topics",editingTopicId),{title,categoryId,content,preview,pinned,isGuide,updatedAt:serverTimestamp()});const posts=await getDocs(query(collection(db,"forum_posts"),where("topicId","==",editingTopicId),where("isOriginal","==",true)));if(!posts.empty)await updateDoc(doc(db,"forum_posts",posts.docs[0].id),{content});notify('–û–Ω–æ–≤–ª–µ–Ω–æ!');closeTopicModal();openTopic(editingTopicId)}else{const ref=await addDoc(collection(db,"forum_topics"),{title,categoryId,content,preview,pinned,isGuide,status:'open',locked:false,authorId:user.uid,authorName:userData.name,authorRole:userData.role,authorAvatar:userData.avatar||null,repliesCount:0,createdAt:serverTimestamp(),lastActivity:serverTimestamp()});await addDoc(collection(db,"forum_posts"),{topicId:ref.id,content,isOriginal:true,authorId:user.uid,authorName:userData.name,authorRole:userData.role,authorAvatar:userData.avatar||null,likes:[],createdAt:serverTimestamp()});notify('–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!');closeTopicModal();setTimeout(()=>openTopic(ref.id),300)}}catch(e){notify(e.message,'error')}};

window.openTopic=async id=>{currentTopicId=id;const snap=await getDoc(doc(db,"forum_topics",id));if(!snap.exists())return notify('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ','error');currentTopicData={id,...snap.data()};document.getElementById('topicsView').style.display='none';document.getElementById('topicView').classList.add('active');document.getElementById('topicTitle').textContent=currentTopicData.title;let badges='';if(currentTopicData.pinned)badges+='<span class="badge badge-pinned">üìå –ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ</span>';if(currentTopicData.isGuide)badges+='<span class="badge badge-guide">üìò –ì–∞–π–¥</span>';if(currentTopicData.status==='closed')badges+='<span class="badge badge-closed">üîí –ó–∞–∫—Ä–∏—Ç–æ</span>';if(currentTopicData.locked)badges+='<span class="badge badge-locked">üîá –ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ</span>';document.getElementById('topicBadges').innerHTML=badges;const cat=categories.find(c=>c.id===currentTopicData.categoryId);document.getElementById('topicMeta').innerHTML=`<div class="topic-author-card"><div class="topic-author-avatar-big">${currentTopicData.authorAvatar?`<img src="${currentTopicData.authorAvatar}">`:(getInitials(currentTopicData.authorName))}</div><div><div style="font-weight:600">${currentTopicData.authorName}</div><div style="font-size:11px;color:var(--t-s)">${currentTopicData.authorRole}</div></div></div><div class="topic-meta-item">üìÇ <span>${cat?.name||''}</span></div><div class="topic-meta-item">üìÖ <span>${formatDate(currentTopicData.createdAt)}</span></div>`;updateBreadcrumb([{label:'–§–æ—Ä—É–º',icon:'üè†',action:'showCategories()'},{label:cat?.name||'–ö–∞—Ç–µ–≥–æ—Ä—ñ—è',action:'backToTopics()'},{label:currentTopicData.title.length>30?currentTopicData.title.substring(0,30)+'...':currentTopicData.title}]);const isOwner=currentTopicData.authorId===user.uid,panel=document.getElementById('topicAdminPanel');if(isAdmin()||(isInstructor()&&isOwner)||isOwner){panel.classList.add('show');updateTopicButtons()}else{panel.classList.remove('show')}const replySection=document.getElementById('replySection'),replyTitle=document.getElementById('replyTitleText');if(currentTopicData.locked){replySection.classList.add('disabled');replyTitle.textContent='–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ'}else if(currentTopicData.status==='closed'){replySection.classList.add('disabled');replyTitle.textContent='–¢–µ–º–∞ –∑–∞–∫—Ä–∏—Ç–∞'}else{replySection.classList.remove('disabled');replyTitle.textContent='–ù–∞–ø–∏—Å–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å'}loadPosts()};
function updateTopicButtons(){document.getElementById('btnPin').innerHTML=currentTopicData.pinned?'üìå –í—ñ–¥–∫—Ä—ñ–ø–∏—Ç–∏':'üìå –ó–∞–∫—Ä—ñ–ø–∏—Ç–∏';document.getElementById('btnClose').innerHTML=currentTopicData.status==='closed'?'üîì –í—ñ–¥–∫—Ä–∏—Ç–∏':'üîí –ó–∞–∫—Ä–∏—Ç–∏';document.getElementById('btnLock').innerHTML=currentTopicData.locked?'üîä –†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏':'üîá –ë–ª–æ–∫—É–≤–∞—Ç–∏'}
window.togglePin=async()=>{if(!isAdmin())return;await updateDoc(doc(db,"forum_topics",currentTopicId),{pinned:!currentTopicData.pinned});currentTopicData.pinned=!currentTopicData.pinned;updateTopicButtons();notify(currentTopicData.pinned?'–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ!':'–í—ñ–¥–∫—Ä—ñ–ø–ª–µ–Ω–æ!')};
window.toggleClose=async()=>{const newStatus=currentTopicData.status==='closed'?'open':'closed';await updateDoc(doc(db,"forum_topics",currentTopicId),{status:newStatus});currentTopicData.status=newStatus;updateTopicButtons();openTopic(currentTopicId);notify(newStatus==='closed'?'–ó–∞–∫—Ä–∏—Ç–æ!':'–í—ñ–¥–∫—Ä–∏—Ç–æ!')};
window.toggleLock=async()=>{await updateDoc(doc(db,"forum_topics",currentTopicId),{locked:!currentTopicData.locked});currentTopicData.locked=!currentTopicData.locked;updateTopicButtons();openTopic(currentTopicId);notify(currentTopicData.locked?'–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ!':'–†–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ!')};
window.editTopic=()=>{editingTopicId=currentTopicId;document.getElementById('newTopicTitle').value=currentTopicData.title;document.getElementById('newTopicCategory').value=currentTopicData.categoryId;document.getElementById('newTopicEditor').innerHTML=currentTopicData.content;document.getElementById('newTopicPinned').checked=currentTopicData.pinned||false;document.getElementById('newTopicGuide').checked=currentTopicData.isGuide||false;document.getElementById('topicModalTitle').textContent='–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–µ–º—É';document.getElementById('topicModal').classList.add('active')};
window.deleteTopic=async()=>{if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–º—É?'))return;try{const posts=await getDocs(query(collection(db,"forum_posts"),where("topicId","==",currentTopicId)));for(const p of posts.docs)await deleteDoc(doc(db,"forum_posts",p.id));await deleteDoc(doc(db,"forum_topics",currentTopicId));notify('–í–∏–¥–∞–ª–µ–Ω–æ!');backToTopics()}catch(e){notify(e.message,'error')}};

function loadPosts(){if(postsUnsubscribe)postsUnsubscribe();const q=query(collection(db,"forum_posts"),where("topicId","==",currentTopicId),orderBy("createdAt","asc"));postsUnsubscribe=onSnapshot(q,snap=>{const posts=[];snap.forEach(d=>posts.push({id:d.id,...d.data()}));renderPosts(posts)},error=>{console.error("Posts error:",error);notify('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è','error')})}
function renderPosts(posts){document.getElementById('postsCount').textContent=posts.length;if(!posts.length){document.getElementById('postsList').innerHTML=`<div class="empty-state"><div class="empty-icon">üí¨</div><div class="empty-title">–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</div></div>`;return}document.getElementById('postsList').innerHTML=posts.map((p,i)=>{const roleClass=p.authorRole==='admin'?'admin':p.authorRole==='instructor'?'instructor':'member';const isLiked=p.likes&&p.likes.includes(user.uid);const canEdit=p.authorId===user.uid||isAdmin();return`<div class="post-card ${p.isOriginal?'original':''}"><div class="post-header"><div class="post-avatar">${p.authorAvatar?`<img src="${p.authorAvatar}">`:(getInitials(p.authorName))}</div><div class="post-author-info"><div class="post-author-top"><span class="post-author-name">${p.authorName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</span><span class="post-author-role ${roleClass}">${p.authorRole||'member'}</span></div><div class="post-num">#${i+1}</div></div><div class="post-date">${formatDate(p.createdAt)}</div>${canEdit&&!p.isOriginal?`<div class="dropdown"><button class="btn-icon" onclick="togglePostMenu('${p.id}')" style="width:32px;height:32px">‚ãÆ</button><div class="dropdown-menu" id="pm_${p.id}"><div class="dropdown-item danger" onclick="deletePost('${p.id}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</div></div></div>`:''}</div><div class="post-content">${p.content}</div><div class="post-footer"><button class="post-action-btn ${isLiked?'liked':''}" onclick="toggleLike('${p.id}')">üëç ${p.likes?.length||0}</button><button class="post-action-btn" onclick="quotePost('${p.authorName}')">üí¨ –¶–∏—Ç—É–≤–∞—Ç–∏</button></div></div>`}).join('')}
window.togglePostMenu=id=>{document.querySelectorAll('.dropdown-menu').forEach(m=>{if(m.id!==`pm_${id}`)m.classList.remove('open')});document.getElementById(`pm_${id}`)?.classList.toggle('open')};
window.toggleLike=async id=>{const ref=doc(db,"forum_posts",id);const snap=await getDoc(ref);if(!snap.exists())return;let likes=snap.data().likes||[];if(likes.includes(user.uid))likes=likes.filter(i=>i!==user.uid);else likes.push(user.uid);await updateDoc(ref,{likes})};
window.deletePost=async id=>{if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏?'))return;await deleteDoc(doc(db,"forum_posts",id));await updateDoc(doc(db,"forum_topics",currentTopicId),{repliesCount:Math.max(0,(currentTopicData.repliesCount||0)-1)});currentTopicData.repliesCount=Math.max(0,(currentTopicData.repliesCount||0)-1);notify('–í–∏–¥–∞–ª–µ–Ω–æ!')};
window.quotePost=author=>{const editor=document.getElementById('replyEditor');editor.innerHTML=`<blockquote><strong>${author}:</strong><br>...</blockquote><p></p>`+editor.innerHTML;editor.focus();document.getElementById('replySection').scrollIntoView({behavior:'smooth'})};
window.submitReply=async()=>{const editor=document.getElementById('replyEditor');const content=editor.innerHTML.trim();if(!content||content==='<br>'||content==='<p><br></p>')return notify('–ù–∞–ø–∏—à—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å','error');if(currentTopicData.locked||currentTopicData.status==='closed')return notify('–ù–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏','error');try{await addDoc(collection(db,"forum_posts"),{topicId:currentTopicId,content,isOriginal:false,authorId:user.uid,authorName:userData.name,authorRole:userData.role,authorAvatar:userData.avatar||null,likes:[],createdAt:serverTimestamp()});await updateDoc(doc(db,"forum_topics",currentTopicId),{repliesCount:(currentTopicData.repliesCount||0)+1,lastActivity:serverTimestamp()});currentTopicData.repliesCount=(currentTopicData.repliesCount||0)+1;editor.innerHTML='';notify('–ù–∞–¥—ñ—Å–ª–∞–Ω–æ!');setTimeout(()=>{const list=document.getElementById('postsList');list.lastElementChild?.scrollIntoView({behavior:'smooth'})},500)}catch(e){notify(e.message,'error')}};

window.execCmd=cmd=>{document.getElementById('replyEditor').focus();document.execCommand(cmd,false,null)};
window.execCmdModal=cmd=>{document.getElementById('newTopicEditor').focus();document.execCommand(cmd,false,null)};
window.applyFont=f=>{document.getElementById('replyEditor').focus();document.execCommand('fontName',false,f)};
window.applyFontModal=f=>{document.getElementById('newTopicEditor').focus();document.execCommand('fontName',false,f)};
window.applySize=s=>{document.getElementById('replyEditor').focus();document.execCommand('fontSize',false,s)};
window.applySizeModal=s=>{document.getElementById('newTopicEditor').focus();document.execCommand('fontSize',false,s)};
window.applyColor=c=>{document.getElementById('replyEditor').focus();document.execCommand('foreColor',false,c)};
window.applyColorModal=c=>{document.getElementById('newTopicEditor').focus();document.execCommand('foreColor',false,c)};
window.insertQuote=()=>{document.getElementById('replyEditor').focus();document.execCommand('insertHTML',false,'<blockquote>–¶–∏—Ç–∞—Ç–∞...</blockquote><p></p>')};
window.insertQuoteModal=()=>{document.getElementById('newTopicEditor').focus();document.execCommand('insertHTML',false,'<blockquote>–¶–∏—Ç–∞—Ç–∞...</blockquote><p></p>')};
window.openLinkModal=()=>{linkTarget='reply';document.getElementById('linkUrl').value='';document.getElementById('linkText').value='';document.getElementById('linkModal').classList.add('active')};
window.openLinkModalFor=t=>{linkTarget=t;document.getElementById('linkUrl').value='';document.getElementById('linkText').value='';document.getElementById('linkModal').classList.add('active')};
window.closeLinkModal=()=>document.getElementById('linkModal').classList.remove('active');
window.insertLink=()=>{const url=document.getElementById('linkUrl').value.trim(),text=document.getElementById('linkText').value.trim()||url;if(!url)return notify('–í–≤–µ–¥—ñ—Ç—å URL','error');document.getElementById(linkTarget==='modal'?'newTopicEditor':'replyEditor').focus();document.execCommand('insertHTML',false,`<a href="${url}" target="_blank">${text}</a>`);closeLinkModal()};
window.insertImage=input=>{if(!input.files||!input.files[0])return;const file=input.files[0];if(file.size>5*1024*1024){notify('–§–∞–π–ª > 5MB','error');input.value='';return}const reader=new FileReader();reader.onload=e=>{document.getElementById('replyEditor').focus();document.execCommand('insertHTML',false,`<img src="${e.target.result}" style="max-width:100%;border-radius:10px;margin:10px 0">`)};reader.readAsDataURL(file);input.value=''};
window.insertImageModal=input=>{if(!input.files||!input.files[0])return;const file=input.files[0];if(file.size>5*1024*1024){notify('–§–∞–π–ª > 5MB','error');input.value='';return}const reader=new FileReader();reader.onload=e=>{document.getElementById('newTopicEditor').focus();document.execCommand('insertHTML',false,`<img src="${e.target.result}" style="max-width:100%;border-radius:10px;margin:10px 0">`)};reader.readAsDataURL(file);input.value=''};

window.openProfileModal=async()=>{if(!user||!userData)return;document.getElementById('profileNameInput').value=userData.name||'';document.getElementById('profileEmailInput').value=user.email||'';document.getElementById('profileBioInput').value=userData.bio||'';document.getElementById('profileNameDisplay').textContent=userData.name||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';const roleBadge=document.getElementById('profileRoleBadge');roleBadge.textContent=userData.role||'member';roleBadge.className=`profile-role-badge ${userData.role||'member'}`;const avatarEl=document.getElementById('profileAvatarBig');avatarEl.innerHTML=userData.avatar?`<img src="${userData.avatar}">`:getInitials(userData.name);const userTopics=topics.filter(t=>t.authorId===user.uid);document.getElementById('profileTopicsCount').textContent=userTopics.length;let postsCount=0,likesCount=0;try{const postsSnap=await getDocs(query(collection(db,"forum_posts"),where("authorId","==",user.uid)));postsCount=postsSnap.size;postsSnap.forEach(d=>{likesCount+=(d.data().likes?.length||0)})}catch(e){}document.getElementById('profilePostsCount').textContent=postsCount;document.getElementById('profileLikesCount').textContent=likesCount;document.getElementById('profileModal').classList.add('active')};
window.closeProfileModal=()=>document.getElementById('profileModal').classList.remove('active');
window.uploadAvatar=input=>{if(!input.files||!input.files[0])return;const file=input.files[0];if(file.size>2*1024*1024){notify('–ê–≤–∞—Ç–∞—Ä > 2MB','error');input.value='';return}const reader=new FileReader();reader.onload=e=>{const avatarData=e.target.result;document.getElementById('profileAvatarBig').innerHTML=`<img src="${avatarData}">`;userData.avatar=avatarData;updateUserAvatars()};reader.readAsDataURL(file);input.value=''};
window.saveProfile=async()=>{const name=document.getElementById('profileNameInput').value.trim(),bio=document.getElementById('profileBioInput').value.trim();if(!name)return notify("–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è",'error');if(name.length<2)return notify("–Ü–º'—è –∑–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–µ",'error');try{await updateDoc(doc(db,"users",user.uid),{name,bio,avatar:userData.avatar||null});userData.name=name;userData.bio=bio;document.getElementById('userNameNav').textContent=name;document.getElementById('profileNameDisplay').textContent=name;updateUserAvatars();notify('–ü—Ä–æ—Ñ—ñ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–æ!');closeProfileModal()}catch(e){notify(e.message,'error')}};

document.addEventListener('click',e=>{if(!e.target.closest('.dropdown'))document.querySelectorAll('.dropdown-menu').forEach(m=>m.classList.remove('open'))});
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active')}));
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal-overlay.active').forEach(m=>m.classList.remove('active'))});
</script>
</body>
</html>
