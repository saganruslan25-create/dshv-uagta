<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–®–í | –¢–ê–ö–¢–ò–ß–ù–ò–ô –ó–í'–Ø–ó–û–ö</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #22c55e;
            --primary-bright: #4ade80;
            --bg: #030507;
            --card-bg: #0a0c10;
            --glass-border: rgba(34, 197, 94, 0.2);
            --danger: #ef4444;
            --warning: #fbbf24;
            --mention-bg: rgba(251, 191, 36, 0.2);
            --mention-text: #fbbf24;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

        body { 
            background-color: var(--bg);
            background-image: radial-gradient(circle at 50% 0%, rgba(34, 197, 94, 0.1) 0%, transparent 50%);
            color: white; font-family: 'Inter', sans-serif; height: 100vh; display: flex; overflow: hidden; 
            user-select: none; /* –ß–∞—Å—Ç–∏–Ω–∞ –∑–∞—Ö–∏—Å—Ç—É */
        }

        /* SIDEBAR */
        .sidebar {
            width: 320px; background: var(--card-bg); border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column; padding: 25px; z-index: 10;
        }

        .dsw-title {
            background: var(--primary); color: black; padding: 8px 15px; border-radius: 8px;
            font-weight: 900; text-align: center; text-transform: uppercase; margin-bottom: 25px;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); letter-spacing: 1px;
        }

        .back-btn {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            color: white; padding: 14px; border-radius: 12px; text-decoration: none;
            text-align: center; font-weight: 800; font-size: 13px; margin-bottom: 20px; display: block;
        }
        .back-btn:hover { background: var(--danger); border-color: var(--danger); transform: scale(1.02); }

        .channel-list { flex-grow: 1; overflow-y: auto; }
        
        .channel-item {
            padding: 12px 15px; border-radius: 12px; cursor: pointer; color: #777;
            margin-bottom: 8px; font-weight: 700; display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.02); border: 1px solid transparent;
        }
        .channel-item:hover, .channel-item.active { 
            background: rgba(34, 197, 94, 0.05); color: var(--primary-bright); 
            border-color: var(--glass-border); 
        }

        .channel-controls { display: flex; align-items: center; gap: 10px; }
        .drag-handle { cursor: grab; opacity: 0.3; font-size: 18px; padding: 5px; }
        .drag-handle:active { cursor: grabbing; }
        .chan-del-btn { color: #444; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .chan-del-btn:hover { color: var(--danger); transform: scale(1.2); }

        .create-btn {
            background: var(--primary); color: black; border: none; padding: 15px;
            border-radius: 12px; font-weight: 900; cursor: pointer; margin-top: 20px; text-transform: uppercase;
        }

        /* CHAT AREA */
        .chat-main { flex-grow: 1; display: flex; flex-direction: column; position: relative; background: transparent; }
        
        .chat-header {
            padding: 20px 40px; background: rgba(3, 5, 7, 0.8); backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--glass-border); font-weight: 900; font-size: 20px; z-index: 5;
            display: flex; align-items: center; justify-content: space-between;
        }
        
        /* –ü–µ—Ä–µ–º–∏–∫–∞—á –≤–∏–¥–∏–º–æ—Å—Ç—ñ —á–∞—Ç—É (–¥–ª—è –∞–¥–º—ñ–Ω–∞) */
        .visibility-toggle {
            font-size: 12px; background: rgba(255,255,255,0.1); padding: 5px 10px; 
            border-radius: 5px; cursor: pointer; display: none; /* –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ */
        }
        .visibility-toggle.active { background: var(--primary); color: black; }

        .messages-container { flex-grow: 1; overflow-y: auto; padding: 30px 40px; display: flex; flex-direction: column; gap: 2px; /* –ú–µ–Ω—à–∏–π –≤—ñ–¥—Å—Ç—É–ø –¥–ª—è –≥—Ä—É–ø–∏ */ }
        
        /* MESSAGES STYLE */
        .msg { 
            position: relative; padding: 5px 25px; border-radius: 5px;
            border: 1px solid transparent; transition: all 0.2s;
        }
        .msg:hover { background: rgba(255, 255, 255, 0.02); }
        .msg.grouped { padding-top: 2px; padding-bottom: 2px; } /* –î–ª—è –∑–≥—Ä—É–ø–æ–≤–∞–Ω–∏—Ö */

        .msg-header { display: flex; align-items: center; gap: 12px; margin-bottom: 4px; margin-top: 10px; }
        .msg.grouped .msg-header { display: none; } /* –•–æ–≤–∞—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫, —è–∫—â–æ –≥—Ä—É–ø–∞ */
        
        .msg-author { font-weight: 900; color: var(--primary-bright); font-size: 14px; text-transform: uppercase; cursor: pointer; }
        .msg-time { font-size: 11px; color: #444; }

        .msg-content { line-height: 1.5; white-space: pre-wrap; color: #ddd; padding-left: 0; }
        .msg.grouped .msg-content { padding-left: 0; } /* –í—ñ–¥—Å—Ç—É–ø –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω, —è–∫—â–æ –Ω–µ–º–∞—î –∞–≤–∞—Ç–∞—Ä–∞ –∑–ª—ñ–≤–∞ */

        /* –°—Ç–∏–ª—ñ –¥–ª—è —Ü–∏—Ç–∞—Ç (–≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π) */
        .reply-block {
            border-left: 3px solid var(--warning); background: rgba(251, 191, 36, 0.1);
            padding: 5px 10px; margin-bottom: 5px; border-radius: 4px; font-size: 12px; color: #aaa;
            cursor: pointer;
        }
        .reply-author { color: var(--warning); font-weight: 700; margin-right: 5px; }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω—å */
        .msg-image {
            max-width: 300px; max-height: 300px; border-radius: 10px; 
            margin-top: 5px; cursor: pointer; border: 1px solid var(--glass-border);
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –∑–≥–∞–¥—É–≤–∞–Ω—å (@) */
        .mention { background: var(--mention-bg); color: var(--mention-text); padding: 0 4px; border-radius: 4px; font-weight: bold; }

        /* ACTION BUTTONS */
        .msg-actions {
            position: absolute; right: 20px; top: -10px; /* –¢—Ä–æ—Ö–∏ –≤–∏—â–µ */
            display: none; gap: 5px; z-index: 100; background: var(--card-bg);
            padding: 4px; border-radius: 8px; border: 1px solid var(--glass-border);
        }
        .msg:hover .msg-actions { display: flex; top: -15px; } /* –°–ø–ª–∏–≤–∞—î –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
        
        .action-btn {
            background: transparent; border: none; color: #888;
            padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;
        }
        .action-btn:hover { color: var(--primary); background: rgba(255,255,255,0.05); }
        .del-btn:hover { color: var(--danger); }

        /* INPUT AREA */
        .chat-input-area { padding: 20px 40px; background: rgba(3, 5, 7, 0.9); border-top: 1px solid var(--glass-border); display: none; flex-direction: column; }
        
        /* –ë–ª–æ–∫ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ */
        #replyPreview {
            display: none; background: rgba(34, 197, 94, 0.1); padding: 8px 15px; 
            border-left: 3px solid var(--primary); border-radius: 5px 5px 0 0;
            font-size: 12px; color: #ccc; justify-content: space-between; align-items: center;
        }
        #replyPreview span { font-weight: bold; color: var(--primary-bright); }
        .close-reply { cursor: pointer; color: #666; font-weight: bold; }
        .close-reply:hover { color: white; }

        .input-wrapper {
            background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 15px; 
            display: flex; align-items: center; padding: 5px 15px; gap: 10px;
        }
        .input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 15px rgba(34, 197, 94, 0.1); }
        
        textarea { background: none; border: none; color: white; padding: 12px; flex-grow: 1; outline: none; font-family: inherit; resize: none; max-height: 100px; overflow-y: auto; }
        
        /* –ö–Ω–æ–ø–∫–∏ –≤–≤–æ–¥—É */
        .upload-btn { cursor: pointer; font-size: 20px; color: #666; padding: 5px; }
        .upload-btn:hover { color: var(--primary); }
        
        .send-btn { background: var(--primary); color: black; border: none; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; font-weight: 900; display: flex; align-items: center; justify-content: center; }
        .send-btn:hover { background: var(--primary-bright); }

        /* –°–∫—Ä–æ–ª–±–∞—Ä */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="sidebar">
        <div class="dsw-title">–î–®–í –ö–û–ú–£–ù–Ü–ö–ê–¶–Ü–Ø</div>
        <a href="cabinet.html" class="back-btn">‚¨Ö –ù–ê–ó–ê–î –î–û –ö–ê–ë–Ü–ù–ï–¢–£</a>
        
        <div id="channelList" class="channel-list"></div>
        
        <button id="adminCreateChannel" class="create-btn" style="display:none;" onclick="createChannel()">+ –°–¢–í–û–†–ò–¢–ò –ö–ê–ù–ê–õ</button>
    </div>

    <div class="chat-main">
        <div class="chat-header">
            <div><span style="color:var(--primary)">#</span> <span id="activeChannelName">–û–ë–ï–†–Ü–¢–¨ –ö–ê–ù–ê–õ</span></div>
            <div id="visibilityToggle" class="visibility-toggle" onclick="toggleChatVisibility()">üëÅÔ∏è –í–ò–î–ò–ú–Ü–°–¢–¨ –î–õ–Ø –ë–Ü–ô–¶–Ü–í</div>
        </div>
        
        <div id="messages" class="messages-container"></div>
        
        <div id="inputArea" class="chat-input-area">
            <div id="replyPreview">
                <div id="replyText">–í—ñ–¥–ø–æ–≤—ñ–¥—å –¥–ª—è: <span>User</span></div>
                <div class="close-reply" onclick="cancelReply()">‚úï</div>
            </div>
            
            <div class="input-wrapper">
                <label for="imgUpload" class="upload-btn">üì∑</label>
                <input type="file" id="imgUpload" accept="image/*" style="display:none;" onchange="handleImageUpload(this)">
                
                <textarea id="msgInput" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è... (@ –¥–ª—è –∑–≥–∞–¥—É–≤–∞–Ω–Ω—è)" rows="1"></textarea>
                <button class="send-btn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc, deleteDoc, updateDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyATUpLUHSp1VbyxkJXhMS-2R71zNOBGC00",
            authDomain: "dsv-gta.firebaseapp.com",
            projectId: "dsv-gta",
            storageBucket: "dsv-gta.firebasestorage.app",
            messagingSenderId: "661591588818",
            appId: "1:661591588818:web:a8e8dca3d061447e24d20b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let userData = null;
        let activeChannelId = null;
        let unsubMessages = null;
        let replyTo = null; // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è ID –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –Ω–∞ —è–∫–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ
        let uploadedImageBase64 = null; // –î–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é

        // --- 1. –ó–ê–•–ò–°–¢ –í–Ü–î –ö–û–ù–°–û–õ–Ü ---
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false;
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
        }

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                user = u;
                const snap = await getDoc(doc(db, "users", u.uid));
                userData = snap.data();
                
                // –Ø–∫—â–æ –∞–¥–º—ñ–Ω
                if (userData.role === 'admin') {
                    document.getElementById('adminCreateChannel').style.display = 'block';
                    document.getElementById('visibilityToggle').style.display = 'block'; // –ü–µ—Ä–µ–º–∏–∫–∞—á –≤–∏–¥–∏–º–æ—Å—Ç—ñ
                    initSortable();
                }
                
                loadChannels();
            } else { window.location.href = "index.html"; }
        });

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞–Ω–∞–ª—ñ–≤
        function loadChannels() {
            const q = query(collection(db, "channels"), orderBy("index", "asc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('channelList');
                list.innerHTML = "";
                snap.forEach(d => {
                    const ch = d.data();
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç—ñ –∫–∞–Ω–∞–ª—É (–º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ø–æ–ª–µ visibility –≤ –ë–î, —Ç—É—Ç —Å–ø—Ä–æ—â–µ–Ω–æ)
                    // –Ø–∫—â–æ –∫–∞–Ω–∞–ª "–ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π", –ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—É (–ª–æ–≥—ñ–∫—É –º–æ–∂–Ω–∞ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏)

                    const item = document.createElement('div');
                    item.className = `channel-item ${d.id === activeChannelId ? 'active' : ''}`;
                    item.dataset.id = d.id;
                    item.innerHTML = `
                        <span># ${ch.name}</span>
                        <div class="channel-controls">
                            ${userData?.role === 'admin' ? `
                                <span class="chan-del-btn" onclick="deleteChannel('${d.id}', '${ch.name}')">‚úï</span>
                                <span class="drag-handle">‚ãÆ‚ãÆ</span>
                            ` : ''}
                        </div>
                    `;
                    item.onclick = (e) => {
                        if (e.target.classList.contains('drag-handle') || e.target.classList.contains('chan-del-btn')) return;
                        selectChannel(d.id, ch.name, ch.readOnly); // readOnly - –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è —Å–∫—Ä–∏—Ç—Ç—è —á–∞—Ç—É
                    };
                    list.appendChild(item);
                });
            });
        }

        // --- 2. –°–ö–†–ò–¢–¢–Ø –ß–ê–¢–£ –í–Ü–î –ó–í–ò–ß–ê–ô–ù–ò–• –ë–Ü–ô–¶–Ü–í ---
        // –í–∏–±—ñ—Ä –∫–∞–Ω–∞–ª—É
        function selectChannel(id, name, isReadOnly) {
            activeChannelId = id;
            document.getElementById('activeChannelName').innerText = name;
            
            // –Ø–∫—â–æ –∞–¥–º—ñ–Ω –∞–±–æ –∫–∞–Ω–∞–ª –Ω–µ —Ç—ñ–ª—å–∫–∏ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è - –ø–æ–∫–∞–∑—É—î–º–æ –≤–≤—ñ–¥
            // –ê–ë–û: –ó–∞ —É–º–æ–≤–æ—é - —Å–∫—Ä–∏—Ç—Ç—è –≤—ñ–¥ –∑–≤–∏—á–∞–π–Ω–∏—Ö –±—ñ–π—Ü—ñ–≤.
            // –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è: –Ø–∫—â–æ –Ω–µ –∞–¥–º—ñ–Ω - —Ö–æ–≤–∞—î–º–æ —ñ–Ω–ø—É—Ç (—Ç—ñ–ª—å–∫–∏ —á–∏—Ç–∞–Ω–Ω—è).
            
            if (userData.role === 'admin') {
                document.getElementById('inputArea').style.display = 'flex';
                // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ (—è–∫—â–æ –± –≤–æ–Ω–∞ –∑–±–µ—Ä—ñ–≥–∞–ª–∞—Å—å –≤ –ë–î)
            } else {
                // –ó–≤–∏—á–∞–π–Ω–∏–π –±–æ—î—Ü—å
                // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–ø–æ—Ä—Ü—è –≤ –∫–∞–Ω–∞–ª—ñ, 
                // –∞–ª–µ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∑—Ä–æ–±–∏–º–æ –¥–æ—Å—Ç—É–ø–Ω–∏–º –¥–ª—è —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è, 
                // –∞ –∞–¥–º—ñ–Ω –º–æ–∂–µ "–∑–∞–∫—Ä–∏—Ç–∏" —á–∞—Ç (readOnly).
                // –î–ª—è –ø—Ä–∏–∫–ª–∞–¥—É: —è–∫—â–æ isReadOnly == true, —Ö–æ–≤–∞—î–º–æ.
                // –Ø–∫—â–æ —Ç—Ä–µ–±–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ —Å—Ö–æ–≤–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø–∏—Å–∞—Ç–∏ –∑–≤–∏—á–∞–π–Ω–∏–º:
                // document.getElementById('inputArea').style.display = 'none'; 
                
                // –í –∫–æ–¥—ñ –Ω–∏–∂—á–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —Ç–∞–∫: —è–∫—â–æ isReadOnly (–≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∞–¥–º—ñ–Ω–æ–º), —Ç–æ —ñ–Ω–ø—É—Ç —Ö–æ–≤–∞—î—Ç—å—Å—è.
                // –Ø–∫—â–æ –ø–æ–ª–µ –Ω–µ –∑–∞–¥–∞–Ω–æ, –≤–≤–∞–∂–∞—î–º–æ –≤—ñ–¥–∫—Ä–∏—Ç–∏–º.
                if (isReadOnly) {
                    document.getElementById('inputArea').style.display = 'none';
                } else {
                    document.getElementById('inputArea').style.display = 'flex';
                }
            }
            
            loadMessages(id);
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∞–¥–º—ñ–Ω–∞: –ø–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ä–µ–∂–∏–º "–¢—ñ–ª—å–∫–∏ —á–∏—Ç–∞–Ω–Ω—è" –¥–ª—è –∫–∞–Ω–∞–ª—É
        window.toggleChatVisibility = async () => {
            if (!activeChannelId || userData.role !== 'admin') return;
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω
            const chanRef = doc(db, "channels", activeChannelId);
            const snap = await getDoc(chanRef);
            const currentStatus = snap.data().readOnly || false;
            
            await updateDoc(chanRef, { readOnly: !currentStatus });
            
            const btn = document.getElementById('visibilityToggle');
            if (!currentStatus) {
                btn.classList.add('active');
                btn.innerText = "üîí –ß–ê–¢ –ó–ê–ö–†–ò–¢–û (–¢–Ü–õ–¨–ö–ò –ß–ò–¢–ê–ù–ù–Ø)";
            } else {
                btn.classList.remove('active');
                btn.innerText = "üëÅÔ∏è –ß–ê–¢ –í–Ü–î–ö–†–ò–¢–û";
            }
        };


        // --- 5. –°–ò–°–¢–ï–ú–ê –ì–†–£–ü–£–í–ê–ù–ù–Ø –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨ ---
        function loadMessages(channelId) {
            if (unsubMessages) unsubMessages();
            const q = query(collection(db, "channels", channelId, "messages"), orderBy("createdAt", "asc"));
            
            unsubMessages = onSnapshot(q, (snap) => {
                const container = document.getElementById('messages');
                container.innerHTML = "";
                
                let lastAuth = null;
                let lastTime = 0;

                snap.forEach(d => {
                    const m = d.data();
                    const msgTime = m.createdAt ? m.createdAt.toMillis() : 0;
                    const timeStr = m.createdAt ? new Date(msgTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è (—Ç–æ–π —Å–∞–º–∏–π –∞–≤—Ç–æ—Ä —ñ —Ä—ñ–∑–Ω–∏—Ü—è < 5 —Ö–≤)
                    let isGrouped = false;
                    if (lastAuth === m.author && (msgTime - lastTime) < 300000) {
                        isGrouped = true;
                    }

                    const msgDiv = document.createElement('div');
                    msgDiv.className = `msg ${isGrouped ? 'grouped' : ''}`;
                    msgDiv.id = `msg-${d.id}`;
                    
                    // –û–±—Ä–æ–±–∫–∞ –≤–º—ñ—Å—Ç—É (—Ç–µ–∫—Å—Ç + –≤—ñ–¥–ø–æ–≤—ñ–¥—å + –∫–∞—Ä—Ç–∏–Ω–∫–∞)
                    let contentHtml = "";
                    
                    // –Ø–∫—â–æ —Ü–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
                    if (m.replyTo) {
                        contentHtml += `
                            <div class="reply-block">
                                <span class="reply-author">‚Ü© ${m.replyTo.author}:</span> 
                                ${m.replyTo.text ? m.replyTo.text.substring(0, 50) + "..." : "–§–æ—Ç–æ"}
                            </div>
                        `;
                    }
                    
                    // –¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è–º
                    contentHtml += `<div class="msg-content">${formatMessage(m.text)}</div>`;
                    
                    // –Ø–∫—â–æ —î –∫–∞—Ä—Ç–∏–Ω–∫–∞
                    if (m.imageUrl) {
                        contentHtml += `<img src="${m.imageUrl}" class="msg-image" onclick="window.open('${m.imageUrl}')">`;
                    }

                    msgDiv.innerHTML = `
                        ${!isGrouped ? `
                            <div class="msg-header">
                                <span class="msg-author" onclick="mentionUser('${m.author}')">${m.author}</span>
                                <span class="msg-time">${timeStr}</span>
                            </div>
                        ` : ''}
                        
                        ${contentHtml}
                        
                        <div class="msg-actions">
                            <button class="action-btn" title="–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏" onclick="replyToMessage('${d.id}', '${m.author}', \`${m.text}\`)">‚Ü©</button>
                            ${(userData.role === 'admin' || m.uid === user.uid) ? `
                                <button class="action-btn del-btn" title="–í–∏–¥–∞–ª–∏—Ç–∏" onclick="deleteMessage('${d.id}')">‚úï</button>
                            ` : ''}
                        </div>
                    `;
                    
                    container.appendChild(msgDiv);
                    
                    lastAuth = m.author;
                    lastTime = msgTime;
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        // --- 6. –°–ò–°–¢–ï–ú–ê –ó–ì–ê–î–£–í–ê–ù–¨ (@) ---
        function formatMessage(text) {
            if (!text) return "";
            // URL
            let formatted = text.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig, '<a href="$1" target="_blank">$1</a>');
            // –ó–≥–∞–¥—É–≤–∞–Ω–Ω—è (@Name)
            formatted = formatted.replace(/@([\w–∞-—è–ê-–Ø—ë–Å—ñ–Ü—ó–á—î–Ñ]+)/g, '<span class="mention">@$1</span>');
            return formatted;
        }

        window.mentionUser = (name) => {
            const input = document.getElementById('msgInput');
            input.value += `@${name} `;
            input.focus();
        };

        // --- 4. –°–ò–°–¢–ï–ú–ê –í–Ü–î–ü–û–í–Ü–î–Ü ---
        window.replyToMessage = (id, author, text) => {
            replyTo = { id, author, text };
            const preview = document.getElementById('replyPreview');
            preview.style.display = 'flex';
            document.getElementById('replyText').innerHTML = `–í—ñ–¥–ø–æ–≤—ñ–¥—å –¥–ª—è <span>${author}</span>: ${text.substring(0, 30)}...`;
            document.getElementById('msgInput').focus();
        };

        window.cancelReply = () => {
            replyTo = null;
            document.getElementById('replyPreview').style.display = 'none';
        };

        // --- 7. –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –§–û–¢–û ---
        window.handleImageUpload = (input) => {
            const file = input.files[0];
            if (!file) return;
            
            // –û–±–º–µ–∂–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É (1.5 MB –¥–ª—è Firestore Base64)
            if (file.size > 1500000) {
                alert("–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π! –ú–∞–∫—Å–∏–º—É–º 1.5MB.");
                input.value = "";
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImageBase64 = e.target.result;
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø—Ä–µ–≤'—é –≤ –ø–æ–ª—ñ –≤–≤–æ–¥—É –∞–±–æ –∑–º—ñ–Ω—é—î–º–æ —ñ–∫–æ–Ω–∫—É
                document.querySelector('.upload-btn').style.color = 'var(--primary)';
                document.getElementById('msgInput').placeholder = "üì∑ –§–æ—Ç–æ –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–æ. –î–æ–¥–∞–π—Ç–µ –ø—ñ–¥–ø–∏—Å...";
            };
            reader.readAsDataURL(file);
        };

        // --- 3. –í–Ü–î–ü–†–ê–í–ö–ê –ù–ê ENTER ---
        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ–π –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥—É
        document.getElementById('msgInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –ø–µ—Ä–µ–Ω–æ—Å—É —Ä—è–¥–∫–∞
                sendMessage();
            }
        });

        window.sendMessage = async () => {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            
            // –Ø–∫—â–æ –Ω–µ–º–∞—î —Ç–µ–∫—Å—Ç—É —ñ –Ω–µ–º–∞—î –∫–∞—Ä—Ç–∏–Ω–∫–∏ - –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ
            if ((!text && !uploadedImageBase64) || !activeChannelId) return;
            
            const msgData = {
                text: text,
                author: userData.name,
                uid: user.uid,
                createdAt: serverTimestamp()
            };

            // –Ø–∫—â–æ —î –≤—ñ–¥–ø–æ–≤—ñ–¥—å
            if (replyTo) {
                msgData.replyTo = {
                    id: replyTo.id,
                    author: replyTo.author,
                    text: replyTo.text
                };
            }

            // –Ø–∫—â–æ —î —Ñ–æ—Ç–æ
            if (uploadedImageBase64) {
                msgData.imageUrl = uploadedImageBase64;
            }

            await addDoc(collection(db, "channels", activeChannelId, "messages"), msgData);
            
            // –û—á–∏—â–µ–Ω–Ω—è
            input.value = "";
            cancelReply();
            uploadedImageBase64 = null;
            document.querySelector('.upload-btn').style.color = '#666';
            document.getElementById('imgUpload').value = "";
            input.placeholder = "–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è... (@ –¥–ª—è –∑–≥–∞–¥—É–≤–∞–Ω–Ω—è)";
        };

        // --- –Ü–ù–®–Ü –§–£–ù–ö–¶–Ü–á ---
        window.deleteMessage = async (msgId) => { 
            if (confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?")) 
                await deleteDoc(doc(db, "channels", activeChannelId, "messages", msgId)); 
        };

        window.createChannel = async () => { 
            const name = prompt("–ù–∞–∑–≤–∞ –∫–∞–Ω–∞–ª—É:"); 
            if (name) {
                const snap = await getDocs(collection(db, "channels"));
                await addDoc(collection(db, "channels"), { 
                    name: name.toUpperCase(), 
                    index: snap.size,
                    readOnly: false // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤—ñ–¥–∫—Ä–∏—Ç–∏–π
                }); 
            }
        };

        window.deleteChannel = async (id, name) => {
            if (confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –∫–∞–Ω–∞–ª #${name}?`)) {
                await deleteDoc(doc(db, "channels", id));
                if (activeChannelId === id) window.location.reload();
            }
        };

        function initSortable() {
            const el = document.getElementById('channelList');
            Sortable.create(el, {
                handle: '.drag-handle',
                animation: 250,
                onEnd: async () => {
                    const items = el.querySelectorAll('.channel-item');
                    const batch = writeBatch(db);
                    items.forEach((item, idx) => {
                        const ref = doc(db, "channels", item.dataset.id);
                        batch.update(ref, { index: idx });
                    });
                    await batch.commit();
                }
            });
        }
    </script>
</body>
</html>
