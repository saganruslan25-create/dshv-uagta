<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–®–í | –ö–û–õ–ï–°–û –§–û–†–¢–£–ù–ò - –û–ù–û–í–õ–ï–ù–û</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #22c55e;
            --primary-glow: rgba(34, 197, 94, 0.5);
            --accent: #f97316;
            --accent-glow: rgba(249, 115, 22, 0.5);
            --bg: #020305;
            --card-bg: rgba(10, 15, 25, 0.9);
            --glass-border: rgba(34, 197, 94, 0.3);
            --text-gray: #94a3b8;
            --danger: #ef4444;
            --currency: #fbbf24;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            background-image: 
                radial-gradient(circle at 50% -20%, var(--primary-glow) 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, rgba(14, 165, 233, 0.1) 0%, transparent 40%);
            color: white; 
            font-family: 'Inter', sans-serif;
            min-height: 100vh; overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 60px;
            user-select: none;
            -webkit-user-select: none;
        }

        input, textarea {
            user-select: text !important;
            -webkit-user-select: text !important;
            cursor: text;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #05070a; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; box-shadow: 0 0 10px var(--primary-glow); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 
            0%, 100% { transform: scale(1); box-shadow: 0 0 40px var(--accent-glow); }
            50% { transform: scale(1.02); box-shadow: 0 0 60px var(--accent-glow); }
        }

        .neon-text {
            text-shadow: 0 0 10px var(--accent-glow), 0 0 20px var(--accent-glow);
            letter-spacing: 5px; text-transform: uppercase;
        }

        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 5%; background: rgba(2, 3, 5, 0.8);
            backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border);
            position: sticky; top: 0; z-index: 1000;
            flex-wrap: wrap; gap: 10px;
        }

        .stat-item {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border);
            padding: 10px 20px; border-radius: 15px; font-weight: 800; font-size: 14px;
            transition: 0.3s;
        }

        .main-container {
            display: grid; grid-template-columns: 280px 1fr; gap: 30px;
            max-width: 1600px; margin: 30px auto; padding: 0 5%;
        }

        .sidebar {
            background: var(--card-bg); border: 1px solid var(--glass-border);
            border-radius: 24px; padding: 20px; display: flex; flex-direction: column; gap: 12px;
            height: fit-content; position: sticky; top: 110px;
        }

        .menu-btn {
            padding: 16px; border-radius: 14px; border: 1px solid transparent;
            background: rgba(255,255, 255, 0.03); color: white; text-align: left;
            font-weight: 700; cursor: pointer; transition: 0.4s; font-size: 14px;
        }
        .menu-btn:hover, .menu-btn.active {
            background: rgba(34, 197, 94, 0.15); border-color: var(--primary); 
            color: var(--primary); box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
        }

        .status-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 40px; background: rgba(10, 15, 25, 0.9);
            backdrop-filter: blur(15px); border-top: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 2000; font-size: 10px; font-weight: 800;
            color: var(--text-gray); letter-spacing: 1px;
        }

        .content-section { display: none; animation: fadeIn 0.5s ease; }
        .content-section.active { display: block; }

        /* PROMO BANNER */
        #promoBanner {
            display: none;
            background: linear-gradient(135deg, #f97316, #ea580c);
            padding: 20px; border-radius: 20px; margin-bottom: 30px;
            text-align: center; border: 2px solid var(--accent);
            box-shadow: 0 0 40px var(--accent-glow);
            animation: pulse 2s infinite;
        }

        /* ROULETTE */
        .roulette-container {
            background: #05080f; border: 1px solid var(--glass-border);
            border-radius: 40px; padding: 60px 20px; text-align: center; position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8); overflow: hidden;
            margin-bottom: 30px;
        }

        .carousel-outer {
            position: relative; height: 260px; margin: 40px 0; overflow: hidden;
            background: rgba(255, 255, 255, 0.02); border-radius: 24px;
            mask-image: linear-gradient(to right, transparent, black 20%, black 80%, transparent);
            border: 1px solid rgba(255,255,255, 0.05);
        }
        
        .pointer {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 4px; height: 100%; background: var(--accent); z-index: 100;
            box-shadow: 0 0 25px var(--accent);
        }
        
        #winOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 50;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(2px); animation: fadeIn 0.5s;
        }

        .track {
            display: flex; position: absolute; left: 0; top: 30px;
            will-change: transform;
        }
        
        .prize-card {
            width: 200px; height: 200px; margin: 0 10px;
            background: rgba(255,255,255, 0.03); border: 1px solid rgba(255,255, 255, 0.07);
            border-radius: 20px; display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 15px; flex-shrink: 0;
        }
        .prize-card img { width: 110px; height: 110px; object-fit: contain; }
        .prize-card span { font-size: 12px; font-weight: 900; margin-top: 12px; color: var(--text-gray); }

        .spin-actions {
            display: flex; justify-content: center; align-items: stretch;
            gap: 20px; max-width: 100%; margin: 20px auto 0; padding: 0 20px;
        }

        .btn-main {
            flex: 1; padding: 18px 20px; border-radius: 16px; border: none; font-weight: 900;
            cursor: pointer; text-transform: uppercase; font-size: 14px; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
            max-width: 300px; width: 100%; position: relative; overflow: hidden;
        }
        .btn-main:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        
        .btn-buy { background: linear-gradient(135deg, #f97316, #ea580c); color: white; box-shadow: 0 0 25px rgba(249, 115, 22, 0.4); }
        .btn-spin { background: #1e293b; color: #94a3b8; border: 1px solid #334155; }

        .admin-box { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 30px; padding: 35px; }
        .input, .select, .textarea { 
            width: 100%; background: #000; border: 1px solid #222; color: white; 
            padding: 16px; border-radius: 12px; outline: none; font-family: 'Inter', sans-serif;
        }

        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.96); z-index: 5000; display: none; 
            align-items: center; justify-content: center; padding: 20px; 
        }
        
        .modal-inner { 
            background: #0a0e14; border: 1px solid var(--glass-border); 
            border-radius: 30px; padding: 40px; width: 100%; max-width: 500px; 
            text-align: center; max-height: 90vh; overflow-y: auto; animation: fadeIn 0.3s; 
        }

        .processing-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 10000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }

        .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(34, 197, 94, 0.1);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }

        #toastContainer { 
            position: fixed; bottom: 80px; right: 30px; z-index: 9999; 
            display: flex; flex-direction: column; gap: 10px; 
        }
        
        .toast { 
            background: #0a0f18; border-left: 5px solid var(--primary); 
            color: white; padding: 18px 30px; border-radius: 12px; 
            font-weight: 700; box-shadow: 0 10px 40px rgba(0,0,0, 0.5); 
            animation: slideDown 0.3s ease-out; 
        }

        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .shop-card { 
            background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255,255, 255, 0.05);
            border-radius: 20px; padding: 25px; text-align: center; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; position: relative;
        }
        .shop-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .shop-card img { width: 120px; height: 120px; object-fit: contain; margin-bottom: 15px; }
        .price-tag { font-size: 22px; font-weight: 900; color: var(--primary); margin-bottom: 15px; }

        .toggle-container { 
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px; 
            background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 12px; 
        }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: #333; transition: .4s; border-radius: 24px; 
        }
        .slider:before { 
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; 
            bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; 
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        @media (max-width: 1024px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar { 
                position: relative; top: 0; flex-direction: row; 
                overflow-x: auto; padding: 12px; gap: 8px; 
            }
            .menu-btn { white-space: nowrap; padding: 12px 20px; }
        }

        @media (max-width: 768px) {
            header { flex-direction: column; padding: 12px 3%; }
            .carousel-outer { height: 180px; }
            .prize-card { width: 130px; height: 130px; }
            .prize-card img { width: 70px; height: 70px; }
            .spin-actions { flex-direction: column; gap: 12px; }
            .btn-main { max-width: 100%; }
        }
    </style>
</head>
<body>

<div id="toastContainer"></div>

<div id="processingModal" class="processing-overlay">
    <div style="text-align: center; padding: 30px; background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 20px; max-width: 400px;">
        <div class="spinner"></div>
        <h3 id="procTitle" style="color:var(--primary);">–û–ë–†–û–ë–ö–ê</h3>
        <p id="procText" style="color:var(--text-gray); font-size:14px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
    </div>
</div>

<!-- SPIN LOCK OVERLAY - –í–ò–ü–†–ê–í–õ–ï–ù–û: –ë—ñ–ª—å—à–µ –Ω–µ –±–ª–æ–∫—É—î –≤–µ—Å—å –µ–∫—Ä–∞–Ω -->
<div id="spinLockOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 9998; pointer-events: none;">
</div>
</div>

<header>
    <a href="cabinet.html" style="color: var(--text-gray); text-decoration: none; font-weight: 900; font-size: 11px; text-transform: uppercase;">‚Üê –ù–ê–ó–ê–î</a>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
        <div class="stat-item">‚ö™ <span id="pointsVal">0</span></div>
        <div class="stat-item" style="border-color: var(--currency);">üí∏ <span id="currencyVal">0</span> ‚Ç¥</div>
        <button class="stat-item" style="cursor: pointer; background: linear-gradient(135deg, #fbbf24, #d97706); border:none; color:black;" onclick="openExchangeModal()">–û–ë–ú–Ü–ù</button>
    </div>
</header>

<div class="main-container">
    <aside class="sidebar">
        <button id="nav-roulette" class="menu-btn active" onclick="showPage('roulette', this)">üé∞ –†–£–õ–ï–¢–ö–ê</button>
        <button id="nav-shop" class="menu-btn" onclick="showPage('shop', this)">üõí –ú–ê–ì–ê–ó–ò–ù</button>
        <button id="adminBtn" class="menu-btn" style="display:none;" onclick="showPage('admin', this)">‚öôÔ∏è –ö–û–ù–°–û–õ–¨</button>
    </aside>

    <main class="content-wrapper">
        <!-- ROULETTE PAGE -->
        <section id="roulettePage" class="content-section active">
            <!-- PROMO BANNER -->
            <div id="promoBanner">
                <div style="font-size: 14px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px;">
                    üî• –ê–ö–¶–Ü–Ø üî•
                </div>
                <div id="promoBannerText" style="font-size: 22px; font-weight: 900; color: white; margin-bottom: 10px;">
                    –°–í–Ø–¢–ö–û–í–ê –ó–ù–ò–ñ–ö–ê!
                </div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 15px;">
                    <span style="font-size: 20px; color: rgba(255,255,255,0.6); text-decoration: line-through;">
                        <span id="promoOldPrice">100</span> ‚ö™
                    </span>
                    <span style="font-size: 36px; font-weight: 900; color: white;">
                        <span id="promoNewPrice">80</span> ‚ö™
                    </span>
                </div>
                <div id="promoPercentLabel" style="margin-top: 10px; background: rgba(0, 0, 0, 0.3); display: inline-block; padding: 8px 20px; border-radius: 50px; font-weight: 900; color: white;">
                    -20% –ó–ù–ò–ñ–ö–ê
                </div>
            </div>

            <div class="roulette-container">
                <h1 class="roulette-title neon-text">–ö–û–õ–ï–°–û –§–û–†–¢–£–ù–ò</h1>
                <div class="carousel-outer">
                    <div class="pointer"></div>
                    <div id="winOverlay">
                        <div style="font-size: 40px; font-weight: 900; color: var(--accent); text-shadow: 0 0 20px var(--accent); margin-bottom: 10px;">
                            –í–ò–ì–†–ê–®
                        </div>
                        <div id="winPrizeName" style="font-size: 24px; font-weight: 800; color: white;">NAME</div>
                    </div>
                    <div id="track" class="track">–ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø...</div>
                </div>
                <div class="spin-actions">
                    <button class="btn-main btn-buy" onclick="openPurchaseModal()">
                        <span>–ö–£–ü–ò–¢–ò –ö–í–ò–¢–û–ö</span>
                        <small id="ticketPriceLabel" style="opacity:0.8; font-size:10px;">–í–ê–†–¢–Ü–°–¢–¨: 100 ‚ö™</small>
                    </button>
                    <button class="btn-main btn-spin" id="spinBtn" onclick="startSpin()">
                        <span>–ö–†–£–¢–ò–¢–ò –ö–û–õ–ï–°–û</span>
                        <span style="color:var(--primary); font-size:10px;">–ö–í–ò–¢–ö–Ü–í: <b id="ticketsVal">0</b></span>
                    </button>
                </div>
            </div>
            <h3 style="text-transform: uppercase; letter-spacing: 3px; color: var(--primary); font-size: 12px; margin-bottom: 20px;">–ü–†–ò–ó–ò –í –¶–Ü–ô –†–£–õ–ï–¢–¶–Ü</h3>
            <div id="prizePreview" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px;"></div>
        </section>

        <!-- SHOP PAGE -->
        <section id="shopPage" class="content-section">
            <h1 class="neon-text" style="font-size:32px; margin-bottom:30px;">–ú–ê–ì–ê–ó–ò–ù</h1>
            <div id="shopGrid" class="shop-grid"></div>
        </section>

        <!-- ADMIN PAGE -->
        <section id="adminPage" class="content-section">
            <div class="admin-box">
                <div style="display:flex; gap:10px; margin-bottom:30px; overflow-x:auto;">
                    <button class="menu-btn" onclick="switchAdminTab('price', this)">üí∞ –¶–Ü–ù–ê</button>
                    <button class="menu-btn" onclick="switchAdminTab('promo', this)">üî• –ê–ö–¶–Ü–á</button>
                    <button class="menu-btn" onclick="switchAdminTab('balance', this)">üíé –ë–ê–õ–ê–ù–°</button>
                    <button class="menu-btn" onclick="switchAdminTab('prizes', this)">üé∞ –°–õ–û–¢–ò</button>
                    <button class="menu-btn" onclick="switchAdminTab('logs', this)">üìä –õ–û–ì–ò</button>
                </div>

                <!-- TAB: TICKET PRICE -->
                <div id="tabPrice" class="admin-tab" style="display:none;">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">üí∞ –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –¶–Ü–ù–ò –ö–í–ò–¢–ö–ê</h3>
                    <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px;">
                        <label style="font-size: 12px; color: var(--text-gray); display: block; margin-bottom: 8px;">
                            –ë–∞–∑–æ–≤–∞ —Ü—ñ–Ω–∞ –∫–≤–∏—Ç–∫–∞ (–≤ –±–∞–ª–∞—Ö)
                        </label>
                        <input type="number" id="ticketPriceInput" class="input" placeholder="100" min="1" value="100">
                        <button onclick="saveTicketPrice()" class="btn-main btn-buy" style="margin-top: 15px; width: 100%;">
                            –ó–ë–ï–†–ï–ì–¢–ò –¶–Ü–ù–£
                        </button>
                        <div style="background: rgba(34, 197, 94, 0.05); padding: 12px; border-radius: 10px; margin-top: 15px; font-size: 11px; color: var(--text-gray);">
                            ‚ÑπÔ∏è –ü–æ—Ç–æ—á–Ω–∞ —Ü—ñ–Ω–∞: <span id="currentTicketPrice" style="color: var(--primary); font-weight: 900;">100</span> ‚ö™
                        </div>
                    </div>
                </div>

                <!-- TAB: PROMOTIONS -->
                <div id="tabPromo" class="admin-tab" style="display:none;">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">üî• –°–ò–°–¢–ï–ú–ê –ê–ö–¶–Ü–ô</h3>
                    
                    <div class="toggle-container">
                        <span style="font-weight: 700; color: white;">–ê–∫—Ü—ñ—è –∞–∫—Ç–∏–≤–Ω–∞</span>
                        <label class="switch">
                            <input type="checkbox" id="promoActiveToggle" onchange="togglePromo()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <label style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px; display: block;">
                            –ó–Ω–∏–∂–∫–∞ / –ù–∞—Ü—ñ–Ω–∫–∞ (%)
                        </label>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <input type="range" id="promoSlider" min="-50" max="50" value="0" step="5"
                                   style="flex: 1; height: 8px; accent-color: var(--primary);" oninput="updatePromoPreview()">
                            <div id="promoValueDisplay" style="min-width: 80px; font-weight: 900; font-size: 20px; color: var(--primary);">
                                0%
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                            <div style="font-size: 11px; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase;">
                                –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ —Ü—ñ–Ω–∏:
                            </div>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                                <span id="originalPrice" style="font-size: 18px; color: #666; text-decoration: line-through;">
                                    100 ‚ö™
                                </span>
                                <span style="font-size: 28px; color: var(--accent); font-weight: 900;">‚Üí</span>
                                <span id="newPrice" style="font-size: 28px; color: var(--primary); font-weight: 900;">
                                    100 ‚ö™
                                </span>
                            </div>
                            <div id="discountLabel" style="margin-top: 10px; font-size: 14px; font-weight: 800; text-align: center; color: var(--text-gray);">
                                –ë–ï–ó –ó–ú–Ü–ù
                            </div>
                        </div>
                        
                        <label style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px; display: block;">
                            –¢–µ–∫—Å—Ç –∞–∫—Ü—ñ—ó (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
                        </label>
                        <input type="text" id="promoTextInput" class="input" placeholder="–°–í–Ø–¢–ö–û–í–ê –ê–ö–¶–Ü–Ø! üéâ" maxlength="50">
                        
                        <button onclick="savePromoSettings()" class="btn-main btn-buy" style="margin-top: 15px; width: 100%;">
                            –ó–ë–ï–†–ï–ì–¢–ò –ê–ö–¶–Ü–Æ
                        </button>
                    </div>
                    
                    <!-- Auto Odds Toggle -->
                    <div style="background: rgba(255, 255, 255, 0.03); padding: 25px; border-radius: 15px; margin-top: 25px; border: 1px solid rgba(255, 255, 255, 0.05);">
                        <h4 style="color: var(--primary); margin-bottom: 20px;">üé≤ –°–∏—Å—Ç–µ–º–∞ —à–∞–Ω—Å—ñ–≤</h4>
                        <div class="toggle-container">
                            <span style="font-weight: 700; color: var(--text-gray);">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ —à–∞–Ω—Å–∏ (—Ä—ñ–≤–Ω–æ–º—ñ—Ä–Ω—ñ)</span>
                            <label class="switch">
                                <input type="checkbox" id="autoOddsToggle" onchange="toggleAutoOdds()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <p style="font-size: 12px; color: var(--text-gray); margin-top: 10px;">
                            –Ø–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ - –≤—Å—ñ –ø—Ä–∏–∑–∏ –º–∞—é—Ç—å –æ–¥–Ω–∞–∫–æ–≤—ñ —à–∞–Ω—Å–∏ –≤–∏–ø–∞–¥–∞–Ω–Ω—è –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å.
                        </p>
                    </div>
                </div>

                <!-- TAB: BALANCE -->
                <div id="tabBalance" class="admin-tab" style="display:none;">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">üíé –ü–û–ü–û–í–ù–ï–ù–ù–Ø –ë–ê–õ–ê–ù–°–£</h3>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px;">
                        <label style="font-size: 12px; color: var(--text-gray); display: block; margin-bottom: 8px;">
                            –û–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                        </label>
                        <select id="topUpUserSelect" class="select" onchange="updateTopUpBalances()">
                            <option value="">-- –û–±–µ—Ä—ñ—Ç—å –±—ñ–π—Ü—è --</option>
                        </select>
                        
                        <div id="currentBalances" style="display: none; margin: 25px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid var(--primary); border-radius: 15px; padding: 20px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 8px;">–ë–ê–õ–ò</div>
                                    <div style="font-size: 28px; font-weight: 900; color: var(--primary);">
                                        <span id="currentPoints">0</span> ‚ö™
                                    </div>
                                </div>
                                <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid var(--currency); border-radius: 15px; padding: 20px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 8px;">–ì–†–û–®–Ü</div>
                                    <div style="font-size: 28px; font-weight: 900; color: var(--currency);">
                                        <span id="currentCurrency">0</span> ‚Ç¥
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <label style="font-size: 12px; color: var(--text-gray); display: block; margin-bottom: 8px;">
                            –¢–∏–ø –±–∞–ª–∞–Ω—Å—É
                        </label>
                        <select id="topUpType" class="select">
                            <option value="points">‚ö™ –ë–∞–ª–∏</option>
                            <option value="currency">‚Ç¥ –ì—Ä–æ—à—ñ</option>
                        </select>
                        
                        <label style="font-size: 12px; color: var(--text-gray); display: block; margin: 15px 0 8px;">
                            –°—É–º–∞
                        </label>
                        <input type="number" id="topUpAmount" class="input" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É" min="1">
                        
                        <label style="font-size: 12px; color: var(--text-gray); display: block; margin: 15px 0 8px;">
                            –ö–æ–º–µ–Ω—Ç–∞—Ä (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
                        </label>
                        <input type="text" id="topUpComment" class="input" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –ø–æ–ø–æ–≤–Ω–µ–Ω–Ω—è...">
                        
                        <button onclick="processTopUp()" class="btn-main btn-buy" style="margin-top: 15px; width: 100%;">
                            –ü–û–ü–û–í–ù–ò–¢–ò
                        </button>
                    </div>
                </div>

                <!-- TAB: PRIZES (—Å–ª–æ—Ç–∏) -->
                <div id="tabPrizes" class="admin-tab" style="display:none;">
                    <h3 style="color: var(--primary); margin-bottom: 25px;">üéÅ –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –°–õ–û–¢–ê–ú–ò</h3>
                    
                    <!-- Prize Management Grid -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--accent); margin-bottom: 15px;">üé∞ –°–õ–û–¢–ò –†–£–õ–ï–¢–ö–ò</h4>
                        <div id="manageRouletteGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-bottom: 30px;"></div>
                        
                        <h4 style="color: var(--currency); margin-bottom: 15px;">üõí –°–õ–û–¢–ò –ú–ê–ì–ê–ó–ò–ù–£</h4>
                        <div id="manageShopGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;"></div>
                    </div>
                    
                    <div id="instructorNotice" style="display: none; background: rgba(251, 191, 36, 0.1); border: 1px solid var(--currency); padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 800; color: var(--currency); margin-bottom: 8px;">‚ö†Ô∏è –û–ë–ú–ï–ñ–ï–ù–ò–ô –î–û–°–¢–£–ü</div>
                        <p style="font-size: 12px; color: var(--text-gray); margin: 0;">
                            –Ü–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ —Å–ª–æ—Ç–∏. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è, —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–æ –ª–∏—à–µ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.
                        </p>
                    </div>
                    
                    <!-- Prize Form -->
                    <div style="background: rgba(255, 255, 255, 0.03); padding: 25px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.05);">
                        <h4 id="formTitle" style="color: var(--primary); margin-bottom: 20px;">–°–¢–í–û–†–ò–¢–ò –ù–û–í–ò–ô –°–õ–û–¢</h4>
                        
                        <label style="font-size: 12px; color: var(--text-gray); display: block; margin-bottom: 8px;">–ù–∞–∑–≤–∞ –ø—Ä–∏–∑—É</label>
                        <input type="text" id="newPrizeName" class="input" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: iPhone 15" style="margin-bottom: 15px;">
                        
                        <label style="font-size: 12px; color: var(--text-gray); display: block; margin-bottom: 8px;">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                        <select id="newPrizeCategory" class="select" onchange="togglePrizeSettings()" style="margin-bottom: 15px;">
                            <option value="roulette">üé∞ –†—É–ª–µ—Ç–∫–∞</option>
                            <option value="shop">üõí –ú–∞–≥–∞–∑–∏–Ω</option>
                        </select>
                        
                        <div id="rouletteSettings">
                            <label style="font-size: 12px; color: var(--text-gray); display: block; margin-bottom: 8px;">
                                –®–∞–Ω—Å –≤–∏–ø–∞–¥–∞–Ω–Ω—è (%) - –ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –≤–∏–º–∫–Ω–µ–Ω—ñ –∞–≤—Ç–æ—à–∞–Ω—Å–∏
                            </label>
                            <input type="number" id="newPrizeChance" class="input" value="10" min="0" max="100" step="0.1" style="margin-bottom: 15px;">
                        </div>
                        
                        <div id="shopSettings" style="display: none;">
                            <label style="font-size: 12px; color: var(--text-gray); display: block; margin-bottom: 8px;">–¶—ñ–Ω–∞ (–±–∞–ª–∏)</label>
                            <input type="number" id="newPrizePrice" class="input" value="100" min="1" style="margin-bottom: 15px;">
                        </div>
                        
                        <label style="font-size: 12px; color: var(--text-gray); display: block; margin-bottom: 8px;">–¢–∏–ø –¥—ñ—ó –ø—Ä–∏ –≤–∏–≥—Ä–∞—à—ñ</label>
                        <select id="newPrizeActionType" class="select" onchange="toggleActionVal()" style="margin-bottom: 15px;">
                            <option value="item">üì¶ –ü—Ä–µ–¥–º–µ—Ç (–±–µ–∑ –¥—ñ–π)</option>
                            <option value="points">‚ö™ –ù–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ –±–∞–ª–∏</option>
                            <option value="currency">üí∏ –ù–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ –≥—Ä–æ—à—ñ</option>
                            <option value="ticket">üé´ –ù–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ –∫–≤–∏—Ç–∫–∏</option>
                        </select>
                        
                        <div id="actionValContainer" style="display: none;">
                            <label style="font-size: 12px; color: var(--text-gray); display: block; margin-bottom: 8px;">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–ª—è –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è</label>
                            <input type="number" id="newPrizeActionVal" class="input" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å" min="1" style="margin-bottom: 15px;">
                        </div>
                        
                        <label style="font-size: 12px; color: var(--text-gray); display: block; margin-bottom: 8px;">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—Ä–∏–∑—É</label>
                        <input type="file" id="newPrizeImgFile" accept="image/*" onchange="previewSlotImage()" class="input" style="margin-bottom: 15px; padding: 12px;">
                        
                        <div style="text-align: center; margin-bottom: 15px;">
                            <img id="slotImgPreview" style="max-width: 150px; max-height: 150px; border-radius: 10px; display: none; border: 2px solid var(--primary);">
                        </div>
                        
                        <div id="prizeFormActions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button id="cancelEditBtn" onclick="window.resetPrizeForm()" class="btn-main" style="background: #333; color: white; display: none;">
                                –°–ö–ê–°–£–í–ê–¢–ò
                            </button>
                            <button id="savePrizeBtn" onclick="savePrize()" class="btn-main btn-buy" style="grid-column: span 2;">
                                –ó–ë–ï–†–ï–ì–¢–ò
                            </button>
                        </div>
                    </div>
                </div>

                <!-- TAB: LOGS (original content) -->
                <div id="tabLogs" class="admin-tab" style="display:none;">
                    <div id="logsList" style="min-height: 300px; background: #000; border: 2px solid #333; border-radius: 8px; padding: 15px; font-family: 'Courier New', Courier, monospace; color: #00ff41;">
                        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª–æ–≥—ñ–≤...
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- EXCHANGE MODAL -->
<div id="exchangeModal" class="modal">
    <div class="modal-inner">
        <h2 style="color: var(--primary); margin-bottom: 20px; font-size: 24px;">üí± –û–ë–ú–Ü–ù–ù–ò–ö</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid var(--primary); border-radius: 15px; padding: 20px; text-align: center;">
                <div style="font-size: 11px; color: var(--text-gray); margin-bottom: 5px;">–ë–ê–õ–ò</div>
                <div style="font-size: 24px; font-weight: 900; color: var(--primary);">
                    <span id="exPointsVal">0</span> ‚ö™
                </div>
            </div>
            <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid var(--currency); border-radius: 15px; padding: 20px; text-align: center;">
                <div style="font-size: 11px; color: var(--text-gray); margin-bottom: 5px;">–ì–†–û–®–Ü</div>
                <div style="font-size: 24px; font-weight: 900; color: var(--currency);">
                    <span id="exCurrencyVal">0</span> ‚Ç¥
                </div>
            </div>
        </div>
        
        <div style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 11px; color: var(--text-gray); margin-bottom: 5px;">–ö–£–†–° –û–ë–ú–Ü–ù–£</div>
            <div style="font-size: 20px; font-weight: 900; color: var(--primary);">
                1 ‚ö™ = <span id="exchangeRate">500</span> ‚Ç¥
            </div>
        </div>
        
        <label style="font-size: 12px; color: var(--text-gray); display: block; margin-bottom: 8px;">
            –©–æ —Ö–æ—á–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏?
        </label>
        <select id="exchangeOperation" class="select" onchange="updateExchangeUI()" style="margin-bottom: 20px;">
            <option value="exchange">üí± –û–±–º—ñ–Ω—è—Ç–∏ –±–∞–ª–∏ –Ω–∞ –≥—Ä–æ—à—ñ</option>
            <option value="withdrawMoney">üí∏ –í–∏–≤–µ—Å—Ç–∏ –≥—Ä–æ—à—ñ –∑ —Ä–∞—Ö—É–Ω–∫—É</option>
            <option value="withdrawPoints">‚ö™ –í–∏–≤–µ—Å—Ç–∏ –±–∞–ª–∏ –∑ —Ä–∞—Ö—É–Ω–∫—É</option>
        </select>
        
        <label style="font-size: 12px; color: var(--text-gray); display: block; margin-bottom: 8px;">
            –°—É–º–∞
        </label>
        <input type="number" id="exchangeAmount" class="input" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É" min="1" oninput="calculateExchange()" style="margin-bottom: 20px;">
        
        <div id="exchangePreview" style="background: rgba(34, 197, 94, 0.05); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--glass-border); display: none;">
            <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 10px; text-align: center;">
                –†–ï–ó–£–õ–¨–¢–ê–¢ –û–ü–ï–†–ê–¶–Ü–á:
            </div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 11px; color: var(--text-gray);">–°–ü–ò–°–ê–ù–û</div>
                    <div style="font-size: 20px; font-weight: 900; color: var(--danger);">
                        - <span id="previewFromAmount">0</span> <span id="previewFromCurrency">‚ö™</span>
                    </div>
                </div>
                <div style="font-size: 24px; color: var(--primary);">‚Üí</div>
                <div id="previewTo" style="text-align: center;">
                    <div style="font-size: 11px; color: var(--text-gray);">–û–¢–†–ò–ú–ê–ù–û</div>
                    <div style="font-size: 20px; font-weight: 900; color: var(--primary);">
                        + <span id="previewToAmount">0</span> <span id="previewToCurrency">‚Ç¥</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <button onclick="closeExchangeModal()" class="btn-main" style="background: #333; color: white;">
                –°–ö–ê–°–£–í–ê–¢–ò
            </button>
            <button onclick="processExchange()" id="exchangeBtn" class="btn-main btn-buy">
                –í–ò–ö–û–ù–ê–¢–ò
            </button>
        </div>
    </div>
</div>

<!-- PURCHASE MODAL -->
<div id="purchaseModal" class="modal">
    <div class="modal-inner">
        <h2 style="color: var(--primary); margin-bottom: 20px;">üé´ –ö–£–ü–Ü–í–õ–Ø –ö–í–ò–¢–ö–Ü–í</h2>
        <input type="number" id="ticketCount" class="input" value="1" min="1" oninput="updateTotalCost()" style="margin-bottom: 15px;">
        <div style="font-size: 24px; font-weight: 900; color: var(--primary); margin-bottom: 20px;">
            –í–°–¨–û–ì–û: <span id="totalCostDisplay">100 ‚ö™</span>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <button onclick="document.getElementById('purchaseModal').style.display='none'" class="btn-main" style="background: #333; color: white;">
                –°–ö–ê–°–£–í–ê–¢–ò
            </button>
            <button onclick="confirmPurchase()" class="btn-main btn-buy">
                –ö–£–ü–ò–¢–ò
            </button>
        </div>
    </div>
</div>

<div class="status-bar">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span style="width: 6px; height: 6px; border-radius: 50%; background: var(--primary); box-shadow: 0 0 8px var(--primary);"></span>
        <span>–°–ò–°–¢–ï–ú–ê –ê–ö–¢–ò–í–ù–ê</span>
    </div>
    <div id="footerPageLabel" style="color: white; background: rgba(34, 197, 94, 0.1); padding: 4px 10px; border-radius: 4px;">
        ROULETTE
    </div>
    <div id="footerRoleLabel" style="color: var(--primary);">USER</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, onSnapshot, getDocs, deleteDoc, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyATUpLUHSp1VbyxkJXhMS-2R71zNOBGC00",
        authDomain: "dsv-gta.firebaseapp.com",
        projectId: "dsv-gta",
        storageBucket: "dsv-gta.firebasestorage.app",
        messagingSenderId: "661591588818",
        appId: "1:661591588818:web:a8e8dca3d061447e24d20b"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let user = null;
    let userData = {};
    let currentUID = null;
    let prizePool = [];
    let isSpinning = false;
    let isSpinRequested = false;
    let isProcessing = false;
    
    const CARD_WIDTH = 220;
    const TOTAL_CARDS = 100;
    const SPIN_TIME_SECONDS = 8;
    
    let currentPromotion = { isActive: false, percentage: 0, promoText: "" };
    let allUsers = [];
    let rouletteState = { isSpinning: false, spinStartTime: null, targetPrize: null, userId: null };
    let isAutoOdds = false;
    let editingId = null;
    let currentSlotBase64 = null;

    // === HELPER FUNCTIONS ===
    function notify(msg) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerText = msg;
        document.getElementById('toastContainer').appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function showProcessing(title, text) {
        document.getElementById('procTitle').innerText = title;
        document.getElementById('procText').innerText = text;
        document.getElementById('processingModal').style.display = 'flex';
    }

    function hideProcessing() {
        document.getElementById('processingModal').style.display = 'none';
    }

    // === TICKET PRICE SYSTEM ===
    async function loadTicketPrice() {
        try {
            const docRef = doc(db, "settings", "ticketPrice");
            const snap = await getDoc(docRef);
            
            if (snap.exists()) {
                const price = snap.data().basePrice;
                document.getElementById('ticketPriceInput').value = price;
                document.getElementById('currentTicketPrice').innerText = price;
                updateBuyButtonPrice(price);
            }
        } catch (e) {
            console.error("Load ticket price error:", e);
        }
    }

    window.saveTicketPrice = async function() {
        const newPrice = parseInt(document.getElementById('ticketPriceInput').value);
        
        if (!newPrice || newPrice < 1) {
            notify('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Ü—ñ–Ω—É!');
            return;
        }
        
        try {
            await setDoc(doc(db, "settings", "ticketPrice"), {
                basePrice: newPrice,
                updatedAt: serverTimestamp(),
                updatedBy: userData.name
            });
            
            notify('–¶—ñ–Ω–∞ –∫–≤–∏—Ç–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–∞!');
            document.getElementById('currentTicketPrice').innerText = newPrice;
            updateBuyButtonPrice(newPrice);
            
            await addLog('UPDATE_TICKET_PRICE', `–ó–º—ñ–Ω–µ–Ω–æ —Ü—ñ–Ω—É –∫–≤–∏—Ç–∫–∞ –Ω–∞ ${newPrice} –±–∞–ª—ñ–≤`);
        } catch (err) {
            notify('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + err.message);
        }
    };

    function updateBuyButtonPrice(price) {
        const priceText = document.getElementById('ticketPriceLabel');
        if (priceText) {
            priceText.innerText = `–í–ê–†–¢–Ü–°–¢–¨: ${price} ‚ö™`;
        }
    }

    // === PROMOTION SYSTEM ===
    async function loadPromoSettings() {
        try {
            const docRef = doc(db, "settings", "promotion");
            const snap = await getDoc(docRef);
            
            if (snap.exists()) {
                currentPromotion = snap.data();
                
                document.getElementById('promoActiveToggle').checked = currentPromotion.isActive;
                document.getElementById('promoSlider').value = currentPromotion.percentage;
                document.getElementById('promoTextInput').value = currentPromotion.promoText || "";
                
                updatePromoPreview();
                updatePromoBanner();
            }
        } catch (e) {
            console.error("Load promo error:", e);
        }
    }

    window.updatePromoPreview = function() {
        const basePrice = parseInt(document.getElementById('currentTicketPrice').innerText) || 100;
        const percentage = parseInt(document.getElementById('promoSlider').value);
        const newPrice = Math.round(basePrice * (1 + percentage / 100));
        
        document.getElementById('promoValueDisplay').innerText = (percentage > 0 ? '+' : '') + percentage + '%';
        document.getElementById('originalPrice').innerText = basePrice + ' ‚ö™';
        document.getElementById('newPrice').innerText = newPrice + ' ‚ö™';
        
        const newPriceEl = document.getElementById('newPrice');
        const discountLabel = document.getElementById('discountLabel');
        
        if (percentage < 0) {
            newPriceEl.style.color = 'var(--primary)';
            discountLabel.innerHTML = `üí∞ –ó–ù–ò–ñ–ö–ê ${Math.abs(percentage)}%`;
            discountLabel.style.color = 'var(--primary)';
        } else if (percentage > 0) {
            newPriceEl.style.color = 'var(--danger)';
            discountLabel.innerHTML = `üìà –ù–ê–¶–Ü–ù–ö–ê +${percentage}%`;
            discountLabel.style.color = 'var(--danger)';
        } else {
            newPriceEl.style.color = 'var(--text-gray)';
            discountLabel.innerHTML = `–ë–ï–ó –ó–ú–Ü–ù`;
            discountLabel.style.color = 'var(--text-gray)';
        }
    };

    window.togglePromo = function() {
        const isActive = document.getElementById('promoActiveToggle').checked;
        notify(isActive ? '–ê–∫—Ü—ñ—è –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞! –ó–±–µ—Ä–µ–∂—ñ—Ç—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.' : '–ê–∫—Ü—ñ—è –¥–µ–∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞!');
    };

    window.savePromoSettings = async function() {
        const isActive = document.getElementById('promoActiveToggle').checked;
        const percentage = parseInt(document.getElementById('promoSlider').value);
        const promoText = document.getElementById('promoTextInput').value.trim();
        
        try {
            await setDoc(doc(db, "settings", "promotion"), {
                isActive: isActive,
                percentage: percentage,
                promoText: promoText,
                updatedAt: serverTimestamp(),
                updatedBy: userData.name
            });
            
            currentPromotion = { isActive, percentage, promoText };
            
            notify('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–∫—Ü—ñ—ó –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
            updatePromoBanner();
            
            await addLog('UPDATE_PROMOTION', `–ê–∫—Ü—ñ—è: ${isActive ? '–ê–ö–¢–ò–í–ù–ê' : '–ù–ï–ê–ö–¢–ò–í–ù–ê'}, ${percentage}%`);
        } catch (err) {
            notify('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + err.message);
        }
    };

    function updatePromoBanner() {
        const banner = document.getElementById('promoBanner');
        
        if (currentPromotion.isActive) {
            banner.style.display = 'block';
            
            const basePrice = parseInt(document.getElementById('currentTicketPrice').innerText) || 100;
            const newPrice = calculatePromoPrice();
            const percentage = currentPromotion.percentage;
            
            document.getElementById('promoBannerText').innerText = currentPromotion.promoText || '–ê–ö–¶–Ü–Ø!';
            document.getElementById('promoOldPrice').innerText = basePrice;
            document.getElementById('promoNewPrice').innerText = newPrice;
            
            const label = document.getElementById('promoPercentLabel');
            if (percentage < 0) {
                label.innerText = `${Math.abs(percentage)}% –ó–ù–ò–ñ–ö–ê`;
                label.style.background = 'var(--primary)';
            } else {
                label.innerText = `+${percentage}% –ù–ê–¶–Ü–ù–ö–ê`;
                label.style.background = 'var(--danger)';
            }
            
            updateBuyButtonPrice(newPrice);
        } else {
            banner.style.display = 'none';
            const basePrice = parseInt(document.getElementById('currentTicketPrice').innerText) || 100;
            updateBuyButtonPrice(basePrice);
        }
    }

    function calculatePromoPrice() {
        const basePrice = parseInt(document.getElementById('currentTicketPrice').innerText) || 100;
        
        if (currentPromotion.isActive) {
            return Math.round(basePrice * (1 + currentPromotion.percentage / 100));
        }
        
        return basePrice;
    }

    // === BALANCE MANAGEMENT ===
    async function loadUsersForTopUp() {
        const snapshot = await getDocs(collection(db, "users"));
        allUsers = [];
        const select = document.getElementById('topUpUserSelect');
        select.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –±—ñ–π—Ü—è --</option>';
        
        snapshot.forEach(doc => {
            const user = { id: doc.id, ...doc.data() };
            
            // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ñ–≤ —Ç–∞ –∞–¥–º—ñ–Ω—ñ–≤
            if (user.role === 'instructor' || user.role === 'admin') {
                allUsers.push(user);
                
                const option = document.createElement('option');
                option.value = doc.id;
                option.innerText = `${user.name} (${user.rank || user.role})`;
                select.appendChild(option);
            }
        });
    }

    window.updateTopUpBalances = async function() {
        const userId = document.getElementById('topUpUserSelect').value;
        
        if (!userId) {
            document.getElementById('currentBalances').style.display = 'none';
            return;
        }
        
        const user = allUsers.find(u => u.id === userId);
        
        if (user) {
            document.getElementById('currentBalances').style.display = 'block';
            document.getElementById('currentPoints').innerText = user.points || 0;
            document.getElementById('currentCurrency').innerText = user.currency || 0;
        }
    };

    window.processTopUp = async function() {
        const userId = document.getElementById('topUpUserSelect').value;
        const type = document.getElementById('topUpType').value;
        const amount = parseInt(document.getElementById('topUpAmount').value);
        const comment = document.getElementById('topUpComment').value.trim();
        
        if (!userId) {
            notify('–û–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞!');
            return;
        }
        
        if (!amount || amount < 1) {
            notify('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É!');
            return;
        }
        
        try {
            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);
            const currentValue = userSnap.data()[type] || 0;
            
            await updateDoc(userRef, {
                [type]: currentValue + amount
            });
            
            const userName = userSnap.data().name;
            const typeLabel = type === 'points' ? '–±–∞–ª—ñ–≤' : '–≥—Ä–∏–≤–µ–Ω—å';
            
            notify(`+${amount} ${typeLabel} –¥–ª—è ${userName}!`);
            
            await addLog('TOP_UP_BALANCE', `${userName}: +${amount} ${typeLabel}${comment ? ' (' + comment + ')' : ''}`);
            
            document.getElementById('topUpUserSelect').value = '';
            document.getElementById('topUpAmount').value = '';
            document.getElementById('topUpComment').value = '';
            document.getElementById('currentBalances').style.display = 'none';
            
            await loadUsersForTopUp();
        } catch (err) {
            notify('–ü–æ–º–∏–ª–∫–∞ –ø–æ–ø–æ–≤–Ω–µ–Ω–Ω—è: ' + err.message);
        }
    };

    // === EXCHANGE SYSTEM ===
    window.openExchangeModal = function() {
        document.getElementById('exchangeModal').style.display = 'flex';
        document.getElementById('exPointsVal').innerText = userData.points || 0;
        document.getElementById('exCurrencyVal').innerText = userData.currency || 0;
        updateExchangeUI();
    };

    window.closeExchangeModal = function() {
        document.getElementById('exchangeModal').style.display = 'none';
        document.getElementById('exchangeAmount').value = '';
        document.getElementById('exchangePreview').style.display = 'none';
    };

    window.updateExchangeUI = function() {
        const operation = document.getElementById('exchangeOperation').value;
        const exchangeBtn = document.getElementById('exchangeBtn');
        
        switch(operation) {
            case 'exchange':
                exchangeBtn.innerText = '–û–ë–ú–Ü–ù–Ø–¢–ò';
                break;
            case 'withdrawMoney':
                exchangeBtn.innerText = '–í–ò–í–ï–°–¢–ò –ì–†–û–®–Ü';
                break;
            case 'withdrawPoints':
                exchangeBtn.innerText = '–í–ò–í–ï–°–¢–ò –ë–ê–õ–ò';
                break;
        }
        
        calculateExchange();
    };

    window.calculateExchange = function() {
        const operation = document.getElementById('exchangeOperation').value;
        const amount = parseInt(document.getElementById('exchangeAmount').value);
        
        if (!amount || amount < 1) {
            document.getElementById('exchangePreview').style.display = 'none';
            return;
        }
        
        const rate = 500; // Default rate
        const preview = document.getElementById('exchangePreview');
        
        preview.style.display = 'block';
        
        switch(operation) {
            case 'exchange':
                document.getElementById('previewFromAmount').innerText = amount;
                document.getElementById('previewFromCurrency').innerText = '‚ö™';
                document.getElementById('previewToAmount').innerText = amount * rate;
                document.getElementById('previewToCurrency').innerText = '‚Ç¥';
                document.getElementById('previewTo').style.display = 'block';
                break;
            case 'withdrawMoney':
                document.getElementById('previewFromAmount').innerText = amount;
                document.getElementById('previewFromCurrency').innerText = '‚Ç¥';
                document.getElementById('previewTo').style.display = 'none';
                break;
            case 'withdrawPoints':
                document.getElementById('previewFromAmount').innerText = amount;
                document.getElementById('previewFromCurrency').innerText = '‚ö™';
                document.getElementById('previewTo').style.display = 'none';
                break;
        }
    };

    window.processExchange = async function() {
        const operation = document.getElementById('exchangeOperation').value;
        const amount = parseInt(document.getElementById('exchangeAmount').value);
        
        if (!amount || amount < 1) {
            notify('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É!');
            return;
        }
        
        const userRef = doc(db, "users", currentUID);
        const rate = 500;
        
        try {
            switch(operation) {
                case 'exchange':
                    if (userData.points < amount) {
                        notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –±–∞–ª—ñ–≤!');
                        return;
                    }
                    
                    await updateDoc(userRef, {
                        points: userData.points - amount,
                        currency: (userData.currency || 0) + (amount * rate)
                    });
                    
                    notify(`–û–±–º—ñ–Ω—è–Ω–æ ${amount} ‚ö™ –Ω–∞ ${amount * rate} ‚Ç¥`);
                    await addLog('EXCHANGE', `–û–±–º—ñ–Ω: ${amount} –±–∞–ª—ñ–≤ ‚Üí ${amount * rate} –≥—Ä–∏–≤–µ–Ω—å`);
                    break;
                    
                case 'withdrawMoney':
                    if ((userData.currency || 0) < amount) {
                        notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≥—Ä–æ—à–µ–π!');
                        return;
                    }
                    
                    await updateDoc(userRef, {
                        currency: userData.currency - amount
                    });
                    
                    notify(`–í–∏–≤–µ–¥–µ–Ω–æ ${amount} ‚Ç¥`);
                    await addLog('WITHDRAW_MONEY', `–í–∏–≤–µ–¥–µ–Ω–Ω—è –≥—Ä–æ—à–µ–π: ${amount} –≥—Ä–∏–≤–µ–Ω—å`);
                    break;
                    
                case 'withdrawPoints':
                    if (userData.points < amount) {
                        notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –±–∞–ª—ñ–≤!');
                        return;
                    }
                    
                    await updateDoc(userRef, {
                        points: userData.points - amount
                    });
                    
                    notify(`–í–∏–≤–µ–¥–µ–Ω–æ ${amount} ‚ö™`);
                    await addLog('WITHDRAW_POINTS', `–í–∏–≤–µ–¥–µ–Ω–Ω—è –±–∞–ª—ñ–≤: ${amount} –±–∞–ª—ñ–≤`);
                    break;
            }
            
            closeExchangeModal();
        } catch (err) {
            notify('–ü–æ–º–∏–ª–∫–∞ –æ–ø–µ—Ä–∞—Ü—ñ—ó: ' + err.message);
        }
    };

    // === SPIN LOCK SYSTEM ===
    function saveRouletteState() {
        localStorage.setItem('rouletteState', JSON.stringify(rouletteState));
    }

    function loadRouletteState() {
        const saved = localStorage.getItem('rouletteState');
        if (saved) {
            rouletteState = JSON.parse(saved);
            
            if (rouletteState.isSpinning) {
                lockNavigation();
            }
        }
    }

    function lockNavigation() {
        rouletteState.isSpinning = true;
        saveRouletteState();
        
        const overlay = document.getElementById('spinLockOverlay');
        if (overlay) {
            overlay.style.display = 'flex';
        }
        
        document.querySelectorAll('.menu-btn, a[href]').forEach(el => {
            el.style.pointerEvents = 'none';
            el.style.opacity = '0.5';
        });
    }

    function unlockNavigation() {
        rouletteState.isSpinning = false;
        rouletteState.spinStartTime = null;
        saveRouletteState();
        
        const overlay = document.getElementById('spinLockOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
        
        document.querySelectorAll('.menu-btn, a[href]').forEach(el => {
            el.style.pointerEvents = 'auto';
            el.style.opacity = '1';
        });
    }

    // === TICKET PURCHASE ===
    window.openPurchaseModal = function() {
        document.getElementById('purchaseModal').style.display = 'flex';
        document.getElementById('ticketCount').value = 1;
        updateTotalCost();
    };

    window.updateTotalCost = function() {
        let count = parseInt(document.getElementById('ticketCount').value) || 1;
        if(count < 1) count = 1;
        const price = calculatePromoPrice();
        document.getElementById('totalCostDisplay').innerText = (count * price) + " ‚ö™";
    };

    window.confirmPurchase = async function() {
        let count = parseInt(document.getElementById('ticketCount').value) || 1;
        if (!count || count <= 0) return notify("–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å!");

        const price = calculatePromoPrice();
        const cost = count * price;
        const pts = userData.points || 0;

        if(pts < cost) return notify("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –±–∞–ª—ñ–≤!");
        
        document.getElementById('purchaseModal').style.display = 'none';
        showProcessing("–ö–í–ò–¢–ö–ò", `–ö—É–ø—ñ–≤–ª—è ${count} –∫–≤–∏—Ç–∫—ñ–≤...`);

        try {
            await updateDoc(doc(db, "users", currentUID), { 
                points: pts - cost, 
                roulette_passes: (userData.roulette_passes || 0) + count 
            });
            
            await addLog('TICKET_PURCHASE', `–ö—É–ø–∏–≤ ${count} –∫–≤–∏—Ç–∫—ñ–≤ –∑–∞ ${cost} –±–∞–ª—ñ–≤`);
            notify(`–ö—É–ø–ª–µ–Ω–æ ${count} –∫–≤–∏—Ç–∫—ñ–≤!`);
        } catch(e) {
            notify("–ü–æ–º–∏–ª–∫–∞: " + e.message);
        } finally {
            hideProcessing();
        }
    };

    // === SPIN LOGIC ===
    function createPrizeNode(p) {
        const el = document.createElement('div');
        el.className = 'prize-card';
        el.innerHTML = `<img src="${p.img || 'https://via.placeholder.com/110'}"><span>${p.name || 'Prize'}</span>`;
        return el;
    }

    function initTrack(prizes) {
        const track = document.getElementById('track');
        if (!track || prizes.length === 0) return;
        
        track.innerHTML = "";
        for (let i = 0; i < TOTAL_CARDS; i++) {
            const p = prizes[Math.floor(Math.random() * prizes.length)];
            track.appendChild(createPrizeNode(p));
        }
    }

    window.startSpin = async function() {
        if (isSpinRequested || isSpinning) return;
        isSpinRequested = true;
        
        const spinBtn = document.getElementById('spinBtn');
        spinBtn.disabled = true;
        
        if (!userData || userData.roulette_passes < 1) {
            notify("–ù–µ–º–∞—î –∫–≤–∏—Ç–∫—ñ–≤!");
            isSpinRequested = false;
            spinBtn.disabled = false;
            return;
        }
        
        // Lock navigation
        lockNavigation();
        
        try {
            await updateDoc(doc(db, "users", currentUID), { 
                roulette_passes: Math.max(0, (userData.roulette_passes || 0) - 1) 
            });
            
            document.getElementById('winOverlay').style.display = 'none';
            
            const track = document.getElementById('track');
            const rouletteItems = prizePool.filter(p => !p.category || p.category === 'roulette');
            
            if (rouletteItems.length === 0) {
                notify('–ù–µ–º–∞—î –ø—Ä–∏–∑—ñ–≤ –≤ —Ä—É–ª–µ—Ç—Ü—ñ!');
                unlockNavigation();
                isSpinRequested = false;
                spinBtn.disabled = false;
                return;
            }
            
            const winPrize = rouletteItems[Math.floor(Math.random() * rouletteItems.length)];
            
            const targetIndex = 55;
            const targetCard = track.children[targetIndex];
            
            if (targetCard) {
                const img = targetCard.querySelector('img');
                const txt = targetCard.querySelector('span');
                if(img) img.src = winPrize.img || 'https://via.placeholder.com/110';
                if(txt) txt.innerText = winPrize.name;
            }
            
            const containerWidth = document.querySelector('.carousel-outer').offsetWidth;
            const targetCenter = (targetIndex * CARD_WIDTH) + (CARD_WIDTH / 2);
            const scrollAmount = targetCenter - (containerWidth / 2);
            
            isSpinning = true;
            
            track.style.transition = `transform ${SPIN_TIME_SECONDS}s cubic-bezier(0.15, 0, 0.2, 1)`;
            track.style.transform = `translateX(-${scrollAmount}px)`;
            
            setTimeout(async () => {
                isSpinning = false;
                
                document.getElementById('winPrizeName').innerText = winPrize.name;
                document.getElementById('winOverlay').style.display = 'flex';
                
                notify(`–í–∏–≥—Ä–∞—à: ${winPrize.name}`);
                
                await processWin(winPrize);
                
                setTimeout(() => {
                    document.getElementById('winOverlay').style.display = 'none';
                    track.style.transition = 'none';
                    track.style.transform = 'translateX(0)';
                    initTrack(rouletteItems);
                    
                    unlockNavigation();
                    isSpinRequested = false;
                    spinBtn.disabled = false;
                }, 3000);
            }, SPIN_TIME_SECONDS * 1000);
            
        } catch(e) {
            notify("–ü–æ–º–∏–ª–∫–∞: " + e.message);
            unlockNavigation();
            isSpinRequested = false;
            spinBtn.disabled = false;
        }
    };

    async function processWin(prize) {
        try {
            const action = prize.action || 'item';
            const actionVal = parseInt(prize.actionVal) || 0;
            
            if (action === 'points') {
                await updateDoc(doc(db, "users", currentUID), {
                    points: (userData.points || 0) + actionVal
                });
            } else if (action === 'currency') {
                await updateDoc(doc(db, "users", currentUID), {
                    currency: (userData.currency || 0) + actionVal
                });
            } else if (action === 'ticket') {
                await updateDoc(doc(db, "users", currentUID), {
                    roulette_passes: (userData.roulette_passes || 0) + actionVal
                });
            }
            
            await addLog('ROULETTE_WIN', `–í–∏–≥—Ä–∞–≤: ${prize.name}`);
        } catch (e) {
            console.error("Process win error:", e);
        }
    }

    // === LOGS ===
    async function addLog(action, desc) {
        try {
            await addDoc(collection(db, "logs"), {
                user: userData.name || 'Unknown',
                action: action,
                desc: desc,
                timestamp: serverTimestamp()
            });
        } catch (e) {
            console.error("Add log error:", e);
        }
    }

    async function loadLogs() {
        const q = query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(50));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('logsList');
            if(!list) return;
            list.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                const time = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleTimeString() : "???";
                list.innerHTML += `
                    <div style="border-bottom: 1px dashed #333; padding: 8px 0;">
                        <span style="color: #666;">[${time}]</span>
                        <span style="color: #00bfff;">${data.user}</span>
                        <span style="color: #fff;"> ${data.action}</span>
                        <span style="color: #ddd;"> - ${data.desc}</span>
                    </div>`;
            });
        });
    }

    // === NAVIGATION ===
    window.showPage = function(pageId, btn) {
        document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
        document.getElementById(pageId + 'Page').classList.add('active');
        
        document.querySelectorAll('.sidebar .menu-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');

        document.getElementById('footerPageLabel').innerText = pageId.toUpperCase();
    };

    window.switchAdminTab = function(tabId, btn) {
        document.querySelectorAll('.admin-tab').forEach(el => el.style.display = 'none');
        document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).style.display = 'block';
        
        document.querySelectorAll('.admin-box .menu-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    };

    // === AUTH & INIT ===
    onAuthStateChanged(auth, async (u) => {
        if (!u) {
            window.location.href = "index.html";
            return;
        }
        
        user = u;
        currentUID = u.uid;
        
        onSnapshot(doc(db, "users", u.uid), (s) => {
            userData = s.data() || {};
            
            document.getElementById('pointsVal').innerText = userData.points || 0;
            document.getElementById('currencyVal').innerText = userData.currency || 0;
            const tickets = userData.roulette_passes || 0;
            document.getElementById('ticketsVal').innerText = tickets;
            document.getElementById('ticketsVal2').innerText = tickets;
            document.getElementById('footerRoleLabel').innerText = (userData.role || 'user').toUpperCase();
            
            const spinBtn = document.getElementById('spinBtn');
            spinBtn.disabled = tickets < 1 || isSpinning;
            
            if (['admin', 'instructor'].includes(userData.role)) {
                document.getElementById('adminBtn').style.display = 'block';
                loadUsersForTopUp();
                loadLogs();
            }
        });

        loadTicketPrice();
        loadPromoSettings();
        loadAutoOdds();
        loadRouletteState();
        loadPrizes();
        applyRoleRestrictions();
    });


    // === AUTO ODDS SYSTEM ===
    window.toggleAutoOdds = async function() {
        if (userData.role !== 'admin') {
            notify("–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω –º–æ–∂–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Ü–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è!");
            document.getElementById('autoOddsToggle').checked = isAutoOdds;
            return;
        }
        
        isAutoOdds = document.getElementById('autoOddsToggle').checked;
        
        try {
            await setDoc(doc(db, "settings", "autoOdds"), {
                enabled: isAutoOdds,
                updatedAt: serverTimestamp(),
                updatedBy: userData.name
            });
            
            notify(isAutoOdds ? '–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ —à–∞–Ω—Å–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–æ!' : '–†—É—á–Ω—ñ —à–∞–Ω—Å–∏ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ!');
            renderManage();
            
            await addLog('UPDATE_AUTO_ODDS', `–ê–≤—Ç–æ—à–∞–Ω—Å–∏: ${isAutoOdds ? '–£–í–Ü–ú–ö–ù–ï–ù–û' : '–í–ò–ú–ö–ù–ï–ù–û'}`);
        } catch (err) {
            notify('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + err.message);
        }
    };

    async function loadAutoOdds() {
        try {
            const docRef = doc(db, "settings", "autoOdds");
            const snap = await getDoc(docRef);
            
            if (snap.exists()) {
                isAutoOdds = snap.data().enabled || false;
                document.getElementById('autoOddsToggle').checked = isAutoOdds;
            }
        } catch (e) {
            console.error("Load auto odds error:", e);
        }
    }

    // === PRIZE MANAGEMENT ===
    window.previewSlotImage = function() {
        const file = document.getElementById('newPrizeImgFile').files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            currentSlotBase64 = e.target.result;
            const img = document.getElementById('slotImgPreview');
            img.src = currentSlotBase64;
            img.style.display = 'block';
        };
        reader.readAsDataURL(file);
    };

    window.togglePrizeSettings = function() {
        const cat = document.getElementById('newPrizeCategory').value;
        document.getElementById('rouletteSettings').style.display = cat === 'roulette' ? 'block' : 'none';
        document.getElementById('shopSettings').style.display = cat === 'shop' ? 'block' : 'none';
    };

    window.toggleActionVal = function() {
        const action = document.getElementById('newPrizeActionType').value;
        document.getElementById('actionValContainer').style.display = action !== 'item' ? 'block' : 'none';
    };

    window.editPrize = function(id) {
        if (userData.role !== 'admin') return notify("–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω –º–æ–∂–µ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏!");
        
        editingId = id;
        const p = prizePool.find(prize => prize.id === id);
        if (!p) return;
        
        document.getElementById('newPrizeName').value = p.name;
        document.getElementById('newPrizeCategory').value = p.category || 'roulette';
        togglePrizeSettings();
        
        document.getElementById('newPrizeActionType').value = p.action || 'item';
        toggleActionVal();
        
        if (p.category === 'roulette') {
            document.getElementById('newPrizeChance').value = p.chance || 10;
        }
        if (p.category === 'shop') {
            document.getElementById('newPrizePrice').value = p.price || 0;
        }
        
        document.getElementById('newPrizeActionVal').value = p.actionVal || "";
        
        currentSlotBase64 = p.img;
        const img = document.getElementById('slotImgPreview');
        img.src = p.img;
        img.style.display = 'block';

        document.getElementById('formTitle').innerText = "–†–ï–î–ê–ì–£–í–ê–¢–ò –°–õ–û–¢";
        document.getElementById('savePrizeBtn').innerText = "–û–ù–û–í–ò–¢–ò –°–õ–û–¢";
        document.getElementById('cancelEditBtn').style.display = 'block';
        
        document.getElementById('tabPrizes').scrollIntoView({behavior: "smooth"});
    };

    window.savePrize = async () => {
        if (userData.role !== 'admin') return notify("–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω!");
        const name = document.getElementById('newPrizeName').value;
        const cat = document.getElementById('newPrizeCategory').value;
        const act = document.getElementById('newPrizeActionType').value;
        
        if (!name) return notify("–ù–∞–∑–≤–∞ –æ–±–æ–≤'—è–∑–∫–æ–≤–∞!");
        if (!editingId && !currentSlotBase64) return notify("–§–æ—Ç–æ –æ–±–æ–≤'—è–∑–∫–æ–≤–µ!");

        const data = { name, category: cat, action: act };
        
        if (currentSlotBase64) data.img = currentSlotBase64;
        
        if (cat === 'roulette') {
            data.chance = parseFloat(document.getElementById('newPrizeChance').value) || 0;
        } else {
            data.price = parseInt(document.getElementById('newPrizePrice').value) || 0;
        }

        if (act !== 'item') {
            data.actionVal = document.getElementById('newPrizeActionVal').value;
        }

        if (editingId) {
            await updateDoc(doc(db, "roulette_prizes", editingId), data);
            notify("–°–ª–æ—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ!");
            window.resetPrizeForm();
        } else {
            await addDoc(collection(db, "roulette_prizes"), data);
            notify("–°–ª–æ—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ!");
            window.resetPrizeForm();
        }
    };

    window.deletePrize = async (id) => {
        if (userData.role !== 'admin') return notify("–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω!");
        if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Å–ª–æ—Ç –Ω–∞–∑–∞–≤–∂–¥–∏?")) {
            await deleteDoc(doc(db, "roulette_prizes", id));
            notify("–°–ª–æ—Ç –≤–∏–¥–∞–ª–µ–Ω–æ");
        }
    };

    window.resetPrizeForm = () => {
        editingId = null;
        document.getElementById('newPrizeName').value = "";
        document.getElementById('newPrizeImgFile').value = "";
        document.getElementById('slotImgPreview').style.display = 'none';
        currentSlotBase64 = null;
        document.getElementById('formTitle').innerText = "–°–¢–í–û–†–ò–¢–ò –ù–û–í–ò–ô –°–õ–û–¢";
        document.getElementById('savePrizeBtn').innerText = "–ó–ë–ï–†–ï–ì–¢–ò";
        document.getElementById('cancelEditBtn').style.display = 'none';
    };

    function renderManage() {
        const rouletteGrid = document.getElementById('manageRouletteGrid');
        const shopGrid = document.getElementById('manageShopGrid');
        if(!rouletteGrid || !shopGrid) return;

        rouletteGrid.innerHTML = "";
        shopGrid.innerHTML = "";
        
        const rouletteItems = prizePool.filter(p => !p.category || p.category === 'roulette');
        let totalChance = rouletteItems.reduce((sum, p) => sum + (parseFloat(p.chance) || 0), 0);

        prizePool.forEach(p => {
            let chanceDisplay = "";
            if (p.category === 'shop') {
                chanceDisplay = `–¶—ñ–Ω–∞: ${p.price} ‚ö™`;
            } else {
                if (isAutoOdds) {
                    chanceDisplay = `–®–∞–Ω—Å: ${(100 / rouletteItems.length).toFixed(1)}%`;
                } else {
                    let thisChance = parseFloat(p.chance) || 0;
                    let percent = totalChance > 0 ? ((thisChance / totalChance) * 100).toFixed(1) : 0;
                    chanceDisplay = `–®–∞–Ω—Å: ${thisChance}% (${percent} —Ä–µ–∞–ª—å–Ω.)`;
                }
            }

            const html = `
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; text-align:center; position:relative; border:1px solid rgba(255,255,255,0.1);">
                    <img src="${p.img}" style="width:50px; height:50px;">
                    <div style="font-size:10px; font-weight:700; margin-top:5px; color:#fff;">${p.name}</div>
                    <div style="font-size:9px; color:var(--primary); margin-top:2px; margin-bottom:5px;">${chanceDisplay}</div>
                    <div style="display:flex; gap:5px; justify-content:center;">
                        <button onclick="window.editPrize('${p.id}')" style="background:#334155; border:none; color:white; padding:4px 8px; border-radius:4px; font-size:10px; cursor:pointer;">‚úèÔ∏è</button>
                        <button onclick="window.deletePrize('${p.id}')" style="background:#7f1d1d; border:none; color:white; padding:4px 8px; border-radius:4px; font-size:10px; cursor:pointer;">üóëÔ∏è</button>
                    </div>
                </div>`;
            
            if (p.category === 'shop') shopGrid.innerHTML += html;
            else rouletteGrid.innerHTML += html;
        });
    }

    function applyRoleRestrictions() {
        if (userData.role !== 'admin') {
            if(document.getElementById('prizeFormActions')) document.getElementById('prizeFormActions').style.display = 'none';
            if(document.getElementById('instructorNotice')) document.getElementById('instructorNotice').style.display = 'block';
            if(document.getElementById('autoOddsToggle')) document.getElementById('autoOddsToggle').disabled = true;
        }
    }

    function loadPrizes() {
        onSnapshot(collection(db, "roulette_prizes"), (snap) => {
            prizePool = [];
            snap.forEach(d => prizePool.push({ id: d.id, ...d.data() }));
            
            const rouletteItems = prizePool.filter(p => !p.category || p.category === 'roulette');
            const shopItems = prizePool.filter(p => p.category === 'shop');
            
            renderRoulettePreview(rouletteItems);
            renderShop(shopItems);
            renderManage();
            
            if (!isSpinning) {
                initTrack(rouletteItems);
            }
        });
    }

    function renderRoulettePreview(items) {
        const preview = document.getElementById('prizePreview');
        if (!preview) return;
        preview.innerHTML = "";
        items.forEach(p => {
            preview.innerHTML += `<div style="background:rgba(255,255,255,0.02); padding:15px; border-radius:15px; text-align:center; border:1px solid rgba(255,255,255,0.05);">
                <img src="${p.img || 'https://via.placeholder.com/50'}" style="width:50px; height:50px; object-fit: contain; margin-bottom:8px;">
                <div style="font-size:10px; font-weight:800;">${p.name}</div>
            </div>`;
        });
    }

    function renderShop(items) {
        const grid = document.getElementById('shopGrid');
        if (!grid) return;
        grid.innerHTML = items.length === 0 ? "<div style='grid-column: 1/-1; text-align:center; padding: 50px; opacity:0.3;'>–ú–ê–ì–ê–ó–ò–ù –ü–û–†–û–ñ–ù–Ü–ô</div>" : "";
        items.forEach(p => {
            grid.innerHTML += `<div class="shop-card">
                <img src="${p.img || 'https://via.placeholder.com/120'}">
                <div style="font-weight:800; font-size: 14px; margin-bottom: 10px;">${p.name}</div>
                <div class="price-tag">${p.price || 0} ‚ö™</div>
                <button class="btn-main btn-buy" style="width:100%; padding:14px;" onclick="buyShopItem('${p.id}')">–ö–£–ü–ò–¢–ò</button>
            </div>`;
        });
    }

    window.buyShopItem = async function(id) {
        const item = prizePool.find(p => p.id === id);
        if (!item) return;
        
        const points = userData.points || 0;
        if (points < item.price) {
            notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –±–∞–ª—ñ–≤!');
            return;
        }
        
        showProcessing("–ü–û–ö–£–ü–ö–ê", `–ö—É–ø—ñ–≤–ª—è: ${item.name}`);
        
        try {
            await updateDoc(doc(db, "users", currentUID), { 
                points: points - item.price 
            });
            
            await addLog('SHOP_PURCHASE', `–ö—É–ø–∏–≤ ${item.name} –∑–∞ ${item.price} –±–∞–ª—ñ–≤`);
            notify('–ü–æ–∫—É–ø–∫–∞ —É—Å–ø—ñ—à–Ω–∞!');
        } catch(e) {
            notify("–ü–æ–º–∏–ª–∫–∞: " + e.message);
        } finally {
            hideProcessing();
        }
    };
</script>
</body>
</html>
