<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Å–æ–±–∏—Å—Ç–∏–π –ö–∞–±—ñ–Ω–µ—Ç | –î–®–í</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #22c55e;
            --primary-bright: #4ade80;
            --bg: #030507;
            --card-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(34, 197, 94, 0.2);
            --danger: #ef4444;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            background-image: radial-gradient(circle at 50% 0%, rgba(34, 197, 94, 0.15) 0%, transparent 50%);
            color: white; font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* --- –ù–ê–í–Ü–ì–ê–¶–Ü–Ø –¢–ê –î–ó–í–Ü–ù–û–ß–û–ö --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 8%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px);
            position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--glass-border);
        }

        .nav-right { display: flex; align-items: center; gap: 25px; }

        .notification-wrapper { position: relative; cursor: pointer; }
        .bell-icon { font-size: 22px; transition: 0.3s; }
        .bell-icon:hover { transform: scale(1.1); color: var(--primary-bright); }
        .bell-dot { 
            position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; 
            background: var(--danger); border-radius: 50%; border: 2px solid var(--bg);
            display: none; /* –ü–æ–∫–∞–∑—É—î–º–æ —á–µ—Ä–µ–∑ JS */
        }

        .notif-dropdown {
            position: absolute; top: 40px; right: 0; width: 300px; 
            background: #0a0f1a; border: 1px solid var(--glass-border);
            border-radius: 15px; padding: 15px; display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 2000;
        }
        .notif-dropdown.active { display: block; }
        .notif-item { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; color: #cbd5e1; }
        .notif-item:last-child { border: none; }
        .notif-item b { color: var(--primary-bright); }

        /* --- –ö–ê–†–¢–ö–ò –¢–ê –ê–ù–Ü–ú–ê–¶–Ü–á --- */
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        
        .stat-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; margin-bottom: 40px; 
        }

        .stat-card {
            background: var(--card-bg); border: 1px solid var(--glass-border);
            padding: 25px; border-radius: 20px; text-align: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* –ü—Ä—É–∂–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è */
        }
        /* –ê–Ω—ñ–º–∞—Ü—ñ—è –∑–±—ñ–ª—å—à–µ–Ω–Ω—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
        .stat-card:hover {
            transform: translateY(-10px) scale(1.05);
            background: rgba(34, 197, 94, 0.07);
            border-color: var(--primary-bright);
            box-shadow: 0 15px 30px rgba(34, 197, 94, 0.1);
        }

        .stat-card h3 { font-size: 12px; color: var(--primary-bright); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .stat-card p { font-size: 28px; font-weight: 900; margin: 0; }

        /* --- –ö–ù–û–ü–ö–ò –ó –í–û–ì–ù–ò–ö–û–ú --- */
        .action-menu { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 50px; }
        
        .btn-link {
            position: relative; text-decoration: none; background: var(--card-bg);
            color: white; padding: 15px 25px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1); font-weight: 700; font-size: 14px;
            transition: 0.3s; display: flex; align-items: center; gap: 10px;
        }
        .btn-link:hover { border-color: var(--primary); background: rgba(34, 197, 94, 0.1); }
        
        /* –ß–µ—Ä–≤–æ–Ω–∏–π –æ–≥–æ–Ω—å–æ–∫ */
        .fire-badge {
            width: 8px; height: 8px; background: var(--danger);
            border-radius: 50%; box-shadow: 0 0 10px var(--danger);
            display: none; /* –ü–æ–∫–∞–∑—É—î–º–æ —á–µ—Ä–µ–∑ JS */
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- –¢–ê–ë–õ–ò–¶–Ø –°–ö–õ–ê–î–£ --- */
        .admin-section { display: none; margin-top: 60px; }
        .staff-table { width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 20px; overflow: hidden; }
        .staff-table th { background: rgba(34, 197, 94, 0.1); padding: 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: var(--primary-bright); }
        .staff-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
        
        .btn-del { background: none; border: 1px solid var(--danger); color: var(--danger); padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 800; transition: 0.3s; }
        .btn-del:hover { background: var(--danger); color: white; }

        .logout-btn { color: var(--danger); cursor: pointer; font-weight: 800; font-size: 13px; }
    </style>
</head>
<body>

<nav>
    <a href="index.html" style="text-decoration:none; color:var(--primary); font-weight:900; font-size:22px;">–î–®–í</a>
    
    <div class="nav-right">
        <div class="notification-wrapper" onclick="toggleNotifs()">
            <span class="bell-icon">üîî</span>
            <div id="bellDot" class="bell-dot"></div>
            <div id="notifDropdown" class="notif-dropdown">
                <h4 style="margin:0 0 10px 0; font-size: 14px; border-bottom: 1px solid #222; padding-bottom: 5px;">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h4>
                <div id="notifList">
                    <div class="notif-item">–ù–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–µ–º–∞—î</div>
                </div>
            </div>
        </div>
        <span id="userName" style="font-weight:700;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
        <span class="logout-btn" onclick="window.logout()">–í–ò–ô–¢–ò</span>
    </div>
</nav>

<div class="container">
    <h1 id="welcomeText" style="font-size: 32px; font-weight: 900; margin-bottom: 10px;">–ü—Ä–∏–≤—ñ—Ç, –ë–æ–π—Ü—é!</h1>
    <p style="color: var(--primary-bright); font-weight: 800; font-size: 12px; letter-spacing: 3px; margin-bottom: 40px; text-transform: uppercase;">–û—Å–æ–±–∏—Å—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</p>

    <div class="stat-grid">
        <div class="stat-card">
            <h3>–í–∞—à–µ –ó–≤–∞–Ω–Ω—è</h3>
            <p id="userRank">‚Äî</p>
        </div>
        <div class="stat-card">
            <h3>–î–æ–≥–∞–Ω–∏</h3>
            <p id="userWarns" style="color: var(--danger);">0</p>
        </div>
        <div class="stat-card">
            <h3>–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è</h3>
            <p id="userReprimands" style="color: #fbbf24;">0</p>
        </div>
        <div class="stat-card">
            <h3>ID –ì—Ä–∞–≤—Ü—è</h3>
            <p id="userGameID">‚Äî</p>
        </div>
    </div>

    <div class="action-menu">
        <a href="reports.html" class="btn-link" onclick="markRead('reports')">
            –©–æ—Ç–∏–∂–Ω–µ–≤—ñ –∑–≤—ñ—Ç–∏ <div id="dot-reports" class="fire-badge"></div>
        </a>
        <a href="subotnik.html" class="btn-link" onclick="markRead('subotniks')">
            –°—É–±–æ—Ç–Ω–∏–∫–∏ <div id="dot-subotniks" class="fire-badge"></div>
        </a>
        <div id="adminBtns" style="display: none; gap: 15px;">
            <a href="applications.html" class="btn-link" onclick="markRead('applications')" style="border-color: var(--primary);">
                –ü–µ—Ä–µ–≥–ª—è–¥ —Ä–∞–ø–æ—Ä—Ç—ñ–≤ <div id="dot-applications" class="fire-badge"></div>
            </a>
        </div>
    </div>

    <div class="admin-section" id="adminSection">
        <h2 style="font-size: 20px; font-weight: 900; margin-bottom: 20px; text-transform: uppercase; color: var(--primary-bright);">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–∫–ª–∞–¥–æ–º</h2>
        <table class="staff-table">
            <thead>
                <tr>
                    <th>–ë–æ—î—Ü—å</th>
                    <th>–ó–≤–∞–Ω–Ω—è</th>
                    <th>Discord</th>
                    <th>–î–æ–≥–∞–Ω–∏ / –ü–æ–ø.</th>
                    <th>–î—ñ—è</th>
                </tr>
            </thead>
            <tbody id="staffList"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, onSnapshot, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyATUpLUHSp1VbyxkJXhMS-2R71zNOBGC00",
        authDomain: "dsv-gta.firebaseapp.com",
        projectId: "dsv-gta",
        storageBucket: "dsv-gta.firebasestorage.app",
        messagingSenderId: "661591588818",
        appId: "1:661591588818:web:a8e8dca3d061447e24d20b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // –§—É–Ω–∫—Ü—ñ—è –≤–∏—Ö–æ–¥—É
    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");

    // –ü–µ—Ä–µ–º–∏–∫–∞—á –¥–∑–≤—ñ–Ω–æ—á–∫–∞
    window.toggleNotifs = () => {
        document.getElementById('notifDropdown').classList.toggle('active');
        document.getElementById('bellDot').style.display = 'none'; // –ì–∞—Å–∏–º–æ —Ç–æ—á–∫—É –ø—Ä–∏ –∫–ª—ñ–∫—É
    };

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è —Ä–æ–∑–¥—ñ–ª—É —è–∫ "–ø—Ä–æ—á–∏—Ç–∞–Ω–æ–≥–æ"
    window.markRead = (collectionName) => {
        localStorage.setItem('last_view_' + collectionName, Date.now());
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('userName').innerText = data.name;
                document.getElementById('welcomeText').innerText = `–ü—Ä–∏–≤—ñ—Ç, ${data.name}!`;
                document.getElementById('userRank').innerText = data.rank;
                document.getElementById('userWarns').innerText = data.warns || 0;
                document.getElementById('userReprimands').innerText = data.reprimands || 0;
                document.getElementById('userGameID').innerText = data.gameID || '‚Äî';

                if (data.role === 'admin') {
                    document.getElementById('adminSection').style.display = 'block';
                    document.getElementById('adminBtns').style.display = 'flex';
                    loadStaff();
                }
                
                // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–∏—Å—Ç–µ–º—É —Å–ø–æ–≤—ñ—â–µ–Ω—å
                initNotifications();
            }
        } else {
            window.location.href = "index.html";
        }
    });

    // --- –õ–û–ì–Ü–ö–ê –°–ö–õ–ê–î–£ ---
    function loadStaff() {
        onSnapshot(collection(db, "users"), (snap) => {
            const list = document.getElementById('staffList');
            list.innerHTML = "";
            snap.forEach(s => {
                const u = s.data();
                list.innerHTML += `
                    <tr>
                        <td><b>${u.name}</b><br><small style="opacity:0.5">ID: ${u.gameID}</small></td>
                        <td>${u.rank}</td>
                        <td>${u.discord}</td>
                        <td>${u.warns || 0} / ${u.reprimands || 0}</td>
                        <td><button class="btn-del" onclick="window.deleteUser('${s.id}')">–í–ò–î–ê–õ–ò–¢–ò</button></td>
                    </tr>
                `;
            });
        });
    }

    window.deleteUser = async (id) => {
        if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –±—ñ–π—Ü—è –∑—ñ —Å–ø–∏—Å–∫—É?")) await deleteDoc(doc(db, "users", id));
    };

    // --- –°–ò–°–¢–ï–ú–ê –°–ü–û–í–Ü–©–ï–ù–¨ –¢–ê –û–ì–û–ù–¨–ö–Ü–í ---
    function initNotifications() {
        const collections = ['reports', 'subotniks', 'applications'];
        const notifList = document.getElementById('notifList');
        let hasGlobalNew = false;

        collections.forEach(col => {
            // –°—Ç–µ–∂–∏–º–æ –∑–∞ –∫–æ–∂–Ω–æ—é –∫–æ–ª–µ–∫—Ü—ñ—î—é –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
            const q = query(collection(db, col), orderBy("timestamp", "desc"), limit(1));
            
            onSnapshot(q, (snap) => {
                if (!snap.empty) {
                    const lastDoc = snap.docs[0].data();
                    const lastTime = lastDoc.timestamp?.toMillis() || 0;
                    const lastViewed = parseInt(localStorage.getItem('last_view_' + col) || 0);

                    // –Ø–∫—â–æ –≤ –±–∞–∑—ñ —î —â–æ—Å—å –Ω–æ–≤—ñ—à–µ, –Ω—ñ–∂ –º–∏ –±–∞—á–∏–ª–∏ –≤ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä–∞–∑
                    if (lastTime > lastViewed) {
                        document.getElementById('dot-' + col).style.display = 'block';
                        document.getElementById('bellDot').style.display = 'block';
                        
                        // –î–æ–¥–∞—î–º–æ –≤ —Å–ø–∏—Å–æ–∫ –¥–∑–≤—ñ–Ω–æ—á–∫–∞
                        const item = document.createElement('div');
                        item.className = 'notif-item';
                        const colNames = {reports: '–ó–≤—ñ—Ç', subotniks: '–°—É–±–æ—Ç–Ω–∏–∫', applications: '–†–∞–ø–æ—Ä—Ç'};
                        item.innerHTML = `–ù–æ–≤–∏–π <b>${colNames[col]}</b> –≤—ñ–¥ <b>${lastDoc.name || '–ö–∞–Ω–¥–∏–¥–∞—Ç–∞'}</b>`;
                        
                        // –û—á–∏—â—É—î–º–æ –∑–∞–≥–ª—É—à–∫—É —ñ –¥–æ–¥–∞—î–º–æ –Ω–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ –ø–æ—á–∞—Ç–æ–∫
                        if(notifList.innerText.includes("–Ω–µ–º–∞—î")) notifList.innerHTML = "";
                        notifList.prepend(item);
                    } else {
                        document.getElementById('dot-' + col).style.display = 'none';
                    }
                }
            });
        });
    }

</script>
</body>
</html>
