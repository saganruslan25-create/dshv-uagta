<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import{getAuth,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import{getFirestore,doc,getDoc,getDocs,collection,updateDoc,addDoc,deleteDoc,onSnapshot,serverTimestamp,query,orderBy}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
const app=initializeApp({apiKey:"AIzaSyATUpLUHSp1VbyxkJXhMS-2R71zNOBGC00",authDomain:"dsv-gta.firebaseapp.com",projectId:"dsv-gta",storageBucket:"dsv-gta.firebasestorage.app",messagingSenderId:"661591588818",appId:"1:661591588818:web:a8e8dca3d061447e24d20b"});
const auth=getAuth(app),db=getFirestore(app);
let ME={name:'–ù–µ–≤—ñ–¥–æ–º–∏–π',role:'fighter',uid:''},allUsers=[],tests=[],results=[],reviewers=JSON.parse(localStorage.getItem('isput_reviewers')||'[]'),adminList=JSON.parse(localStorage.getItem('isput_admins')||'[]'),webhookUrl=localStorage.getItem('isput_webhook')||'',currentTest=null,currentQ=0,answers={},timer=null,timeLeft=30,editingTestId=null,agreementAccepted=false,questionImages={};
const saveLocal=()=>{localStorage.setItem('isput_reviewers',JSON.stringify(reviewers));localStorage.setItem('isput_admins',JSON.stringify(adminList));localStorage.setItem('isput_webhook',webhookUrl)},letters='–ê–ë–í–ì“ê–î–ï–ñ–ó–ò',isAdmin=()=>ME.role==='admin'||adminList.includes(ME.name),isReviewer=()=>isAdmin()||reviewers.includes(ME.name),genId=()=>Date.now().toString(36)+Math.random().toString(36).substr(2,5),now=()=>{const d=new Date();return d.toLocaleDateString('uk')+' '+d.toLocaleTimeString('uk',{hour:'2-digit',minute:'2-digit'})};
onSnapshot(query(collection(db,'tests'),orderBy('createdAt','desc')),(snapshot)=>{tests=[];snapshot.forEach(docSnap=>{tests.push({id:docSnap.id,...docSnap.data()})});if(document.querySelector('.view.active')?.id==='viewHome')renderHome();if(document.querySelector('.view.active')?.id==='viewManage')renderManage()});
onSnapshot(query(collection(db,'results'),orderBy('timestamp','desc')),(snapshot)=>{results=[];snapshot.forEach(docSnap=>{results.push({id:docSnap.id,...docSnap.data()})});if(document.querySelector('.view.active')?.id==='viewHome')renderHome();if(document.querySelector('.view.active')?.id==='viewReview')renderReview()});
onAuthStateChanged(auth,async u=>{if(!u){window.location.href='index.html';return}ME.uid=u.uid;try{const snap=await getDoc(doc(db,'users',u.uid));if(snap.exists()){const d=snap.data();ME.name=d.name||'–ù–µ–≤—ñ–¥–æ–º–∏–π';ME.role=d.role||'fighter'}const all=await getDocs(collection(db,'users'));allUsers=[];all.forEach(s=>{const d=s.data();allUsers.push({uid:s.id,name:d.name||'---',role:d.role||'fighter'})})}catch(e){console.log('Firebase err:',e)}document.getElementById('headerName').textContent=ME.name;const rb=document.getElementById('headerRole');if(ME.role==='admin'){rb.textContent='–ê–î–ú–Ü–ù';rb.className='role-badge role-admin'}else if(ME.role==='instructor'){rb.textContent='–Ü–ù–°–¢–†–£–ö–¢–û–†';rb.className='role-badge role-instructor'}else{rb.textContent='–ë–Ü–Ñ–¶–¨';rb.className='role-badge role-fighter'}buildNav();showView('home')});
let notifs=JSON.parse(localStorage.getItem('isput_notifs')||'[]');
function addNotif(text){notifs.unshift({text,time:now(),read:false});if(notifs.length>20)notifs.pop();localStorage.setItem('isput_notifs',JSON.stringify(notifs));renderNotifs()}
function renderNotifs(){const list=document.getElementById('notifList'),badge=document.getElementById('bellBadge'),unread=notifs.filter(n=>!n.read).length;if(unread>0){badge.textContent=unread;badge.style.display='block'}else{badge.style.display='none'}if(notifs.length===0){list.innerHTML='<div style="color:var(--text-gray);text-align:center;padding:20px;font-size:12px">–ù–µ–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω—å</div>';return}list.innerHTML=notifs.map((n,i)=>`<div class="notif-item${n.read?' read':''}" onclick="readNotif(${i})"><div style="font-size:12px;font-weight:600;margin-bottom:3px">${n.text}</div><div style="font-size:10px;color:var(--text-gray)">${n.time}</div></div>`).join('')}
window.readNotif=i=>{notifs[i].read=true;localStorage.setItem('isput_notifs',JSON.stringify(notifs));renderNotifs()};
window.clearNotifs=()=>{notifs=[];localStorage.setItem('isput_notifs','[]');renderNotifs()};
window.toggleNotifs=e=>{e.stopPropagation();const p=document.getElementById('notifPanel');p.style.display=p.style.display==='flex'?'none':'flex'};
document.addEventListener('click',e=>{if(!e.target.closest('.notif-wrap'))document.getElementById('notifPanel').style.display='none'});
async function sendWebhook(embed){if(!webhookUrl)return;try{await fetch(webhookUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({embeds:[embed]})})}catch(e){console.log('Webhook err:',e)}}
function sendTestResultWebhook(r,test,reviewer){const passed=r.status==='approved'||(r.status==='auto'&&r.score>=test.passScore);sendWebhook({title:passed?'‚úÖ –Ü–°–ü–ò–¢ –°–ö–õ–ê–î–ï–ù–û':'‚ùå –Ü–°–ü–ò–¢ –ù–ï –°–ö–õ–ê–î–ï–ù–û',color:passed?0x00ff44:0xef4444,fields:[{name:'üë§ –ë–æ—î—Ü—å',value:r.userName,inline:true},{name:'üìù –Ü—Å–ø–∏—Ç',value:test.name,inline:true},{name:'\u200b',value:'\u200b',inline:true},{name:'üìä –†–µ–∑—É–ª—å—Ç–∞—Ç',value:`**${r.score}** / ${test.maxScore} –±–∞–ª—ñ–≤`,inline:true},{name:'üéØ –ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª',value:`${test.passScore} –±–∞–ª—ñ–≤`,inline:true},{name:'üìã –°—Ç–∞—Ç—É—Å',value:passed?'–°–∫–ª–∞–¥–µ–Ω–æ':'–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ',inline:true},{name:'üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π',value:reviewer||'SYSTEM',inline:true},{name:'üìÖ –î–∞—Ç–∞',value:r.date,inline:true}],footer:{text:'–î–®–í | –Ü–°–ü–ò–¢ –¶–ï–ù–¢–†'},timestamp:new Date().toISOString()})}
function sendTestWebhookNotify(){if(!webhookUrl)return;sendWebhook({title:'üì¢ –ù–û–í–ò–ô –Ü–°–ü–ò–¢ –ù–ê –ü–ï–†–ï–í–Ü–†–ö–£',color:0xfbbf24,description:'–ù–∞–¥—ñ–π—à–æ–≤ –Ω–æ–≤–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —ñ—Å–ø–∏—Ç—É –∑ –≤—ñ–ª—å–Ω–∏–º–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—è–º–∏. –ü–æ—Ç—Ä—ñ–±–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞.',footer:{text:'–î–®–í | –Ü–°–ü–ò–¢ –¶–ï–ù–¢–†'},timestamp:new Date().toISOString()})}
function buildNav(){const tabs=document.getElementById('navTabs');let html='<button class="nav-btn active" onclick="showView(\'home\')">üè† –ì–æ–ª–æ–≤–Ω–∞</button>';if(isAdmin()){html+='<button class="nav-btn" onclick="showView(\'create\')">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</button>';html+='<button class="nav-btn" onclick="showView(\'manage\')">‚öôÔ∏è –ö–µ—Ä—É–≤–∞—Ç–∏</button>';html+='<button class="nav-btn" onclick="showView(\'settings\')">üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>';html+='<button class="nav-btn" onclick="showView(\'adminList\')">üëë –ê–¥–º—ñ–Ω–∏</button>'}if(isReviewer())html+='<button class="nav-btn" onclick="showView(\'review\')">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞</button>';tabs.innerHTML=html}
window.showView=v=>{document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));document.getElementById('view'+v.charAt(0).toUpperCase()+v.slice(1)).classList.add('active');document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));const btns=document.querySelectorAll('.nav-btn'),map={home:0,create:1,manage:2,settings:3,adminList:4,review:isAdmin()?5:1};if(btns[map[v]])btns[map[v]].classList.add('active');if(v==='home')renderHome();if(v==='create')renderCreateForm();if(v==='review')renderReview();if(v==='manage')renderManage();if(v==='settings')renderSettings();if(v==='adminList')renderAdminList()};
function renderHome(){const myRes=results.filter(r=>r.userId===ME.uid),passed=myRes.filter(r=>{const t=tests.find(x=>x.id===r.testId);return r.status==='approved'||(r.status==='auto'&&t&&r.score>=t.passScore)}).length,failed=myRes.filter(r=>{const t=tests.find(x=>x.id===r.testId);return r.status==='rejected'||(r.status==='auto'&&t&&r.score<t.passScore)}).length,pending=myRes.filter(r=>r.status==='pending').length;document.getElementById('statsRow').innerHTML=`<div class="stat-card"><div class="stat-num">${tests.length}</div><div class="stat-label">–Ü—Å–ø–∏—Ç—ñ–≤</div></div><div class="stat-card"><div class="stat-num" style="color:var(--success)">${passed}</div><div class="stat-label">–°–∫–ª–∞–¥–µ–Ω–æ</div></div><div class="stat-card"><div class="stat-num" style="color:var(--danger)">${failed}</div><div class="stat-label">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div></div><div class="stat-card"><div class="stat-num" style="color:var(--warning)">${pending}</div><div class="stat-label">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</div></div>`;if(tests.length===0){document.getElementById('testsGrid').innerHTML='<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px;width:100%">–Ü—Å–ø–∏—Ç—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>'}else{let totalTime=0;document.getElementById('testsGrid').innerHTML=tests.map(t=>{const pps=t.maxScore>0?Math.round(t.maxScore/t.questions.length*10)/10:0;totalTime=0;t.questions.forEach(q=>{totalTime+=(q.timeLimit||30)});return`<div class="test-card" onclick="startIntro('${t.id}')"><span class="emoji">${t.emoji||'üìù'}</span><h3>${t.name}</h3><p>${t.description||'–ë–µ–∑ –æ–ø–∏—Å—É'}</p><div class="test-meta"><span class="meta-tag">‚ùì ${t.questions.length} –ø–∏—Ç–∞–Ω—å</span><span class="meta-tag warn">üéØ ${t.passScore}/${t.maxScore} –±.</span><span class="meta-tag">‚è± ${totalTime}—Å</span><span class="meta-tag">üíé ${pps} –±./–ø–∏—Ç.</span></div></div>`}).join('')}if(myRes.length===0){document.getElementById('myResults').innerHTML='<div style="color:var(--text-gray);text-align:center;padding:30px;font-size:13px">–í–∏ —â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —ñ—Å–ø–∏—Ç–∏</div>'}else{let rows=myRes.map(r=>{const t=tests.find(x=>x.id===r.testId),tname=t?t.name:'–í–∏–¥–∞–ª–µ–Ω–∏–π',passS=t?t.passScore:0;let st,stc;if(r.status==='pending'){st='–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ';stc='st-pending'}else if(r.status==='approved'){st='–°—Ö–≤–∞–ª–µ–Ω–æ';stc='st-approved'}else if(r.status==='rejected'){st='–í—ñ–¥—Ö–∏–ª–µ–Ω–æ';stc='st-rejected'}else{const p=r.score>=passS;st=p?'–°–∫–ª–∞–¥–µ–Ω–æ':'–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ';stc=p?'st-pass':'st-fail'}return`<tr><td>${tname}</td><td><b>${r.score}</b> / ${t?t.maxScore:'?'}</td><td><span class="status-badge ${stc}">${st}</span></td><td>${r.reviewer||'SYSTEM'}</td><td>${r.date}</td></tr>`}).join('');document.getElementById('myResults').innerHTML=`<div class="results-table"><table><thead><tr><th>–Ü—Å–ø–∏—Ç</th><th>–ë–∞–ª–∏</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π</th><th>–î–∞—Ç–∞</th></tr></thead><tbody>${rows}</tbody></table></div>`}}
window.startIntro=id=>{const t=tests.find(x=>x.id===id);if(!t)return;const myResults=results.filter(r=>r.testId===id&&r.userId===ME.uid),hasPending=myResults.find(r=>r.status==='pending'),hasAutoNotReviewed=myResults.find(r=>r.status==='auto'&&!r.reviewedByHuman);if(hasPending||hasAutoNotReviewed){alert('‚ö†Ô∏è –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —ñ—Å–ø–∏—Ç —â–µ –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ –ª—é–¥–∏–Ω–æ—é! –î–æ—á–µ–∫–∞–π—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.');return}currentTest=t;agreementAccepted=false;const pps=t.maxScore>0?Math.round(t.maxScore/t.questions.length*10)/10:0;let totalTime=0;t.questions.forEach(q=>{totalTime+=(q.timeLimit||30)});let agreementHTML='';if(t.agreementText){agreementHTML=`<div class="agreement-section"><h3 style="font-size:16px;font-weight:800;color:var(--primary);margin-bottom:15px">üìú –£–º–æ–≤–∏ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —ñ—Å–ø–∏—Ç—É</h3><div class="agreement-text">${t.agreementText.replace(/\n/g,'<br>')}</div><div class="agreement-checkbox-wrapper" onclick="toggleAgreement()"><div class="custom-checkbox" id="agreementCheckbox"></div><div class="agreement-label">–Ø –æ–∑–Ω–∞–π–æ–º–∏–≤—Å—è —ñ –ø–æ–≥–æ–¥–∂—É—é—Å—å –∑ —É–º–æ–≤–∞–º–∏</div></div></div>`}document.getElementById('introCard').innerHTML=`<span class="emoji">${t.emoji||'üìù'}</span><h2>${t.name}</h2><p>${t.description||''}</p><div style="margin:25px 0;display:grid;grid-template-columns:1fr 1fr;gap:10px;text-align:center"><div style="background:rgba(0,255,68,0.05);border:1px solid rgba(0,255,68,0.15);border-radius:12px;padding:15px"><div style="font-size:22px;font-weight:900;color:var(--primary)">${t.questions.length}</div><div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ü–ò–¢–ê–ù–¨</div></div><div style="background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.15);border-radius:12px;padding:15px"><div style="font-size:22px;font-weight:900;color:var(--warning)">${t.passScore}/${t.maxScore}</div><div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ü–†–û–•–Ü–î–ù–ò–ô –ë–ê–õ</div></div><div style="background:rgba(59,130,246,0.05);border:1px solid rgba(59,130,246,0.15);border-radius:12px;padding:15px"><div style="font-size:22px;font-weight:900;color:var(--info)">‚è± ${totalTime}—Å</div><div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ó–ê–ì–ê–õ–¨–ù–ò–ô –ß–ê–°</div></div><div style="background:rgba(16,185,129,0.05);border:1px solid rgba(16,185,129,0.15);border-radius:12px;padding:15px"><div style="font-size:22px;font-weight:900;color:var(--success)">${pps}</div><div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ë–ê–õ–Ü–í –ó–ê –ü–ò–¢–ê–ù–ù–Ø</div></div></div>${agreementHTML}<div class="btn-group"><button class="btn btn-primary" onclick="beginQuiz()" id="startTestBtn" ${t.agreementText?'disabled':''}>üöÄ –†–û–ó–ü–û–ß–ê–¢–ò –Ü–°–ü–ò–¢</button><button class="btn btn-secondary" onclick="showView('home')">‚Üê –ù–∞–∑–∞–¥</button></div>`;showView('intro')};
window.toggleAgreement=()=>{agreementAccepted=!agreementAccepted;const cb=document.getElementById('agreementCheckbox'),btn=document.getElementById('startTestBtn');if(agreementAccepted){cb.classList.add('checked');btn.disabled=false;btn.style.opacity='1'}else{cb.classList.remove('checked');btn.disabled=true;btn.style.opacity='0.5'}};
window.beginQuiz=()=>{if(currentTest&&currentTest.agreementText&&!agreementAccepted){alert('‚ùå –°–ø–æ—á–∞—Ç–∫—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–∏–π–Ω—è—Ç–∏ —É–º–æ–≤–∏!');return}currentQ=0;answers={};showView('quiz');renderQuestion()};
function renderQuestion(){if(!currentTest)return;const q=currentTest.questions[currentQ],total=currentTest.questions.length,pps=currentTest.maxScore>0?Math.round(currentTest.maxScore/total*10)/10:0,progress=((currentQ)/total)*100;clearInterval(timer);timeLeft=q.timeLimit||30;let answersHtml='';if(q.answerType==='table'){const cols=q.tableData.columns,rows=q.tableData.rows;answersHtml=`<div class="answer-table-wrapper"><table class="answer-table"><thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}<th style="width:60px">–í–∏–±—ñ—Ä</th></tr></thead><tbody>${rows.map((row,ri)=>`<tr>${cols.map((c,ci)=>`<td>${row[ci]||''}</td>`).join('')}<td style="text-align:center"><div class="table-radio${answers[currentQ]?.value===ri?' checked':''}" onclick="selectTableAnswer(${ri})"></div></td></tr>`).join('')}</tbody></table></div>`}else{answersHtml=`<div class="quiz-answers">${q.options.map((o,i)=>{const sel=answers[currentQ]?.type==='choice'&&answers[currentQ]?.value===i;return`<div class="answer-btn${sel?' selected':''}" onclick="selectAnswer(${i})"><div class="answer-letter">${letters[i]||i+1}</div><div>${o.text}</div></div>`}).join('')}</div>`}const hasFree=q.allowFree,freeActive=answers[currentQ]?.type==='free',freeVal=freeActive?answers[currentQ]?.value:'';document.getElementById('quizContainer').innerHTML=`<div class="quiz-progress-bar"><div class="quiz-progress-fill" style="width:${progress}%"></div></div><div class="quiz-header"><div class="quiz-q-num">–ü–∏—Ç–∞–Ω–Ω—è ${currentQ+1} –∑ ${total} ‚Ä¢ <span style="color:var(--primary)">${pps} –±.</span> ‚Ä¢ <span style="color:var(--info)">‚è± ${q.timeLimit||30}—Å</span></div><div class="quiz-timer" id="timerDisplay">${timeLeft}</div></div><div class="quiz-question"><h3>${q.text}</h3>${q.image?`<img src="${q.image}" class="question-image" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–∏—Ç–∞–Ω–Ω—è">`:''}${answersHtml}${hasFree?`<div class="free-answer-area"><div class="free-answer-toggle${freeActive?' active':''}" onclick="toggleFreeAnswer()">‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç–∏ —Å–≤—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç</div>${freeActive?`<textarea class="free-input" id="freeInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å...">${freeVal}</textarea>`:''}</div>`:''}</div><div class="btn-group">${currentQ>0?'<button class="btn btn-secondary" onclick="prevQuestion()">‚Üê –ù–∞–∑–∞–¥</button>':'<button class="btn btn-secondary" onclick="showView(\'home\')">üè† –í–∏—Ö—ñ–¥</button>'}<button class="btn btn-primary" onclick="nextQuestion()">${currentQ===total-1?'üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç–∏':'–î–∞–ª—ñ ‚Üí'}</button></div>`;startTimer()}
function startTimer(){const el=()=>document.getElementById('timerDisplay');timer=setInterval(()=>{timeLeft--;const d=el();if(d){d.textContent=timeLeft;if(timeLeft<=10)d.classList.add('danger');else d.classList.remove('danger')}if(timeLeft<=0){clearInterval(timer);nextQuestion()}},1000)}
window.selectAnswer=i=>{answers[currentQ]={type:'choice',value:i};renderQuestion()};
window.selectTableAnswer=i=>{answers[currentQ]={type:'choice',value:i};renderQuestion()};
window.toggleFreeAnswer=()=>{if(answers[currentQ]?.type==='free'){delete answers[currentQ]}else{answers[currentQ]={type:'free',value:''}}renderQuestion()};
window.prevQuestion=()=>{if(currentQ>0){clearInterval(timer);currentQ--;renderQuestion()}};
window.nextQuestion=()=>{const fi=document.getElementById('freeInput');if(fi&&answers[currentQ]?.type==='free'){answers[currentQ].value=fi.value}clearInterval(timer);if(currentQ>=currentTest.questions.length-1){finishQuiz()}else{currentQ++;renderQuestion()}};
async function finishQuiz(){const t=currentTest,total=t.questions.length,pps=t.maxScore>0?t.maxScore/total:0;let score=0,details=[],hasFreeAnswers=false;t.questions.forEach((q,i)=>{const ans=answers[i];let d={qText:q.text,answered:false,correct:false,points:0,userAnswer:'',correctAnswer:'',isFree:false,status:'wrong'},correctIdx=-1;if(q.answerType==='table'){correctIdx=q.tableData.correctRowIndex;const rows=q.tableData.rows,cols=q.tableData.columns;d.correctAnswer=correctIdx>=0?rows[correctIdx].join(' | '):'‚Äî'}else{correctIdx=q.options.findIndex(o=>o.correct);d.correctAnswer=correctIdx>=0?q.options[correctIdx].text:'‚Äî'}if(!ans){d.userAnswer='–ë–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ';d.status='wrong'}else if(ans.type==='choice'){if(q.answerType==='table'){const rows=q.tableData.rows;d.userAnswer=rows[ans.value]?rows[ans.value].join(' | '):'‚Äî'}else{d.userAnswer=q.options[ans.value]?.text||'‚Äî'}d.answered=true;if(ans.value===correctIdx){d.correct=true;d.points=pps;score+=pps;d.status='correct'}else{d.status='wrong'}}else if(ans.type==='free'){d.userAnswer=ans.value||'–ü–æ—Ä–æ–∂–Ω—å–æ';d.answered=true;d.isFree=true;d.status='pending';hasFreeAnswers=true}details.push(d)});score=Math.round(score*100)/100;const needsReview=hasFreeAnswers,status=needsReview?'pending':'auto';try{await addDoc(collection(db,'results'),{testId:t.id,testName:t.name,userId:ME.uid,userName:ME.name,score,maxScore:t.maxScore,passScore:t.passScore,details,date:now(),status,reviewer:needsReview?null:'SYSTEM',reviewedByHuman:false,timestamp:serverTimestamp()});if(!needsReview){if(score>=t.passScore)addNotif(`‚úÖ –Ü—Å–ø–∏—Ç "${t.name}" –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ: ${score}/${t.maxScore}. –û—á—ñ–∫—É–π—Ç–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ª—é–¥–∏–Ω–æ—é.`);else addNotif(`‚ùå –Ü—Å–ø–∏—Ç "${t.name}" –Ω–µ —Å–∫–ª–∞–¥–µ–Ω–æ: ${score}/${t.maxScore}. –û—á—ñ–∫—É–π—Ç–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ª—é–¥–∏–Ω–æ—é.`)}else{sendTestWebhookNotify();addNotif(`‚è≥ –Ü—Å–ø–∏—Ç "${t.name}" –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É`)}}catch(e){alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É: '+e.message);console.error(e)}}
onSnapshot(query(collection(db,'results'),orderBy('timestamp','desc')),(snapshot)=>{results=[];snapshot.forEach(docSnap=>{const data=docSnap.data();if(data.userId===ME.uid&&data.testId===currentTest?.id){const newResult={id:docSnap.id,...data},existing=results.find(r=>r.id===newResult.id);if(!existing||existing.status!==newResult.status){renderResult(newResult);showView('result')}results.push(newResult)}else{results.push({id:docSnap.id,...data})}});if(document.querySelector('.view.active')?.id==='viewHome')renderHome();if(document.querySelector('.view.active')?.id==='viewReview')renderReview()});
function renderResult(r){const t=tests.find(x=>x.id===r.testId),passScore=t?t.passScore:0,isPending=r.status==='pending'||(r.status==='auto'&&!r.reviewedByHuman),passed=!isPending&&r.score>=passScore&&r.reviewedByHuman,el=document.getElementById('resultScreen');let detailsHtml=r.details.map((d,i)=>{let markClass=d.status==='correct'?'ok':d.status==='pending'?'pend':'no',markIcon=d.status==='correct'?'‚úì':d.status==='pending'?'?':'‚úó',pointsText=d.status==='correct'?`+${Math.round(d.points*10)/10} –±.`:d.status==='pending'?'–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ':'0 –±.';return`<div class="result-detail"><div class="mark ${markClass}">${markIcon}</div><div style="flex:1"><div style="font-size:13px;font-weight:700;margin-bottom:4px;word-wrap:break-word">${i+1}. ${d.qText}</div><div style="font-size:12px;color:var(--text-light);word-wrap:break-word">–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: <b>${d.userAnswer}</b></div>${d.status!=='pending'?`<div style="font-size:11px;color:var(--primary);margin-top:2px;word-wrap:break-word">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${d.correctAnswer}</div>`:''}<div style="font-size:11px;font-weight:800;color:${d.status==='correct'?'var(--primary)':d.status==='pending'?'var(--warning)':'var(--danger)'};margin-top:3px">${pointsText}</div></div></div>`}).join('');el.innerHTML=`<div class="result-circle ${isPending?'':passed?'pass':'fail'}"><div class="result-score" style="color:${isPending?'var(--warning)':passed?'var(--primary)':'var(--danger)'}">${r.score}</div><div class="result-max">–∑ ${r.maxScore} –±–∞–ª—ñ–≤</div></div><div class="result-status ${isPending?'':passed?'pass':'fail'}">${isPending?'‚è≥ –ù–ê –ü–ï–†–ï–í–Ü–†–¶–Ü':passed?'‚úÖ –Ü–°–ü–ò–¢ –°–ö–õ–ê–î–ï–ù–û':'‚ùå –ù–ï –°–ö–õ–ê–î–ï–ù–û'}</div><p style="color:var(--text-gray);font-size:13px;margin-bottom:25px">${isPending?'–û—á—ñ–∫—É–π—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ª—é–¥–∏–Ω–æ—é':'–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª: '+passScore+' –±–∞–ª—ñ–≤'}</p><div style="text-align:left">${detailsHtml}</div><div class="btn-group"><button class="btn btn-primary" onclick="startIntro('${r.testId}')" ${isPending?'disabled':''} style="${isPending?'opacity:0.5;cursor:not-allowed':''}">${isPending?'‚è≥ –û—á—ñ–∫—É–π—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏':'üîÑ –ü—Ä–æ–π—Ç–∏ –∑–Ω–æ–≤—É'}</button><button class="btn btn-secondary" onclick="showView('home')">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</button></div>`}
function renderCreateForm(testData){editingTestId=testData?testData.id:null;questionImages={};document.getElementById('createTitle').innerHTML=editingTestId?'‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —ñ—Å–ø–∏—Ç':'‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ—Å–ø–∏—Ç';const t=testData||{name:'',description:'',emoji:'üìù',maxScore:12,passScore:8,questions:[],agreementText:''},qs=t.questions.length>0?t.questions:[{text:'',options:[{text:'',correct:false},{text:'',correct:false},{text:'',correct:false},{text:'',correct:false}],allowFree:false,timeLimit:30,answerType:'normal',image:''}];if(testData&&testData.questions){testData.questions.forEach((q,i)=>{if(q.image)questionImages[i]=q.image})}let qBlocks=qs.map((q,qi)=>{let opts='';if(q.answerType==='table'){const cols=q.tableData?.columns||[],rows=q.tableData?.rows||[],correctRow=q.tableData?.correctRowIndex||0;opts=`<div class="table-builder"><div style="font-size:11px;font-weight:700;color:var(--primary);margin-bottom:8px">–°–¢–û–í–ü–¶–Ü –¢–ê–ë–õ–ò–¶–Ü</div><div class="table-builder-head" id="tableCols-${qi}">${cols.map((c,ci)=>`<input class="table-col-input" placeholder="–°—Ç–æ–≤–ø–µ—Ü—å ${ci+1}" value="${c}" data-qi="${qi}" data-ci="${ci}">`).join('')}</div><button class="add-opt-btn" onclick="addTableColumn(${qi})" style="margin-bottom:10px">+ –î–æ–¥–∞—Ç–∏ —Å—Ç–æ–≤–ø–µ—Ü—å</button><div style="font-size:11px;font-weight:700;color:var(--primary);margin-bottom:8px">–†–Ø–î–ö–ò –¢–ê–ë–õ–ò–¶–Ü</div><div class="table-builder-rows" id="tableRows-${qi}">${rows.map((row,ri)=>`<div class="table-row-builder"><div class="opt-radio${ri===correctRow?' checked':''}" onclick="toggleTableCorrect(${qi},${ri})"></div>${cols.map((c,ci)=>`<input class="table-cell-input" placeholder="${c}" value="${row[ci]||''}" data-qi="${qi}" data-ri="${ri}" data-ci="${ci}">`).join('')}<button class="opt-del" onclick="delTableRow(${qi},${ri})">‚úï</button></div>`).join('')}</div><button class="add-opt-btn" onclick="addTableRow(${qi})">+ –î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫</button></div>`}else{opts=q.options.map((o,oi)=>`<div class="opt-row"><div class="opt-radio${o.correct?' checked':''}" onclick="toggleCorrect(${qi},${oi})"></div><input class="opt-input" placeholder="–í–∞—Ä—ñ–∞–Ω—Ç ${letters[oi]||oi+1}" value="${o.text.replace(/"/g,'&quot;')}" data-qi="${qi}" data-oi="${oi}"><button class="opt-del" onclick="delOption(${qi},${oi})">‚úï</button></div>`).join('');opts+=`<button class="add-opt-btn" onclick="addOption(${qi})">+ –î–æ–¥–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç</button>`}const imgPreview=questionImages[qi]?`<img src="${questionImages[qi]}" class="q-image-preview" id="qimg-${qi}">`:'';return`<div class="q-block" id="qblock-${qi}"><div class="q-block-head"><span class="q-num">–ü–∏—Ç–∞–Ω–Ω—è ${qi+1}</span><button class="q-del" onclick="delQuestion(${qi})">üóë</button></div><textarea class="form-input" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Ç–∞–Ω–Ω—è..." id="qtext-${qi}" style="margin-bottom:12px;min-height:80px;resize:vertical">${q.text.replace(/"/g,'&quot;')}</textarea><div class="q-image-section"><label class="form-label">üñº –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è –ø–∏—Ç–∞–Ω–Ω—è (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label><input type="file" id="qimginput-${qi}" accept="image/*" style="display:none" onchange="handleQuestionImage(this,${qi})"><button class="btn-upload-img" onclick="document.getElementById('qimginput-${qi}').click()">üì∑ –û–ë–†–ê–¢–ò –ó–û–ë–†–ê–ñ–ï–ù–ù–Ø</button>${imgPreview}${questionImages[qi]?`<button class="btn-danger" onclick="removeQuestionImage(${qi})" style="margin-left:10px;padding:4px 10px;font-size:10px">‚úï –í–∏–¥–∞–ª–∏—Ç–∏</button>`:''}</div><div style="margin-bottom:10px"><label class="form-label">–ß–∞—Å –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è (—Å–µ–∫—É–Ω–¥)</label><input class="form-input" type="number" id="qtime-${qi}" value="${q.timeLimit||30}" min="5" max="600"></div><div class="table-toggle-create" onclick="toggleTableMode(${qi})"><div class="toggle-switch${q.answerType==='table'?' on':''}" id="tableSwitch-${qi}"></div>–†–µ–∂–∏–º —Ç–∞–±–ª–∏—Ü—ñ</div><div id="opts-${qi}" style="margin-top:12px">${opts}</div><div class="free-toggle-create" onclick="toggleFreeCreate(${qi})"><div class="toggle-switch${q.allowFree?' on':''}" id="freeSwitch-${qi}"></div>–î–æ–∑–≤–æ–ª–∏—Ç–∏ –≤—ñ–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å</div></div>`}).join('');document.getElementById('createForm').innerHTML=`<div class="form-card"><div class="form-row-inline"><div class="form-row"><label class="form-label">–ù–∞–∑–≤–∞ —ñ—Å–ø–∏—Ç—É</label><input class="form-input" id="testName" value="${t.name.replace(/"/g,'&quot;')}" placeholder="–ù–∞–∑–≤–∞..."></div><div class="form-row"><label class="form-label">–ï–º–æ–¥–∑—ñ</label><input class="form-input" id="testEmoji" value="${t.emoji}" placeholder="üìù" style="text-align:center;font-size:24px"></div></div><div class="form-row"><label class="form-label">–û–ø–∏—Å</label><textarea class="form-input" id="testDesc" rows="2" placeholder="–û–ø–∏—Å —ñ—Å–ø–∏—Ç—É...">${t.description||''}</textarea></div><div class="form-row-inline"><div class="form-row"><label class="form-label">–ú–∞–∫—Å. –±–∞–ª</label><input class="form-input" id="testMaxScore" type="number" value="${t.maxScore}" min="1"></div><div class="form-row"><label class="form-label">–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª</label><input class="form-input" id="testPassScore" type="number" value="${t.passScore}" min="0"></div></div><div class="form-hint" id="scoreHint">üíé –ó–∞ –∫–æ–∂–Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è: ${qs.length>0?Math.round(t.maxScore/qs.length*100)/100:0} –±–∞–ª—ñ–≤</div><div class="form-row" style="margin-top:25px"><label class="form-label">üìú –¢–µ–∫—Å—Ç —É–≥–æ–¥–∏ / —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label><textarea class="form-input" id="agreementText" rows="4" placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç —É–≥–æ–¥–∏ –∞–±–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º —Ç–µ—Å—Ç—É...">${t.agreementText||''}</textarea></div></div><div class="section-title">üìã –ü–∏—Ç–∞–Ω–Ω—è</div><div id="questionsContainer">${qBlocks}</div><button class="btn btn-secondary" onclick="addQuestion()" style="width:100%;margin-bottom:20px">+ –î–æ–¥–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è</button><div class="btn-group"><button class="btn btn-primary" onclick="saveTest()">üíæ ${editingTestId?'–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏':'–°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ—Å–ø–∏—Ç'}</button><button class="btn btn-secondary" onclick="showView('home')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>${webhookUrl?'<button class="btn btn-info" onclick="sendTestMsg()">üì© –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</button>':''}</div>`;document.getElementById('testMaxScore').addEventListener('input',updateScoreHint)}
window.handleQuestionImage=(input,qi)=>{if(input.files&&input.files[0]){const file=input.files[0],reader=new FileReader();reader.onload=(e)=>{const img=new Image();img.onload=()=>{const canvas=document.createElement('canvas');let w=img.width,h=img.height,max=1000;if(w>h){if(w>max){h*=max/w;w=max}}else{if(h>max){w*=max/h;h=max}}canvas.width=w;canvas.height=h;canvas.getContext('2d').drawImage(img,0,0,w,h);questionImages[qi]=canvas.toDataURL('image/jpeg',0.8);const preview=document.getElementById('qimg-'+qi);if(preview){preview.src=questionImages[qi]}else{const section=document.querySelector(`#qblock-${qi} .q-image-section`);const btn=section.querySelector('.btn-upload-img');btn.insertAdjacentHTML('afterend',`<img src="${questionImages[qi]}" class="q-image-preview" id="qimg-${qi}"><button class="btn-danger" onclick="removeQuestionImage(${qi})" style="margin-left:10px;padding:4px 10px;font-size:10px">‚úï –í–∏–¥–∞–ª–∏—Ç–∏</button>`)}};img.src=e.target.result};reader.readAsDataURL(file)}};
window.removeQuestionImage=qi=>{delete questionImages[qi];const preview=document.getElementById('qimg-'+qi);if(preview)preview.remove();const btn=document.querySelector(`#qblock-${qi} .q-image-section .btn-danger`);if(btn)btn.remove()};
function updateScoreHint(){const ms=parseInt(document.getElementById('testMaxScore').value)||0,cnt=document.querySelectorAll('.q-block').length;document.getElementById('scoreHint').textContent=`üíé –ó–∞ –∫–æ–∂–Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è: ${cnt>0?Math.round(ms/cnt*100)/100:0} –±–∞–ª—ñ–≤`}
function getFormQuestions(){const blocks=document.querySelectorAll('.q-block');let qs=[];blocks.forEach((b,qi)=>{const text=document.getElementById('qtext-'+qi)?.value||'',timeLimit=parseInt(document.getElementById('qtime-'+qi)?.value)||30,tableMode=document.getElementById('tableSwitch-'+qi)?.classList.contains('on')||false,image=questionImages[qi]||'';let opts=[],tableData=null;if(tableMode){const colInputs=document.querySelectorAll(`#tableCols-${qi} .table-col-input`),cols=Array.from(colInputs).map(inp=>inp.value),rowDivs=document.querySelectorAll(`#tableRows-${qi} .table-row-builder`),rows=[];let correctRowIndex=0;rowDivs.forEach((div,ri)=>{const radio=div.querySelector('.opt-radio');if(radio.classList.contains('checked'))correctRowIndex=ri;const cells=div.querySelectorAll('.table-cell-input');rows.push(Array.from(cells).map(c=>c.value))});tableData={columns:cols,rows,correctRowIndex}}else{const optRows=b.querySelectorAll('.opt-row');optRows.forEach((r,oi)=>{const inp=r.querySelector('.opt-input'),radio=r.querySelector('.opt-radio');opts.push({text:inp.value,correct:radio.classList.contains('checked')})})}const sw=document.getElementById('freeSwitch-'+qi);qs.push({text,options:opts,allowFree:sw?.classList.contains('on')||false,timeLimit,answerType:tableMode?'table':'normal',tableData,image})});return qs}
window.toggleCorrect=(qi,oi)=>{const qs=getFormQuestions();qs[qi].options.forEach((o,i)=>o.correct=i===oi);rebuildQuestions(qs)};
window.delOption=(qi,oi)=>{const qs=getFormQuestions();qs[qi].options.splice(oi,1);rebuildQuestions(qs)};
window.addOption=qi=>{const qs=getFormQuestions();qs[qi].options.push({text:'',correct:false});rebuildQuestions(qs)};
window.delQuestion=qi=>{const qs=getFormQuestions();qs.splice(qi,1);const newImages={};Object.keys(questionImages).forEach(k=>{const idx=parseInt(k);if(idx<qi)newImages[idx]=questionImages[idx];else if(idx>qi)newImages[idx-1]=questionImages[idx]});questionImages=newImages;rebuildQuestions(qs);updateScoreHint()};
window.addQuestion=()=>{const qs=getFormQuestions();qs.push({text:'',options:[{text:'',correct:false},{text:'',correct:false},{text:'',correct:false},{text:'',correct:false}],allowFree:false,timeLimit:30,answerType:'normal',image:''});rebuildQuestions(qs);updateScoreHint()};
window.toggleFreeCreate=qi=>{const qs=getFormQuestions();qs[qi].allowFree=!qs[qi].allowFree;rebuildQuestions(qs)};
window.toggleTableMode=qi=>{const qs=getFormQuestions();if(qs[qi].answerType==='table'){qs[qi].answerType='normal';qs[qi].tableData=null;if(qs[qi].options.length===0){qs[qi].options=[{text:'',correct:false},{text:'',correct:false},{text:'',correct:false},{text:'',correct:false}]}}else{qs[qi].answerType='table';qs[qi].tableData={columns:['–ö–æ–¥','–û–ø–∏—Å'],rows:[['',''],['','']],correctRowIndex:0};qs[qi].options=[]}rebuildQuestions(qs)};
window.addTableColumn=qi=>{const qs=getFormQuestions();qs[qi].tableData.columns.push('');qs[qi].tableData.rows.forEach(r=>r.push(''));rebuildQuestions(qs)};
window.addTableRow=qi=>{const qs=getFormQuestions();const colCount=qs[qi].tableData.columns.length;qs[qi].tableData.rows.push(new Array(colCount).fill(''));rebuildQuestions(qs)};
window.delTableRow=(qi,ri)=>{const qs=getFormQuestions();qs[qi].tableData.rows.splice(ri,1);if(qs[qi].tableData.correctRowIndex>=qs[qi].tableData.rows.length){qs[qi].tableData.correctRowIndex=Math.max(0,qs[qi].tableData.rows.length-1)}rebuildQuestions(qs)};
window.toggleTableCorrect=(qi,ri)=>{const qs=getFormQuestions();qs[qi].tableData.correctRowIndex=ri;rebuildQuestions(qs)};
function rebuildQuestions(qs){const container=document.getElementById('questionsContainer');container.innerHTML=qs.map((q,qi)=>{let opts='';if(q.answerType==='table'){const cols=q.tableData?.columns||[],rows=q.tableData?.rows||[],correctRow=q.tableData?.correctRowIndex||0;opts=`<div class="table-builder"><div style="font-size:11px;font-weight:700;color:var(--primary);margin-bottom:8px">–°–¢–û–í–ü–¶–Ü –¢–ê–ë–õ–ò–¶–Ü</div><div class="table-builder-head" id="tableCols-${qi}">${cols.map((c,ci)=>`<input class="table-col-input" placeholder="–°—Ç–æ–≤–ø–µ—Ü—å ${ci+1}" value="${c}" data-qi="${qi}" data-ci="${ci}">`).join('')}</div><button class="add-opt-btn" onclick="addTableColumn(${qi})" style="margin-bottom:10px">+ –î–æ–¥–∞—Ç–∏ —Å—Ç–æ–≤–ø–µ—Ü—å</button><div style="font-size:11px;font-weight:700;color:var(--primary);margin-bottom:8px">–†–Ø–î–ö–ò –¢–ê–ë–õ–ò–¶–Ü</div><div class="table-builder-rows" id="tableRows-${qi}">${rows.map((row,ri)=>`<div class="table-row-builder"><div class="opt-radio${ri===correctRow?' checked':''}" onclick="toggleTableCorrect(${qi},${ri})"></div>${cols.map((c,ci)=>`<input class="table-cell-input" placeholder="${c}" value="${row[ci]||''}" data-qi="${qi}" data-ri="${ri}" data-ci="${ci}">`).join('')}<button class="opt-del" onclick="delTableRow(${qi},${ri})">‚úï</button></div>`).join('')}</div><button class="add-opt-btn" onclick="addTableRow(${qi})">+ –î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫</button></div>`}else{opts=q.options.map((o,oi)=>`<div class="opt-row"><div class="opt-radio${o.correct?' checked':''}" onclick="toggleCorrect(${qi},${oi})"></div><input class="opt-input" placeholder="–í–∞—Ä
13:32
l
e
t
t
e
r
s
[
o
i
]
‚à£
‚à£
o
i
+
1
"
v
a
l
u
e
=
"
letters[oi]‚à£‚à£oi+1"value="{o.text.replace(/"/g,'&quot;')}" data-qi="
q
i
"
d
a
t
a
‚àí
o
i
=
"
qi"data‚àíoi="{oi}"> <button class="opt-del" onclick="delOption(${qi},${oi})">‚úï</button></div>).join('');opts+=<button class="add-opt-btn" onclick="addOption(${qi})">+ –î–æ–¥–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç</button>}const imgPreview=questionImages[qi]?<img src="${questionImages[qi]}" class="q-image-preview" id="qimg-${qi}">:'';return<div class="q-block" id="qblock-${qi}"><div class="q-block-head"><span class="q-num">–ü–∏—Ç–∞–Ω–Ω—è ${qi+1}</span><button class="q-del" onclick="delQuestion(${qi})">üóë</button></div><textarea class="form-input" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Ç–∞–Ω–Ω—è..." id="qtext-${qi}" style="margin-bottom:12px;min-height:80px;resize:vertical">${q.text.replace(/"/g,'"')}</textarea><div class="q-image-section"><label class="form-label">üñº –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è –ø–∏—Ç–∞–Ω–Ω—è</label><input type="file" id="qimginput-${qi}" accept="image/*" style="display:none" onchange="handleQuestionImage(this,${qi})"><button class="btn-upload-img" onclick="document.getElementById('qimginput-${qi}').click()">üì∑ –û–ë–†–ê–¢–ò –ó–û–ë–†–ê–ñ–ï–ù–ù–Ø</button>
i
m
g
P
r
e
v
i
e
w
imgPreview{questionImages[qi]? <button class="btn-danger" onclick="removeQuestionImage(${qi})" style="margin-left:10px;padding:4px 10px;font-size:10px">‚úï –í–∏–¥–∞–ª–∏—Ç–∏</button>:''}</div><div style="margin-bottom:10px"><label class="form-label">–ß–∞—Å (—Å–µ–∫)</label><input class="form-input" type="number" id="qtime-${qi}" value="${q.timeLimit||30}" min="5" max="600"></div><div class="table-toggle-create" onclick="toggleTableMode(${qi})"><div class="toggle-switch${q.answerType==='table'?' on':''}" id="tableSwitch-${qi}"></div>–†–µ–∂–∏–º —Ç–∞–±–ª–∏—Ü—ñ</div><div id="opts-${qi}" style="margin-top:12px">${opts}</div><div class="free-toggle-create" onclick="toggleFreeCreate(${qi})"><div class="toggle-switch${q.allowFree?' on':''}" id="freeSwitch-${qi}"></div>–í—ñ–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</div></div>}).join('')} window.saveTest=async()=>{const name=document.getElementById('testName').value.trim(),desc=document.getElementById('testDesc').value.trim(),emoji=document.getElementById('testEmoji').value.trim()||'üìù',maxScore=parseInt(document.getElementById('testMaxScore').value)||12,passScore=parseInt(document.getElementById('testPassScore').value)||8,agreementText=document.getElementById('agreementText').value.trim(),qs=getFormQuestions();if(!name){alert('‚ùå –í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —ñ—Å–ø–∏—Ç—É!');return}for(let i=0;i<qs.length;i++){if(!qs[i].text.trim()){const el=document.getElementById('qblock-'+i);if(el){el.classList.add('error');el.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>el.classList.remove('error'),2000)}alert(‚ùå –ü–∏—Ç–∞–Ω–Ω—è ${i+1} –Ω–µ –º–∞—î —Ç–µ–∫—Å—Ç—É!);return}if(qs[i].answerType==='table'){if(!qs[i].tableData||qs[i].tableData.rows.length===0){const el=document.getElementById('qblock-'+i);if(el){el.classList.add('error');el.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>el.classList.remove('error'),2000)}alert(‚ùå –ü–∏—Ç–∞–Ω–Ω—è ${i+1}: –¥–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–∏–Ω —Ä—è–¥–æ–∫ —É —Ç–∞–±–ª–∏—Ü—é!);return}}else{const hasCorrect=qs[i].options.some(o=>o.correct);if(!hasCorrect&&!qs[i].allowFree){const el=document.getElementById('qblock-'+i);if(el){el.classList.add('error');el.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>el.classList.remove('error'),2000)}alert(‚ùå –ü–∏—Ç–∞–Ω–Ω—è ${i+1}: –æ–±–µ—Ä—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞–±–æ —É–≤—ñ–º–∫–Ω—ñ—Ç—å –≤—ñ–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å!);return}}}const testObj={name,description:desc,emoji,maxScore,passScore,questions:qs,agreementText,createdBy:ME.name,createdAt:now()};try{if(editingTestId){await updateDoc(doc(db,'tests',editingTestId),{...testObj,updatedAt:serverTimestamp()});addNotif(üìù –Ü—Å–ø–∏—Ç "${name}" –æ–Ω–æ–≤–ª–µ–Ω–æ!)}else{await addDoc(collection(db,'tests'),{...testObj,createdAt:serverTimestamp()});addNotif(üìù –Ü—Å–ø–∏—Ç "${name}" —Å—Ç–≤–æ—Ä–µ–Ω–æ!)}editingTestId=null;questionImages={};alert('‚úÖ –Ü—Å–ø–∏—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');showView('home')}catch(e){alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: '+e.message);console.error(e)}}; window.sendTestMsg=()=>{sendWebhook({title:'üß™ –¢–ï–°–¢–û–í–ï –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø',color:0x3b82f6,description:'–¶–µ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –Ü–°–ü–ò–¢ –¶–ï–ù–¢–†–£ –î–®–í.',fields:[{name:'üë§ –í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫',value:ME.name,inline:true},{name:'üìÖ –î–∞—Ç–∞',value:now(),inline:true}],footer:{text:'–î–®–í | –Ü–°–ü–ò–¢ –¶–ï–ù–¢–†'},timestamp:new Date().toISOString()});alert('üì© –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!')}; function renderReview(){const pending=results.filter(r=>r.status==='pending'||(r.status==='auto'&&!r.reviewedByHuman));if(pending.length===0){document.getElementById('reviewList').innerHTML='<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px">–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ ‚úì</div>';return}document.getElementById('reviewList').innerHTML=pending.map(r=>{const t=tests.find(x=>x.id===r.testId);let questionsHtml=r.details.map((d,i)=>{let cls=d.status==='correct'?'auto-ok':d.status==='pending'?'pending':'auto-fail',pts=d.status==='correct'?<span class="q-points" style="color:var(--primary)">+${Math.round(d.points*10)/10} –±.</span>:d.status==='wrong'?<span class="q-points" style="color:var(--danger)">0 –±.</span>:<span class="q-points" style="color:var(--warning)">? –±. ‚Äî –ø–æ—Ç—Ä—ñ–±–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞</span>;return<div class="review-q ${cls}"><div class="q-title">${i+1}. ${d.qText}</div><div class="q-answer">–í—ñ–¥–ø–æ–≤—ñ–¥—å: <b>${d.userAnswer}</b></div>${d.status!=='pending'?<div class="q-correct">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${d.correctAnswer}</div>:''}<div>${pts}</div></div>}).join('');const hasFreeQ=r.details.some(d=>d.status==='pending');return<div class="review-card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px"><div><h3 style="font-size:16px;font-weight:800">${r.userName}</h3><div style="font-size:12px;color:var(--text-gray)">${r.testName||'–Ü—Å–ø–∏—Ç'} ‚Ä¢ ${r.date}</div></div><div style="font-size:18px;font-weight:900;color:var(--primary)">${r.score} / ${r.maxScore} –±.</div></div>
q
u
e
s
t
i
o
n
s
H
t
m
l
questionsHtml{hasFreeQ? <div style="margin-top:15px;padding:15px;background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.15);border-radius:12px"><div style="font-size:12px;font-weight:800;color:var(--warning);margin-bottom:10px">‚ö†Ô∏è –í—ñ–ª—å–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</div><div class="btn-group" style="margin-top:10px"><button class="btn btn-primary" onclick="approveResult('${r.id}')">‚úÖ –°—Ö–≤–∞–ª–∏—Ç–∏</button><button class="btn btn-danger" onclick="rejectResult('${r.id}')">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button></div></div>:'<div class="btn-group"><button class="btn btn-primary" onclick="approveResult(\''+r.id+'\')">‚úÖ –°—Ö–≤–∞–ª–∏—Ç–∏</button><button class="btn btn-danger" onclick="rejectResult(\''+r.id+'\')">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button></div>'}</div>}).join('')} window.approveResult=async(id)=>{const r=results.find(x=>x.id===id);if(!r)return;const t=tests.find(x=>x.id===r.testId),pps=t?t.maxScore/t.questions.length:0;r.details.forEach(d=>{if(d.status==='pending'){d.status='correct';d.points=pps;r.score+=pps}});r.score=Math.round(r.score*100)/100;try{await updateDoc(doc(db,'results',id),{score:r.score,details:r.details,status:'approved',reviewer:ME.name,reviewedByHuman:true});sendTestResultWebhook(r,t||{passScore:0,maxScore:r.maxScore,name:r.testName},ME.name);addNotif(‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç ${r.userName} —Å—Ö–≤–∞–ª–µ–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–º ${ME.name})}catch(e){alert('–ü–æ–º–∏–ª–∫–∞: '+e.message)}}; window.rejectResult=async(id)=>{const r=results.find(x=>x.id===id);if(!r)return;const t=tests.find(x=>x.id===r.testId);r.details.forEach(d=>{if(d.status==='pending'){d.status='wrong';d.points=0}});try{await updateDoc(doc(db,'results',id),{details:r.details,status:'rejected',reviewer:ME.name,reviewedByHuman:true});sendTestResultWebhook(r,t||{passScore:0,maxScore:r.maxScore,name:r.testName},ME.name);addNotif(‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç ${r.userName} –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–º ${ME.name})}catch(e){alert('–ü–æ–º–∏–ª–∫–∞: '+e.message)}}; function renderManage(){if(tests.length===0){document.getElementById('manageList').innerHTML='<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px">–ù–µ–º–∞—î —ñ—Å–ø–∏—Ç—ñ–≤</div>';return}document.getElementById('manageList').innerHTML=tests.map(t=>{const res=results.filter(r=>r.testId===t.id),passed=res.filter(r=>(r.status==='approved'||r.status==='auto')&&r.score>=t.passScore&&r.reviewedByHuman).length;return<div class="manage-card"><div><b style="font-size:15px">${t.emoji} ${t.name}</b><br><span style="font-size:11px;color:var(--text-gray)">–ü–∏—Ç–∞–Ω—å: {t.questions.length} ‚Ä¢ –ú–∞–∫—Å: ${t.maxScore}–± ‚Ä¢ –ü—Ä–æ—Ö—ñ–¥: ${t.passScore}–± ‚Ä¢ –ü—Ä–æ–π—à–ª–∏: ${passed}/ {res.length} </span></div><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-info" onclick="editTest('${t.id}')" style="padding:8px 14px;font-size:11px">‚úèÔ∏è</button><button class="btn btn-warning" onclick="clearTestResults('${t.id}')" style="padding:8px 14px;font-size:11px">üßπ</button><button class="btn btn-danger" onclick="deleteTest('${t.id}')" style="padding:8px 14px;font-size:11px">üóë</button></div></div>}).join('')} window.editTest=async(id)=>{const t=tests.find(x=>x.id===id);if(t){editingTestId=id;renderCreateForm(t);showView('create')}}; window.clearTestResults=async(id)=>{if(confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ü—å–æ–≥–æ —ñ—Å–ø–∏—Ç—É?')){try{const toDelete=results.filter(r=>r.testId===id);for(const r of toDelete){await deleteDoc(doc(db,'results',r.id))}addNotif('üßπ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ—á–∏—â–µ–Ω–æ')}catch(e){alert('–ü–æ–º–∏–ª–∫–∞: '+e.message)}}}; window.deleteTest=async(id)=>{if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å–ø–∏—Ç?')){try{await deleteDoc(doc(db,'tests',id));const toDelete=results.filter(r=>r.testId===id);for(const r of toDelete){await deleteDoc(doc(db,'results',r.id))}addNotif('üóë –Ü—Å–ø–∏—Ç –≤–∏–¥–∞–ª–µ–Ω–æ')}catch(e){alert('–ü–æ–º–∏–ª–∫–∞: '+e.message)}}}; function renderSettings(){document.getElementById('settingsContent').innerHTML=<div class="setting-block"><h4>üîó Discord Webhook</h4><div class="form-row"><input class="form-input" id="webhookInput" value="${webhookUrl}" placeholder="https://discord.com/api/webhooks/..."></div><div class="btn-group" style="justify-content:flex-start"><button class="btn btn-primary" onclick="saveWebhook()" style="padding:10px 20px;font-size:12px">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button><button class="btn btn-info" onclick="sendTestMsg()" style="padding:10px 20px;font-size:12px">üì© –¢–µ—Å—Ç</button></div></div><div class="setting-block"><h4>üîç –ü–µ—Ä–µ–≤—ñ—Ä—é–≤–∞—á—ñ —ñ—Å–ø–∏—Ç—ñ–≤</h4><div id="reviewersList" style="margin-bottom:12px">${reviewers.map(r=><span class="reviewer-chip">${r}<button onclick="removeReviewer('${r}')">‚úï</button></span>).join('')||'<span style="color:var(--text-gray);font-size:12px">–ù–µ –¥–æ–¥–∞–Ω–æ</span>'}</div><div class="people-dropdown"><input class="form-input" id="reviewerSearch" placeholder="–ü–æ—à—É–∫ –ª—é–¥–∏–Ω–∏..." oninput="filterPeople('reviewer')" onfocus="filterPeople('reviewer')"><div class="people-list" id="reviewerDropdown"></div></div></div>} window.saveWebhook=()=>{webhookUrl=document.getElementById('webhookInput').value.trim();saveLocal();alert('‚úÖ Webhook –∑–±–µ—Ä–µ–∂–µ–Ω–æ!')}; window.removeReviewer=n=>{reviewers=reviewers.filter(r=>r!==n);saveLocal();renderSettings()}; window.filterPeople=(type)=>{const input=document.getElementById(type+'Search'),drop=document.getElementById(type+'Dropdown'),val=input.value.toLowerCase(),list=type==='reviewer'?allUsers.filter(u=>!reviewers.includes(u.name)):allUsers.filter(u=>!adminList.includes(u.name)),filtered=val?list.filter(u=>u.name.toLowerCase().includes(val)):list;if(filtered.length===0){drop.innerHTML='<div style="padding:15px;text-align:center;color:var(--text-gray);font-size:12px">–ù—ñ–∫–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';drop.classList.add('show');return}drop.innerHTML=filtered.map(u=>{const roleLabel=u.role==='admin'?'–ê–¥–º—ñ–Ω':u.role==='instructor'?'–Ü–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä':'–ë—ñ—î—Ü—å',roleColor=u.role==='admin'?'var(--primary)':u.role==='instructor'?'var(--warning)':'var(--text-gray)';return<div class="people-item" onclick="selectPerson('${type}','${u.name}')"><span>${u.name}</span><span style="font-size:10px;color:${roleColor};font-weight:700">${roleLabel}</span></div>}).join('');drop.classList.add('show')}; window.selectPerson=(type,name)=>{if(type==='reviewer'&&!reviewers.includes(name)){reviewers.push(name);saveLocal();renderSettings()}if(type==='admin'&&!adminList.includes(name)){adminList.push(name);saveLocal();renderAdminList();buildNav()}document.querySelectorAll('.people-list').forEach(d=>d.classList.remove('show'))}; document.addEventListener('click',e=>{if(!e.target.closest('.people-dropdown'))document.querySelectorAll('.people-list').forEach(d=>d.classList.remove('show'))}); function renderAdminList(){document.getElementById('adminListContent').innerHTML=<div class="admin-list-panel"><h4 style="font-size:13px;font-weight:800;color:var(--primary-bright);margin-bottom:15px">üëë –õ—é–¥–∏ –∑ –∞–¥–º—ñ–Ω –ø—Ä–∞–≤–∞–º–∏ –≤ —ñ—Å–ø–∏—Ç–∞—Ö</h4><p style="font-size:11px;color:var(--text-gray);margin-bottom:15px">–¶—ñ –ª—é–¥–∏ –º–∞—é—Ç—å –ø–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è, —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —ñ—Å–ø–∏—Ç—ñ–≤ (–æ–∫—Ä—ñ–º –≤–±—É–¥–æ–≤–∞–Ω–æ—ó —Ä–æ–ª—ñ admin –∑ Firebase)</p><div id="adminChips" style="margin-bottom:15px">${adminList.map(n=><span class="reviewer-chip" style="background:rgba(251,191,36,0.1);border-color:rgba(251,191,36,0.3);color:var(--warning)">${n}<button onclick="removeAdmin('${n}')">‚úï</button></span>).join('')||'<span style="color:var(--text-gray);font-size:12px">–ù–µ –¥–æ–¥–∞–Ω–æ</span>'}</div><div class="people-dropdown"><input class="form-input" id="adminSearch" placeholder="–ü–æ—à—É–∫ –ª—é–¥–∏–Ω–∏..." oninput="filterPeople('admin')" onfocus="filterPeople('admin')"><div class="people-list" id="adminDropdown"></div></div></div>`} window.removeAdmin=n=>{adminList=adminList.filter(a=>a!==n);saveLocal();renderAdminList();buildNav()}; renderNotifs(); document.onkeydown=e=>{if(e.keyCode===123||(e.ctrlKey&&e.shiftKey&&[73,74,67].includes(e.keyCode))||(e.ctrlKey&&e.keyCode===85))return false}; </script>

</body> </html> ```
