<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–î–®–í | –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
--primary: #00ff44;
--primary-bright: #e0ffe8;
--primary-glow: rgba(0,255,68,0.7);
--primary-dim: rgba(0,255,68,0.15);
--bg: #030507;
--card-bg: rgba(10,12,16,0.85);
--glass-border: rgba(0,255,68,0.3);
--danger: #ef4444;
--danger-glow: rgba(239,68,68,0.6);
--warning: #fbbf24;
--warning-glow: rgba(251,191,36,0.5);
--info: #3b82f6;
--info-glow: rgba(59,130,246,0.5);
--text-gray: #94a3b8;
--text-light: #cbd5e1;
--success: #10b981;
--card-hover: rgba(0,255,68,0.08);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
background: var(--bg);
color: white;
font-family: 'Inter', sans-serif;
min-height: 100vh;
overflow-x: hidden;
user-select: none;
-webkit-user-select: none;
}
body::before {
content: '';
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
background:
radial-gradient(ellipse at 15% 50%, rgba(0,255,68,0.18), transparent 55%),
radial-gradient(ellipse at 85% 20%, rgba(0,255,68,0.15), transparent 55%),
radial-gradient(ellipse at 50% 80%, rgba(0,255,68,0.12), transparent 55%);
pointer-events: none;
z-index: 0;
animation: bgPulse 10s ease-in-out infinite;
}
@keyframes bgPulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.75; }
}
input, textarea {
user-select: text !important;
-webkit-user-select: text !important;
}
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #0a0d12; }
::-webkit-scrollbar-thumb {
background: var(--primary);
border-radius: 10px;
box-shadow: 0 0 8px var(--primary);
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}
@keyframes slideDown {
from { opacity: 0; transform: translateY(-15px); }
to { opacity: 1; transform: translateY(0); }
}
@keyframes pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}
@keyframes glow {
0%, 100% { box-shadow: 0 0 5px var(--primary-glow); }
50% { box-shadow: 0 0 25px var(--primary-glow), 0 0 50px rgba(0,255,68,0.2); }
}
@keyframes shake {
0%, 100% { transform: translateX(0); }
20%, 60% { transform: translateX(-8px); }
40%, 80% { transform: translateX(8px); }
}

/* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é */
.context-menu {
position: fixed;
background: rgba(10,15,25,0.98);
border: 1px solid var(--glass-border);
border-radius: 12px;
padding: 6px;
z-index: 9999;
display: none;
min-width: 180px;
backdrop-filter: blur(20px);
box-shadow: 0 10px 40px rgba(0,0,0,0.9), 0 0 20px rgba(0,255,68,0.2);
animation: slideDown 0.2s ease;
}
.context-menu.active {
display: block;
}
.context-menu-item {
padding: 10px 14px;
cursor: pointer;
font-size: 12px;
font-weight: 600;
border-radius: 8px;
transition: 0.2s;
display: flex;
align-items: center;
gap: 10px;
color: var(--text-light);
}
.context-menu-item:hover {
background: rgba(0,255,68,0.1);
color: var(--primary-bright);
}
.context-menu-item.danger:hover {
background: rgba(239,68,68,0.1);
color: var(--danger);
}
.context-menu-divider {
height: 1px;
background: rgba(255,255,255,0.1);
margin: 4px 0;
}

/* Modal –¥–ª—è –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è */
.modal-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.85);
z-index: 8888;
display: none;
justify-content: center;
align-items: center;
backdrop-filter: blur(10px);
}
.modal-overlay.active {
display: flex;
}
.modal-box {
background: var(--card-bg);
border: 1px solid var(--glass-border);
border-radius: 20px;
padding: 30px;
max-width: 500px;
width: 90%;
backdrop-filter: blur(20px);
animation: fadeIn 0.3s ease;
}
.modal-box h3 {
font-size: 18px;
font-weight: 900;
margin-bottom: 15px;
color: var(--primary-bright);
}
.modal-box .link-display {
background: rgba(0,0,0,0.4);
border: 1px solid rgba(0,255,68,0.2);
border-radius: 12px;
padding: 12px;
font-size: 12px;
color: var(--primary);
word-break: break-all;
margin: 15px 0;
font-family: 'Courier New', monospace;
}

/* Score controls –¥–ª—è review */
.score-controls {
display: flex;
align-items: center;
gap: 8px;
margin-top: 8px;
}
.score-btn {
background: rgba(0,255,68,0.1);
border: 1px solid rgba(0,255,68,0.3);
color: var(--primary);
width: 32px;
height: 32px;
border-radius: 8px;
cursor: pointer;
font-size: 16px;
font-weight: 900;
display: flex;
align-items: center;
justify-content: center;
transition: 0.2s;
}
.score-btn:hover {
background: rgba(0,255,68,0.2);
transform: scale(1.1);
}
.score-btn.minus {
background: rgba(239,68,68,0.1);
border-color: rgba(239,68,68,0.3);
color: var(--danger);
}
.score-btn.minus:hover {
background: rgba(239,68,68,0.2);
}
.score-display {
font-size: 16px;
font-weight: 900;
color: var(--primary);
min-width: 60px;
text-align: center;
background: rgba(0,255,68,0.05);
border-radius: 8px;
padding: 6px 10px;
}
</style>
<style>
header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 15px 5%;
background: rgba(3,5,7,0.9);
border-bottom: 1px solid var(--glass-border);
position: sticky;
top: 0;
z-index: 1000;
backdrop-filter: blur(20px);
}

.logo-box {
background: var(--primary);
color: black;
padding: 8px 16px;
border-radius: 10px;
font-weight: 900;
text-decoration: none;
font-size: 14px;
text-transform: uppercase;
box-shadow: 0 0 20px var(--primary-glow);
transition: 0.3s;
letter-spacing: 1px;
}

.logo-box:hover {
box-shadow: 0 0 30px var(--primary-glow);
transform: translateY(-2px);
}

.header-right {
display: flex;
align-items: center;
gap: 12px;
flex-wrap: wrap;
}

.user-name-header {
font-family: 'Inter', sans-serif;
font-weight: 700;
font-size: 13px;
color: var(--primary-bright);
letter-spacing: 0.3px;
}

.role-badge {
padding: 6px 14px;
border-radius: 8px;
font-size: 11px;
font-weight: 900;
text-transform: uppercase;
letter-spacing: 1px;
border: 1px solid;
}

.role-admin {
background: rgba(0,255,68,0.15);
color: var(--primary);
border-color: var(--primary);
box-shadow: 0 0 15px rgba(0,255,68,0.3);
}

.role-instructor {
background: rgba(251,191,36,0.15);
color: var(--warning);
border-color: var(--warning);
box-shadow: 0 0 15px rgba(251,191,36,0.3);
}

.role-fighter {
background: rgba(59,130,246,0.15);
color: var(--info);
border-color: var(--info);
box-shadow: 0 0 15px rgba(59,130,246,0.3);
}

.nav-tabs { display: flex; gap: 6px; flex-wrap: wrap; }

.nav-btn {
background: rgba(255,255,255,0.03);
border: 1px solid rgba(255,255,255,0.1);
color: var(--text-light);
padding: 10px 18px;
border-radius: 12px;
font-weight: 700;
cursor: pointer;
font-size: 12px;
position: relative;
overflow: hidden;
transition: all 0.3s ease;
text-transform: uppercase;
letter-spacing: 0.5px;
}

.nav-btn:hover {
border-color: var(--primary);
color: var(--primary-bright);
background: rgba(0,255,68,0.08);
transform: translateY(-2px);
}

.nav-btn.active {
background: var(--primary);
color: black;
border-color: var(--primary);
box-shadow: 0 0 20px var(--primary-glow);
font-weight: 900;
}

.main-wrap {
max-width: 1200px;
margin: 0 auto;
padding: 30px 20px;
}

.view {
display: none;
animation: fadeIn 0.5s ease;
}

.view.active { display: block; }

.stats-row {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 15px;
margin-bottom: 30px;
}

.stat-card {
background: var(--card-bg);
border: 1px solid rgba(0,255,68,0.15);
border-radius: 16px;
padding: 22px;
text-align: center;
backdrop-filter: blur(10px);
transition: all 0.3s ease;
}

.stat-card:hover {
border-color: var(--primary);
transform: translateY(-3px);
box-shadow: 0 8px 30px rgba(0,255,68,0.15);
}

.stat-num {
font-size: 32px;
font-weight: 900;
color: var(--primary);
text-shadow: 0 0 15px var(--primary-glow);
margin-bottom: 4px;
}

.stat-label {
font-size: 10px;
font-weight: 700;
color: var(--text-gray);
text-transform: uppercase;
letter-spacing: 1.5px;
}

.section-title {
font-size: 18px;
font-weight: 900;
color: var(--primary-bright);
margin-bottom: 20px;
display: flex;
align-items: center;
gap: 10px;
text-transform: uppercase;
letter-spacing: 1px;
}

.tests-grid {
display: flex;
flex-wrap: wrap;
justify-content: center;
gap: 20px;
margin-bottom: 40px;
}

.test-card {
background: var(--card-bg);
border: 1px solid rgba(0,255,68,0.15);
border-radius: 20px;
padding: 28px;
width: 320px;
backdrop-filter: blur(10px);
transition: all 0.4s ease;
cursor: pointer;
position: relative;
}

.test-card:hover {
border-color: var(--primary);
transform: translateY(-5px);
box-shadow: 0 10px 40px rgba(0,255,68,0.2);
}

.test-card .emoji {
font-size: 48px;
margin-bottom: 15px;
display: block;
}

.test-card h3 {
font-size: 17px;
font-weight: 800;
margin-bottom: 8px;
color: white;
}

.test-card p {
font-size: 12px;
color: var(--text-gray);
margin-bottom: 15px;
line-height: 1.5;
}

.test-meta {
display: flex;
gap: 8px;
flex-wrap: wrap;
}

.meta-tag {
font-size: 10px;
padding: 5px 10px;
border-radius: 8px;
font-weight: 700;
background: rgba(0,255,68,0.1);
color: var(--primary);
border: 1px solid rgba(0,255,68,0.2);
}

.agreement-box {
background: rgba(251,191,36,0.05);
border: 1px solid rgba(251,191,36,0.3);
border-radius: 16px;
padding: 20px;
margin-bottom: 25px;
}

.agreement-check {
display: flex;
align-items: flex-start;
gap: 12px;
cursor: pointer;
user-select: none;
}

.agreement-check input[type="checkbox"] {
width: 22px;
height: 22px;
cursor: pointer;
accent-color: var(--primary);
flex-shrink: 0;
margin-top: 2px;
}

.agreement-text {
font-size: 13px;
color: var(--text-light);
line-height: 1.6;
user-select: text;
}

.agreement-text strong {
color: var(--warning);
font-weight: 800;
}

.intro-card {
max-width: 600px;
margin: 40px auto;
background: var(--card-bg);
border: 1px solid var(--glass-border);
border-radius: 24px;
padding: 40px;
text-align: center;
backdrop-filter: blur(10px);
}

.intro-card .emoji {
font-size: 64px;
margin-bottom: 20px;
display: block;
}

.intro-card h2 {
font-size: 24px;
font-weight: 900;
margin-bottom: 10px;
}

.intro-card p {
color: var(--text-gray);
font-size: 13px;
margin-bottom: 8px;
}

.quiz-container {
max-width: 700px;
margin: 20px auto;
}

.quiz-progress-bar {
width: 100%;
height: 6px;
background: rgba(255,255,255,0.05);
border-radius: 10px;
margin-bottom: 25px;
overflow: hidden;
}

.quiz-progress-fill {
height: 100%;
background: linear-gradient(90deg, var(--primary), #00ff88);
border-radius: 10px;
transition: width 0.5s ease;
box-shadow: 0 0 10px var(--primary-glow);
}

.quiz-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
flex-wrap: wrap;
gap: 10px;
}

.quiz-timer {
font-size: 28px;
font-weight: 900;
color: var(--warning);
text-shadow: 0 0 15px var(--warning-glow);
}

.quiz-timer.danger {
color: var(--danger);
text-shadow: 0 0 15px var(--danger-glow);
animation: pulse 0.5s infinite;
}

.quiz-question {
background: var(--card-bg);
border: 1px solid var(--glass-border);
border-radius: 20px;
padding: 30px;
margin-bottom: 20px;
backdrop-filter: blur(10px);
}

.quiz-question h3 {
font-size: 18px;
font-weight: 800;
margin-bottom: 5px;
line-height: 1.6;
white-space: pre-wrap;
word-wrap: break-word;
}

.quiz-answers {
display: flex;
flex-direction: column;
gap: 10px;
margin-bottom: 20px;
}

.answer-btn {
background: rgba(255,255,255,0.03);
border: 2px solid rgba(255,255,255,0.08);
border-radius: 14px;
padding: 16px 20px;
color: white;
font-size: 14px;
font-weight: 600;
cursor: pointer;
text-align: left;
transition: all 0.3s ease;
display: flex;
align-items: center;
gap: 12px;
}

.answer-btn:hover {
border-color: var(--primary);
background: rgba(0,255,68,0.05);
transform: translateX(5px);
}

.answer-btn.selected {
border-color: var(--primary);
background: rgba(0,255,68,0.1);
box-shadow: 0 0 20px rgba(0,255,68,0.15);
}

.answer-letter {
width: 32px;
height: 32px;
border-radius: 10px;
background: rgba(255,255,255,0.05);
display: flex;
align-items: center;
justify-content: center;
font-weight: 900;
font-size: 13px;
color: var(--text-gray);
flex-shrink: 0;
border: 1px solid rgba(255,255,255,0.1);
transition: 0.3s;
}

.answer-btn.selected .answer-letter {
background: var(--primary);
color: black;
border-color: var(--primary);
box-shadow: 0 0 10px var(--primary-glow);
}

.btn {
padding: 14px 28px;
border: none;
border-radius: 14px;
font-weight: 800;
font-size: 13px;
cursor: pointer;
text-transform: uppercase;
letter-spacing: 0.5px;
transition: all 0.3s ease;
}

.btn:active {
transform: scale(0.96);
}

.btn-primary {
background: var(--primary);
color: black;
box-shadow: 0 4px 15px rgba(0,255,68,0.3);
}

.btn-primary:hover {
background: var(--primary-bright);
box-shadow: 0 6px 25px rgba(0,255,68,0.5);
transform: translateY(-2px);
}

.btn-primary:disabled {
opacity: 0.5;
cursor: not-allowed;
background: rgba(0,255,68,0.2);
}

.btn-secondary {
background: rgba(255,255,255,0.05);
border: 1px solid rgba(255,255,255,0.15);
color: white;
}

.btn-secondary:hover {
border-color: var(--primary);
color: var(--primary-bright);
background: rgba(0,255,68,0.08);
transform: translateY(-2px);
}

.btn-danger {
background: rgba(239,68,68,0.1);
border: 1px solid var(--danger);
color: var(--danger);
}

.btn-danger:hover {
background: var(--danger);
color: white;
transform: translateY(-2px);
box-shadow: 0 6px 20px var(--danger-glow);
}

.btn-warning {
background: rgba(251,191,36,0.1);
border: 1px solid var(--warning);
color: var(--warning);
}

.btn-warning:hover {
background: var(--warning);
color: black;
transform: translateY(-2px);
box-shadow: 0 6px 20px var(--warning-glow);
}

.btn-info {
background: rgba(59,130,246,0.1);
border: 1px solid var(--info);
color: var(--info);
}

.btn-info:hover {
background: var(--info);
color: white;
transform: translateY(-2px);
box-shadow: 0 6px 20px var(--info-glow);
}

.btn-group {
display: flex;
gap: 10px;
justify-content: center;
margin-top: 25px;
flex-wrap: wrap;
}

.form-card {
background: var(--card-bg);
border: 1px solid var(--glass-border);
border-radius: 20px;
padding: 30px;
backdrop-filter: blur(10px);
margin-bottom: 20px;
}

.form-row {
margin-bottom: 18px;
}

.form-label {
display: block;
font-size: 11px;
color: var(--primary);
margin-bottom: 8px;
text-transform: uppercase;
font-weight: 800;
letter-spacing: 1px;
}

.form-input {
width: 100%;
background: rgba(0,0,0,0.4);
border: 1px solid rgba(255,255,255,0.1);
color: white;
padding: 14px;
border-radius: 12px;
font-size: 14px;
outline: none;
font-family: inherit;
transition: 0.3s;
}

.form-input:focus {
border-color: var(--primary);
box-shadow: 0 0 15px rgba(0,255,68,0.15);
}

.form-row-inline {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 15px;
}

.form-hint {
font-size: 11px;
color: var(--text-gray);
margin-top: 8px;
font-weight: 600;
}

.result-detail {
background: var(--card-bg);
border: 1px solid rgba(255,255,255,0.05);
border-radius: 16px;
padding: 18px;
margin-bottom: 10px;
text-align: left;
display: flex;
align-items: flex-start;
gap: 12px;
}

.result-detail .mark {
width: 28px;
height: 28px;
border-radius: 8px;
display: flex;
align-items: center;
justify-content: center;
font-size: 14px;
flex-shrink: 0;
font-weight: 900;
}

.mark.ok {
background: rgba(0,255,68,0.15);
color: var(--primary);
}

.mark.no {
background: rgba(239,68,68,0.15);
color: var(--danger);
}

.mark.pend {
background: rgba(251,191,36,0.15);
color: var(--warning);
}

.result-circle {
width: 160px;
height: 160px;
border-radius: 50%;
margin: 0 auto 25px;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
border: 4px solid;
}

.result-circle.pass {
border-color: var(--primary);
box-shadow: 0 0 40px var(--primary-glow);
animation: glow 2s infinite;
}

.result-circle.fail {
border-color: var(--danger);
box-shadow: 0 0 40px var(--danger-glow);
}

.result-score {
font-size: 36px;
font-weight: 900;
}

.result-max {
font-size: 12px;
color: var(--text-gray);
font-weight: 700;
}

.result-status {
font-size: 28px;
font-weight: 900;
margin-bottom: 10px;
}

.result-status.pass {
color: var(--primary);
text-shadow: 0 0 20px var(--primary-glow);
}

.result-status.fail {
color: var(--danger);
text-shadow: 0 0 20px var(--danger-glow);
}

.results-table {
width: 100%;
border-collapse: collapse;
margin-top: 15px;
overflow-x: auto;
display: block;
}

.results-table table {
width: 100%;
min-width: 600px;
}

.results-table th {
text-align: left;
padding: 12px 15px;
font-size: 10px;
color: var(--primary);
text-transform: uppercase;
letter-spacing: 1px;
border-bottom: 2px solid var(--glass-border);
font-weight: 800;
}

.results-table td {
padding: 12px 15px;
font-size: 13px;
border-bottom: 1px solid rgba(255,255,255,0.04);
}

.results-table tr:hover td {
background: rgba(0,255,68,0.03);
}

.status-badge {
padding: 4px 12px;
border-radius: 8px;
font-size: 10px;
font-weight: 800;
text-transform: uppercase;
white-space: nowrap;
}

.st-pass {
background: rgba(16,185,129,0.15);
color: var(--success);
border: 1px solid rgba(16,185,129,0.3);
}

.st-fail {
background: rgba(239,68,68,0.15);
color: var(--danger);
border: 1px solid rgba(239,68,68,0.3);
}

.st-pending {
background: rgba(251,191,36,0.15);
color: var(--warning);
border: 1px solid rgba(251,191,36,0.3);
}

.st-approved {
background: rgba(0,255,68,0.15);
color: var(--primary);
border: 1px solid rgba(0,255,68,0.3);
}

.st-rejected {
background: rgba(239,68,68,0.15);
color: var(--danger);
border: 1px solid rgba(239,68,68,0.3);
}

.test-photo-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
gap: 12px;
margin-top: 15px;
}

.test-photo-item {
position: relative;
border-radius: 12px;
overflow: hidden;
cursor: zoom-in;
border: 1px solid rgba(255,255,255,0.1);
transition: 0.3s;
}

.test-photo-item:hover {
transform: scale(1.05);
border-color: var(--primary);
box-shadow: 0 0 20px rgba(0,255,68,0.3);
}

.test-photo-item img {
width: 100%;
height: 120px;
object-fit: cover;
}

.photo-delete-mini {
position: absolute;
top: 5px;
right: 5px;
background: rgba(239,68,68,0.9);
color: white;
border: none;
width: 24px;
height: 24px;
border-radius: 50%;
cursor: pointer;
font-size: 14px;
display: flex;
align-items: center;
justify-content: center;
font-weight: 900;
}

.upload-photo-btn {
background: rgba(0,255,68,0.1);
border: 2px dashed var(--primary);
color: var(--primary);
padding: 12px 24px;
border-radius: 12px;
cursor: pointer;
font-weight: 700;
font-size: 13px;
transition: 0.3s;
margin-top: 15px;
width: 100%;
}

.upload-photo-btn:hover {
background: rgba(0,255,68,0.2);
transform: translateY(-2px);
}

.question-photo-section {
margin-top: 12px;
margin-bottom: 12px;
}

.question-photo-preview {
position: relative;
display: inline-block;
border-radius: 12px;
overflow: hidden;
border: 1px solid rgba(0,255,68,0.2);
}

.question-photo-preview img {
width: 200px;
height: 150px;
object-fit: cover;
display: block;
cursor: zoom-in;
}

.question-photo-delete {
position: absolute;
top: 8px;
right: 8px;
background: rgba(239,68,68,0.95);
color: white;
border: none;
width: 28px;
height: 28px;
border-radius: 50%;
cursor: pointer;
font-size: 16px;
display: flex;
align-items: center;
justify-content: center;
font-weight: 900;
}

.add-question-photo-btn {
background: rgba(0,255,68,0.08);
border: 1px dashed rgba(0,255,68,0.3);
color: var(--primary);
padding: 8px 16px;
border-radius: 10px;
cursor: pointer;
font-size: 12px;
font-weight: 700;
transition: 0.3s;
}

.add-question-photo-btn:hover {
background: rgba(0,255,68,0.15);
border-color: var(--primary);
}

.quiz-question-photo {
margin-top: 15px;
margin-bottom: 15px;
text-align: center;
}

.quiz-question-photo img {
max-width: 100%;
max-height: 300px;
border-radius: 12px;
border: 1px solid rgba(0,255,68,0.2);
cursor: zoom-in;
transition: 0.3s;
}

.quiz-question-photo img:hover {
transform: scale(1.02);
border-color: var(--primary);
box-shadow: 0 0 20px rgba(0,255,68,0.3);
}

.lightbox {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.95);
z-index: 3000;
display: none;
justify-content: center;
align-items: center;
backdrop-filter: blur(10px);
}

.lightbox.active {
display: flex;
}

.lightbox-img {
max-width: 90%;
max-height: 85vh;
border-radius: 8px;
box-shadow: 0 0 50px rgba(0,255,68,0.3);
}

.lightbox-close {
position: absolute;
top: 30px;
right: 30px;
font-size: 40px;
color: white;
cursor: pointer;
opacity: 0.7;
transition: 0.3s;
z-index: 3001;
}

.lightbox-close:hover {
opacity: 1;
color: var(--danger);
transform: rotate(90deg);
}

.q-block {
background: var(--card-bg);
border: 1px solid rgba(255,255,255,0.08);
border-radius: 16px;
padding: 20px;
margin-bottom: 15px;
transition: 0.3s;
}

.q-block:hover {
border-color: rgba(0,255,68,0.2);
}

.q-block.error {
border-color: var(--danger) !important;
animation: shake 0.5s;
box-shadow: 0 0 20px var(--danger-glow);
}

.q-block-head {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 12px;
}

.q-num {
font-size: 12px;
font-weight: 800;
color: var(--primary);
text-transform: uppercase;
letter-spacing: 1px;
}

.q-del {
background: none;
border: none;
color: var(--danger);
cursor: pointer;
font-size: 18px;
opacity: 0.5;
transition: 0.3s;
}

.q-del:hover {
opacity: 1;
transform: scale(1.2);
}

.opt-row {
display: flex;
align-items: center;
gap: 10px;
margin-bottom: 8px;
}

.opt-radio {
width: 22px;
height: 22px;
border-radius: 50%;
border: 2px solid rgba(255,255,255,0.2);
cursor: pointer;
transition: 0.3s;
flex-shrink: 0;
display: flex;
align-items: center;
justify-content: center;
}

.opt-radio:hover {
border-color: var(--primary);
}

.opt-radio.checked {
border-color: var(--primary);
background: var(--primary);
box-shadow: 0 0 10px var(--primary-glow);
}

.opt-radio.checked::after {
content: '‚úì';
color: black;
font-size: 12px;
font-weight: 900;
}

.opt-input {
flex: 1;
background: rgba(0,0,0,0.3);
border: 1px solid rgba(255,255,255,0.08);
color: white;
padding: 10px 14px;
border-radius: 10px;
font-size: 13px;
outline: none;
font-family: inherit;
transition: 0.3s;
}

.opt-input:focus {
border-color: var(--primary);
}

.opt-del {
background: none;
border: none;
color: var(--danger);
cursor: pointer;
font-size: 14px;
opacity: 0.4;
transition: 0.3s;
}

.opt-del:hover {
opacity: 1;
}

.add-opt-btn {
background: none;
border: 1px dashed rgba(255,255,255,0.1);
color: var(--text-gray);
padding: 8px;
border-radius: 10px;
cursor: pointer;
font-size: 12px;
width: 100%;
transition: 0.3s;
font-weight: 600;
}

.add-opt-btn:hover {
border-color: var(--primary);
color: var(--primary);
}

.free-toggle-create,
.table-toggle-create {
display: flex;
align-items: center;
gap: 8px;
margin-top: 10px;
cursor: pointer;
font-size: 12px;
color: var(--text-gray);
font-weight: 600;
transition: 0.3s;
}

.free-toggle-create:hover,
.table-toggle-create:hover {
color: var(--primary);
}

.toggle-switch {
width: 36px;
height: 20px;
border-radius: 12px;
background: rgba(255,255,255,0.1);
position: relative;
transition: 0.3s;
flex-shrink: 0;
}

.toggle-switch.on {
background: var(--primary);
}

.toggle-switch::after {
content: '';
position: absolute;
top: 2px;
left: 2px;
width: 16px;
height: 16px;
border-radius: 50%;
background: white;
transition: 0.3s;
}

.toggle-switch.on::after {
left: 18px;
}

.table-builder {
margin-top: 15px;
padding: 15px;
background: rgba(0,255,68,0.03);
border: 1px solid rgba(0,255,68,0.15);
border-radius: 12px;
}

.table-builder-head {
display: flex;
gap: 10px;
margin-bottom: 10px;
flex-wrap: wrap;
}

.table-col-input {
flex: 1;
min-width: 100px;
background: rgba(0,0,0,0.3);
border: 1px solid rgba(255,255,255,0.1);
color: white;
padding: 8px 12px;
border-radius: 8px;
font-size: 12px;
outline: none;
font-family: inherit;
}

.table-col-input:focus {
border-color: var(--primary);
}

.table-builder-rows {
margin-top: 10px;
}

.table-row-builder {
display: flex;
gap: 10px;
margin-bottom: 8px;
align-items: center;
}

.table-cell-input {
flex: 1;
min-width: 100px;
background: rgba(0,0,0,0.4);
border: 1px solid rgba(255,255,255,0.08);
color: white;
padding: 8px 12px;
border-radius: 8px;
font-size: 12px;
outline: none;
font-family: inherit;
}

.table-cell-input:focus {
border-color: var(--primary);
}

.answer-table-wrapper {
overflow-x: auto;
margin-bottom: 15px;
}

.answer-table {
width: 100%;
border-collapse: collapse;
background: rgba(0,0,0,0.3);
border-radius: 12px;
overflow: hidden;
}

.answer-table th {
background: rgba(0,255,68,0.1);
color: var(--primary);
padding: 12px;
text-align: left;
font-size: 12px;
font-weight: 800;
text-transform: uppercase;
border-bottom: 2px solid rgba(0,255,68,0.2);
}

.answer-table td {
padding: 12px;
border-bottom: 1px solid rgba(255,255,255,0.05);
font-size: 13px;
}

.answer-table tr:hover td {
background: rgba(0,255,68,0.03);
}

.table-radio {
width: 24px;
height: 24px;
border-radius: 50%;
border: 2px solid rgba(255,255,255,0.2);
cursor: pointer;
transition: 0.3s;
display: inline-flex;
align-items: center;
justify-content: center;
vertical-align: middle;
}

.table-radio:hover {
border-color: var(--primary);
}

.table-radio.checked {
border-color: var(--primary);
background: var(--primary);
box-shadow: 0 0 10px var(--primary-glow);
}

.table-radio.checked::after {
content: '‚úì';
color: black;
font-size: 12px;
font-weight: 900;
}

.free-answer-area {
margin-top: 15px;
}

.free-answer-toggle {
display: flex;
align-items: center;
gap: 10px;
cursor: pointer;
padding: 12px 16px;
border-radius: 12px;
border: 1px dashed rgba(255,255,255,0.1);
background: rgba(255,255,255,0.02);
transition: 0.3s;
font-size: 13px;
color: var(--text-gray);
font-weight: 600;
}

.free-answer-toggle:hover {
border-color: var(--primary);
color: var(--primary-bright);
background: rgba(0,255,68,0.05);
}

.free-answer-toggle.active {
border-color: var(--primary);
color: var(--primary);
background: rgba(0,255,68,0.08);
}

.free-input {
width: 100%;
margin-top: 10px;
background: rgba(0,0,0,0.4);
border: 1px solid rgba(255,255,255,0.1);
color: white;
padding: 14px;
border-radius: 12px;
font-size: 14px;
outline: none;
font-family: inherit;
resize: vertical;
min-height: 80px;
transition: 0.3s;
}

.free-input:focus {
border-color: var(--primary);
box-shadow: 0 0 15px rgba(0,255,68,0.2);
}

.reviewer-chip {
display: inline-flex;
align-items: center;
gap: 6px;
background: rgba(0,255,68,0.1);
border: 1px solid rgba(0,255,68,0.2);
color: var(--primary-bright);
padding: 6px 12px;
border-radius: 10px;
font-size: 12px;
font-weight: 700;
margin: 3px;
}

.reviewer-chip button {
background: none;
border: none;
color: var(--danger);
cursor: pointer;
font-size: 14px;
margin-left: 4px;
}

.people-dropdown {
position: relative;
}

.people-list {
position: absolute;
top: 100%;
left: 0;
right: 0;
background: rgba(10,15,25,0.98);
border: 1px solid var(--glass-border);
border-radius: 12px;
max-height: 200px;
overflow-y: auto;
z-index: 100;
display: none;
box-shadow: 0 10px 40px rgba(0,0,0,0.8);
}

.people-list.show {
display: block;
animation: slideDown 0.2s ease;
}

.people-item {
padding: 10px 15px;
cursor: pointer;
font-size: 13px;
display: flex;
justify-content: space-between;
align-items: center;
transition: 0.2s;
}

.people-item:hover {
background: rgba(0,255,68,0.08);
}

.review-card {
background: var(--card-bg);
border: 1px solid rgba(255,255,255,0.06);
border-radius: 18px;
padding: 25px;
margin-bottom: 15px;
}

.review-q {
margin-bottom: 15px;
padding: 15px;
background: rgba(255,255,255,0.02);
border-radius: 12px;
border-left: 3px solid;
}

.review-q.auto-ok {
border-color: var(--primary);
}

.review-q.auto-fail {
border-color: var(--danger);
}

.review-q.pending {
border-color: var(--warning);
}

.review-q .q-title {
font-size: 13px;
font-weight: 700;
margin-bottom: 6px;
word-wrap: break-word;
}

.review-q .q-answer {
font-size: 12px;
color: var(--text-light);
word-wrap: break-word;
}

.review-q .q-correct {
font-size: 11px;
color: var(--primary);
margin-top: 4px;
}

.review-q .q-points {
font-size: 11px;
font-weight: 800;
margin-top: 4px;
}

.setting-block {
background: var(--card-bg);
border: 1px solid rgba(255,255,255,0.05);
border-radius: 16px;
padding: 22px;
margin-bottom: 15px;
}

.setting-block h4 {
font-size: 13px;
font-weight: 800;
color: var(--primary-bright);
margin-bottom: 12px;
display: flex;
align-items: center;
gap: 8px;
}

.admin-list-panel {
background: var(--card-bg);
border: 1px solid rgba(255,255,255,0.06);
border-radius: 16px;
padding: 22px;
margin-bottom: 15px;
}

.manage-card {
background: var(--card-bg);
border: 1px solid rgba(255,255,255,0.05);
border-radius: 14px;
padding: 18px 20px;
margin-bottom: 10px;
display: flex;
justify-content: space-between;
align-items: center;
transition: 0.3s;
flex-wrap: wrap;
gap: 15px;
}

.manage-card:hover {
border-color: var(--glass-border);
background: rgba(0,255,68,0.03);
}

@media(max-width: 768px) {
.stats-row {
grid-template-columns: 1fr 1fr;
}
.test-card {
width: 100%;
max-width: 400px;
}
.form-row-inline {
grid-template-columns: 1fr;
}
.btn-group {
flex-direction: column;
}
.btn {
width: 100%;
}
}

@media(max-width: 480px) {
.stats-row {
grid-template-columns: 1fr;
}
header {
flex-direction: column;
gap: 10px;
}
}
</style>
</head>
<body>

<header>
<a href="cabinet.html" class="logo-box">‚öî –î–®–í</a>
<div class="header-right">
<div class="nav-tabs" id="navTabs"></div>
<span class="user-name-header" id="headerName">...</span>
<span class="role-badge" id="headerRole">...</span>
</div>
</header>

<div class="main-wrap">
<div class="view active" id="viewHome">
<div class="stats-row" id="statsRow"></div>
<div class="section-title">üìã –î–æ—Å—Ç—É–ø–Ω—ñ —ñ—Å–ø–∏—Ç–∏</div>
<div class="tests-grid" id="testsGrid"></div>
<div class="section-title">üìä –ú–æ—ó —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏</div>
<div id="myResults"></div>
</div>

<div class="view" id="viewIntro">
<div class="intro-card" id="introCard"></div>
</div>

<div class="view" id="viewQuiz">
<div class="quiz-container" id="quizContainer"></div>
</div>

<div class="view" id="viewResult">
<div class="result-screen" id="resultScreen"></div>
</div>

<div class="view" id="viewCreate">
<div class="section-title" id="createTitle">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ—Å–ø–∏—Ç</div>
<div id="createForm"></div>
</div>

<div class="view" id="viewReview">
<div class="section-title">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</div>
<div id="reviewList"></div>
</div>

<div class="view" id="viewManage">
<div class="section-title">‚öôÔ∏è –ö–µ—Ä—É–≤–∞–Ω–Ω—è —ñ—Å–ø–∏—Ç–∞–º–∏</div>
<div id="manageList"></div>
</div>

<div class="view" id="viewSettings">
<div class="section-title">üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
<div id="settingsContent"></div>
</div>

<div class="view" id="viewAdminList">
<div class="section-title">üëë –ê–¥–º—ñ–Ω –ø—Ä–∞–≤–∞ –≤ —ñ—Å–ø–∏—Ç–∞—Ö</div>
<div id="adminListContent"></div>
</div>

<div class="view" id="viewHistory">
<div class="section-title">üìú –Ü—Å—Ç–æ—Ä—ñ—è –≤—Å—ñ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</div>
<div id="historyContent"></div>
</div>
</div>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é -->
<div id="contextMenu" class="context-menu">
<div class="context-menu-item" onclick="contextEditTest()">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</div>
<div class="context-menu-item" onclick="contextPublicLink()">üîó –ü—É–±–ª—ñ—á–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</div>
<div class="context-menu-divider"></div>
<div class="context-menu-item" onclick="contextClearResults()">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏</div>
<div class="context-menu-item danger" onclick="contextDeleteTest()">üóë –í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å–ø–∏—Ç</div>
</div>

<!-- Modal –¥–ª—è –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è -->
<div id="publicLinkModal" class="modal-overlay">
<div class="modal-box">
<h3>üîó –ü—É–±–ª—ñ—á–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —ñ—Å–ø–∏—Ç</h3>
<p style="font-size:12px;color:var(--text-gray);margin-bottom:15px">
–¶–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ª—é–¥–∏ –±–µ–∑ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É. –í–æ–Ω–∏ –≤–≤–µ–¥—É—Ç—å —Å–≤–æ—î —ñ–º'—è, –ø–æ—Å–∞–¥—É —ñ —Å–∫–ª–∞–¥—É—Ç—å —Ç–µ—Å—Ç.
</p>
<div class="link-display" id="publicLinkDisplay"></div>
<div class="btn-group">
<button class="btn btn-primary" onclick="copyPublicLink()">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
<button class="btn btn-secondary" onclick="closePublicLinkModal()">–ó–∞–∫—Ä–∏—Ç–∏</button>
</div>
</div>
</div>

<div id="lightbox" class="lightbox" onclick="closeLightbox()">
<span class="lightbox-close" onclick="closeLightbox()">&times;</span>
<img id="lightboxImg" class="lightbox-img" src="">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, collection, updateDoc, addDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const app = initializeApp({
apiKey: "AIzaSyATUpLUHSp1VbyxkJXhMS-2R71zNOBGC00",
authDomain: "dsv-gta.firebaseapp.com",
projectId: "dsv-gta",
storageBucket: "dsv-gta.firebasestorage.app",
messagingSenderId: "661591588818",
appId: "1:661591588818:web:a8e8dca3d061447e24d20b"
});

const auth = getAuth(app);
const db = getFirestore(app);

let ME = {name: '–ù–µ–≤—ñ–¥–æ–º–∏–π', role: 'fighter', uid: ''};
let allUsers = [];
let tests = [];
let results = JSON.parse(localStorage.getItem('isput_results') || '[]');
let reviewers = JSON.parse(localStorage.getItem('isput_reviewers') || '[]');
let adminList = JSON.parse(localStorage.getItem('isput_admins') || '[]');
let webhookUrl = localStorage.getItem('isput_webhook') || '';
let currentTest = null;
let currentQ = 0;
let answers = {};
let timer = null;
let timeLeft = 30;
let editingTestId = null;
let agreementAccepted = false;
let currentTestPhotos = [];
let contextTestId = null;
let questionScores = {}; // –î–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –±–∞–ª—ñ–≤ –ø–æ –ø–∏—Ç–∞–Ω–Ω—è—Ö –≤ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ

const save = () => {
localStorage.setItem('isput_results', JSON.stringify(results));
localStorage.setItem('isput_reviewers', JSON.stringify(reviewers));
localStorage.setItem('isput_admins', JSON.stringify(adminList));
localStorage.setItem('isput_webhook', webhookUrl);
};

const letters = '–ê–ë–í–ì“ê–î–ï–ñ–ó–ò';
const isAdmin = () => ME.role === 'admin' || adminList.includes(ME.name);
const isReviewer = () => isAdmin() || reviewers.includes(ME.name);
const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);

const now = () => {
const d = new Date();
return d.toLocaleDateString('uk') + ' ' + d.toLocaleTimeString('uk', {hour: '2-digit', minute: '2-digit'});
};

// ============================================
// üîî –°–ò–°–¢–ï–ú–ê DISCORD –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨
// ============================================

async function sendDiscordNotification(type, data) {
if (!webhookUrl) return;

let embed = {};
const timestamp = new Date().toISOString();

switch(type) {
case 'NEW_TEST':
embed = {
title: 'üìù –ù–æ–≤–∏–π —ñ—Å–ø–∏—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ!',
color: 0x00ff44,
fields: [
{name: 'üìã –ù–∞–∑–≤–∞', value: data.testName, inline: false},
{name: 'üë§ –°—Ç–≤–æ—Ä–∏–≤', value: data.createdBy, inline: true},
{name: '‚ùì –ü–∏—Ç–∞–Ω—å', value: data.questionCount.toString(), inline: true},
{name: 'üéØ –ú–∞–∫—Å. –±–∞–ª', value: data.maxScore.toString(), inline: true},
{name: '‚úÖ –ü—Ä–æ—Ö—ñ–¥–Ω–∏–π', value: data.passScore.toString(), inline: true},
{name: '‚è± –ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Å', value: `${data.totalTime}—Å`, inline: true},
{name: 'üìÖ –î–∞—Ç–∞', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'TEST_UPDATED':
embed = {
title: '‚úèÔ∏è –Ü—Å–ø–∏—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ!',
color: 0xfbbf24,
fields: [
{name: 'üìã –ù–∞–∑–≤–∞', value: data.testName, inline: false},
{name: 'üë§ –†–µ–¥–∞–≥—É–≤–∞–≤', value: data.editedBy, inline: true},
{name: '‚ùì –ü–∏—Ç–∞–Ω—å', value: data.questionCount.toString(), inline: true},
{name: 'üéØ –ë–∞–ª–∏', value: `${data.passScore}/${data.maxScore}`, inline: true},
{name: 'üìÖ –î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'TEST_DELETED':
embed = {
title: 'üóë –Ü—Å–ø–∏—Ç –≤–∏–¥–∞–ª–µ–Ω–æ!',
color: 0xef4444,
fields: [
{name: 'üìã –ù–∞–∑–≤–∞', value: data.testName, inline: true},
{name: 'üë§ –í–∏–¥–∞–ª–∏–≤', value: data.deletedBy, inline: true},
{name: 'üìÖ –î–∞—Ç–∞', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'QUIZ_COMPLETED':
const statusEmoji = data.status === 'pending' ? '‚è≥' : data.passed ? '‚úÖ' : '‚ùå';
const statusText = data.status === 'pending' ? '–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ' : data.passed ? '–°–ö–õ–ê–î–ï–ù–û' : '–ù–ï –°–ö–õ–ê–î–ï–ù–û';
const statusColor = data.status === 'pending' ? 0xfbbf24 : data.passed ? 0x10b981 : 0xef4444;
embed = {
title: `${statusEmoji} –Ü—Å–ø–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ${data.testName}`,
color: statusColor,
description: `**${data.userName}** –∑–∞–≤–µ—Ä—à–∏–≤ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —ñ—Å–ø–∏—Ç—É`,
fields: [
{name: 'üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', value: data.userName, inline: true},
{name: 'üéñ –ó–≤–∞–Ω–Ω—è', value: data.userRole, inline: true},
{name: 'üìä –†–µ–∑—É–ª—å—Ç–∞—Ç', value: `**${data.score}** / ${data.maxScore} –±–∞–ª—ñ–≤`, inline: true},
{name: 'üéØ –ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª', value: data.passScore.toString(), inline: true},
{name: 'üìà –í—ñ–¥—Å–æ—Ç–æ–∫', value: `${Math.round((data.score / data.maxScore) * 100)}%`, inline: true},
{name: '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö', value: `${data.correctAnswers} / ${data.totalQuestions}`, inline: true},
{name: 'üìÖ –î–∞—Ç–∞', value: data.date, inline: false},
{name: 'üîç –°—Ç–∞—Ç—É—Å', value: statusText, inline: true},
{name: 'ü§ñ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞', value: data.status === 'pending' ? '–ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä—É—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞' : '–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞', inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'RESULT_APPROVED':
embed = {
title: '‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ö–≤–∞–ª–µ–Ω–æ!',
color: 0x00ff44,
description: `–ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π **${data.reviewer}** —Å—Ö–≤–∞–ª–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç`,
fields: [
{name: 'üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', value: data.userName, inline: true},
{name: 'üìã –Ü—Å–ø–∏—Ç', value: data.testName, inline: true},
{name: 'üìä –§—ñ–Ω–∞–ª—å–Ω–∏–π –±–∞–ª', value: `**${data.finalScore}** / ${data.maxScore}`, inline: true},
{name: 'üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤', value: data.reviewer, inline: true},
{name: 'üìÖ –î–∞—Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏', value: data.date, inline: true},
{name: 'üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä', value: data.status === 'approved' ? '‚úÖ –Ü—Å–ø–∏—Ç –ø—Ä–æ–π–¥–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!' : '‚úÖ –ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ', inline: false}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'RESULT_REJECTED':
embed = {
title: '‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ!',
color: 0xef4444,
description: `–ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π **${data.reviewer}** –≤—ñ–¥—Ö–∏–ª–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç`,
fields: [
{name: 'üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', value: data.userName, inline: true},
{name: 'üìã –Ü—Å–ø–∏—Ç', value: data.testName, inline: true},
{name: 'üìä –ë–∞–ª', value: `${data.score} / ${data.maxScore}`, inline: true},
{name: 'üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤', value: data.reviewer, inline: true},
{name: 'üìÖ –î–∞—Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏', value: data.date, inline: true},
{name: 'üí¨ –ü—Ä–∏—á–∏–Ω–∞', value: '–í—ñ–ª—å–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–µ –∑–∞—Ä–∞—Ö–æ–≤–∞–Ω—ñ', inline: false}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'RESULTS_CLEARED':
embed = {
title: 'üßπ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ—á–∏—â–µ–Ω–æ!',
color: 0xfbbf24,
fields: [
{name: 'üìã –Ü—Å–ø–∏—Ç', value: data.testName, inline: true},
{name: 'üë§ –û—á–∏—Å—Ç–∏–≤', value: data.clearedBy, inline: true},
{name: 'üóë –í–∏–¥–∞–ª–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤', value: data.count.toString(), inline: true},
{name: 'üìÖ –î–∞—Ç–∞', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'REVIEWER_ADDED':
embed = {
title: 'üîç –î–æ–¥–∞–Ω–æ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—á–æ–≥–æ!',
color: 0x3b82f6,
fields: [
{name: 'üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', value: data.reviewerName, inline: true},
{name: '‚ûï –î–æ–¥–∞–≤', value: data.addedBy, inline: true},
{name: 'üìÖ –î–∞—Ç–∞', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'ADMIN_ADDED':
embed = {
title: 'üëë –î–æ–¥–∞–Ω–æ –Ω–æ–≤–æ–≥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞!',
color: 0x00ff44,
fields: [
{name: 'üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', value: data.adminName, inline: true},
{name: '‚ûï –î–æ–¥–∞–≤', value: data.addedBy, inline: true},
{name: 'üîë –ü—Ä–∞–≤–∞', value: '–ü–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ —Å–∏—Å—Ç–µ–º–∏', inline: false},
{name: 'üìÖ –î–∞—Ç–∞', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;
}

try {
await fetch(webhookUrl, {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({embeds: [embed]})
});
} catch (e) {
console.log('Discord webhook error:', e);
}
}

// ============================================
// üîß –û–°–ù–û–í–ù–Ü –§–£–ù–ö–¶–Ü–á
// ============================================

let notifs = JSON.parse(localStorage.getItem('isput_notifs') || '[]');

function addNotif(text) {
notifs.unshift({text, time: now(), read: false});
if (notifs.length > 20) notifs.pop();
localStorage.setItem('isput_notifs', JSON.stringify(notifs));
}

onAuthStateChanged(auth, async u => {
if (!u) {
window.location.href = 'index.html';
return;
}
ME.uid = u.uid;

try {
const snap = await getDoc(doc(db, 'users', u.uid));
if (snap.exists()) {
const d = snap.data();
ME.name = d.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π';
ME.role = d.role || 'fighter';
}

const all = await getDocs(collection(db, 'users'));
allUsers = [];
all.forEach(s => {
const d = s.data();
allUsers.push({uid: s.id, name: d.name || '---', role: d.role || 'fighter'});
});

loadTestsFromFirebase();
} catch (e) {
console.log('Firebase err:', e);
}

document.getElementById('headerName').textContent = ME.name;
const rb = document.getElementById('headerRole');
if (ME.role === 'admin') {
rb.textContent = '–ê–î–ú–Ü–ù';
rb.className = 'role-badge role-admin';
} else if (ME.role === 'instructor') {
rb.textContent = '–Ü–ù–°–¢–†–£–ö–¢–û–†';
rb.className = 'role-badge role-instructor';
} else {
rb.textContent = '–ë–Ü–Ñ–¶–¨';
rb.className = 'role-badge role-fighter';
}

buildNav();
showView('home');
});

function loadTestsFromFirebase() {
const q = query(collection(db, 'tests'), orderBy('createdAt', 'desc'));
onSnapshot(q, snapshot => {
tests = [];
snapshot.forEach(docSnap => {
tests.push({id: docSnap.id, ...docSnap.data()});
});

const activeView = document.querySelector('.view.active');
if (activeView) {
if (activeView.id === 'viewHome') renderHome();
if (activeView.id === 'viewManage') renderManage();
if (activeView.id === 'viewHistory') renderHistory();
}
});
}

async function saveTestToFirebase(testObj) {
try {
let totalTime = 0;
testObj.questions.forEach(q => {totalTime += (q.timeLimit || 30)});

if (editingTestId) {
await updateDoc(doc(db, 'tests', editingTestId), testObj);
addNotif(`üìù –Ü—Å–ø–∏—Ç "${testObj.name}" –æ–Ω–æ–≤–ª–µ–Ω–æ!`);

await sendDiscordNotification('TEST_UPDATED', {
testName: testObj.name,
editedBy: ME.name,
questionCount: testObj.questions.length,
maxScore: testObj.maxScore,
passScore: testObj.passScore,
date: now()
});

} else {
await addDoc(collection(db, 'tests'), {
...testObj,
createdAt: serverTimestamp()
});
addNotif(`üìù –Ü—Å–ø–∏—Ç "${testObj.name}" —Å—Ç–≤–æ—Ä–µ–Ω–æ!`);

await sendDiscordNotification('NEW_TEST', {
testName: testObj.name,
createdBy: testObj.createdBy,
questionCount: testObj.questions.length,
maxScore: testObj.maxScore,
passScore: testObj.passScore,
totalTime: totalTime,
date: now()
});
}
return true;
} catch (e) {
console.error('Save error:', e);
alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + e.message);
return false;
}
}

async function deleteTestFromFirebase(id) {
try {
const t = tests.find(x => x.id === id);
const testName = t ? t.name : '–ù–µ–≤—ñ–¥–æ–º–∏–π —ñ—Å–ø–∏—Ç';

await deleteDoc(doc(db, 'tests', id));
results = results.filter(r => r.testId !== id);
save();
addNotif('üóë –Ü—Å–ø–∏—Ç –≤–∏–¥–∞–ª–µ–Ω–æ');

await sendDiscordNotification('TEST_DELETED', {
testName: testName,
deletedBy: ME.name,
date: now()
});

return true;
} catch (e) {
alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + e.message);
return false;
}
}

function buildNav() {
const tabs = document.getElementById('navTabs');
let html = '<button class="nav-btn active" onclick="showView(\'home\')">üè† –ì–æ–ª–æ–≤–Ω–∞</button>';

if (isAdmin()) {
html += '<button class="nav-btn" onclick="showView(\'create\')">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</button>';
html += '<button class="nav-btn" onclick="showView(\'manage\')">‚öôÔ∏è –ö–µ—Ä—É–≤–∞—Ç–∏</button>';
html += '<button class="nav-btn" onclick="showView(\'settings\')">üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>';
html += '<button class="nav-btn" onclick="showView(\'history\')">üìú –Ü—Å—Ç–æ—Ä—ñ—è</button>';
html += '<button class="nav-btn" onclick="showView(\'adminList\')">üëë –ê–¥–º—ñ–Ω–∏</button>';
}

if (isReviewer()) {
html += '<button class="nav-btn" onclick="showView(\'review\')">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞</button>';
}

tabs.innerHTML = html;
}

window.showView = v => {
document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
document.getElementById('view' + v.charAt(0).toUpperCase() + v.slice(1)).classList.add('active');
document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

const btns = document.querySelectorAll('.nav-btn');
const map = {
home: 0, 
create: 1, 
manage: 2, 
settings: 3, 
history: 4,
adminList: 5, 
review: isAdmin() ? 6 : 1
};
if (btns[map[v]]) btns[map[v]].classList.add('active');

if (v === 'home') renderHome();
if (v === 'create') renderCreateForm();
if (v === 'review') renderReview();
if (v === 'manage') renderManage();
if (v === 'settings') renderSettings();
if (v === 'adminList') renderAdminList();
if (v === 'history') renderHistory();
};

// ============================================
// üìú –Ü–°–¢–û–†–Ü–Ø –í–°–Ü–• –†–ï–ó–£–õ–¨–¢–ê–¢–Ü–í
// ============================================

function renderHistory() {
if (results.length === 0) {
document.getElementById('historyContent').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px">–ù–µ–º–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</div>';
return;
}

// –°–æ—Ä—Ç—É—î–º–æ –∑–∞ –¥–∞—Ç–æ—é (–Ω–∞–π–Ω–æ–≤—ñ—à—ñ –∑–≤–µ—Ä—Ö—É)
const sorted = [...results].sort((a, b) => {
const dateA = new Date(a.date.split(' ').reverse().join(' '));
const dateB = new Date(b.date.split(' ').reverse().join(' '));
return dateB - dateA;
});

let rows = sorted.map(r => {
const t = tests.find(x => x.id === r.testId);
const tname = t ? t.name : '–í–∏–¥–∞–ª–µ–Ω–∏–π —ñ—Å–ø–∏—Ç';
const passS = t ? t.passScore : 0;
let st, stc;

if (r.status === 'pending') {
st = '–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ';
stc = 'st-pending';
} else if (r.status === 'approved') {
st = '–°—Ö–≤–∞–ª–µ–Ω–æ';
stc = 'st-approved';
} else if (r.status === 'rejected') {
st = '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ';
stc = 'st-rejected';
} else {
const p = r.score >= passS;
st = p ? '–°–∫–ª–∞–¥–µ–Ω–æ' : '–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ';
stc = p ? 'st-pass' : 'st-fail';
}

const percent = t ? Math.round((r.score / t.maxScore) * 100) : 0;

return `<tr>
<td><b>${r.userName}</b></td>
<td>${tname}</td>
<td style="color:var(--primary);font-weight:800">${r.score}</td>
<td style="color:var(--text-gray)">${t ? t.maxScore : '?'}</td>
<td style="color:${percent >= 70 ? 'var(--primary)' : percent >= 50 ? 'var(--warning)' : 'var(--danger)'};font-weight:700">${percent}%</td>
<td><span class="status-badge ${stc}">${st}</span></td>
<td style="color:var(--text-gray);font-size:11px">${r.reviewer || 'SYSTEM'}</td>
<td style="color:var(--text-gray);font-size:11px">${r.date}</td>
</tr>`;
}).join('');

document.getElementById('historyContent').innerHTML = `
<div style="margin-bottom:20px;display:flex;gap:15px;flex-wrap:wrap;align-items:center">
<div style="background:var(--card-bg);padding:15px 20px;border-radius:12px;border:1px solid rgba(0,255,68,0.15)">
<div style="font-size:24px;font-weight:900;color:var(--primary)">${results.length}</div>
<div style="font-size:10px;color:var(--text-gray);text-transform:uppercase;margin-top:4px">–í—Å—å–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</div>
</div>
<div style="background:var(--card-bg);padding:15px 20px;border-radius:12px;border:1px solid rgba(0,255,68,0.15)">
<div style="font-size:24px;font-weight:900;color:var(--success)">${results.filter(r => r.status === 'approved' || (r.status === 'auto' && r.reviewedByHuman)).length}</div>
<div style="font-size:10px;color:var(--text-gray);text-transform:uppercase;margin-top:4px">–°—Ö–≤–∞–ª–µ–Ω–æ</div>
</div>
<div style="background:var(--card-bg);padding:15px 20px;border-radius:12px;border:1px solid rgba(239,68,68,0.15)">
<div style="font-size:24px;font-weight:900;color:var(--danger)">${results.filter(r => r.status === 'rejected').length}</div>
<div style="font-size:10px;color:var(--text-gray);text-transform:uppercase;margin-top:4px">–í—ñ–¥—Ö–∏–ª–µ–Ω–æ</div>
</div>
<div style="background:var(--card-bg);padding:15px 20px;border-radius:12px;border:1px solid rgba(251,191,36,0.15)">
<div style="font-size:24px;font-weight:900;color:var(--warning)">${results.filter(r => r.status === 'pending' || (r.status === 'auto' && !r.reviewedByHuman)).length}</div>
<div style="font-size:10px;color:var(--text-gray);text-transform:uppercase;margin-top:4px">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</div>
</div>
</div>

<div class="results-table">
<table>
<thead>
<tr>
<th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
<th>–Ü—Å–ø–∏—Ç</th>
<th>–ë–∞–ª–∏</th>
<th>–ú–∞–∫—Å</th>
<th>%</th>
<th>–°—Ç–∞—Ç—É—Å</th>
<th>–ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π</th>
<th>–î–∞—Ç–∞</th>
</tr>
</thead>
<tbody>${rows}</tbody>
</table>
</div>
`;
}

// ============================================
// üñ±Ô∏è –ö–û–ù–¢–ï–ö–°–¢–ù–ï –ú–ï–ù–Æ –î–õ–Ø –¢–ï–°–¢–Ü–í
// ============================================

function renderHome() {
const myRes = results.filter(r => r.userId === ME.uid);
const passed = myRes.filter(r => {
const t = tests.find(x => x.id === r.testId);
return r.status === 'approved' || (r.status === 'auto' && t && r.score >= t.passScore);
}).length;

const failed = myRes.filter(r => {
const t = tests.find(x => x.id === r.testId);
return r.status === 'rejected' || (r.status === 'auto' && t && r.score < t.passScore);
}).length;

const pending = myRes.filter(r => r.status === 'pending').length;

document.getElementById('statsRow').innerHTML = `
<div class="stat-card">
<div class="stat-num">${tests.length}</div>
<div class="stat-label">–Ü—Å–ø–∏—Ç—ñ–≤</div>
</div>
<div class="stat-card">
<div class="stat-num" style="color:var(--success)">${passed}</div>
<div class="stat-label">–°–∫–ª–∞–¥–µ–Ω–æ</div>
</div>
<div class="stat-card">
<div class="stat-num" style="color:var(--danger)">${failed}</div>
<div class="stat-label">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div>
</div>
<div class="stat-card">
<div class="stat-num" style="color:var(--warning)">${pending}</div>
<div class="stat-label">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</div>
</div>
`;

if (tests.length === 0) {
document.getElementById('testsGrid').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px;width:100%">–Ü—Å–ø–∏—Ç—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>';
} else {
document.getElementById('testsGrid').innerHTML = tests.map(t => {
const pps = t.maxScore > 0 ? Math.round(t.maxScore / t.questions.length * 10) / 10 : 0;
let totalTime = 0;
t.questions.forEach(q => {totalTime += (q.timeLimit || 30)});

// –î–æ–¥–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ–≤
const contextAttr = isAdmin() ? `oncontextmenu="showContextMenu(event, '${t.id}'); return false;"` : '';

return `<div class="test-card" onclick="startIntro('${t.id}')" ${contextAttr}>
<span class="emoji">${t.emoji || 'üìù'}</span>
<h3>${t.name}</h3>
<p>${t.description || '–ë–µ–∑ –æ–ø–∏—Å—É'}</p>
<div class="test-meta">
<span class="meta-tag">‚ùì ${t.questions.length} –ø–∏—Ç–∞–Ω—å</span>
<span class="meta-tag">üéØ ${t.passScore}/${t.maxScore} –±.</span>
<span class="meta-tag">‚è± ${totalTime}—Å</span>
</div>
</div>`;
}).join('');
}

if (myRes.length === 0) {
document.getElementById('myResults').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:30px;font-size:13px">–í–∏ —â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —ñ—Å–ø–∏—Ç–∏</div>';
} else {
let rows = myRes.map(r => {
const t = tests.find(x => x.id === r.testId);
const tname = t ? t.name : '–í–∏–¥–∞–ª–µ–Ω–∏–π';
const passS = t ? t.passScore : 0;
let st, stc;

if (r.status === 'pending') {
st = '–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ';
stc = 'st-pending';
} else if (r.status === 'approved') {
st = '–°—Ö–≤–∞–ª–µ–Ω–æ';
stc = 'st-approved';
} else if (r.status === 'rejected') {
st = '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ';
stc = 'st-rejected';
} else {
const p = r.score >= passS;
st = p ? '–°–∫–ª–∞–¥–µ–Ω–æ' : '–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ';
stc = p ? 'st-pass' : 'st-fail';
}

return `<tr>
<td>${tname}</td>
<td><b>${r.score}</b> / ${t ? t.maxScore : '?'}</td>
<td><span class="status-badge ${stc}">${st}</span></td>
<td>${r.reviewer || 'SYSTEM'}</td>
<td>${r.date}</td>
</tr>`;
}).join('');

document.getElementById('myResults').innerHTML = `
<div class="results-table">
<table>
<thead>
<tr>
<th>–Ü—Å–ø–∏—Ç</th>
<th>–ë–∞–ª–∏</th>
<th>–°—Ç–∞—Ç—É—Å</th>
<th>–ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π</th>
<th>–î–∞—Ç–∞</th>
</tr>
</thead>
<tbody>${rows}</tbody>
</table>
</div>
`;
}
}

window.showContextMenu = (e, testId) => {
e.preventDefault();
e.stopPropagation();
  
contextTestId = testId;
const menu = document.getElementById('contextMenu');
menu.classList.add('active');
menu.style.left = e.pageX + 'px';
menu.style.top = e.pageY + 'px';
};

window.contextEditTest = () => {
hideContextMenu();
if (contextTestId) {
const t = tests.find(x => x.id === contextTestId);
if (t) {
renderCreateForm(t);
showView('create');
}
}
};

window.contextPublicLink = () => {
hideContextMenu();
if (contextTestId) {
const t = tests.find(x => x.id === contextTestId);
if (t) {
const baseUrl = window.location.origin + window.location.pathname.replace('cabinet.html', '');
const link = `${baseUrl}public.html?test=${contextTestId}`;
document.getElementById('publicLinkDisplay').textContent = link;
document.getElementById('publicLinkModal').classList.add('active');
}
}
};

window.copyPublicLink = () => {
const link = document.getElementById('publicLinkDisplay').textContent;
navigator.clipboard.writeText(link).then(() => {
alert('‚úÖ –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');
}).catch(() => {
alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è');
});
};

window.closePublicLinkModal = () => {
document.getElementById('publicLinkModal').classList.remove('active');
};

window.contextClearResults = async () => {
hideContextMenu();
if (contextTestId && confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ü—å–æ–≥–æ —ñ—Å–ø–∏—Ç—É?')) {
const t = tests.find(x => x.id === contextTestId);
const testName = t ? t.name : '–ù–µ–≤—ñ–¥–æ–º–∏–π —ñ—Å–ø–∏—Ç';
const count = results.filter(r => r.testId === contextTestId).length;

results = results.filter(r => r.testId !== contextTestId);
save();

await sendDiscordNotification('RESULTS_CLEARED', {
testName: testName,
clearedBy: ME.name,
count: count,
date: now()
});

renderHome();
renderManage();
alert('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ—á–∏—â–µ–Ω–æ!');
}
};

window.contextDeleteTest = async () => {
hideContextMenu();
if (contextTestId && confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å–ø–∏—Ç –Ω–∞–∑–∞–≤–∂–¥–∏?')) {
const success = await deleteTestFromFirebase(contextTestId);
if (success) {
renderHome();
alert('‚úÖ –Ü—Å–ø–∏—Ç –≤–∏–¥–∞–ª–µ–Ω–æ!');
}
}
};

function hideContextMenu() {
document.getElementById('contextMenu').classList.remove('active');
}

// –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
document.addEventListener('click', (e) => {
if (!e.target.closest('.context-menu')) {
hideContextMenu();
}
});

// –ó–∞–∫—Ä–∏–≤–∞—î–º–æ modal –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
document.getElementById('publicLinkModal').addEventListener('click', (e) => {
if (e.target.id === 'publicLinkModal') {
closePublicLinkModal();
}
});

  // ============================================
// –ß–ê–°–¢–ò–ù–ê 2 - –î–û–î–ê–ô–¢–ï –¶–ï–ô –ö–û–î –ü–ï–†–ï–î </script>
// ============================================

// =================================
// –°–¢–í–û–†–ï–ù–ù–Ø/–†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –Ü–°–ü–ò–¢–Ü–í
// =================================

function renderCreateForm(testData) {
editingTestId = testData ? testData.id : null;
document.getElementById('createTitle').innerHTML = editingTestId ? '‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —ñ—Å–ø–∏—Ç' : '‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ—Å–ø–∏—Ç';

const t = testData || {
name: '',
description: '',
emoji: 'üìù',
maxScore: 12,
passScore: 8,
questions: [],
photos: [],
agreementText: '–Ø –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–∏–π –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —ñ—Å–ø–∏—Ç—É —Ç–∞ –∑–æ–±–æ–≤\'—è–∑—É—é—Å—å –¥–æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏—Å—å —ó—Ö.'
};

currentTestPhotos = t.photos || [];

const qs = t.questions.length > 0 ? t.questions : [{
text: '',
options: [{text: '', correct: false}, {text: '', correct: false}, {text: '', correct: false}, {text: '', correct: false}],
allowFree: false,
timeLimit: 30,
answerType: 'normal',
photo: null
}];

let photosHtml = '';
if (currentTestPhotos.length > 0) {
photosHtml = `<div class="test-photo-grid">
${currentTestPhotos.map((photo, pi) => `
<div class="test-photo-item">
<img src="${photo.url}" alt="–§–æ—Ç–æ ${pi + 1}">
<button class="photo-delete-mini" onclick="deleteTestPhoto(${pi})">‚úï</button>
</div>
`).join('')}
</div>`;
}

let qBlocks = qs.map((q, qi) => {
let qPhotoHtml = '';
if (q.photo) {
qPhotoHtml = `<div class="question-photo-section">
<div class="question-photo-preview">
<img src="${q.photo}" alt="–§–æ—Ç–æ –ø–∏—Ç–∞–Ω–Ω—è">
<button class="question-photo-delete" onclick="deleteQuestionPhoto(${qi})">‚úï</button>
</div>
</div>`;
} else {
qPhotoHtml = `<div class="question-photo-section">
<input type="file" id="qPhotoInput-${qi}" accept="image/*" style="display:none" onchange="handleQuestionPhoto(this, ${qi})">
<button class="add-question-photo-btn" onclick="document.getElementById('qPhotoInput-${qi}').click()">üì∑ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –¥–æ –ø–∏—Ç–∞–Ω–Ω—è</button>
</div>`;
}

let opts = '';
if (q.answerType === 'table') {
const cols = q.tableData?.columns || [];
const rows = q.tableData?.rows || [];
const correctRow = q.tableData?.correctRowIndex || 0;

opts = `<div class="table-builder">
<div style="font-size:11px;font-weight:700;color:var(--primary);margin-bottom:8px">–°–¢–û–í–ü–¶–Ü –¢–ê–ë–õ–ò–¶–Ü</div>
<div class="table-builder-head" id="tableCols-${qi}">
${cols.map((c, ci) => `<input class="table-col-input" placeholder="–°—Ç–æ–≤–ø–µ—Ü—å ${ci + 1}" value="${c}" data-qi="${qi}" data-ci="${ci}">`).join('')}
</div>
<button class="add-opt-btn" onclick="addTableColumn(${qi})" style="margin-bottom:10px">+ –î–æ–¥–∞—Ç–∏ —Å—Ç–æ–≤–ø–µ—Ü—å</button>
<div style="font-size:11px;font-weight:700;color:var(--primary);margin-bottom:8px">–†–Ø–î–ö–ò –¢–ê–ë–õ–ò–¶–Ü</div>
<div class="table-builder-rows" id="tableRows-${qi}">
${rows.map((row, ri) => `<div class="table-row-builder">
<div class="opt-radio${ri === correctRow ? ' checked' : ''}" onclick="toggleTableCorrect(${qi},${ri})"></div>
${cols.map((c, ci) => `<input class="table-cell-input" placeholder="${c}" value="${row[ci] || ''}" data-qi="${qi}" data-ri="${ri}" data-ci="${ci}">`).join('')}
<button class="opt-del" onclick="delTableRow(${qi},${ri})">‚úï</button>
</div>`).join('')}
</div>
<button class="add-opt-btn" onclick="addTableRow(${qi})">+ –î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫</button>
</div>`;
} else {
opts = q.options.map((o, oi) => `<div class="opt-row">
<div class="opt-radio${o.correct ? ' checked' : ''}" onclick="toggleCorrect(${qi},${oi})"></div>
<input class="opt-input" placeholder="–í–∞—Ä—ñ–∞–Ω—Ç ${letters[oi] || oi + 1}" value="${o.text.replace(/"/g, '&quot;')}" data-qi="${qi}" data-oi="${oi}">
<button class="opt-del" onclick="delOption(${qi},${oi})">‚úï</button>
</div>`).join('');
opts += `<button class="add-opt-btn" onclick="addOption(${qi})">+ –î–æ–¥–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç</button>`;
}

return `<div class="q-block" id="qblock-${qi}">
<div class="q-block-head">
<span class="q-num">–ü–∏—Ç–∞–Ω–Ω—è ${qi + 1}</span>
<button class="q-del" onclick="delQuestion(${qi})">üóë</button>
</div>
<textarea class="form-input" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Ç–∞–Ω–Ω—è..." id="qtext-${qi}" style="margin-bottom:12px;min-height:80px;resize:vertical">${q.text.replace(/"/g, '&quot;')}</textarea>
${qPhotoHtml}
<div style="margin-bottom:10px">
<label class="form-label">–ß–∞—Å –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è (—Å–µ–∫—É–Ω–¥)</label>
<input class="form-input" type="number" id="qtime-${qi}" value="${q.timeLimit || 30}" min="5" max="600">
</div>
<div class="table-toggle-create" onclick="toggleTableMode(${qi})">
<div class="toggle-switch${q.answerType === 'table' ? ' on' : ''}" id="tableSwitch-${qi}"></div>
–†–µ–∂–∏–º —Ç–∞–±–ª–∏—Ü—ñ
</div>
<div id="opts-${qi}" style="margin-top:12px">${opts}</div>
<div class="free-toggle-create" onclick="toggleFreeCreate(${qi})">
<div class="toggle-switch${q.allowFree ? ' on' : ''}" id="freeSwitch-${qi}"></div>
–î–æ–∑–≤–æ–ª–∏—Ç–∏ –≤—ñ–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
</div>
</div>`;
}).join('');

document.getElementById('createForm').innerHTML = `
<div class="form-card">
<div class="form-row-inline">
<div class="form-row">
<label class="form-label">–ù–∞–∑–≤–∞ —ñ—Å–ø–∏—Ç—É</label>
<input class="form-input" id="testName" value="${t.name.replace(/"/g, '&quot;')}" placeholder="–ù–∞–∑–≤–∞...">
</div>
<div class="form-row">
<label class="form-label">–ï–º–æ–¥–∑—ñ</label>
<input class="form-input" id="testEmoji" value="${t.emoji}" placeholder="üìù" style="text-align:center;font-size:24px">
</div>
</div>
<div class="form-row">
<label class="form-label">–û–ø–∏—Å</label>
<textarea class="form-input" id="testDesc" rows="2" placeholder="–û–ø–∏—Å —ñ—Å–ø–∏—Ç—É...">${t.description || ''}</textarea>
</div>
<div class="form-row-inline">
<div class="form-row">
<label class="form-label">–ú–∞–∫—Å. –±–∞–ª</label>
<input class="form-input" id="testMaxScore" type="number" value="${t.maxScore}" min="1">
</div>
<div class="form-row">
<label class="form-label">–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª</label>
<input class="form-input" id="testPassScore" type="number" value="${t.passScore}" min="0">
</div>
</div>
<div class="form-hint" id="scoreHint">üíé –ó–∞ –∫–æ–∂–Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è: ${qs.length > 0 ? Math.round(t.maxScore / qs.length * 100) / 100 : 0} –±–∞–ª—ñ–≤</div>
</div>

<div class="form-card test-photos-section">
<h4 style="font-size:13px;font-weight:800;color:var(--primary-bright);margin-bottom:12px">üì∏ –§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è —Ç–µ—Å—Ç—É</h4>
<p style="font-size:11px;color:var(--text-gray);margin-bottom:15px">–î–æ–¥–∞–π—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è, —è–∫—ñ –±—É–¥—É—Ç—å –ø–æ–∫–∞–∑–∞–Ω—ñ –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º —ñ—Å–ø–∏—Ç—É</p>
${photosHtml}
<input type="file" id="testPhotoInput" accept="image/*" style="display:none" onchange="handleTestPhoto(this)">
<button class="upload-photo-btn" onclick="document.getElementById('testPhotoInput').click()">üì∑ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</button>
</div>

<div class="form-card">
<h4 style="font-size:13px;font-weight:800;color:var(--primary-bright);margin-bottom:12px">üìú –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∞ —É–≥–æ–¥–∞</h4>
<p style="font-size:11px;color:var(--text-gray);margin-bottom:10px">–¢–µ–∫—Å—Ç, —è–∫–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ–≤–∏–Ω–µ–Ω –ø—Ä–∏–π–Ω—è—Ç–∏ –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º</p>
<textarea class="form-input" id="agreementText" rows="3" placeholder="–Ø –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–∏–π –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏...">${t.agreementText || ''}</textarea>
</div>

<div class="section-title">üìã –ü–∏—Ç–∞–Ω–Ω—è</div>
<div id="questionsContainer">${qBlocks}</div>
<button class="btn btn-secondary" onclick="addQuestion()" style="width:100%;margin-bottom:20px">+ –î–æ–¥–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è</button>

<div class="btn-group">
<button class="btn btn-primary" onclick="saveTest()">üíæ ${editingTestId ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ—Å–ø–∏—Ç'}</button>
<button class="btn btn-secondary" onclick="showView('home')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
</div>
`;

document.getElementById('testMaxScore').addEventListener('input', updateScoreHint);
}

function updateScoreHint() {
const ms = parseInt(document.getElementById('testMaxScore').value) || 0;
const cnt = document.querySelectorAll('.q-block').length;
document.getElementById('scoreHint').textContent = `üíé –ó–∞ –∫–æ–∂–Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è: ${cnt > 0 ? Math.round(ms / cnt * 100) / 100 : 0} –±–∞–ª—ñ–≤`;
}

window.handleTestPhoto = input => {
if (input.files && input.files[0]) {
processTestImage(input.files[0]);
}
};

function processTestImage(file) {
const reader = new FileReader();
reader.onload = e => {
const img = new Image();
img.onload = () => {
const canvas = document.createElement('canvas');
let w = img.width, h = img.height, max = 800;
if (w > h) {
if (w > max) { h *= max / w; w = max; }
} else {
if (h > max) { w *= max / h; h = max; }
}
canvas.width = w;
canvas.height = h;
canvas.getContext('2d').drawImage(img, 0, 0, w, h);
const base64 = canvas.toDataURL('image/jpeg', 0.7);

currentTestPhotos.push({url: base64});
renderCreateForm({
name: document.getElementById('testName').value,
description: document.getElementById('testDesc').value,
emoji: document.getElementById('testEmoji').value,
maxScore: parseInt(document.getElementById('testMaxScore').value),
passScore: parseInt(document.getElementById('testPassScore').value),
photos: currentTestPhotos,
agreementText: document.getElementById('agreementText').value,
questions: getFormQuestions()
});
};
img.src = e.target.result;
};
reader.readAsDataURL(file);
}

window.deleteTestPhoto = pi => {
currentTestPhotos.splice(pi, 1);
renderCreateForm({
name: document.getElementById('testName').value,
description: document.getElementById('testDesc').value,
emoji: document.getElementById('testEmoji').value,
maxScore: parseInt(document.getElementById('testMaxScore').value),
passScore: parseInt(document.getElementById('testPassScore').value),
photos: currentTestPhotos,
agreementText: document.getElementById('agreementText').value,
questions: getFormQuestions()
});
};

window.handleQuestionPhoto = (input, qi) => {
if (input.files && input.files[0]) {
const reader = new FileReader();
reader.onload = e => {
const img = new Image();
img.onload = () => {
const canvas = document.createElement('canvas');
let w = img.width, h = img.height, max = 600;
if (w > h) {
if (w > max) { h *= max / w; w = max; }
} else {
if (h > max) { w *= max / h; h = max; }
}
canvas.width = w;
canvas.height = h;
canvas.getContext('2d').drawImage(img, 0, 0, w, h);
const base64 = canvas.toDataURL('image/jpeg', 0.7);

const qs = getFormQuestions();
qs[qi].photo = base64;
renderCreateForm({
name: document.getElementById('testName').value,
description: document.getElementById('testDesc').value,
emoji: document.getElementById('testEmoji').value,
maxScore: parseInt(document.getElementById('testMaxScore').value),
passScore: parseInt(document.getElementById('testPassScore').value),
photos: currentTestPhotos,
agreementText: document.getElementById('agreementText').value,
questions: qs
});
};
img.src = e.target.result;
};
reader.readAsDataURL(input.files[0]);
}
};

window.deleteQuestionPhoto = qi => {
const qs = getFormQuestions();
qs[qi].photo = null;
renderCreateForm({
name: document.getElementById('testName').value,
description: document.getElementById('testDesc').value,
emoji: document.getElementById('testEmoji').value,
maxScore: parseInt(document.getElementById('testMaxScore').value),
passScore: parseInt(document.getElementById('testPassScore').value),
photos: currentTestPhotos,
agreementText: document.getElementById('agreementText').value,
questions: qs
});
};

function getFormQuestions() {
const blocks = document.querySelectorAll('.q-block');
let qs = [];

blocks.forEach((b, qi) => {
const text = document.getElementById('qtext-' + qi)?.value || '';
const timeLimit = parseInt(document.getElementById('qtime-' + qi)?.value) || 30;
const tableMode = document.getElementById('tableSwitch-' + qi)?.classList.contains('on') || false;

let opts = [];
let tableData = null;

if (tableMode) {
const colInputs = document.querySelectorAll(`#tableCols-${qi} .table-col-input`);
const cols = Array.from(colInputs).map(inp => inp.value);
const rowDivs = document.querySelectorAll(`#tableRows-${qi} .table-row-builder`);
const rows = [];
let correctRowIndex = 0;

rowDivs.forEach((div, ri) => {
const radio = div.querySelector('.opt-radio');
if (radio.classList.contains('checked')) correctRowIndex = ri;
const cells = div.querySelectorAll('.table-cell-input');
rows.push(Array.from(cells).map(c => c.value));
});

tableData = {columns: cols, rows, correctRowIndex};
} else {
const optRows = b.querySelectorAll('.opt-row');
optRows.forEach((r, oi) => {
const inp = r.querySelector('.opt-input');
const radio = r.querySelector('.opt-radio');
opts.push({text: inp.value, correct: radio.classList.contains('checked')});
});
}

const sw = document.getElementById('freeSwitch-' + qi);
let qPhoto = null;
const existingPhoto = b.querySelector('.question-photo-preview img');
if (existingPhoto) {
qPhoto = existingPhoto.src;
}

qs.push({
text,
options: opts,
allowFree: sw?.classList.contains('on') || false,
timeLimit,
answerType: tableMode ? 'table' : 'normal',
tableData,
photo: qPhoto
});
});

return qs;
}

window.toggleCorrect = (qi, oi) => {
const qs = getFormQuestions();
qs[qi].options.forEach((o, i) => o.correct = i === oi);
rebuildQuestions(qs);
};

window.delOption = (qi, oi) => {
const qs = getFormQuestions();
qs[qi].options.splice(oi, 1);
rebuildQuestions(qs);
};

window.addOption = qi => {
const qs = getFormQuestions();
qs[qi].options.push({text: '', correct: false});
rebuildQuestions(qs);
};

window.delQuestion = qi => {
const qs = getFormQuestions();
qs.splice(qi, 1);
rebuildQuestions(qs);
updateScoreHint();
};

window.addQuestion = () => {
const qs = getFormQuestions();
qs.push({
text: '',
options: [{text: '', correct: false}, {text: '', correct: false}, {text: '', correct: false}, {text: '', correct: false}],
allowFree: false,
timeLimit: 30,
answerType: 'normal',
photo: null
});
rebuildQuestions(qs);
updateScoreHint();
};

window.toggleFreeCreate = qi => {
const qs = getFormQuestions();
qs[qi].allowFree = !qs[qi].allowFree;
rebuildQuestions(qs);
};

window.toggleTableMode = qi => {
const qs = getFormQuestions();
if (qs[qi].answerType === 'table') {
qs[qi].answerType = 'normal';
qs[qi].tableData = null;
if (qs[qi].options.length === 0) {
qs[qi].options = [{text: '', correct: false}, {text: '', correct: false}, {text: '', correct: false}, {text: '', correct: false}];
}
} else {
qs[qi].answerType = 'table';
qs[qi].tableData = {columns: ['–ö–æ–¥', '–û–ø–∏—Å'], rows: [['', ''], ['', '']], correctRowIndex: 0};
qs[qi].options = [];
}
rebuildQuestions(qs);
};

window.addTableColumn = qi => {
const qs = getFormQuestions();
qs[qi].tableData.columns.push('');
qs[qi].tableData.rows.forEach(r => r.push(''));
rebuildQuestions(qs);
};

window.addTableRow = qi => {
const qs = getFormQuestions();
const colCount = qs[qi].tableData.columns.length;
qs[qi].tableData.rows.push(new Array(colCount).fill(''));
rebuildQuestions(qs);
};

window.delTableRow = (qi, ri) => {
const qs = getFormQuestions();
qs[qi].tableData.rows.splice(ri, 1);
if (qs[qi].tableData.correctRowIndex >= qs[qi].tableData.rows.length) {
qs[qi].tableData.correctRowIndex = Math.max(0, qs[qi].tableData.rows.length - 1);
}
rebuildQuestions(qs);
};

window.toggleTableCorrect = (qi, ri) => {
const qs = getFormQuestions();
qs[qi].tableData.correctRowIndex = ri;
rebuildQuestions(qs);
};

function rebuildQuestions(qs) {
const currentData = {
name: document.getElementById('testName').value,
description: document.getElementById('testDesc').value,
emoji: document.getElementById('testEmoji').value,
maxScore: parseInt(document.getElementById('testMaxScore').value),
passScore: parseInt(document.getElementById('testPassScore').value),
photos: currentTestPhotos,
agreementText: document.getElementById('agreementText').value,
questions: qs
};
renderCreateForm(currentData);
}

window.saveTest = async () => {
const name = document.getElementById('testName').value.trim();
const desc = document.getElementById('testDesc').value.trim();
const emoji = document.getElementById('testEmoji').value.trim() || 'üìù';
const maxScore = parseInt(document.getElementById('testMaxScore').value) || 12;
const passScore = parseInt(document.getElementById('testPassScore').value) || 8;
const agreementText = document.getElementById('agreementText').value.trim();
const qs = getFormQuestions();

if (!name) {
alert('‚ùå –í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —ñ—Å–ø–∏—Ç—É!');
return;
}

for (let i = 0; i < qs.length; i++) {
if (!qs[i].text.trim()) {
const el = document.getElementById('qblock-' + i);
if (el) {
el.classList.add('error');
el.scrollIntoView({behavior: 'smooth', block: 'center'});
setTimeout(() => el.classList.remove('error'), 2000);
}
alert(`‚ùå –ü–∏—Ç–∞–Ω–Ω—è ${i + 1} –Ω–µ –º–∞—î —Ç–µ–∫—Å—Ç—É!`);
return;
}

if (qs[i].answerType === 'table') {
if (!qs[i].tableData || qs[i].tableData.rows.length === 0) {
alert(`‚ùå –ü–∏—Ç–∞–Ω–Ω—è ${i + 1}: –¥–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–∏–Ω —Ä—è–¥–æ–∫ —É —Ç–∞–±–ª–∏—Ü—é!`);
return;
}
} else {
const hasCorrect = qs[i].options.some(o => o.correct);
if (!hasCorrect && !qs[i].allowFree) {
alert(`‚ùå –ü–∏—Ç–∞–Ω–Ω—è ${i + 1}: –æ–±–µ—Ä—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞–±–æ —É–≤—ñ–º–∫–Ω—ñ—Ç—å –≤—ñ–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å!`);
return;
}
}
}

const testObj = {
name,
description: desc,
emoji,
maxScore,
passScore,
questions: qs,
photos: currentTestPhotos,
agreementText,
createdBy: ME.name
};

const success = await saveTestToFirebase(testObj);
if (success) {
alert('‚úÖ –Ü—Å–ø–∏—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
editingTestId = null;
currentTestPhotos = [];
showView('home');
}
};

// =================================
// –ö–ï–†–£–í–ê–ù–ù–Ø –Ü–°–ü–ò–¢–ê–ú–ò
// =================================

function renderManage() {
if (tests.length === 0) {
document.getElementById('manageList').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px">–ù–µ–º–∞—î —ñ—Å–ø–∏—Ç—ñ–≤</div>';
return;
}

document.getElementById('manageList').innerHTML = tests.map(t => {
const res = results.filter(r => r.testId === t.id);
const passed = res.filter(r => (r.status === 'approved' || r.status === 'auto') && r.score >= t.passScore && r.reviewedByHuman).length;

return `<div class="manage-card">
<div>
<b style="font-size:15px">${t.emoji} ${t.name}</b><br>
<span style="font-size:11px;color:var(--text-gray)">–ü–∏—Ç–∞–Ω—å: ${t.questions.length} ‚Ä¢ –ú–∞–∫—Å: ${t.maxScore}–± ‚Ä¢ –ü—Ä–æ—Ö—ñ–¥: ${t.passScore}–± ‚Ä¢ –ü—Ä–æ–π—à–ª–∏: ${passed}/${res.length}</span>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn btn-info" onclick="editTest('${t.id}')" style="padding:8px 14px;font-size:11px">‚úèÔ∏è</button>
<button class="btn btn-warning" onclick="clearTestResults('${t.id}')" style="padding:8px 14px;font-size:11px">üßπ</button>
<button class="btn btn-danger" onclick="deleteTest('${t.id}')" style="padding:8px 14px;font-size:11px">üóë</button>
</div>
</div>`;
}).join('');
}

window.editTest = id => {
const t = tests.find(x => x.id === id);
if (t) {
renderCreateForm(t);
showView('create');
}
};

window.clearTestResults = async (id) => {
if (confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ü—å–æ–≥–æ —ñ—Å–ø–∏—Ç—É?')) {
const t = tests.find(x => x.id === id);
const testName = t ? t.name : '–ù–µ–≤—ñ–¥–æ–º–∏–π —ñ—Å–ø–∏—Ç';
const count = results.filter(r => r.testId === id).length;

results = results.filter(r => r.testId !== id);
save();

await sendDiscordNotification('RESULTS_CLEARED', {
testName: testName,
clearedBy: ME.name,
count: count,
date: now()
});

renderManage();
}
};

window.deleteTest = async id => {
if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å–ø–∏—Ç?')) {
const success = await deleteTestFromFirebase(id);
if (success) {
renderManage();
}
}
};

// =================================
// –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø
// =================================

function renderSettings() {
document.getElementById('settingsContent').innerHTML = `
<div class="setting-block">
<h4>üîó Discord Webhook</h4>
<div class="form-row">
<input class="form-input" id="webhookInput" value="${webhookUrl}" placeholder="https://discord.com/api/webhooks/...">
</div>
<div class="btn-group" style="justify-content:flex-start">
<button class="btn btn-primary" onclick="saveWebhook()" style="padding:10px 20px;font-size:12px">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
<button class="btn btn-info" onclick="sendTestWebhook()" style="padding:10px 20px;font-size:12px">üß™ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</button>
</div>
</div>

<div class="setting-block">
<h4>üîç –ü–µ—Ä–µ–≤—ñ—Ä—é–≤–∞—á—ñ —ñ—Å–ø–∏—Ç—ñ–≤</h4>
<div id="reviewersList" style="margin-bottom:12px">
${reviewers.map(r => `<span class="reviewer-chip">${r}<button onclick="removeReviewer('${r}')">‚úï</button></span>`).join('') || '<span style="color:var(--text-gray);font-size:12px">–ù–µ –¥–æ–¥–∞–Ω–æ</span>'}
</div>
<div class="people-dropdown">
<input class="form-input" id="reviewerSearch" placeholder="–ü–æ—à—É–∫ –ª—é–¥–∏–Ω–∏..." oninput="filterPeople('reviewer')" onfocus="filterPeople('reviewer')">
<div class="people-list" id="reviewerDropdown"></div>
</div>
</div>
`;
}

window.saveWebhook = () => {
webhookUrl = document.getElementById('webhookInput').value.trim();
save();
alert('‚úÖ Webhook –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
};

window.sendTestWebhook = async () => {
const url = document.getElementById('webhookInput').value.trim();
if (!url) {
alert('‚ùå –í–≤–µ–¥—ñ—Ç—å Webhook URL —Å–ø–æ—á–∞—Ç–∫—É!');
return;
}

try {
const response = await fetch(url, {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({
embeds: [{
title: 'üß™ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è',
description: 'Webhook –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ! ‚úÖ',
color: 0x00ff44,
fields: [
{name: '–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫', value: ME.name, inline: true},
{name: '–†–æ–ª—å', value: ME.role, inline: true},
{name: '–ß–∞—Å', value: now(), inline: false}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2.1'},
timestamp: new Date().toISOString()
}]
})
});

if (response.ok) {
alert('‚úÖ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Discord!');
} else {
alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: ' + response.status);
}
} catch (e) {
alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message);
}
};

window.removeReviewer = async (n) => {
reviewers = reviewers.filter(r => r !== n);
save();
renderSettings();
};

window.filterPeople = type => {
const input = document.getElementById(type + 'Search');
const drop = document.getElementById(type + 'Dropdown');
const val = input.value.toLowerCase();

const list = type === 'reviewer' ?
allUsers.filter(u => !reviewers.includes(u.name)) :
allUsers.filter(u => !adminList.includes(u.name));

const filtered = val ? list.filter(u => u.name.toLowerCase().includes(val)) : list;

if (filtered.length === 0) {
drop.innerHTML = '<div style="padding:15px;text-align:center;color:var(--text-gray);font-size:12px">–ù—ñ–∫–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
drop.classList.add('show');
return;
}

drop.innerHTML = filtered.map(u => {
const roleLabel = u.role === 'admin' ? '–ê–¥–º—ñ–Ω' : u.role === 'instructor' ? '–Ü–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä' : '–ë—ñ—î—Ü—å';
const roleColor = u.role === 'admin' ? 'var(--primary)' : u.role === 'instructor' ? 'var(--warning)' : 'var(--text-gray)';

return `<div class="people-item" onclick="selectPerson('${type}','${u.name}')">
<span>${u.name}</span>
<span style="font-size:10px;color:${roleColor};font-weight:700">${roleLabel}</span>
</div>`;
}).join('');

drop.classList.add('show');
};

window.selectPerson = async (type, name) => {
if (type === 'reviewer' && !reviewers.includes(name)) {
reviewers.push(name);
save();

await sendDiscordNotification('REVIEWER_ADDED', {
reviewerName: name,
addedBy: ME.name,
date: now()
});

renderSettings();
}

if (type === 'admin' && !adminList.includes(name)) {
adminList.push(name);
save();

await sendDiscordNotification('ADMIN_ADDED', {
adminName: name,
addedBy: ME.name,
date: now()
});

renderAdminList();
buildNav();
}

document.querySelectorAll('.people-list').forEach(d => d.classList.remove('show'));
};

document.addEventListener('click', e => {
if (!e.target.closest('.people-dropdown')) {
document.querySelectorAll('.people-list').forEach(d => d.classList.remove('show'));
}
});

// =================================
// –ê–î–ú–Ü–ù –°–ü–ò–°–û–ö
// =================================

function renderAdminList() {
document.getElementById('adminListContent').innerHTML = `
<div class="admin-list-panel">
<h4 style="font-size:13px;font-weight:800;color:var(--primary-bright);margin-bottom:15px">üëë –õ—é–¥–∏ –∑ –∞–¥–º—ñ–Ω –ø—Ä–∞–≤–∞–º–∏ –≤ —ñ—Å–ø–∏—Ç–∞—Ö</h4>
<p style="font-size:11px;color:var(--text-gray);margin-bottom:15px">–¶—ñ –ª—é–¥–∏ –º–∞—é—Ç—å –ø–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è, —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —ñ—Å–ø–∏—Ç—ñ–≤</p>
<div id="adminChips" style="margin-bottom:15px">
${adminList.map(n => `<span class="reviewer-chip" style="background:rgba(251,191,36,0.1);border-color:rgba(251,191,36,0.3);color:var(--warning)">${n}<button onclick="removeAdmin('${n}')">‚úï</button></span>`).join('') || '<span style="color:var(--text-gray);font-size:12px">–ù–µ –¥–æ–¥–∞–Ω–æ</span>'}
</div>
<div class="people-dropdown">
<input class="form-input" id="adminSearch" placeholder="–ü–æ—à—É–∫ –ª—é–¥–∏–Ω–∏..." oninput="filterPeople('admin')" onfocus="filterPeople('admin')">
<div class="people-list" id="adminDropdown"></div>
</div>
</div>
`;
}

window.removeAdmin = n => {
adminList = adminList.filter(a => a !== n);
save();
renderAdminList();
buildNav();
};

// =================================
// –§–Ü–ù–ê–õ
// =================================

document.onkeydown = e => {
if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && [73, 74, 67].includes(e.keyCode)) || (e.ctrlKey && e.keyCode === 85)) {
return false;
}
};

// –ü—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –≤ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π —á–∞—Å—Ç–∏–Ω—ñ...
</script>
</body>
</html>
