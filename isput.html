<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>–î–®–í | –Ü–°–ü–ò–¢ –¶–ï–ù–¢–†</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{--p:#00ff44;--pb:#e0ffe8;--pg:rgba(0,255,68,0.7);--bg:#030507;--card:rgba(10,12,16,0.6);--gb:rgba(0,255,68,0.3);--r:#ef4444;--rg:rgba(239,68,68,0.6);--w:#fbbf24;--tg:#94a3b8;--gold:#ffd700;--blue:#3b82f6}
*{box-sizing:border-box;margin:0;padding:0}
body{background-color:var(--bg);color:#fff;font-family:'Inter',sans-serif;min-height:100vh;overflow-x:hidden;user-select:none;-webkit-user-select:none}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 15% 50%,rgba(0,255,68,0.12),transparent 50%),radial-gradient(circle at 85% 30%,rgba(0,255,68,0.12),transparent 50%);pointer-events:none;z-index:0}
input,textarea,select{user-select:text!important;-webkit-user-select:text!important}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#05070a}::-webkit-scrollbar-thumb{background:var(--p);border-radius:10px;box-shadow:0 0 10px var(--p)}

@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes glow{0%,100%{box-shadow:0 0 20px rgba(0,255,68,0.3)}50%{box-shadow:0 0 40px rgba(0,255,68,0.6)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes rotateIn{from{opacity:0;transform:rotate(-10deg) scale(0.8)}to{opacity:1;transform:rotate(0) scale(1)}}
@keyframes countUp{from{opacity:0;transform:scale(0.5)}to{opacity:1;transform:scale(1)}}
@keyframes borderPulse{0%,100%{border-color:rgba(0,255,68,0.3)}50%{border-color:rgba(0,255,68,0.8)}}
@keyframes scanline{0%{top:-100%}100%{top:200%}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes ripple{to{transform:scale(4);opacity:0}}

.particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;overflow:hidden}
.particle{position:absolute;width:2px;height:2px;background:var(--p);border-radius:50%;opacity:0.3;animation:floatParticle linear infinite}
@keyframes floatParticle{0%{transform:translateY(100vh) rotate(0deg);opacity:0}10%{opacity:0.4}90%{opacity:0.4}100%{transform:translateY(-10vh) rotate(720deg);opacity:0}}

header{display:flex;justify-content:space-between;align-items:center;padding:15px 5%;background:rgba(3,5,7,0.9);border-bottom:1px solid var(--gb);position:sticky;top:0;z-index:1000;backdrop-filter:blur(20px);box-shadow:0 0 30px rgba(0,255,68,0.15)}
header::after{content:'';position:absolute;bottom:0;left:0;width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--p),transparent);animation:shimmer 3s infinite linear;background-size:200% 100%}
.logo{display:flex;align-items:center;gap:12px;text-decoration:none}
.logo-badge{background:var(--p);color:#000;padding:6px 14px;border-radius:8px;font-weight:900;font-size:15px;text-transform:uppercase;box-shadow:0 0 20px var(--p);letter-spacing:1px}
.logo-text{color:var(--pb);font-weight:800;font-size:14px;letter-spacing:2px}
.h-right{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.h-name{color:var(--pb);font-weight:800;font-size:14px}
.role-badge{padding:4px 12px;border-radius:6px;font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:1px}
.role-admin{background:rgba(0,255,68,0.15);color:var(--p);border:1px solid var(--p);box-shadow:0 0 10px rgba(0,255,68,0.3)}
.role-instructor{background:rgba(251,191,36,0.15);color:var(--w);border:1px solid var(--w)}
.role-fighter{background:rgba(148,163,184,0.15);color:var(--tg);border:1px solid rgba(148,163,184,0.3)}
.nav-btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:10px 18px;border-radius:10px;font-weight:700;cursor:pointer;font-size:12px;transition:all 0.3s;position:relative;overflow:hidden}
.nav-btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(0,255,68,0.2);border-radius:50%;transform:translate(-50%,-50%);transition:width 0.6s,height 0.6s}
.nav-btn:hover::before{width:300px;height:300px}
.nav-btn:hover{border-color:var(--p);color:var(--pb);transform:translateY(-2px);box-shadow:0 5px 20px rgba(0,255,68,0.3)}
.nav-btn.active{background:var(--p);color:#000;border-color:var(--p);box-shadow:0 0 20px var(--p)}
.btn-back{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:8px 14px;border-radius:8px;font-weight:700;cursor:pointer;font-size:12px;text-decoration:none;transition:all 0.3s}
.btn-back:hover{border-color:var(--p);color:var(--pb)}

.notif-wrap{position:relative;cursor:pointer;padding:5px}
.bell{font-size:22px;filter:drop-shadow(0 0 8px var(--w));transition:transform 0.3s}
.bell:hover{transform:rotate(15deg)}
.bell-badge{position:absolute;top:-2px;right:-2px;background:var(--r);color:#fff;font-size:9px;font-weight:900;padding:2px 5px;border-radius:50%;display:none;animation:pulse 1.5s infinite}
.notif-drop{position:absolute;top:45px;right:0;width:320px;background:rgba(10,15,25,0.97);border:1px solid var(--gb);border-radius:15px;display:none;flex-direction:column;z-index:2000;box-shadow:0 10px 50px rgba(0,0,0,0.9);overflow:hidden;animation:slideDown 0.3s}
.notif-drop.show{display:flex}
.notif-head{padding:12px 15px;background:rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.05)}
.notif-item{padding:12px 15px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:12px;color:#ccc;cursor:pointer;transition:all 0.2s}
.notif-item:hover{background:rgba(0,255,68,0.05)}
.notif-item.unread{border-left:3px solid var(--p);color:#fff}

.main{padding:30px 5%;position:relative;z-index:1}
.view{display:none;animation:fadeIn 0.5s ease}
.view.active{display:block}

.section-title{font-size:28px;font-weight:900;color:var(--pb);margin-bottom:25px;text-transform:uppercase;letter-spacing:1px;text-shadow:0 0 20px rgba(0,255,68,0.3);display:flex;align-items:center;gap:12px}
.section-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--gb),transparent)}

.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:30px}
.stat-card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:20px;text-align:center;backdrop-filter:blur(10px);transition:all 0.4s;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(0,255,68,0.03),transparent 70%);opacity:0;transition:opacity 0.4s}
.stat-card:hover::before{opacity:1}
.stat-card:hover{border-color:var(--gb);transform:translateY(-3px);box-shadow:0 10px 30px rgba(0,0,0,0.5)}
.stat-card .num{font-size:32px;font-weight:900;color:var(--pb);text-shadow:0 0 15px var(--p)}
.stat-card .lbl{font-size:10px;font-weight:700;color:var(--tg);text-transform:uppercase;letter-spacing:1px;margin-top:5px}

.tests-grid{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;margin-bottom:30px}
.test-card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:20px;padding:0;width:300px;cursor:pointer;transition:all 0.4s;position:relative;overflow:hidden;backdrop-filter:blur(10px)}
.test-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--p),var(--blue),var(--p));opacity:0;transition:opacity 0.3s}
.test-card:hover::before{opacity:1}
.test-card:hover{border-color:var(--gb);transform:translateY(-5px) scale(1.02);box-shadow:0 15px 40px rgba(0,255,68,0.15)}
.test-card-inner{padding:25px}
.test-card .emoji{font-size:45px;margin-bottom:12px;display:block;animation:float 4s ease-in-out infinite}
.test-card .t-name{font-size:18px;font-weight:900;margin-bottom:6px;color:#fff}
.test-card .t-desc{font-size:12px;color:var(--tg);margin-bottom:15px;line-height:1.5}
.test-card .t-meta{display:flex;justify-content:space-between;font-size:11px;color:var(--tg)}
.test-card .t-meta span{display:flex;align-items:center;gap:4px}
.cat-badge{display:inline-block;padding:3px 10px;border-radius:5px;font-size:10px;font-weight:700;background:rgba(0,255,68,0.1);color:var(--p);border:1px solid rgba(0,255,68,0.2);margin-bottom:10px}

.results-list{display:flex;flex-direction:column;gap:12px}
.result-item{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:15px;padding:18px 22px;display:flex;justify-content:space-between;align-items:center;transition:all 0.3s;position:relative;overflow:hidden}
.result-item::after{content:'';position:absolute;top:0;left:0;width:3px;height:100%;border-radius:3px}
.result-item.passed::after{background:var(--p);box-shadow:0 0 10px var(--p)}
.result-item.failed::after{background:var(--r);box-shadow:0 0 10px var(--r)}
.result-item.pending::after{background:var(--w);box-shadow:0 0 10px var(--w)}
.result-item:hover{border-color:var(--gb);transform:translateX(5px)}
.r-status{padding:5px 12px;border-radius:8px;font-size:11px;font-weight:900;text-transform:uppercase}
.r-pass{background:rgba(0,255,68,0.15);color:var(--p)}
.r-fail{background:rgba(239,68,68,0.15);color:var(--r)}
.r-pend{background:rgba(251,191,36,0.15);color:var(--w)}

.intro-box{max-width:600px;margin:0 auto;background:var(--card);border:1px solid var(--gb);border-radius:25px;padding:40px;text-align:center;animation:fadeIn 0.5s,glow 3s infinite;position:relative;overflow:hidden}
.intro-box::before{content:'';position:absolute;top:0;left:-100%;width:50%;height:100%;background:linear-gradient(90deg,transparent,rgba(0,255,68,0.03),transparent);animation:scanline 4s infinite linear}
.intro-box .emoji{font-size:70px;margin-bottom:20px;animation:float 3s ease-in-out infinite}
.intro-box h2{font-size:26px;font-weight:900;margin-bottom:10px;color:var(--pb)}
.intro-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:20px 0;text-align:center}
.intro-info div{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.05)}
.intro-info .val{font-size:20px;font-weight:900;color:var(--pb)}
.intro-info .lbl{font-size:10px;color:var(--tg);text-transform:uppercase;margin-top:3px}

.btn-start{background:var(--p);color:#000;border:none;padding:16px 50px;border-radius:12px;font-weight:900;font-size:16px;cursor:pointer;text-transform:uppercase;letter-spacing:2px;transition:all 0.3s;position:relative;overflow:hidden}
.btn-start::after{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,0.3);border-radius:50%;transform:translate(-50%,-50%);transition:all 0.5s}
.btn-start:hover::after{width:400px;height:400px}
.btn-start:hover{transform:scale(1.05);box-shadow:0 0 30px var(--p)}

.quiz-box{max-width:700px;margin:0 auto}
.quiz-progress{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.quiz-progress .bar-wrap{flex:1;height:8px;background:rgba(255,255,255,0.05);border-radius:10px;overflow:hidden;position:relative}
.quiz-progress .bar-fill{height:100%;background:linear-gradient(90deg,var(--p),var(--pb));border-radius:10px;transition:width 0.5s ease;box-shadow:0 0 10px var(--p);position:relative}
.quiz-progress .bar-fill::after{content:'';position:absolute;right:0;top:-2px;width:12px;height:12px;background:var(--pb);border-radius:50%;box-shadow:0 0 15px var(--p)}
.quiz-progress .prog-text{font-size:13px;font-weight:800;color:var(--pb);min-width:60px;text-align:right}
.timer-bar{height:4px;background:rgba(255,255,255,0.05);border-radius:10px;margin-bottom:25px;overflow:hidden}
.timer-fill{height:100%;background:linear-gradient(90deg,var(--p),var(--w),var(--r));border-radius:10px;transition:width 0.1s linear}
.q-card{background:var(--card);border:1px solid var(--gb);border-radius:20px;padding:30px;animation:fadeIn 0.4s;position:relative;overflow:hidden}
.q-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--p),transparent)}
.q-num{font-size:11px;font-weight:800;color:var(--p);text-transform:uppercase;letter-spacing:2px;margin-bottom:12px}
.q-text{font-size:18px;font-weight:700;margin-bottom:25px;line-height:1.5;color:var(--pb)}
.q-opts{display:flex;flex-direction:column;gap:10px}
.q-opt{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:15px 18px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.3s;display:flex;align-items:center;gap:12px;position:relative;overflow:hidden}
.q-opt::before{content:'';position:absolute;top:0;left:0;width:0;height:100%;background:rgba(0,255,68,0.05);transition:width 0.3s}
.q-opt:hover::before{width:100%}
.q-opt:hover{border-color:var(--gb);transform:translateX(5px)}
.q-opt.selected{border-color:var(--p);background:rgba(0,255,68,0.1);box-shadow:0 0 15px rgba(0,255,68,0.2)}
.q-opt.correct{border-color:var(--p);background:rgba(0,255,68,0.15);animation:pulse 0.5s}
.q-opt.wrong{border-color:var(--r);background:rgba(239,68,68,0.15);animation:shake 0.5s}
.opt-letter{width:30px;height:30px;border-radius:8px;background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;color:var(--tg);border:1px solid rgba(255,255,255,0.1);flex-shrink:0;transition:all 0.3s}
.q-opt.selected .opt-letter{background:var(--p);color:#000;border-color:var(--p)}
.free-input{width:100%;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:14px;border-radius:12px;font-size:14px;font-family:inherit;outline:none;resize:vertical;min-height:80px;transition:all 0.3s;margin-top:10px}
.free-input:focus{border-color:var(--p);box-shadow:0 0 15px rgba(0,255,68,0.2)}
.free-label{font-size:12px;color:var(--tg);margin-top:15px;font-weight:700;text-transform:uppercase}
.btn-next{background:var(--p);color:#000;border:none;padding:14px 40px;border-radius:12px;font-weight:900;font-size:14px;cursor:pointer;margin-top:20px;transition:all 0.3s;text-transform:uppercase;letter-spacing:1px}
.btn-next:hover{box-shadow:0 0 25px var(--p);transform:translateY(-2px)}
.btn-next:disabled{background:#333;color:#666;cursor:not-allowed;box-shadow:none;transform:none}

.result-box{max-width:650px;margin:0 auto;text-align:center;animation:fadeIn 0.6s}
.result-circle{width:160px;height:160px;border-radius:50%;margin:0 auto 25px;display:flex;flex-direction:column;align-items:center;justify-content:center;animation:countUp 0.8s ease;position:relative}
.result-circle::before{content:'';position:absolute;inset:-5px;border-radius:50%;border:2px solid transparent;animation:borderPulse 2s infinite}
.result-circle.pass{background:rgba(0,255,68,0.1);border:3px solid var(--p);box-shadow:0 0 40px rgba(0,255,68,0.3)}
.result-circle.pass::before{border-color:var(--p)}
.result-circle.fail{background:rgba(239,68,68,0.1);border:3px solid var(--r);box-shadow:0 0 40px rgba(239,68,68,0.3)}
.result-circle.fail::before{border-color:var(--r)}
.result-circle .score{font-size:36px;font-weight:900}
.result-circle .of{font-size:12px;color:var(--tg)}
.result-status{font-size:24px;font-weight:900;margin-bottom:5px;text-transform:uppercase;letter-spacing:2px}
.result-msg{color:var(--tg);font-size:14px;margin-bottom:25px}
.detail-list{text-align:left;display:flex;flex-direction:column;gap:10px;margin-bottom:25px}
.detail-item{background:var(--card);border-radius:12px;padding:15px;border:1px solid rgba(255,255,255,0.05);transition:all 0.3s}
.detail-item:hover{border-color:var(--gb)}
.detail-item .d-q{font-size:13px;font-weight:700;margin-bottom:6px;color:var(--pb)}
.detail-item .d-a{font-size:12px;display:flex;align-items:center;gap:6px}
.reviewer-info{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:12px;margin-bottom:20px;font-size:13px}
.btn-row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.btn-g{background:var(--p);color:#000;border:none;padding:14px 30px;border-radius:12px;font-weight:900;cursor:pointer;font-size:13px;transition:all 0.3s;text-transform:uppercase}
.btn-g:hover{box-shadow:0 0 20px var(--p);transform:translateY(-2px)}
.btn-o{background:rgba(255,255,255,0.05);color:#fff;border:1px solid rgba(255,255,255,0.1);padding:14px 30px;border-radius:12px;font-weight:900;cursor:pointer;font-size:13px;transition:all 0.3s}
.btn-o:hover{border-color:var(--p);color:var(--pb)}
.btn-r{background:rgba(239,68,68,0.1);color:var(--r);border:1px solid var(--r);padding:12px 24px;border-radius:10px;font-weight:800;cursor:pointer;font-size:12px;transition:all 0.3s}
.btn-r:hover{background:var(--r);color:#fff}

.form-box{max-width:750px;margin:0 auto;background:var(--card);border:1px solid var(--gb);border-radius:20px;padding:30px;animation:fadeIn 0.5s}
.fg{margin-bottom:20px}
.fg label{display:block;font-size:11px;font-weight:800;color:var(--tg);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.fi{width:100%;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:13px;border-radius:10px;font-size:14px;font-family:inherit;outline:none;transition:all 0.3s}
.fi:focus{border-color:var(--p);box-shadow:0 0 15px rgba(0,255,68,0.2)}
.fi-row{display:flex;gap:10px;align-items:center}
.q-block{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:15px;padding:20px;margin-bottom:15px;transition:all 0.3s;position:relative;scroll-margin-top:100px}
.q-block:hover{border-color:var(--gb)}
.q-block.error{border-color:var(--r)!important;animation:shake 0.5s;box-shadow:0 0 20px rgba(239,68,68,0.3)}
.q-block .q-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.q-block .q-head span{font-size:12px;font-weight:800;color:var(--p)}
.opt-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.opt-row .radio{width:20px;height:20px;border-radius:50%;border:2px solid rgba(255,255,255,0.2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s;flex-shrink:0}
.opt-row .radio.active{border-color:var(--p);background:var(--p)}
.opt-row .radio.active::after{content:'‚úì';color:#000;font-size:11px;font-weight:900}
.chk-row{display:flex;align-items:center;gap:10px;margin-top:10px}
.chk{width:18px;height:18px;accent-color:var(--p);cursor:pointer}
.btn-add-sm{background:none;border:1px dashed rgba(255,255,255,0.15);color:var(--tg);padding:8px 15px;border-radius:8px;cursor:pointer;font-size:11px;font-weight:700;transition:all 0.3s}
.btn-add-sm:hover{border-color:var(--p);color:var(--pb)}
.btn-remove{background:none;border:none;color:var(--r);cursor:pointer;font-size:16px;transition:all 0.3s;padding:5px}
.btn-remove:hover{transform:scale(1.2)}

.manage-table{width:100%;border-collapse:collapse;margin-top:15px}
.manage-table th{text-align:left;padding:12px;font-size:11px;color:var(--tg);text-transform:uppercase;border-bottom:1px solid rgba(255,255,255,0.06)}
.manage-table td{padding:12px;font-size:13px;border-bottom:1px solid rgba(255,255,255,0.03)}
.manage-table tr:hover td{background:rgba(0,255,68,0.02)}

.review-card{background:var(--card);border:1px solid var(--gb);border-radius:15px;padding:20px;margin-bottom:15px;animation:fadeIn 0.3s}
.review-q{font-weight:700;margin-bottom:8px;color:var(--pb)}
.review-a{background:rgba(0,0,0,0.3);padding:10px;border-radius:8px;margin-bottom:10px;font-size:13px;border-left:3px solid var(--w)}

.settings-box{max-width:600px;margin:0 auto;background:var(--card);border:1px solid var(--gb);border-radius:20px;padding:30px;animation:fadeIn 0.5s}
.user-pick-list{max-height:200px;overflow-y:auto;border:1px solid rgba(255,255,255,0.06);border-radius:10px;margin-top:5px}
.user-pick-item{padding:10px 15px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:all 0.2s;font-size:13px}
.user-pick-item:hover{background:rgba(0,255,68,0.05)}
.user-pick-item.selected{background:rgba(0,255,68,0.1);border-left:3px solid var(--p)}
.reviewer-tag{display:inline-flex;align-items:center;gap:6px;background:rgba(0,255,68,0.1);border:1px solid var(--gb);padding:5px 12px;border-radius:8px;font-size:12px;font-weight:700;margin:3px}

.empty-state{text-align:center;padding:50px 20px;color:var(--tg)}
.empty-state .emoji{font-size:50px;margin-bottom:15px;display:block}

.modal-ov{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;z-index:3000;backdrop-filter:blur(5px)}
.modal-ov.show{display:flex}
.modal-box{background:#0f1115;border:1px solid var(--gb);padding:30px;border-radius:20px;width:90%;max-width:450px;position:relative;box-shadow:0 0 60px rgba(0,255,68,0.2);animation:fadeIn 0.3s}
.modal-close{position:absolute;top:12px;right:18px;background:none;border:none;color:#555;font-size:24px;cursor:pointer;transition:all 0.3s}
.modal-close:hover{color:#fff;transform:rotate(90deg)}

@media(max-width:768px){
header{padding:12px 15px;flex-wrap:wrap;gap:10px}
.h-right{gap:8px}
.nav-btn{padding:8px 12px;font-size:11px}
.tests-grid{gap:12px}
.test-card{width:100%}
.stats-row{grid-template-columns:1fr 1fr}
.intro-box{padding:25px}
.q-card{padding:20px}
.form-box{padding:20px}
.section-title{font-size:20px}
}
</style>
</head>
<body>

<div class="particles" id="particles"></div>

<header>
<div class="logo">
<a href="cabinet.html" class="btn-back">‚Üê –ö–ê–ë–Ü–ù–ï–¢</a>
<span class="logo-badge">–î–®–í</span>
<span class="logo-text">–Ü–°–ü–ò–¢ –¶–ï–ù–¢–†</span>
</div>
<div class="h-right">
<div class="notif-wrap" onclick="toggleNotif(event)">
<span class="bell">üîî</span>
<div class="bell-badge" id="bellBadge">0</div>
<div class="notif-drop" id="notifDrop">
<div class="notif-head">
<span style="color:var(--pb);font-size:11px;font-weight:800">–°–ü–û–í–Ü–©–ï–ù–ù–Ø</span>
<button onclick="clearNotifs()" style="background:none;border:none;color:var(--tg);font-size:10px;cursor:pointer;font-weight:700">–û–ß–ò–°–¢–ò–¢–ò</button>
</div>
<div id="notifList"><div class="empty-state" style="padding:20px"><span style="font-size:12px">–ù–µ–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω—å</span></div></div>
</div>
</div>
<span class="h-name" id="hName">...</span>
<span class="role-badge role-fighter" id="hRole">...</span>
<nav class="h-right" id="navBtns">
<button class="nav-btn active" onclick="go('home')">üè† –ì–æ–ª–æ–≤–Ω–∞</button>
<button class="nav-btn" onclick="go('create')" id="navCreate" style="display:none">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
<button class="nav-btn" onclick="go('manage')" id="navManage" style="display:none">‚öôÔ∏è –ö–µ—Ä—É–≤–∞–Ω–Ω—è</button>
<button class="nav-btn" onclick="go('settings')" id="navSettings" style="display:none">üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</nav>
</div>
</header>

<div class="main">

<!-- HOME -->
<div class="view active" id="v-home">
<div class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
<div class="stats-row" id="statsRow"></div>
<div class="section-title">üìù –î–æ—Å—Ç—É–ø–Ω—ñ —Ç–µ—Å—Ç–∏</div>
<div class="tests-grid" id="testsGrid"></div>
<div class="section-title">üèÜ –ú–æ—ó —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏</div>
<div class="results-list" id="myResults"></div>
</div>

<!-- INTRO -->
<div class="view" id="v-intro">
<div class="intro-box" id="introBox"></div>
</div>

<!-- QUIZ -->
<div class="view" id="v-quiz">
<div class="quiz-box" id="quizBox"></div>
</div>

<!-- RESULT -->
<div class="view" id="v-result">
<div class="result-box" id="resultBox"></div>
</div>

<!-- CREATE/EDIT -->
<div class="view" id="v-create">
<div class="section-title" id="createTitle">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–µ—Å—Ç</div>
<div class="form-box" id="createForm"></div>
</div>

<!-- MANAGE -->
<div class="view" id="v-manage">
<div class="section-title">‚öôÔ∏è –ö–µ—Ä—É–≤–∞–Ω–Ω—è —Ç–µ—Å—Ç–∞–º–∏</div>
<div id="manageContent"></div>
</div>

<!-- SETTINGS -->
<div class="view" id="v-settings">
<div class="section-title">üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
<div class="settings-box" id="settingsContent"></div>
</div>

<!-- REVIEW -->
<div class="view" id="v-review">
<div class="section-title">üìã –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</div>
<div id="reviewContent" style="max-width:700px;margin:0 auto"></div>
</div>

</div>

<div class="modal-ov" id="errorModal">
<div class="modal-box">
<button class="modal-close" onclick="closeModal('errorModal')">&times;</button>
<h3 style="color:var(--r);text-align:center;margin-bottom:15px" id="errTitle">‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞</h3>
<p style="text-align:center;color:var(--tg);font-size:14px" id="errMsg"></p>
</div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import{getAuth,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import{getFirestore,doc,getDoc,collection,getDocs}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const app=initializeApp({apiKey:"AIzaSyATUpLUHSp1VbyxkJXhMS-2R71zNOBGC00",authDomain:"dsv-gta.firebaseapp.com",projectId:"dsv-gta",storageBucket:"dsv-gta.firebasestorage.app",messagingSenderId:"661591588818",appId:"1:661591588818:web:a8e8dca3d061447e24d20b"});
const auth=getAuth(app),db=getFirestore(app);

/* ========== STATE ========== */
let ME={name:'–ë–æ—î—Ü—å',role:'fighter',uid:''};
let allUsers=[];
let tests=JSON.parse(localStorage.getItem('isput_tests')||'[]');
let results=JSON.parse(localStorage.getItem('isput_results')||'[]');
let settings=JSON.parse(localStorage.getItem('isput_settings')||'{"webhook":"","reviewers":[]}');
let notifs=JSON.parse(localStorage.getItem('isput_notifs')||'[]');
let currentView='home',quizState=null,editingTestId=null;

const save=()=>{localStorage.setItem('isput_tests',JSON.stringify(tests));localStorage.setItem('isput_results',JSON.stringify(results));localStorage.setItem('isput_settings',JSON.stringify(settings));localStorage.setItem('isput_notifs',JSON.stringify(notifs))};
const $=id=>document.getElementById(id);
const letters=['–ê','–ë','–í','–ì','–î','–ï','–Ñ','–ñ','–ó','–Ü','–á','–ö','–õ'];

/* ========== PARTICLES ========== */
function initParticles(){const c=$('particles');for(let i=0;i<30;i++){const p=document.createElement('div');p.className='particle';p.style.left=Math.random()*100+'%';p.style.animationDuration=(8+Math.random()*15)+'s';p.style.animationDelay=Math.random()*10+'s';p.style.width=p.style.height=(1+Math.random()*2)+'px';c.appendChild(p)}}
initParticles();

/* ========== AUTH ========== */
onAuthStateChanged(auth,async u=>{
if(!u){window.location.href='index.html';return}
ME.uid=u.uid;
try{
const snap=await getDoc(doc(db,"users",u.uid));
if(snap.exists()){const d=snap.data();ME.name=d.name||'–ë–æ—î—Ü—å';ME.role=d.role||'fighter'}
const uSnap=await getDocs(collection(db,"users"));
allUsers=[];uSnap.forEach(d=>{const data=d.data();allUsers.push({uid:d.id,name:data.name||'---',role:data.role||'fighter'})});
}catch(e){console.log('Firebase read error',e)}
$('hName').textContent=ME.name;
const rb=$('hRole');rb.textContent=ME.role==='admin'?'–ê–î–ú–Ü–ù':ME.role==='instructor'?'–Ü–ù–°–¢–†–£–ö–¢–û–†':'–ë–Ü–Ñ–¶–¨';
rb.className='role-badge '+(ME.role==='admin'?'role-admin':ME.role==='instructor'?'role-instructor':'role-fighter');
if(ME.role==='admin'){$('navCreate').style.display='';$('navManage').style.display='';$('navSettings').style.display=''}
renderHome();renderNotifBadge()
});

/* ========== SECURITY ========== */
/* –í—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ closure, –Ω–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É scope */
document.onkeydown=e=>{if(e.keyCode===123||(e.ctrlKey&&e.shiftKey&&[73,74,67].includes(e.keyCode))||(e.ctrlKey&&e.keyCode===85))return false};

/* ========== NAVIGATION ========== */
window.go=v=>{
currentView=v;
document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
const el=$(('v-'+v));if(el)el.classList.add('active');
document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
const navMap={home:0,create:1,manage:2,settings:3};
const btns=document.querySelectorAll('#navBtns .nav-btn');
if(btns[navMap[v]])btns[navMap[v]].classList.add('active');
if(v==='home')renderHome();
if(v==='create'){editingTestId=null;$('createTitle').innerHTML='‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–µ—Å—Ç';renderCreateForm()}
if(v==='manage')renderManage();
if(v==='settings')renderSettings();
window.scrollTo({top:0,behavior:'smooth'})
};

/* ========== NOTIFICATIONS ========== */
function addNotif(text){notifs.unshift({text,time:Date.now(),read:false});save();renderNotifBadge();renderNotifList()}
function renderNotifBadge(){const c=notifs.filter(n=>!n.read).length;const b=$('bellBadge');if(c>0){b.textContent=c;b.style.display='block'}else b.style.display='none'}
function renderNotifList(){const el=$('notifList');if(!notifs.length){el.innerHTML='<div class="empty-state" style="padding:20px"><span style="font-size:12px">–ù–µ–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω—å</span></div>';return}
el.innerHTML=notifs.slice(0,20).map((n,i)=>`<div class="notif-item ${n.read?'':'unread'}" onclick="readNotif(${i})">${n.text}<div style="font-size:10px;color:var(--tg);margin-top:4px">${new Date(n.time).toLocaleString('uk')}</div></div>`).join('')}
window.readNotif=i=>{notifs[i].read=true;save();renderNotifBadge();renderNotifList()};
window.clearNotifs=()=>{notifs=[];save();renderNotifBadge();renderNotifList()};
window.toggleNotif=e=>{e.stopPropagation();const d=$('notifDrop');d.classList.toggle('show');renderNotifList()};
document.addEventListener('click',e=>{if(!e.target.closest('.notif-wrap'))$('notifDrop').classList.remove('show')});

/* ========== DISCORD WEBHOOK ========== */
async function sendWebhook(title,fields,color=0x00ff44){
if(!settings.webhook)return;
try{await fetch(settings.webhook,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({embeds:[{title,fields:fields.map(f=>({name:f[0],value:String(f[1]),inline:f[2]||false})),color,footer:{text:'–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† ‚Ä¢ '+new Date().toLocaleString('uk')},thumbnail:{url:'https://i.imgur.com/AfFp7pu.png'}}]})})}catch(e){console.log('Webhook error',e)}
}

/* ========== MODAL ========== */
function showError(title,msg){$('errTitle').textContent=title;$('errMsg').textContent=msg;$('errorModal').classList.add('show')}
window.closeModal=id=>$(id).classList.remove('show');
$('errorModal').addEventListener('click',e=>{if(e.target===$('errorModal'))$('errorModal').classList.remove('show')});

/* ========== HOME ========== */
function renderHome(){
const myRes=results.filter(r=>r.userName===ME.name);
const passed=myRes.filter(r=>r.status==='passed').length;
const failed=myRes.filter(r=>r.status==='failed').length;
const pending=myRes.filter(r=>r.status==='pending').length;
const avg=myRes.length?Math.round(myRes.reduce((s,r)=>s+r.score,0)/myRes.length):0;

$('statsRow').innerHTML=`
<div class="stat-card"><div class="num">${tests.length}</div><div class="lbl">–¢–µ—Å—Ç—ñ–≤</div></div>
<div class="stat-card"><div class="num" style="color:var(--p)">${passed}</div><div class="lbl">–°–∫–ª–∞–¥–µ–Ω–æ</div></div>
<div class="stat-card"><div class="num" style="color:var(--r)">${failed}</div><div class="lbl">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div></div>
<div class="stat-card"><div class="num" style="color:var(--w)">${pending}</div><div class="lbl">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</div></div>`;

if(!tests.length){$('testsGrid').innerHTML='<div class="empty-state"><span class="emoji">üì≠</span><p>–¢–µ—Å—Ç—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</p></div>';} 
else{$('testsGrid').innerHTML=tests.map(t=>{
const qCount=t.questions?t.questions.length:0;
return`<div class="test-card" onclick="startIntro('${t.id}')">
<div class="test-card-inner">
<span class="emoji">${t.emoji||'üìù'}</span>
<div class="cat-badge">${t.category||'–ó–∞–≥–∞–ª—å–Ω–µ'}</div>
<div class="t-name">${t.name}</div>
<div class="t-desc">${t.desc||''}</div>
<div class="t-meta"><span>üìã ${qCount} –ø–∏—Ç–∞–Ω—å</span><span>‚≠ê ${t.maxScore||0} –±–∞–ª—ñ–≤</span><span>‚úÖ –≤—ñ–¥ ${t.passScore||0} –±.</span></div>
</div></div>`}).join('')}

// Pending reviews for admin/reviewers
const canReview=ME.role==='admin'||settings.reviewers.some(r=>r.name===ME.name);
const pendingReviews=results.filter(r=>r.status==='pending'&&r.hasFree);
if(canReview&&pendingReviews.length){
$('testsGrid').innerHTML+=`<div class="test-card" onclick="go('review')" style="border-color:var(--w)">
<div class="test-card-inner" style="text-align:center">
<span class="emoji">üìã</span>
<div class="t-name" style="color:var(--w)">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ</div>
<div class="t-desc">${pendingReviews.length} –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</div>
</div></div>`}

if(!myRes.length){$('myResults').innerHTML='<div class="empty-state"><span class="emoji">üìä</span><p>–í–∏ —â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Ç–µ—Å—Ç—ñ–≤</p></div>';}
else{$('myResults').innerHTML=myRes.map(r=>{
const st=r.status==='passed'?'passed':r.status==='failed'?'failed':'pending';
const stText=r.status==='passed'?'–°–∫–ª–∞–¥–µ–Ω–æ':r.status==='failed'?'–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ':'–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ';
const stClass=r.status==='passed'?'r-pass':r.status==='failed'?'r-fail':'r-pend';
const reviewer=r.reviewer?` | –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤: ${r.reviewer}`:'';
return`<div class="result-item ${st}" onclick="viewResult('${r.id}')">
<div><b>${r.testName}</b><div style="font-size:11px;color:var(--tg);margin-top:4px">${new Date(r.date).toLocaleString('uk')}${reviewer}</div></div>
<div style="display:flex;align-items:center;gap:12px"><span style="font-weight:900;font-size:18px">${r.score}/${r.maxScore}</span><span class="r-status ${stClass}">${stText}</span></div>
</div>`}).join('')}
}

/* ========== INTRO ========== */
window.startIntro=id=>{
const t=tests.find(x=>x.id===id);if(!t)return;
// Check if has pending result
const pendingRes=results.find(r=>r.testId===id&&r.userName===ME.name&&r.status==='pending');
if(pendingRes){showError('‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è','–í–∞—à –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —ñ—Å–ø–∏—Ç —â–µ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ. –î–æ—á–µ–∫–∞–π—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.');return}

$('introBox').innerHTML=`
<span class="emoji">${t.emoji||'üìù'}</span>
<h2>${t.name}</h2>
<p style="color:var(--tg);margin-bottom:15px">${t.desc||''}</p>
<div class="intro-info">
<div><div class="val">${t.questions.length}</div><div class="lbl">–ü–∏—Ç–∞–Ω—å</div></div>
<div><div class="val">${t.maxScore}</div><div class="lbl">–ú–∞–∫—Å. –±–∞–ª—ñ–≤</div></div>
<div><div class="val">${t.passScore}</div><div class="lbl">–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª</div></div>
<div><div class="val">30—Å</div><div class="lbl">–ù–∞ –ø–∏—Ç–∞–Ω–Ω—è</div></div>
</div>
<button class="btn-start" onclick="beginQuiz('${t.id}')">–†–û–ó–ü–û–ß–ê–¢–ò –Ü–°–ü–ò–¢</button>`;
go('intro')
};

/* ========== QUIZ ========== */
window.beginQuiz=id=>{
const t=tests.find(x=>x.id===id);if(!t)return;
// Shuffle options but keep correct answer tracked
const questions=t.questions.map(q=>({...q,options:q.options?[...q.options]:[]}));
quizState={test:t,questions,current:0,answers:[],timer:null,timeLeft:30};
renderQuestion();go('quiz')
};

function renderQuestion(){
if(!quizState)return;
const{test,questions,current,answers}=quizState;
const q=questions[current];
const total=questions.length;
const pct=((current)/total*100);
const pointsPerQ=test.maxScore?Math.round((test.maxScore/total)*100)/100:1;

let optsHtml='';
if(q.options&&q.options.length){
optsHtml=q.options.map((o,i)=>{
const sel=answers[current]&&answers[current].selected===i?'selected':'';
return`<div class="q-opt ${sel}" onclick="selectOpt(${i})"><span class="opt-letter">${letters[i]||String(i+1)}</span><span>${o.text}</span></div>`
}).join('')}
let freeHtml='';
if(q.allowFree){
const freeVal=answers[current]?answers[current].freeText||'':'';
freeHtml=`<div class="free-label">‚úç –í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:</div><textarea class="free-input" id="freeInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å..." oninput="saveFreeText()">${freeVal}</textarea>`}

$('quizBox').innerHTML=`
<div class="quiz-progress"><div class="bar-wrap"><div class="bar-fill" style="width:${pct}%"></div></div><span class="prog-text">${current+1}/${total}</span></div>
<div class="timer-bar"><div class="timer-fill" id="timerFill" style="width:100%"></div></div>
<div class="q-card">
<div class="q-num">–ü–∏—Ç–∞–Ω–Ω—è ${current+1} –∑ ${total} ‚Ä¢ ${pointsPerQ} –±–∞–ª(—ñ–≤)</div>
<div class="q-text">${q.text}</div>
<div class="q-opts">${optsHtml}</div>
${freeHtml}
<div style="display:flex;justify-content:space-between;margin-top:20px">
${current>0?'<button class="btn-o" onclick="prevQ()">‚Üê –ù–∞–∑–∞–¥</button>':'<div></div>'}
<button class="btn-next" id="btnNext" onclick="nextQ()">${current===total-1?'–ó–ê–í–ï–†–®–ò–¢–ò':'–î–ê–õ–Ü ‚Üí'}</button>
</div>
</div>`;
startTimer()
}

window.selectOpt=i=>{
if(!quizState)return;
if(!quizState.answers[quizState.current])quizState.answers[quizState.current]={};
quizState.answers[quizState.current].selected=i;
renderQuestion()
};
window.saveFreeText=()=>{
if(!quizState)return;
if(!quizState.answers[quizState.current])quizState.answers[quizState.current]={};
const el=$('freeInput');if(el)quizState.answers[quizState.current].freeText=el.value
};
window.prevQ=()=>{if(!quizState||quizState.current<=0)return;clearInterval(quizState.timer);quizState.current--;quizState.timeLeft=30;renderQuestion()};
window.nextQ=()=>{
if(!quizState)return;
const ans=quizState.answers[quizState.current];
const q=quizState.questions[quizState.current];
// Validate: must select option or type free text
if((!ans||ans.selected===undefined)&&!(q.allowFree&&ans&&ans.freeText&&ans.freeText.trim())){
showError('‚ö†Ô∏è –£–≤–∞–≥–∞','–û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç');return}
clearInterval(quizState.timer);
if(quizState.current<quizState.questions.length-1){quizState.current++;quizState.timeLeft=30;renderQuestion()}
else finishQuiz()
};

function startTimer(){
clearInterval(quizState.timer);quizState.timeLeft=30;
quizState.timer=setInterval(()=>{
quizState.timeLeft-=0.1;
const pct=(quizState.timeLeft/30)*100;
const fill=$('timerFill');if(fill)fill.style.width=pct+'%';
if(quizState.timeLeft<=0){clearInterval(quizState.timer);
if(!quizState.answers[quizState.current])quizState.answers[quizState.current]={};
quizState.answers[quizState.current].timedOut=true;
if(quizState.current<quizState.questions.length-1){quizState.current++;quizState.timeLeft=30;renderQuestion()}
else finishQuiz()}
},100)}

/* ========== FINISH ========== */
function finishQuiz(){
if(!quizState)return;
const{test,questions,answers}=quizState;
const total=questions.length;
const pointsPerQ=test.maxScore/total;
let score=0;let hasFree=false;let details=[];

questions.forEach((q,i)=>{
const ans=answers[i]||{};
let correct=false;let userAnswer='';let correctAnswer='';

if(q.options&&q.options.length){
const correctIdx=q.options.findIndex(o=>o.correct);
correctAnswer=correctIdx>=0?q.options[correctIdx].text:'‚Äî';
if(ans.selected!==undefined){
userAnswer=q.options[ans.selected]?q.options[ans.selected].text:'‚Äî';
if(ans.selected===correctIdx)correct=true
}else userAnswer='–ù–µ –≤—ñ–¥–ø–æ–≤—ñ–≤'}
if(q.allowFree){
hasFree=true;
if(ans.freeText&&ans.freeText.trim()){userAnswer=(userAnswer&&userAnswer!=='–ù–µ –≤—ñ–¥–ø–æ–≤—ñ–≤'?userAnswer+' | ':'')+'–í—ñ–ª—å–Ω–∞: '+ans.freeText;correct=false /* needs review */}
}
if(correct&&!q.allowFree)score+=pointsPerQ;
details.push({question:q.text,userAnswer,correctAnswer,correct:correct&&!q.allowFree,hasFree:q.allowFree,freeText:ans.freeText||''})
});

score=Math.round(score*100)/100;
let status;
if(hasFree){status='pending'}else{status=score>=test.passScore?'passed':'failed'}

const result={id:Date.now().toString(),testId:test.id,testName:test.name,userName:ME.name,userUid:ME.uid,score,maxScore:test.maxScore,passScore:test.passScore,status,hasFree,details,date:Date.now(),reviewer:hasFree?'':' SYSTEM'};
results.push(result);save();

if(!hasFree){
const emoji=status==='passed'?'‚úÖ':'‚ùå';
sendWebhook(`${emoji} –†–µ–∑—É–ª—å—Ç–∞—Ç —ñ—Å–ø–∏—Ç—É`,[ ['üë§ –ë–æ—î—Ü—å',ME.name,true],['üìù –¢–µ—Å—Ç',test.name,true],['üìä –ë–∞–ª–∏',`${score} / ${test.maxScore}`,true],['‚úÖ –ü—Ä–æ—Ö—ñ–¥–Ω–∏–π',`${test.passScore}`,true],['üìã –°—Ç–∞—Ç—É—Å',status==='passed'?'–°–ö–õ–ê–î–ï–ù–û':'–ù–ï –°–ö–õ–ê–î–ï–ù–û',true],['üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤','SYSTEM',true],['üìÖ –î–∞—Ç–∞',new Date().toLocaleString('uk'),false]],status==='passed'?0x00ff44:0xef4444)
}else{
sendWebhook('üìã –ù–æ–≤–∏–π —ñ—Å–ø–∏—Ç –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É',[['üë§ –ë–æ—î—Ü—å',ME.name,true],['üìù –¢–µ—Å—Ç',test.name,true],['üìä –ê–≤—Ç–æ-–±–∞–ª–∏',`${score} / ${test.maxScore}`,true],['‚è≥ –°—Ç–∞—Ç—É—Å','–û–ß–Ü–ö–£–Ñ –ü–ï–†–ï–í–Ü–†–ö–ò',true],['üìÖ –î–∞—Ç–∞',new Date().toLocaleString('uk'),false]],0xfbbf24);
addNotif(`üìã ${ME.name} –∑–¥–∞–≤ —ñ—Å–ø–∏—Ç "${test.name}" ‚Äî –æ—á—ñ–∫—É—î –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏`)
}
quizState=null;showResult(result.id)
}

/* ========== RESULT ========== */
function showResult(id){
go('result');const r=results.find(x=>x.id===id);if(!r)return;
const isPassed=r.status==='passed';const isFailed=r.status==='failed';const isPending=r.status==='pending';
const circleClass=isPassed?'pass':isFailed?'fail':'pass';
const scoreColor=isPassed?'var(--p)':isFailed?'var(--r)':'var(--w)';
const statusText=isPassed?'‚úÖ –°–ö–õ–ê–î–ï–ù–û':isFailed?'‚ùå –ù–ï –°–ö–õ–ê–î–ï–ù–û':'‚è≥ –ù–ê –ü–ï–†–ï–í–Ü–†–¶–Ü';
const msg=isPassed?'–í—ñ—Ç–∞—î–º–æ! –í–∏ —É—Å–ø—ñ—à–Ω–æ —Å–∫–ª–∞–ª–∏ —ñ—Å–ø–∏—Ç!':isFailed?'–ù–∞ –∂–∞–ª—å, –≤–∏ –Ω–µ –Ω–∞–±—Ä–∞–ª–∏ –ø—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª.':'–í–∞—à—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å—Å—è. –û—á—ñ–∫—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.';

let reviewerHtml='';
if(r.reviewer&&r.reviewer.trim()){reviewerHtml=`<div class="reviewer-info">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤: <b>${r.reviewer}</b></div>`}

const detailsHtml=r.details?r.details.map((d,i)=>{
const icon=d.correct?'‚úÖ':d.hasFree?'‚úç':'‚ùå';
const color=d.correct?'var(--p)':d.hasFree?'var(--w)':'var(--r)';
return`<div class="detail-item"><div class="d-q">${i+1}. ${d.question}</div>
<div class="d-a" style="color:${color}">${icon} ${d.userAnswer||'‚Äî'}</div>
${d.correctAnswer&&!d.hasFree?`<div class="d-a" style="color:var(--tg);font-size:11px">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${d.correctAnswer}</div>`:''}
</div>`}).join(''):'';

// Can retry only if not pending
const retryBtn=!isPending?`<button class="btn-g" onclick="startIntro('${r.testId}')">üîÑ –ü—Ä–æ–π—Ç–∏ –∑–Ω–æ–≤—É</button>`:`<button class="btn-g" style="opacity:0.4;cursor:not-allowed" onclick="showError('‚è≥ –ó–∞—á–µ–∫–∞–π—Ç–µ','–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —ñ—Å–ø–∏—Ç —â–µ –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ')">üîÑ –ü—Ä–æ–π—Ç–∏ –∑–Ω–æ–≤—É</button>`;

$('resultBox').innerHTML=`
<div class="result-circle ${circleClass}"><span class="score" style="color:${scoreColor}">${r.score}</span><span class="of">–∑ ${r.maxScore}</span></div>
<div class="result-status" style="color:${scoreColor}">${statusText}</div>
<div class="result-msg">${msg}</div>
${reviewerHtml}
<div class="detail-list">${detailsHtml}</div>
<div class="btn-row">${retryBtn}<button class="btn-o" onclick="go('home')">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</button></div>`
}
window.viewResult=id=>{showResult(id)};

/* ========== CREATE / EDIT ========== */
let createQuestions=[];

function renderCreateForm(existingTest){
if(existingTest){
editingTestId=existingTest.id;
$('createTitle').innerHTML='‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–µ—Å—Ç—É';
createQuestions=JSON.parse(JSON.stringify(existingTest.questions||[]));
}else{createQuestions=[];editingTestId=null}

const t=existingTest||{name:'',desc:'',category:'',emoji:'üìù',maxScore:12,passScore:8};

$('createForm').innerHTML=`
<div class="fg"><label>–ù–∞–∑–≤–∞ —Ç–µ—Å—Ç—É</label><input class="fi" id="cName" value="${t.name}"></div>
<div class="fg"><label>–û–ø–∏—Å</label><textarea class="fi" id="cDesc" rows="2">${t.desc||''}</textarea></div>
<div class="fi-row" style="gap:15px;margin-bottom:20px">
<div class="fg" style="flex:1"><label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label><input class="fi" id="cCat" value="${t.category||''}"></div>
<div class="fg" style="width:80px"><label>–ï–º–æ–¥–∑—ñ</label><input class="fi" id="cEmoji" value="${t.emoji||'üìù'}" maxlength="4"></div>
</div>
<div class="fi-row" style="gap:15px;margin-bottom:20px">
<div class="fg" style="flex:1"><label>–ú–∞–∫—Å. –±–∞–ª—ñ–≤</label><input class="fi" type="number" id="cMaxScore" value="${t.maxScore||12}" min="1" oninput="updateAutoPoints()"></div>
<div class="fg" style="flex:1"><label>–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª</label><input class="fi" type="number" id="cPassScore" value="${t.passScore||8}" min="1"></div>
</div>
<div id="autoPointsInfo" style="margin-bottom:20px;padding:12px;background:rgba(0,255,68,0.05);border:1px solid var(--gb);border-radius:10px;font-size:12px;color:var(--pb)"></div>
<div id="questionsContainer"></div>
<button class="btn-add-sm" onclick="addQuestion()" style="width:100%;padding:15px;margin:15px 0">+ –î–û–î–ê–¢–ò –ü–ò–¢–ê–ù–ù–Ø</button>
<button class="btn-start" onclick="saveTest()" style="width:100%">${editingTestId?'üíæ –ó–ë–ï–†–ï–ì–¢–ò –ó–ú–Ü–ù–ò':'üíæ –°–¢–í–û–†–ò–¢–ò –¢–ï–°–¢'}</button>`;
renderAllQuestions();updateAutoPoints()
}

function renderAllQuestions(){
const c=$('questionsContainer');if(!c)return;
c.innerHTML=createQuestions.map((q,qi)=>{
const optsHtml=(q.options||[]).map((o,oi)=>`
<div class="opt-row">
<div class="radio ${o.correct?'active':''}" onclick="setCorrect(${qi},${oi})"></div>
<input class="fi" style="flex:1" value="${o.text}" oninput="updateOptText(${qi},${oi},this.value)" placeholder="–í–∞—Ä—ñ–∞–Ω—Ç ${letters[oi]||oi+1}">
<button class="btn-remove" onclick="removeOpt(${qi},${oi})">‚úï</button>
</div>`).join('');
return`<div class="q-block" id="qBlock${qi}">
<div class="q-head"><span>–ü–∏—Ç–∞–Ω–Ω—è ${qi+1}</span><button class="btn-remove" onclick="removeQuestion(${qi})">üóë</button></div>
<div class="fg"><textarea class="fi" rows="2" oninput="updateQText(${qi},this.value)" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Ç–∞–Ω–Ω—è...">${q.text||''}</textarea></div>
<div>${optsHtml}</div>
<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
<button class="btn-add-sm" onclick="addOpt(${qi})">+ –í–∞—Ä—ñ–∞–Ω—Ç</button>
</div>
<div class="chk-row"><input type="checkbox" class="chk" ${q.allowFree?'checked':''} onchange="toggleFree(${qi},this.checked)"><label style="font-size:12px;color:var(--tg)">–î–æ–∑–≤–æ–ª–∏—Ç–∏ –≤—ñ–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å</label></div>
</div>`}).join('');
updateAutoPoints()
}

window.addQuestion=()=>{createQuestions.push({text:'',options:[{text:'',correct:true},{text:'',correct:false},{text:'',correct:false},{text:'',correct:false}],allowFree:false});renderAllQuestions();
const el=$('qBlock'+(createQuestions.length-1));if(el)el.scrollIntoView({behavior:'smooth',block:'center'})};
window.removeQuestion=i=>{createQuestions.splice(i,1);renderAllQuestions()};
window.updateQText=(i,v)=>{createQuestions[i].text=v};
window.addOpt=qi=>{createQuestions[qi].options.push({text:'',correct:false});renderAllQuestions()};
window.removeOpt=(qi,oi)=>{createQuestions[qi].options.splice(oi,1);renderAllQuestions()};
window.updateOptText=(qi,oi,v)=>{createQuestions[qi].options[oi].text=v};
window.setCorrect=(qi,oi)=>{createQuestions[qi].options.forEach((o,i)=>o.correct=i===oi);renderAllQuestions()};
window.toggleFree=(qi,v)=>{createQuestions[qi].allowFree=v};

function updateAutoPoints(){
const max=parseInt($('cMaxScore')?.value||12);
const n=createQuestions.length;
const info=$('autoPointsInfo');
if(!info)return;
if(n>0){const perQ=Math.round(max/n*100)/100;info.innerHTML=`üìä –ê–≤—Ç–æ-—Ä–æ–∑–ø–æ–¥—ñ–ª: <b>${max}</b> –±–∞–ª—ñ–≤ √∑ <b>${n}</b> –ø–∏—Ç–∞–Ω—å = <b>${perQ}</b> –±–∞–ª(—ñ–≤) –∑–∞ –ø–∏—Ç–∞–Ω–Ω—è`}
else info.innerHTML='üìä –î–æ–¥–∞–π—Ç–µ –ø–∏—Ç–∞–Ω–Ω—è –¥–ª—è –∞–≤—Ç–æ-—Ä–æ–∑–ø–æ–¥—ñ–ª—É –±–∞–ª—ñ–≤'
}
window.updateAutoPoints=updateAutoPoints;

window.saveTest=()=>{
const name=$('cName').value.trim();
const desc=$('cDesc').value.trim();
const cat=$('cCat').value.trim();
const emoji=$('cEmoji').value.trim()||'üìù';
const maxScore=parseInt($('cMaxScore').value)||12;
const passScore=parseInt($('cPassScore').value)||8;

if(!name){showError('‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞','–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–µ—Å—Ç—É');return}
if(passScore>maxScore){showError('‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞','–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –±—ñ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ');return}
if(!createQuestions.length){showError('‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞','–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è');return}

for(let i=0;i<createQuestions.length;i++){
const q=createQuestions[i];
if(!q.text||!q.text.trim()){
const el=$('qBlock'+i);if(el){el.classList.add('error');el.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>el.classList.remove('error'),2000)}
showError('‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞',`–ü–∏—Ç–∞–Ω–Ω—è ${i+1} –Ω–µ –º–∞—î —Ç–µ–∫—Å—Ç—É`);return}
if(q.options&&q.options.length){
for(let j=0;j<q.options.length;j++){
if(!q.options[j].text.trim()){
const el=$('qBlock'+i);if(el){el.classList.add('error');el.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>el.classList.remove('error'),2000)}
showError('‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞',`–í–∞—Ä—ñ–∞–Ω—Ç ${letters[j]} —É –ø–∏—Ç–∞–Ω–Ω—ñ ${i+1} –ø–æ—Ä–æ–∂–Ω—ñ–π`);return}}}}

if(editingTestId){
const idx=tests.findIndex(t=>t.id===editingTestId);
if(idx>=0){tests[idx]={...tests[idx],name,desc,category:cat,emoji,maxScore,passScore,questions:JSON.parse(JSON.stringify(createQuestions))}}
}else{
tests.push({id:Date.now().toString(),name,desc,category:cat,emoji,maxScore,passScore,questions:JSON.parse(JSON.stringify(createQuestions))})
}
save();addNotif(`üìù –¢–µ—Å—Ç "${name}" ${editingTestId?'–æ–Ω–æ–≤–ª–µ–Ω–æ':'—Å—Ç–≤–æ—Ä–µ–Ω–æ'}`);go('home')
};

/* ========== REVIEW ========== */
window.go_review=()=>{go('review');renderReview()};

function renderReview(){
const canReview=ME.role==='admin'||settings.reviewers.some(r=>r.name===ME.name);
if(!canReview){$('reviewContent').innerHTML='<div class="empty-state"><span class="emoji">üîí</span><p>–£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É</p></div>';return}
const pending=results.filter(r=>r.status==='pending'&&r.hasFree);
if(!pending.length){$('reviewContent').innerHTML='<div class="empty-state"><span class="emoji">‚úÖ</span><p>–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</p></div>';return}

$('reviewContent').innerHTML=pending.map(r=>{
const freeDetails=r.details.filter(d=>d.hasFree&&d.freeText);
return`<div class="review-card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<div><b style="color:var(--pb)">${r.userName}</b><span style="color:var(--tg);font-size:12px;margin-left:10px">${r.testName}</span></div>
<span style="font-size:12px;color:var(--tg)">${new Date(r.date).toLocaleString('uk')}</span>
</div>
<div style="margin-bottom:10px;font-size:13px">–ê–≤—Ç–æ-–±–∞–ª–∏: <b>${r.score}/${r.maxScore}</b> | –ü—Ä–æ—Ö—ñ–¥–Ω–∏–π: <b>${r.passScore}</b></div>
${freeDetails.map((d,i)=>`<div class="review-q">${d.question}</div><div class="review-a">${d.freeText}</div>`).join('')}
<div style="margin-top:10px">
<label style="font-size:11px;color:var(--tg);display:block;margin-bottom:5px">–§–Ü–ù–ê–õ–¨–ù–ò–ô –ë–ê–õ:</label>
<input type="number" class="fi" id="reviewScore_${r.id}" value="${r.score}" min="0" max="${r.maxScore}" style="width:120px;display:inline-block">
<span style="color:var(--tg);font-size:12px;margin-left:5px">/ ${r.maxScore}</span>
</div>
<div style="display:flex;gap:10px;margin-top:15px">
<button class="btn-g" onclick="approveResult('${r.id}')">‚úÖ –°—Ö–≤–∞–ª–∏—Ç–∏</button>
<button class="btn-r" onclick="rejectResult('${r.id}')">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
</div></div>`}).join('')
}

window.approveResult=id=>{
const r=results.find(x=>x.id===id);if(!r)return;
const scoreEl=$('reviewScore_'+id);
const finalScore=scoreEl?parseFloat(scoreEl.value):r.score;
r.score=finalScore;
r.status=finalScore>=r.passScore?'passed':'failed';
r.reviewer=ME.name;save();
sendWebhook(`${r.status==='passed'?'‚úÖ –°—Ö–≤–∞–ª–µ–Ω–æ':'‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ'} ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç —ñ—Å–ø–∏—Ç—É`,[['üë§ –ë–æ—î—Ü—å',r.userName,true],['üìù –¢–µ—Å—Ç',r.testName,true],['üìä –ë–∞–ª–∏',`${r.score} / ${r.maxScore}`,true],['‚úÖ –ü—Ä–æ—Ö—ñ–¥–Ω–∏–π',`${r.passScore}`,true],['üìã –°—Ç–∞—Ç—É—Å',r.status==='passed'?'–°–ö–õ–ê–î–ï–ù–û':'–ù–ï –°–ö–õ–ê–î–ï–ù–û',true],['üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤',ME.name,true],['üìÖ –î–∞—Ç–∞',new Date().toLocaleString('uk'),false]],r.status==='passed'?0x00ff44:0xef4444);
addNotif(`${r.status==='passed'?'‚úÖ':'‚ùå'} ${r.userName}: "${r.testName}" ‚Äî ${r.status==='passed'?'—Å—Ö–≤–∞–ª–µ–Ω–æ':'–≤—ñ–¥—Ö–∏–ª–µ–Ω–æ'} (${ME.name})`);
renderReview();renderHome()
};
window.rejectResult=id=>{
const r=results.find(x=>x.id===id);if(!r)return;
r.status='failed';r.score=0;r.reviewer=ME.name;save();
sendWebhook('‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç —ñ—Å–ø–∏—Ç—É',[['üë§ –ë–æ—î—Ü—å',r.userName,true],['üìù –¢–µ—Å—Ç',r.testName,true],['üìä –ë–∞–ª–∏','0 / '+r.maxScore,true],['üìã –°—Ç–∞—Ç—É—Å','–í–Ü–î–•–ò–õ–ï–ù–û',true],['üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤',ME.name,true],['üìÖ –î–∞—Ç–∞',new Date().toLocaleString('uk'),false]],0xef4444);
addNotif(`‚ùå ${r.userName}: "${r.testName}" ‚Äî –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ (${ME.name})`);
renderReview();renderHome()
};

/* ========== MANAGE ========== */
function renderManage(){
if(ME.role!=='admin'){$('manageContent').innerHTML='<div class="empty-state"><span class="emoji">üîí</span><p>–¢—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤</p></div>';return}

let html=`<div class="stats-row" style="margin-bottom:25px">
<div class="stat-card"><div class="num">${tests.length}</div><div class="lbl">–¢–µ—Å—Ç—ñ–≤</div></div>
<div class="stat-card"><div class="num">${results.length}</div><div class="lbl">–†–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</div></div>
<div class="stat-card"><div class="num">${results.filter(r=>r.status==='pending').length}</div><div class="lbl">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</div></div>
</div>`;

if(tests.length){
html+=`<table class="manage-table"><thead><tr><th>–¢–µ—Å—Ç</th><th>–ü–∏—Ç–∞–Ω—å</th><th>–ë–∞–ª—ñ–≤</th><th>–î—ñ—ó</th></tr></thead><tbody>`;
tests.forEach(t=>{
html+=`<tr><td><b>${t.emoji} ${t.name}</b></td><td>${t.questions.length}</td><td>${t.maxScore}</td>
<td><div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn-g" style="padding:8px 14px;font-size:11px" onclick="editTest('${t.id}')">‚úèÔ∏è</button>
<button class="btn-r" style="padding:8px 14px;font-size:11px" onclick="deleteTest('${t.id}')">üóë</button>
</div></td></tr>`});
html+=`</tbody></table>`}else{html+=`<div class="empty-state"><span class="emoji">üì≠</span><p>–¢–µ—Å—Ç—ñ–≤ –Ω–µ–º–∞—î</p></div>`}

if(results.length){
html+=`<div class="section-title" style="margin-top:30px">üìä –í—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏</div>`;
html+=`<button class="btn-r" onclick="clearAllResults()" style="margin-bottom:15px">üóë –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏</button>`;
html+=`<table class="manage-table"><thead><tr><th>–ë–æ—î—Ü—å</th><th>–¢–µ—Å—Ç</th><th>–ë–∞–ª–∏</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü–µ—Ä–µ–≤—ñ—Ä–∏–≤</th><th>–î–∞—Ç–∞</th></tr></thead><tbody>`;
results.forEach(r=>{
const st=r.status==='passed'?'<span style="color:var(--p)">–°–∫–ª–∞–¥–µ–Ω–æ</span>':r.status==='failed'?'<span style="color:var(--r)">–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ</span>':'<span style="color:var(--w)">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞</span>';
html+=`<tr><td>${r.userName}</td><td>${r.testName}</td><td>${r.score}/${r.maxScore}</td><td>${st}</td><td>${r.reviewer||'‚Äî'}</td><td>${new Date(r.date).toLocaleDateString('uk')}</td></tr>`});
html+=`</tbody></table>`}

$('manageContent').innerHTML=html
}

window.editTest=id=>{const t=tests.find(x=>x.id===id);if(!t)return;go('create');renderCreateForm(t)};
window.deleteTest=id=>{if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ç–µ—Å—Ç?'))return;tests=tests.filter(t=>t.id!==id);save();renderManage()};
window.clearAllResults=()=>{if(!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –í–°–Ü —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏?'))return;results=[];save();renderManage()};

/* ========== SETTINGS ========== */
function renderSettings(){
if(ME.role!=='admin'){$('settingsContent').innerHTML='<div class="empty-state"><span class="emoji">üîí</span><p>–¢—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤</p></div>';return}

const reviewersHtml=settings.reviewers.map((r,i)=>`<span class="reviewer-tag">${r.name} <button class="btn-remove" onclick="removeReviewer(${i})" style="font-size:12px">‚úï</button></span>`).join('')||'<span style="color:var(--tg);font-size:12px">–ù–µ –¥–æ–¥–∞–Ω–æ</span>';

const userListHtml=allUsers.filter(u=>!settings.reviewers.some(r=>r.uid===u.uid)).map(u=>{
const roleBadge=u.role==='admin'?'–ê–î–ú–Ü–ù':u.role==='instructor'?'–Ü–ù–°–¢–†':'–ë–Ü–Ñ–¶–¨';
const roleColor=u.role==='admin'?'var(--p)':u.role==='instructor'?'var(--w)':'var(--tg)';
return`<div class="user-pick-item" onclick="addReviewer('${u.uid}','${u.name}')">
<span>${u.name}</span><span style="font-size:10px;color:${roleColor};font-weight:800">${roleBadge}</span></div>`}).join('')||'<div style="padding:15px;text-align:center;color:var(--tg);font-size:12px">–í—Å—ñ –¥–æ–¥–∞–Ω—ñ</div>';

$('settingsContent').innerHTML=`
<div class="fg"><label>üîó Discord Webhook URL</label><input class="fi" id="sWebhook" value="${settings.webhook||''}" placeholder="https://discord.com/api/webhooks/..."></div>
<button class="btn-g" onclick="saveWebhook()" style="margin-bottom:25px;width:100%">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ Webhook</button>
<div class="fg"><label>üë• –ü–µ—Ä–µ–≤—ñ—Ä—é–≤–∞—á—ñ</label><div style="margin:8px 0">${reviewersHtml}</div></div>
<div class="fg"><label>–î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä—é–≤–∞—á–∞ –∑—ñ —Å–ø–∏—Å–∫—É:</label>
<input class="fi" id="searchUser" placeholder="üîç –ü–æ—à—É–∫..." oninput="filterUsers()">
<div class="user-pick-list" id="userPickList">${userListHtml}</div></div>`
}

window.saveWebhook=()=>{settings.webhook=$('sWebhook').value.trim();save();addNotif('üîó Webhook –æ–Ω–æ–≤–ª–µ–Ω–æ')};
window.addReviewer=(uid,name)=>{if(!settings.reviewers.some(r=>r.uid===uid)){settings.reviewers.push({uid,name});save();renderSettings()}};
window.removeReviewer=i=>{settings.reviewers.splice(i,1);save();renderSettings()};
window.filterUsers=()=>{
const q=$('searchUser').value.toLowerCase();
const items=document.querySelectorAll('#userPickList .user-pick-item');
items.forEach(el=>{el.style.display=el.textContent.toLowerCase().includes(q)?'':'none'})
};

/* ========== INIT ========== */
document.querySelectorAll('.view').forEach(v=>{if(v.id==='v-home')v.classList.add('active');else v.classList.remove('active')});

// Listen for view changes to render review
const origGo=window.go;
window.go=v=>{origGo(v);if(v==='review')renderReview()};
</script>
</body>
</html>
