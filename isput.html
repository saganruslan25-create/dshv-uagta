<style>
/* üéØ –ö–û–ù–¢–ï–ö–°–¢–ù–ï –ú–ï–ù–Æ –î–õ–Ø –Ü–°–ü–ò–¢–Ü–í */
.context-menu {
    position: fixed;
    background: rgba(10,15,25,0.98);
    border: 1px solid var(--glass-border);
    border-radius: 14px;
    padding: 8px;
    min-width: 220px;
    z-index: 9999;
    backdrop-filter: blur(20px);
    box-shadow: 0 10px 50px rgba(0,0,0,0.8), 0 0 30px rgba(0,255,68,0.15);
    display: none;
    animation: slideDown 0.2s ease;
}

.context-menu.active {
    display: block;
}

.context-menu-item {
    padding: 12px 16px;
    cursor: pointer;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s ease;
    color: var(--text-light);
}

.context-menu-item:hover {
    background: rgba(0,255,68,0.08);
    color: var(--primary-bright);
    transform: translateX(3px);
}

.context-menu-item .icon {
    font-size: 16px;
    width: 20px;
    text-align: center;
}

.context-menu-divider {
    height: 1px;
    background: rgba(255,255,255,0.08);
    margin: 6px 0;
}

.context-menu-item.danger:hover {
    background: rgba(239,68,68,0.15);
    color: var(--danger);
}

.context-menu-item.warning:hover {
    background: rgba(251,191,36,0.15);
    color: var(--warning);
}

.context-menu-item.info:hover {
    background: rgba(59,130,246,0.15);
    color: var(--info);
}

/* üìä –Ü–°–¢–û–†–Ü–Ø –¢–ï–°–¢–Ü–í */
.history-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.92);
    z-index: 8000;
    display: none;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(10px);
    padding: 20px;
}

.history-modal.active {
    display: flex;
}

.history-content {
    background: var(--card-bg);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    width: 100%;
    max-width: 1100px;
    max-height: 85vh;
    overflow-y: auto;
    padding: 35px;
    position: relative;
    backdrop-filter: blur(20px);
    box-shadow: 0 20px 80px rgba(0,0,0,0.9);
}

.history-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(239,68,68,0.15);
    border: 1px solid var(--danger);
    color: var(--danger);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 20px;
    font-weight: 900;
    transition: 0.3s;
}

.history-close:hover {
    background: var(--danger);
    color: white;
    transform: rotate(90deg);
}

.history-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.history-search {
    flex: 1;
    min-width: 200px;
}

.history-export-btn {
    background: rgba(59,130,246,0.1);
    border: 1px solid var(--info);
    color: var(--info);
    padding: 10px 18px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
    font-size: 12px;
    transition: 0.3s;
    white-space: nowrap;
}

.history-export-btn:hover {
    background: var(--info);
    color: white;
    transform: translateY(-2px);
}

/* üé® –†–£–ß–ù–Ü –ë–ê–õ–ò –í –ü–ï–†–ï–í–Ü–†–¶–Ü */
.manual-points-control {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    padding: 10px;
    background: rgba(0,255,68,0.05);
    border: 1px solid rgba(0,255,68,0.15);
    border-radius: 10px;
}

.points-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: 1px solid;
    background: none;
    cursor: pointer;
    font-size: 18px;
    font-weight: 900;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
}

.points-btn.minus {
    border-color: var(--danger);
    color: var(--danger);
}

.points-btn.minus:hover {
    background: var(--danger);
    color: white;
}

.points-btn.plus {
    border-color: var(--primary);
    color: var(--primary);
}

.points-btn.plus:hover {
    background: var(--primary);
    color: black;
}

.points-display {
    flex: 1;
    text-align: center;
    font-weight: 800;
    font-size: 15px;
    color: var(--primary);
}

.points-input {
    width: 70px;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(0,255,68,0.3);
    color: var(--primary);
    padding: 6px;
    border-radius: 8px;
    text-align: center;
    font-size: 14px;
    font-weight: 800;
    outline: none;
}

.points-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 10px rgba(0,255,68,0.2);
}
</style>
<!-- üéØ –ö–û–ù–¢–ï–ö–°–¢–ù–ï –ú–ï–ù–Æ -->
<div id="contextMenu" class="context-menu">
    <div class="context-menu-item info" onclick="contextAction('edit')">
        <span class="icon">‚úèÔ∏è</span>
        <span>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</span>
    </div>
    <div class="context-menu-item" onclick="contextAction('copy')">
        <span class="icon">üîó</span>
        <span>–ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item warning" onclick="contextAction('clear')">
        <span class="icon">üßπ</span>
        <span>–û—á–∏—Å—Ç–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏</span>
    </div>
    <div class="context-menu-item danger" onclick="contextAction('delete')">
        <span class="icon">üóë</span>
        <span>–í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å–ø–∏—Ç</span>
    </div>
</div>

<!-- üìä –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –Ü–°–¢–û–†–Ü–á -->
<div id="historyModal" class="history-modal" onclick="closeHistory(event)">
    <div class="history-content" onclick="event.stopPropagation()">
        <button class="history-close" onclick="closeHistory()">&times;</button>
        <h2 style="font-size:22px;font-weight:900;margin-bottom:20px;color:var(--primary-bright)">
            üìä –ü–æ–≤–Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—è —Ç–µ—Å—Ç—ñ–≤
        </h2>
        
        <div class="history-filters">
            <input class="form-input history-search" id="historySearch" 
                   placeholder="üîç –ü–æ—à—É–∫ –ø–æ —ñ–º–µ–Ω—ñ, —ñ—Å–ø–∏—Ç—É..." 
                   oninput="filterHistory()">
            
            <select class="form-input" id="historyStatusFilter" 
                    onchange="filterHistory()" 
                    style="width:auto;min-width:150px">
                <option value="all">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
                <option value="approved">‚úÖ –°—Ö–≤–∞–ª–µ–Ω–æ</option>
                <option value="rejected">‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ</option>
                <option value="pending">‚è≥ –ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</option>
                <option value="auto">ü§ñ –ê–≤—Ç–æ</option>
            </select>
            
            <button class="history-export-btn" onclick="exportHistory()">
                üì• –ï–∫—Å–ø–æ—Ä—Ç CSV
            </button>
        </div>

        <div class="results-table" id="historyTableContainer">
            <!-- –¢–∞–±–ª–∏—Ü—è –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è JS -->
        </div>
        
        <div style="margin-top:20px;padding:15px;background:rgba(0,255,68,0.05);border:1px solid rgba(0,255,68,0.15);border-radius:12px">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;text-align:center">
                <div>
                    <div style="font-size:24px;font-weight:900;color:var(--primary)" id="historyTotal">0</div>
                    <div style="font-size:10px;color:var(--text-gray);margin-top:4px">–í–°–¨–û–ì–û</div>
                </div>
                <div>
                    <div style="font-size:24px;font-weight:900;color:var(--success)" id="historyPassed">0</div>
                    <div style="font-size:10px;color:var(--text-gray);margin-top:4px">–°–•–í–ê–õ–ï–ù–û</div>
                </div>
                <div>
                    <div style="font-size:24px;font-weight:900;color:var(--danger)" id="historyFailed">0</div>
                    <div style="font-size:10px;color:var(--text-gray);margin-top:4px">–í–Ü–î–•–ò–õ–ï–ù–û</div>
                </div>
                <div>
                    <div style="font-size:24px;font-weight:900;color:var(--warning)" id="historyPending">0</div>
                    <div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ù–ê –ü–ï–†–ï–í–Ü–†–¶–Ü</div>
                </div>
            </div>
        </div>
    </div>
</div>
// ============================================
// üéØ –ö–û–ù–¢–ï–ö–°–¢–ù–ï –ú–ï–ù–Æ –î–õ–Ø –Ü–°–ü–ò–¢–Ü–í
// ============================================
let contextMenuTestId = null;

window.showContextMenu = (e, testId) => {
    e.preventDefault();
    e.stopPropagation();
    
    if (!isAdmin()) return;
    
    contextMenuTestId = testId;
    const menu = document.getElementById('contextMenu');
    
    // –ü–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
    menu.classList.add('active');
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–µ–∂ –µ–∫—Ä–∞–Ω—É
    setTimeout(() => {
        const rect = menu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
            menu.style.left = (e.pageX - rect.width) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
            menu.style.top = (e.pageY - rect.height) + 'px';
        }
    }, 10);
};

window.contextAction = async (action) => {
    const menu = document.getElementById('contextMenu');
    menu.classList.remove('active');
    
    if (!contextMenuTestId) return;
    
    const t = tests.find(x => x.id === contextMenuTestId);
    if (!t) return;
    
    switch(action) {
        case 'edit':
            editTest(contextMenuTestId);
            break;
            
        case 'copy':
            const link = `${window.location.origin}/public-test.html?id=${contextMenuTestId}`;
            try {
                await navigator.clipboard.writeText(link);
                showNotification('üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!', 'success');
            } catch(e) {
                prompt('üìã –°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è:', link);
            }
            break;
            
        case 'clear':
            if (confirm(`üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —ñ—Å–ø–∏—Ç—É "${t.name}"?`)) {
                clearTestResults(contextMenuTestId);
            }
            break;
            
        case 'delete':
            if (confirm(`üóë –í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å–ø–∏—Ç "${t.name}"?\n\n‚ö†Ô∏è –¶–µ —Ç–∞–∫–æ–∂ –≤–∏–¥–∞–ª–∏—Ç—å –≤—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏!`)) {
                deleteTest(contextMenuTestId);
            }
            break;
    }
    
    contextMenuTestId = null;
};

// –ó–∞–∫—Ä–∏—Ç—Ç—è –º–µ–Ω—é –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
document.addEventListener('click', (e) => {
    if (!e.target.closest('.context-menu')) {
        document.getElementById('contextMenu').classList.remove('active');
    }
});

// –ó–∞–∫—Ä–∏—Ç—Ç—è –ø—Ä–∏ —Å–∫—Ä–æ–ª—ñ
document.addEventListener('scroll', () => {
    document.getElementById('contextMenu').classList.remove('active');
});

// üîî –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è
function showNotification(text, type = 'info') {
    const colors = {
        success: 'var(--primary)',
        error: 'var(--danger)',
        warning: 'var(--warning)',
        info: 'var(--info)'
    };
    
    const notif = document.createElement('div');
    notif.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--card-bg);
        border: 2px solid ${colors[type]};
        color: white;
        padding: 16px 24px;
        border-radius: 14px;
        font-weight: 700;
        font-size: 13px;
        z-index: 10000;
        backdrop-filter: blur(20px);
        box-shadow: 0 10px 40px rgba(0,0,0,0.8), 0 0 30px ${colors[type]}33;
        animation: slideDown 0.3s ease;
    `;
    notif.textContent = text;
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.style.animation = 'fadeIn 0.3s ease reverse';
        setTimeout(() => notif.remove(), 300);
    }, 3000);
}
function renderHome() {
    const myRes = results.filter(r => r.userId === ME.uid);
    const passed = myRes.filter(r => {
        const t = tests.find(x => x.id === r.testId);
        return r.status === 'approved' || (r.status === 'auto' && t && r.score >= t.passScore);
    }).length;
    
    const failed = myRes.filter(r => {
        const t = tests.find(x => x.id === r.testId);
        return r.status === 'rejected' || (r.status === 'auto' && t && r.score < t.passScore);
    }).length;
    
    const pending = myRes.filter(r => r.status === 'pending').length;
    
    document.getElementById('statsRow').innerHTML = `
        <div class="stat-card">
            <div class="stat-num">${tests.length}</div>
            <div class="stat-label">–Ü—Å–ø–∏—Ç—ñ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" style="color:var(--success)">${passed}</div>
            <div class="stat-label">–°–∫–ª–∞–¥–µ–Ω–æ</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" style="color:var(--danger)">${failed}</div>
            <div class="stat-label">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" style="color:var(--warning)">${pending}</div>
            <div class="stat-label">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</div>
        </div>
    `;
    
    if (tests.length === 0) {
        document.getElementById('testsGrid').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px;width:100%">–Ü—Å–ø–∏—Ç—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>';
    } else {
        document.getElementById('testsGrid').innerHTML = tests.map(t => {
            const pps = t.maxScore > 0 ? Math.round(t.maxScore / t.questions.length * 10) / 10 : 0;
            let totalTime = 0;
            t.questions.forEach(q => {totalTime += (q.timeLimit || 30)});
            
            // üÜï –î–æ–¥–∞—î–º–æ oncontextmenu –¥–ª—è –∞–¥–º—ñ–Ω—ñ–≤
            const contextHandler = isAdmin() ? `oncontextmenu="showContextMenu(event, '${t.id}')"` : '';
            
            return `<div class="test-card" 
                         onclick="startIntro('${t.id}')" 
                         ${contextHandler}
                         style="${isAdmin() ? 'cursor:context-menu' : ''}">
                <span class="emoji">${t.emoji || 'üìù'}</span>
                <h3>${t.name}</h3>
                <p>${t.description || '–ë–µ–∑ –æ–ø–∏—Å—É'}</p>
                <div class="test-meta">
                    <span class="meta-tag">‚ùì ${t.questions.length} –ø–∏—Ç–∞–Ω—å</span>
                    <span class="meta-tag">üéØ ${t.passScore}/${t.maxScore} –±.</span>
                    <span class="meta-tag">‚è± ${totalTime}—Å</span>
                </div>
                ${isAdmin() ? '<div style="font-size:9px;color:var(--text-gray);margin-top:10px;text-align:center">–ü–ö–ú –¥–ª—è –æ–ø—Ü—ñ–π</div>' : ''}
            </div>`;
        }).join('');
    }
    
    if (myRes.length === 0) {
        document.getElementById('myResults').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:30px;font-size:13px">–í–∏ —â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —ñ—Å–ø–∏—Ç–∏</div>';
    } else {
        let rows = myRes.map(r => {
            const t = tests.find(x => x.id === r.testId);
            const tname = t ? t.name : '–í–∏–¥–∞–ª–µ–Ω–∏–π';
            const passS = t ? t.passScore : 0;
            let st, stc;
            
            if (r.status === 'pending') {
                st = '–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ';
                stc = 'st-pending';
            } else if (r.status === 'approved') {
                st = '–°—Ö–≤–∞–ª–µ–Ω–æ';
                stc = 'st-approved';
            } else if (r.status === 'rejected') {
                st = '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ';
                stc = 'st-rejected';
            } else {
                const p = r.score >= passS;
                st = p ? '–°–∫–ª–∞–¥–µ–Ω–æ' : '–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ';
                stc = p ? 'st-pass' : 'st-fail';
            }
            
            return `<tr>
                <td>${tname}</td>
                <td><b>${r.score}</b> / ${t ? t.maxScore : '?'}</td>
                <td><span class="status-badge ${stc}">${st}</span></td>
                <td>${r.reviewer || 'SYSTEM'}</td>
                <td>${r.date}</td>
            </tr>`;
        }).join('');
        
        document.getElementById('myResults').innerHTML = `
            <div class="results-table">
                <table>
                    <thead>
                        <tr>
                            <th>–Ü—Å–ø–∏—Ç</th>
                            <th>–ë–∞–ª–∏</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π</th>
                            <th>–î–∞—Ç–∞</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        `;
    }
}
          function renderReview() {
    const pending = results.filter(r => r.status === 'pending' || (r.status === 'auto' && !r.reviewedByHuman));
    
    if (pending.length === 0) {
        document.getElementById('reviewList').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px">–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ ‚úì</div>';
        return;
    }
    
    document.getElementById('reviewList').innerHTML = pending.map(r => {
        const t = tests.find(x => x.id === r.testId);
        
        let questionsHtml = r.details.map((d, i) => {
            let cls = d.status === 'correct' ? 'auto-ok' : d.status === 'pending' ? 'pending' : 'auto-fail';
            
            // üÜï –ü–æ—Ç–æ—á–Ω—ñ –±–∞–ª–∏ –ø–∏—Ç–∞–Ω–Ω—è
            const currentPoints = d.points || 0;
            const maxPps = t ? Math.round(t.maxScore / t.questions.length * 10) / 10 : 1;
            
            let ptsDisplay = '';
            if (d.status === 'correct') {
                ptsDisplay = `<span class="q-points" style="color:var(--primary)">+${Math.round(d.points * 10) / 10} –±.</span>`;
            } else if (d.status === 'wrong') {
                ptsDisplay = `<span class="q-points" style="color:var(--danger)">0 –±.</span>`;
            } else {
                // üÜï –†–£–ß–ù–ï –ö–ï–†–£–í–ê–ù–ù–Ø –ë–ê–õ–ê–ú–ò
                ptsDisplay = `
                    <div class="manual-points-control">
                        <button class="points-btn minus" onclick="adjustPoints('${r.id}', ${i}, -0.5)">‚àí</button>
                        <input type="number" 
                               class="points-input" 
                               id="points-${r.id}-${i}" 
                               value="${currentPoints}" 
                               min="0" 
                               max="${maxPps}"
                               step="0.5"
                               onchange="setPoints('${r.id}', ${i}, this.value)">
                        <button class="points-btn plus" onclick="adjustPoints('${r.id}', ${i}, 0.5)">+</button>
                        <span style="font-size:11px;color:var(--text-gray);margin-left:5px">/ ${maxPps}</span>
                    </div>
                `;
            }
            
            return `<div class="review-q ${cls}">
                <div class="q-title">${i + 1}. ${d.qText}</div>
                <div class="q-answer">–í—ñ–¥–ø–æ–≤—ñ–¥—å: <b>${d.userAnswer}</b></div>
                ${d.status !== 'pending' ? `<div class="q-correct">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${d.correctAnswer}</div>` : ''}
                <div>${ptsDisplay}</div>
            </div>`;
        }).join('');
        
        const hasFreeQ = r.details.some(d => d.status === 'pending');
        
        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –±–∞–ª—É
        const currentScore = r.details.reduce((sum, d) => sum + (d.points || 0), 0);
        
        return `<div class="review-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px">
                <div>
                    <h3 style="font-size:16px;font-weight:800">${r.userName}</h3>
                    <div style="font-size:12px;color:var(--text-gray)">${r.testName || '–Ü—Å–ø–∏—Ç'} ‚Ä¢ ${r.date}</div>
                </div>
                <div style="font-size:18px;font-weight:900;color:var(--primary)" id="totalScore-${r.id}">
                    ${Math.round(currentScore * 10) / 10} / ${r.maxScore} –±.
                </div>
            </div>
            
            ${questionsHtml}
            
            <div style="margin-top:20px;padding:15px;background:rgba(0,255,68,0.05);border:1px solid rgba(0,255,68,0.15);border-radius:12px">
                <div style="font-size:12px;font-weight:700;color:var(--primary);margin-bottom:12px">
                    üìä –ü—ñ–¥—Å—É–º–∫–æ–≤–∏–π –±–∞–ª: <span id="finalScore-${r.id}">${Math.round(currentScore * 10) / 10}</span> / ${r.maxScore}
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="approveResultWithPoints('${r.id}')">‚úÖ –°—Ö–≤–∞–ª–∏—Ç–∏ –∑ –ø–æ—Ç–æ—á–Ω–∏–º–∏ –±–∞–ª–∞–º–∏</button>
                    <button class="btn btn-danger" onclick="rejectResult('${r.id}')">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
                </div>
            </div>
        </div>`;
    }).join('');
}
          // ============================================
// üéØ –†–£–ß–ù–ï –ö–ï–†–£–í–ê–ù–ù–Ø –ë–ê–õ–ê–ú–ò
// ============================================
window.adjustPoints = (resultId, questionIndex, delta) => {
    const r = results.find(x => x.id === resultId);
    if (!r || !r.details[questionIndex]) return;
    
    const t = tests.find(x => x.id === r.testId);
    const maxPps = t ? Math.round(t.maxScore / t.questions.length * 10) / 10 : 10;
    
    const d = r.details[questionIndex];
    let newPoints = (d.points || 0) + delta;
    
    // –û–±–º–µ–∂–µ–Ω–Ω—è
    if (newPoints < 0) newPoints = 0;
    if (newPoints > maxPps) newPoints = maxPps;
    
    d.points = Math.round(newPoints * 10) / 10;
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω–ø—É—Ç—É
    const input = document.getElementById(`points-${resultId}-${questionIndex}`);
    if (input) input.value = d.points;
    
    // –ü–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –±–∞–ª—É
    updateTotalScore(resultId);
    save();
};

window.setPoints = (resultId, questionIndex, value) => {
    const r = results.find(x => x.id === resultId);
    if (!r || !r.details[questionIndex]) return;
    
    const t = tests.find(x => x.id === r.testId);
    const maxPps = t ? Math.round(t.maxScore / t.questions.length * 10) / 10 : 10;
    
    let points = parseFloat(value) || 0;
    if (points < 0) points = 0;
    if (points > maxPps) points = maxPps;
    
    r.details[questionIndex].points = Math.round(points * 10) / 10;
    
    updateTotalScore(resultId);
    save();
};

function updateTotalScore(resultId) {
    const r = results.find(x => x.id === resultId);
    if (!r) return;
    
    const totalScore = r.details.reduce((sum, d) => sum + (d.points || 0), 0);
    const rounded = Math.round(totalScore * 10) / 10;
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    const totalEl = document.getElementById(`totalScore-${resultId}`);
    const finalEl = document.getElementById(`finalScore-${resultId}`);
    
    if (totalEl) totalEl.innerHTML = `${rounded} / ${r.maxScore} –±.`;
    if (finalEl) finalEl.textContent = rounded;
}

window.approveResultWithPoints = async (id) => {
    const r = results.find(x => x.id === id);
    if (!r) return;
    
    const t = tests.find(x => x.id === r.testId);
    
    // –ü–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –±–∞–ª—É –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ä—É—á–Ω–∏—Ö –∑–º—ñ–Ω
    let finalScore = 0;
    r.details.forEach(d => {
        if (d.status === 'pending') {
            d.status = 'correct'; // –í–≤–∞–∂–∞—î–º–æ —Å—Ö–≤–∞–ª–µ–Ω–∏–º
        }
        finalScore += (d.points || 0);
    });
    
    r.score = Math.round(finalScore * 10) / 10;
    r.status = 'approved';
    r.reviewer = ME.name;
    r.reviewedByHuman = true;
    save();
    
    addNotif(`‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç ${r.userName} —Å—Ö–≤–∞–ª–µ–Ω–æ –∑ –±–∞–ª–æ–º ${r.score}/${r.maxScore}`);
    
    // Discord: –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ö–≤–∞–ª–µ–Ω–æ
    await sendDiscordNotification('RESULT_APPROVED', {
        userName: r.userName,
        testName: r.testName,
        finalScore: r.score,
        maxScore: r.maxScore,
        reviewer: ME.name,
        status: 'approved',
        date: now()
    });
    
    renderReview();
};
      function renderSettings() {
    document.getElementById('settingsContent').innerHTML = `
        <div class="setting-block">
            <h4>üîó Discord Webhook</h4>
            <div class="form-row">
                <input class="form-input" id="webhookInput" value="${webhookUrl}" 
                       placeholder="https://discord.com/api/webhooks/...">
            </div>
            <div class="btn-group" style="justify-content:flex-start">
                <button class="btn btn-primary" onclick="saveWebhook()" style="padding:10px 20px;font-size:12px">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button class="btn btn-info" onclick="sendTestWebhook()" style="padding:10px 20px;font-size:12px">üß™ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</button>
            </div>
        </div>

        <div class="setting-block">
            <h4>üîç –ü–µ—Ä–µ–≤—ñ—Ä—é–≤–∞—á—ñ —ñ—Å–ø–∏—Ç—ñ–≤</h4>
            <div id="reviewersList" style="margin-bottom:12px">
                ${reviewers.map(r => `<span class="reviewer-chip">${r}<button onclick="removeReviewer('${r}')">‚úï</button></span>`).join('') || '<span style="color:var(--text-gray);font-size:12px">–ù–µ –¥–æ–¥–∞–Ω–æ</span>'}
            </div>
            <div class="people-dropdown">
                <input class="form-input" id="reviewerSearch" placeholder="–ü–æ—à—É–∫ –ª—é–¥–∏–Ω–∏..." 
                       oninput="filterPeople('reviewer')" onfocus="filterPeople('reviewer')">
                <div class="people-list" id="reviewerDropdown"></div>
            </div>
        </div>

        <!-- üÜï –ö–ù–û–ü–ö–ê –Ü–°–¢–û–†–Ü–á -->
        <div class="setting-block">
            <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞ —ñ—Å—Ç–æ—Ä—ñ—è</h4>
            <p style="font-size:12px;color:var(--text-gray);margin-bottom:15px">–ü–µ—Ä–µ–≥–ª—è–¥ –ø–æ–≤–Ω–æ—ó —ñ—Å—Ç–æ—Ä—ñ—ó –≤—Å—ñ—Ö –ø—Ä–æ–π–¥–µ–Ω–∏—Ö —Ç–µ—Å—Ç—ñ–≤</p>
            <button class="btn btn-info" onclick="openHistory()" style="width:100%">
                üìä –í—ñ–¥–∫—Ä–∏—Ç–∏ –ø–æ–≤–Ω—É —ñ—Å—Ç–æ—Ä—ñ—é —Ç–µ—Å—Ç—ñ–≤
            </button>
        </div>
    `;
}
      // ============================================
// üìä –ü–û–í–ù–ê –Ü–°–¢–û–†–Ü–Ø –¢–ï–°–¢–Ü–í
// ============================================
let historyData = [];
let filteredHistory = [];

window.openHistory = () => {
    historyData = [...results];
    filteredHistory = [...results];
    renderHistoryTable();
    document.getElementById('historyModal').classList.add('active');
    document.body.style.overflow = 'hidden';
};

window.closeHistory = (event) => {
    if (event && event.target.closest('.history-content')) return;
    document.getElementById('historyModal').classList.remove('active');
    document.body.style.overflow = 'auto';
};

window.filterHistory = () => {
    const searchText = document.getElementById('historySearch').value.toLowerCase();
    const statusFilter = document.getElementById('historyStatusFilter').value;
    
    filteredHistory = historyData.filter(r => {
        const matchSearch = r.userName.toLowerCase().includes(searchText) || 
                           r.testName.toLowerCase().includes(searchText);
        
        const matchStatus = statusFilter === 'all' || r.status === statusFilter;
        
        return matchSearch && matchStatus;
    });
    
    renderHistoryTable();
};

function renderHistoryTable() {
    const container = document.getElementById('historyTableContainer');
    
    if (filteredHistory.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-gray);font-size:14px">üì≠ –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
        updateHistoryStats();
        return;
    }
    
    const rows = filteredHistory.map(r => {
        const t = tests.find(x => x.id === r.testId);
        const tname = t ? t.name : '–í–∏–¥–∞–ª–µ–Ω–∏–π';
        const passS = t ? t.passScore : 0;
        
        let st, stc;
        if (r.status === 'pending') {
            st = '‚è≥ –ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ';
            stc = 'st-pending';
        } else if (r.status === 'approved') {
            st = '‚úÖ –°—Ö–≤–∞–ª–µ–Ω–æ';
            stc = 'st-approved';
        } else if (r.status === 'rejected') {
            st = '‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ';
            stc = 'st-rejected';
        } else {
            const p = r.score >= passS;
            st = p ? '‚úÖ –°–∫–ª–∞–¥–µ–Ω–æ' : '‚ùå –ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ';
            stc = p ? 'st-pass' : 'st-fail';
        }
        
        const percentage = r.maxScore > 0 ? Math.round((r.score / r.maxScore) * 100) : 0;
        const correctCount = r.details.filter(d => d.status === 'correct').length;
        const totalQuestions = r.details.length;
        
        return `<tr onclick="showResultDetail('${r.id}')" style="cursor:pointer">
            <td><b>${r.userName}</b></td>
            <td>${tname}</td>
            <td><b style="color:var(--primary)">${r.score}</b> / ${r.maxScore}</td>
            <td>${percentage}%</td>
            <td>${correctCount} / ${totalQuestions}</td>
            <td><span class="status-badge ${stc}">${st}</span></td>
            <td style="font-size:11px">${r.reviewer || 'SYSTEM'}</td>
            <td style="font-size:11px">${r.date}</td>
        </tr>`;
    }).join('');
    
    container.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                    <th>üìã –Ü—Å–ø–∏—Ç</th>
                    <th>üéØ –ë–∞–ª–∏</th>
                    <th>üìà %</th>
                    <th>‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö</th>
                    <th>üìä –°—Ç–∞—Ç—É—Å</th>
                    <th>üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤</th>
                    <th>üìÖ –î–∞—Ç–∞</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
    
    updateHistoryStats();
}

function updateHistoryStats() {
    const total = filteredHistory.length;
    const approved = filteredHistory.filter(r => r.status === 'approved').length;
    const rejected = filteredHistory.filter(r => r.status === 'rejected').length;
    const pending = filteredHistory.filter(r => r.status === 'pending').length;
    
    document.getElementById('historyTotal').textContent = total;
    document.getElementById('historyPassed').textContent = approved;
    document.getElementById('historyFailed').textContent = rejected;
    document.getElementById('historyPending').textContent = pending;
}

window.showResultDetail = (resultId) => {
    const r = results.find(x => x.id === resultId);
    if (!r) return;
    
    let detailHtml = r.details.map((d, i) => {
        let markClass = d.status === 'correct' ? 'ok' : d.status === 'pending' ? 'pend' : 'no';
        let markIcon = d.status === 'correct' ? '‚úì' : d.status === 'pending' ? '?' : '‚úó';
        
        return `<div class="result-detail">
            <div class="mark ${markClass}">${markIcon}</div>
            <div style="flex:1">
                <div style="font-size:13px;font-weight:700;margin-bottom:4px">${i + 1}. ${d.qText}</div>
                <div style="font-size:12px;color:var(--text-light)">–í—ñ–¥–ø–æ–≤—ñ–¥—å: <b>${d.userAnswer}</b></div>
                ${d.correctAnswer ? `<div style="font-size:11px;color:var(--primary);margin-top:2px">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${d.correctAnswer}</div>` : ''}
                <div style="font-size:11px;font-weight:800;color:${d.status === 'correct' ? 'var(--primary)' : 'var(--danger)'};margin-top:3px">
                    ${d.points || 0} –±.
                </div>
            </div>
        </div>`;
    }).join('');
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 9500;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        backdrop-filter: blur(10px);
    `;
    
    modal.innerHTML = `
        <div style="background:var(--card-bg);border:1px solid var(--glass-border);border-radius:20px;padding:30px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;position:relative">
            <button onclick="this.closest('div[style*=fixed]').remove();document.body.style.overflow='auto'" 
                    style="position:absolute;top:15px;right:15px;background:rgba(239,68,68,0.2);border:1px solid var(--danger);color:var(--danger);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;font-weight:900;display:flex;align-items:center;justify-content:center;transition:0.3s">
                √ó
            </button>
            
            <h3 style="font-size:20px;font-weight:900;margin-bottom:5px">${r.userName}</h3>
            <p style="font-size:12px;color:var(--text-gray);margin-bottom:20px">${r.testName} ‚Ä¢ ${r.date}</p>
            
            <div style="text-align:center;margin-bottom:25px">
                <div style="font-size:36px;font-weight:900;color:var(--primary)">${r.score} / ${r.maxScore}</div>
                <div style="font-size:12px;color:var(--text-gray);margin-top:5px">–ü–µ—Ä–µ–≤—ñ—Ä–∏–≤: ${r.reviewer || 'SYSTEM'}</div>
            </div>
            
            ${detailHtml}
        </div>
    `;
    
    modal.onclick = (e) => {
        if (e.target === modal) {
            modal.remove();
            document.body.style.overflow = 'auto';
        }
    };
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
};

window.exportHistory = () => {
    if (filteredHistory.length === 0) {
        alert('üì≠ –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É!');
        return;
    }
    
    // CSV –∑–∞–≥–æ–ª–æ–≤–∫–∏
    let csv = '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á,–Ü—Å–ø–∏—Ç,–ë–∞–ª–∏,–ú–∞–∫—Å.–±–∞–ª–∏,–í—ñ–¥—Å–æ—Ç–æ–∫,%,–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö,–í—Å—å–æ–≥–æ –ø–∏—Ç–∞–Ω—å,–°—Ç–∞—Ç—É—Å,–ü–µ—Ä–µ–≤—ñ—Ä–∏–≤,–î–∞—Ç–∞\n';
    
    filteredHistory.forEach(r => {
        const t = tests.find(x => x.id === r.testId);
        const tname = (t ? t.name : '–í–∏–¥–∞–ª–µ–Ω–∏–π').replace(/,/g, ';');
        const percentage = r.maxScore > 0 ? Math.round((r.score / r.maxScore) * 100) : 0;
        const correctCount = r.details.filter(d => d.status === 'correct').length;
        const totalQ = r.details.length;
        
        let status = '';
        if (r.status === 'pending') status = '–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ';
        else if (r.status === 'approved') status = '–°—Ö–≤–∞–ª–µ–Ω–æ';
        else if (r.status === 'rejected') status = '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ';
        else status = r.score >= (t?.passScore || 0) ? '–°–∫–ª–∞–¥–µ–Ω–æ' : '–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ';
        
        csv += `${r.userName},${tname},${r.score},${r.maxScore},${percentage}%,${correctCount},${totalQ},${status},${r.reviewer || 'SYSTEM'},${r.date}\n`;
    });
    
    // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `DSV_History_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('üì• –Ü—Å—Ç–æ—Ä—ñ—è –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–∞!', 'success');
};

window.saveWebhook = () => {
    webhookUrl = document.getElementById('webhookInput').value.trim();
    save();
    showNotification('‚úÖ Webhook –∑–±–µ—Ä–µ–∂–µ–Ω–æ!', 'success');
};

window.sendTestWebhook = async () => {
    const url = document.getElementById('webhookInput').value.trim();
    if (!url) {
        showNotification('‚ùå –í–≤–µ–¥—ñ—Ç—å Webhook URL!', 'error');
        return;
    }
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                embeds: [{
                    title: 'üß™ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è',
                    description: 'Webhook –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ! ‚úÖ',
                    color: 0x00ff44,
                    fields: [
                        {name: '–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫', value: ME.name, inline: true},
                        {name: '–†–æ–ª—å', value: ME.role, inline: true},
                        {name: '–ß–∞—Å', value: now(), inline: false}
                    ],
                    footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
                    timestamp: new Date().toISOString()
                }]
            })
        });
        
        if (response.ok) {
            showNotification('‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Discord!', 'success');
        } else {
            showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + response.status, 'error');
        }
    } catch (e) {
        showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
    }
};

window.removeReviewer = async (n) => {
    reviewers = reviewers.filter(r => r !== n);
    save();
    renderSettings();
};
      // ============================================
// üìä –ü–û–í–ù–ê –Ü–°–¢–û–†–Ü–Ø –¢–ï–°–¢–Ü–í
// ============================================
let historyData = [];
let filteredHistory = [];

window.openHistory = () => {
    historyData = [...results];
    filteredHistory = [...results];
    renderHistoryTable();
    document.getElementById('historyModal').classList.add('active');
    document.body.style.overflow = 'hidden';
};

window.closeHistory = (event) => {
    if (event && event.target.closest('.history-content')) return;
    document.getElementById('historyModal').classList.remove('active');
    document.body.style.overflow = 'auto';
};

window.filterHistory = () => {
    const searchText = document.getElementById('historySearch').value.toLowerCase();
    const statusFilter = document.getElementById('historyStatusFilter').value;
    
    filteredHistory = historyData.filter(r => {
        const matchSearch = r.userName.toLowerCase().includes(searchText) || 
                           r.testName.toLowerCase().includes(searchText);
        
        const matchStatus = statusFilter === 'all' || r.status === statusFilter;
        
        return matchSearch && matchStatus;
    });
    
    renderHistoryTable();
};

function renderHistoryTable() {
    const container = document.getElementById('historyTableContainer');
    
    if (filteredHistory.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-gray);font-size:14px">üì≠ –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
        updateHistoryStats();
        return;
    }
    
    const rows = filteredHistory.map(r => {
        const t = tests.find(x => x.id === r.testId);
        const tname = t ? t.name : '–í–∏–¥–∞–ª–µ–Ω–∏–π';
        const passS = t ? t.passScore : 0;
        
        let st, stc;
        if (r.status === 'pending') {
            st = '‚è≥ –ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ';
            stc = 'st-pending';
        } else if (r.status === 'approved') {
            st = '‚úÖ –°—Ö–≤–∞–ª–µ–Ω–æ';
            stc = 'st-approved';
        } else if (r.status === 'rejected') {
            st = '‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ';
            stc = 'st-rejected';
        } else {
            const p = r.score >= passS;
            st = p ? '‚úÖ –°–∫–ª–∞–¥–µ–Ω–æ' : '‚ùå –ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ';
            stc = p ? 'st-pass' : 'st-fail';
        }
        
        const percentage = r.maxScore > 0 ? Math.round((r.score / r.maxScore) * 100) : 0;
        const correctCount = r.details.filter(d => d.status === 'correct').length;
        const totalQuestions = r.details.length;
        
        return `<tr onclick="showResultDetail('${r.id}')" style="cursor:pointer">
            <td><b>${r.userName}</b></td>
            <td>${tname}</td>
            <td><b style="color:var(--primary)">${r.score}</b> / ${r.maxScore}</td>
            <td>${percentage}%</td>
            <td>${correctCount} / ${totalQuestions}</td>
            <td><span class="status-badge ${stc}">${st}</span></td>
            <td style="font-size:11px">${r.reviewer || 'SYSTEM'}</td>
            <td style="font-size:11px">${r.date}</td>
        </tr>`;
    }).join('');
    
    container.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                    <th>üìã –Ü—Å–ø–∏—Ç</th>
                    <th>üéØ –ë–∞–ª–∏</th>
                    <th>üìà %</th>
                    <th>‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö</th>
                    <th>üìä –°—Ç–∞—Ç—É—Å</th>
                    <th>üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤</th>
                    <th>üìÖ –î–∞—Ç–∞</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
    
    updateHistoryStats();
}

function updateHistoryStats() {
    const total = filteredHistory.length;
    const approved = filteredHistory.filter(r => r.status === 'approved').length;
    const rejected = filteredHistory.filter(r => r.status === 'rejected').length;
    const pending = filteredHistory.filter(r => r.status === 'pending').length;
    
    document.getElementById('historyTotal').textContent = total;
    document.getElementById('historyPassed').textContent = approved;
    document.getElementById('historyFailed').textContent = rejected;
    document.getElementById('historyPending').textContent = pending;
}

window.showResultDetail = (resultId) => {
    const r = results.find(x => x.id === resultId);
    if (!r) return;
    
    let detailHtml = r.details.map((d, i) => {
        let markClass = d.status === 'correct' ? 'ok' : d.status === 'pending' ? 'pend' : 'no';
        let markIcon = d.status === 'correct' ? '‚úì' : d.status === 'pending' ? '?' : '‚úó';
        
        return `<div class="result-detail">
            <div class="mark ${markClass}">${markIcon}</div>
            <div style="flex:1">
                <div style="font-size:13px;font-weight:700;margin-bottom:4px">${i + 1}. ${d.qText}</div>
                <div style="font-size:12px;color:var(--text-light)">–í—ñ–¥–ø–æ–≤—ñ–¥—å: <b>${d.userAnswer}</b></div>
                ${d.correctAnswer ? `<div style="font-size:11px;color:var(--primary);margin-top:2px">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${d.correctAnswer}</div>` : ''}
                <div style="font-size:11px;font-weight:800;color:${d.status === 'correct' ? 'var(--primary)' : 'var(--danger)'};margin-top:3px">
                    ${d.points || 0} –±.
                </div>
            </div>
        </div>`;
    }).join('');
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 9500;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        backdrop-filter: blur(10px);
    `;
    
    modal.innerHTML = `
        <div style="background:var(--card-bg);border:1px solid var(--glass-border);border-radius:20px;padding:30px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;position:relative">
            <button onclick="this.closest('div[style*=fixed]').remove();document.body.style.overflow='auto'" 
                    style="position:absolute;top:15px;right:15px;background:rgba(239,68,68,0.2);border:1px solid var(--danger);color:var(--danger);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;font-weight:900;display:flex;align-items:center;justify-content:center;transition:0.3s">
                √ó
            </button>
            
            <h3 style="font-size:20px;font-weight:900;margin-bottom:5px">${r.userName}</h3>
            <p style="font-size:12px;color:var(--text-gray);margin-bottom:20px">${r.testName} ‚Ä¢ ${r.date}</p>
            
            <div style="text-align:center;margin-bottom:25px">
                <div style="font-size:36px;font-weight:900;color:var(--primary)">${r.score} / ${r.maxScore}</div>
                <div style="font-size:12px;color:var(--text-gray);margin-top:5px">–ü–µ—Ä–µ–≤—ñ—Ä–∏–≤: ${r.reviewer || 'SYSTEM'}</div>
            </div>
            
            ${detailHtml}
        </div>
    `;
    
    modal.onclick = (e) => {
        if (e.target === modal) {
            modal.remove();
            document.body.style.overflow = 'auto';
        }
    };
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
};

window.exportHistory = () => {
    if (filteredHistory.length === 0) {
        alert('üì≠ –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É!');
        return;
    }
    
    // CSV –∑–∞–≥–æ–ª–æ–≤–∫–∏
    let csv = '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á,–Ü—Å–ø–∏—Ç,–ë–∞–ª–∏,–ú–∞–∫—Å.–±–∞–ª–∏,–í—ñ–¥—Å–æ—Ç–æ–∫,%,–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö,–í—Å—å–æ–≥–æ –ø–∏—Ç–∞–Ω—å,–°—Ç–∞—Ç—É—Å,–ü–µ—Ä–µ–≤—ñ—Ä–∏–≤,–î–∞—Ç–∞\n';
    
    filteredHistory.forEach(r => {
        const t = tests.find(x => x.id === r.testId);
        const tname = (t ? t.name : '–í–∏–¥–∞–ª–µ–Ω–∏–π').replace(/,/g, ';');
        const percentage = r.maxScore > 0 ? Math.round((r.score / r.maxScore) * 100) : 0;
        const correctCount = r.details.filter(d => d.status === 'correct').length;
        const totalQ = r.details.length;
        
        let status = '';
        if (r.status === 'pending') status = '–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ';
        else if (r.status === 'approved') status = '–°—Ö–≤–∞–ª–µ–Ω–æ';
        else if (r.status === 'rejected') status = '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ';
        else status = r.score >= (t?.passScore || 0) ? '–°–∫–ª–∞–¥–µ–Ω–æ' : '–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ';
        
        csv += `${r.userName},${tname},${r.score},${r.maxScore},${percentage}%,${correctCount},${totalQ},${status},${r.reviewer || 'SYSTEM'},${r.date}\n`;
    });
    
    // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `DSV_History_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('üì• –Ü—Å—Ç–æ—Ä—ñ—è –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–∞!', 'success');
};

window.saveWebhook = () => {
    webhookUrl = document.getElementById('webhookInput').value.trim();
    save();
    showNotification('‚úÖ Webhook –∑–±–µ—Ä–µ–∂–µ–Ω–æ!', 'success');
};

window.sendTestWebhook = async () => {
    const url = document.getElementById('webhookInput').value.trim();
    if (!url) {
        showNotification('‚ùå –í–≤–µ–¥—ñ—Ç—å Webhook URL!', 'error');
        return;
    }
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                embeds: [{
                    title: 'üß™ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è',
                    description: 'Webhook –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ! ‚úÖ',
                    color: 0x00ff44,
                    fields: [
                        {name: '–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫', value: ME.name, inline: true},
                        {name: '–†–æ–ª—å', value: ME.role, inline: true},
                        {name: '–ß–∞—Å', value: now(), inline: false}
                    ],
                    footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
                    timestamp: new Date().toISOString()
                }]
            })
        });
        
        if (response.ok) {
            showNotification('‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Discord!', 'success');
        } else {
            showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + response.status, 'error');
        }
    } catch (e) {
        showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
    }
};

window.removeReviewer = async (n) => {
    reviewers = reviewers.filter(r => r !== n);
    save();
    renderSettings();
};
      // ============================================
// üîß –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø
// ============================================
window.editTest = id => {
    const t = tests.find(x => x.id === id);
    if (!t) {
        showNotification('‚ùå –Ü—Å–ø–∏—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!', 'error');
        return;
    }
    
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ ID –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    editingTestId = t.id;
    
    // –ö–æ–ø—ñ—é—î–º–æ –¥–∞–Ω—ñ –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –º—É—Ç–∞—Ü—ñ—ó
    const testCopy = JSON.parse(JSON.stringify(t));
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Ñ–æ—Ç–æ
    currentTestPhotos = testCopy.photos || [];
    
    // –†–µ–Ω–¥–µ—Ä–∏–º–æ —Ñ–æ—Ä–º—É
    renderCreateForm(testCopy);
    showView('create');
    
    showNotification(`‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: ${t.name}`, 'info');
};

// ============================================
// üé® –ü–û–ö–†–ê–©–ï–ù–ù–Ø UX
// ============================================

// –ó–∞–∫—Ä–∏—Ç—Ç—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        document.getElementById('contextMenu').classList.remove('active');
        closeHistory();
    }
});

// –ê–Ω—ñ–º–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
function showLoader() {
    const loader = document.createElement('div');
    loader.id = 'globalLoader';
    loader.style.cssText = `
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 99999;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    `;
    loader.innerHTML = `
        <div style="text-align:center">
            <div style="font-size:48px;margin-bottom:15px;animation:pulse 1s infinite">‚öôÔ∏è</div>
            <div style="font-size:16px;font-weight:700;color:var(--primary)">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>
    `;
    document.body.appendChild(loader);
}

function hideLoader() {
    const loader = document.getElementById('globalLoader');
    if (loader) loader.remove();
}

// ============================================
// üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –Ü–°–¢–û–†–Ü–á
// ============================================
function updateHistoryStats() {
    const total = filteredHistory.length;
    
    const approved = filteredHistory.filter(r => r.status === 'approved').length;
    
    const rejected = filteredHistory.filter(r => r.status === 'rejected').length;
    
    const pending = filteredHistory.filter(r => r.status === 'pending' || 
                    (r.status === 'auto' && !r.reviewedByHuman)).length;
    
    const auto = filteredHistory.filter(r => {
        const t = tests.find(x => x.id === r.testId);
        return r.status === 'auto' && r.reviewedByHuman && t && r.score >= t.passScore;
    }).length;
    
    document.getElementById('historyTotal').textContent = total;
    document.getElementById('historyPassed').textContent = approved + auto;
    document.getElementById('historyFailed').textContent = rejected;
    document.getElementById('historyPending').textContent = pending;
}

// ============================================
// üîÑ –û–ù–û–í–õ–ï–ù–ù–Ø –Ü–°–ù–£–Æ–ß–ò–• –§–£–ù–ö–¶–Ü–ô
// ============================================

// –û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–µ—Å—Ç—É
const originalSaveTest = window.saveTest;
window.saveTest = async () => {
    showLoader();
    
    try {
        await originalSaveTest();
    } catch(e) {
        showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è!', 'error');
        console.error(e);
    } finally {
        hideLoader();
    }
};

// –û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
window.deleteTest = async id => {
    const t = tests.find(x => x.id === id);
    if (!t) return;
    
    if (confirm(`üóë –í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å–ø–∏—Ç "${t.name}"?\n\n‚ö†Ô∏è –¶–µ —Ç–∞–∫–æ–∂ –≤–∏–¥–∞–ª–∏—Ç—å –≤—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏!`)) {
        showLoader();
        const success = await deleteTestFromFirebase(id);
        hideLoader();
        
        if (success) {
            showNotification('‚úÖ –Ü—Å–ø–∏—Ç –≤–∏–¥–∞–ª–µ–Ω–æ!', 'success');
            const activeView = document.querySelector('.view.active');
            if (activeView && activeView.id === 'viewManage') {
                renderManage();
            }
        }
    }
};

// –û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –æ—á–∏—â–µ–Ω–Ω—è
window.clearTestResults = async (id) => {
    const t = tests.find(x => x.id === id);
    const testName = t ? t.name : '–ù–µ–≤—ñ–¥–æ–º–∏–π —ñ—Å–ø–∏—Ç';
    const count = results.filter(r => r.testId === id).length;
    
    if (count === 0) {
        showNotification('üì≠ –ù–µ–º–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è', 'warning');
        return;
    }
    
    if (confirm(`üßπ –û—á–∏—Å—Ç–∏—Ç–∏ ${count} —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —ñ—Å–ø–∏—Ç—É "${testName}"?`)) {
        showLoader();
        
        results = results.filter(r => r.testId !== id);
        save();
        
        await sendDiscordNotification('RESULTS_CLEARED', {
            testName: testName,
            clearedBy: ME.name,
            count: count,
            date: now()
        });
        
        hideLoader();
        showNotification(`‚úÖ –û—á–∏—â–µ–Ω–æ ${count} —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤!`, 'success');
        
        const activeView = document.querySelector('.view.active');
        if (activeView && activeView.id === 'viewManage') {
            renderManage();
        }
    }
};

// ============================================
// üéØ –§–Ü–ù–ê–õ–¨–ù–ê –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
// ============================================
console.log('üöÄ –î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2.0');
console.log('‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é - –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ');
console.log('‚úÖ –†—É—á–Ω—ñ –±–∞–ª–∏ - –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ');
console.log('‚úÖ –Ü—Å—Ç–æ—Ä—ñ—è —Ç–µ—Å—Ç—ñ–≤ - –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ');
console.log('‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è - –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ');

// –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è DevTools
document.onkeydown = e => {
    if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && [73, 74, 67].includes(e.keyCode)) || 
        (e.ctrlKey && e.keyCode === 85)) {
        return false;
    }
};

</script>
</body>
</html>
