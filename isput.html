<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–î–®–í | –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #00ff44;
  --primary-bright: #e0ffe8;
  --primary-glow: rgba(0,255,68,0.7);
  --primary-dim: rgba(0,255,68,0.15);
  --bg: #030507;
  --card-bg: rgba(10,12,16,0.85);
  --glass-border: rgba(0,255,68,0.3);
  --danger: #ef4444;
  --danger-glow: rgba(239,68,68,0.6);
  --warning: #fbbf24;
  --warning-glow: rgba(251,191,36,0.5);
  --info: #3b82f6;
  --info-glow: rgba(59,130,246,0.5);
  --text-gray: #94a3b8;
  --text-light: #cbd5e1;
  --success: #10b981;
  --card-hover: rgba(0,255,68,0.08);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: white;
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
  user-select: none;
  -webkit-user-select: none;
}

/* –Ø–°–ö–†–ê–í–Ü–®–ò–ô –§–û–ù */
body::before {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: 
    radial-gradient(ellipse at 15% 50%, rgba(0,255,68,0.18), transparent 55%),
    radial-gradient(ellipse at 85% 20%, rgba(0,255,68,0.15), transparent 55%),
    radial-gradient(ellipse at 50% 80%, rgba(0,255,68,0.12), transparent 55%);
  pointer-events: none;
  z-index: 0;
  animation: bgPulse 10s ease-in-out infinite;
}

@keyframes bgPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.75; }
}

input, textarea {
  user-select: text !important;
  -webkit-user-select: text !important;
}

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #0a0d12; }
::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 10px;
  box-shadow: 0 0 8px var(--primary);
}

/* ANIMATIONS */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-15px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes glow {
  0%, 100% { box-shadow: 0 0 5px var(--primary-glow); }
  50% { box-shadow: 0 0 25px var(--primary-glow), 0 0 50px rgba(0,255,68,0.2); }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-8px); }
  40%, 80% { transform: translateX(8px); }
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

/* HEADER */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 5%;
  background: rgba(3,5,7,0.9);
  border-bottom: 1px solid var(--glass-border);
  position: sticky;
  top: 0;
  z-index: 1000;
  backdrop-filter: blur(20px);
}

.logo-box {
  background: var(--primary);
  color: black;
  padding: 8px 16px;
  border-radius: 10px;
  font-weight: 900;
  text-decoration: none;
  font-size: 14px;
  text-transform: uppercase;
  box-shadow: 0 0 20px var(--primary-glow);
  transition: 0.3s;
  letter-spacing: 1px;
}

.logo-box:hover {
  box-shadow: 0 0 30px var(--primary-glow);
  transform: translateY(-2px);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.user-name-header {
  font-family: 'Inter', sans-serif;
  font-weight: 700;
  font-size: 13px;
  color: var(--primary-bright);
  letter-spacing: 0.3px;
}

.role-badge {
  padding: 6px 14px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 1px;
  border: 1px solid;
}

.role-admin {
  background: rgba(0,255,68,0.15);
  color: var(--primary);
  border-color: var(--primary);
  box-shadow: 0 0 15px rgba(0,255,68,0.3);
}

.role-instructor {
  background: rgba(251,191,36,0.15);
  color: var(--warning);
  border-color: var(--warning);
  box-shadow: 0 0 15px rgba(251,191,36,0.3);
}

.role-fighter {
  background: rgba(59,130,246,0.15);
  color: var(--info);
  border-color: var(--info);
  box-shadow: 0 0 15px rgba(59,130,246,0.3);
}

.nav-tabs { display: flex; gap: 6px; flex-wrap: wrap; }

.nav-btn {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--text-light);
  padding: 10px 18px;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  font-size: 12px;
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.nav-btn:hover {
  border-color: var(--primary);
  color: var(--primary-bright);
  background: rgba(0,255,68,0.08);
  transform: translateY(-2px);
}

.nav-btn.active {
  background: var(--primary);
  color: black;
  border-color: var(--primary);
  box-shadow: 0 0 20px var(--primary-glow);
  font-weight: 900;
}

/* MAIN */
.main-wrap {
  max-width: 1200px;
  margin: 0 auto;
  padding: 30px 20px;
}

.view {
  display: none;
  animation: fadeIn 0.5s ease;
}

.view.active { display: block; }

/* STAT CARDS */
.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 15px;
  margin-bottom: 30px;
}

.stat-card {
  background: var(--card-bg);
  border: 1px solid rgba(0,255,68,0.15);
  border-radius: 16px;
  padding: 22px;
  text-align: center;
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.stat-card:hover {
  border-color: var(--primary);
  transform: translateY(-3px);
  box-shadow: 0 8px 30px rgba(0,255,68,0.15);
}

.stat-num {
  font-size: 32px;
  font-weight: 900;
  color: var(--primary);
  text-shadow: 0 0 15px var(--primary-glow);
  margin-bottom: 4px;
}

.stat-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--text-gray);
  text-transform: uppercase;
  letter-spacing: 1.5px;
}

/* SECTION TITLE */
.section-title {
  font-size: 18px;
  font-weight: 900;
  color: var(--primary-bright);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* CHECKBOX –£–ì–û–î–ò */
.agreement-box {
  background: rgba(251,191,36,0.05);
  border: 1px solid rgba(251,191,36,0.3);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 25px;
}

.agreement-check {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  cursor: pointer;
  user-select: none;
}

.agreement-check input[type="checkbox"] {
  width: 22px;
  height: 22px;
  cursor: pointer;
  accent-color: var(--primary);
  flex-shrink: 0;
  margin-top: 2px;
}

.agreement-text {
  font-size: 13px;
  color: var(--text-light);
  line-height: 1.6;
  user-select: text;
}

.agreement-text strong {
  color: var(--warning);
  font-weight: 800;
}

/* PHOTO GALLERY –í –¢–ï–°–¢–Ü */
.test-photos-section {
  margin-bottom: 25px;
}

.test-photo-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 12px;
  margin-top: 15px;
}

.test-photo-item {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  cursor: zoom-in;
  border: 1px solid rgba(255,255,255,0.1);
  transition: 0.3s;
}

.test-photo-item:hover {
  transform: scale(1.05);
  border-color: var(--primary);
  box-shadow: 0 0 20px rgba(0,255,68,0.3);
}

.test-photo-item img {
  width: 100%;
  height: 120px;
  object-fit: cover;
}

.photo-delete-mini {
  position: absolute;
  top: 5px;
  right: 5px;
  background: rgba(239,68,68,0.9);
  color: white;
  border: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
}

.upload-photo-btn {
  background: rgba(0,255,68,0.1);
  border: 2px dashed var(--primary);
  color: var(--primary);
  padding: 12px 24px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 700;
  font-size: 13px;
  transition: 0.3s;
  margin-top: 15px;
  width: 100%;
}

.upload-photo-btn:hover {
  background: rgba(0,255,68,0.2);
  transform: translateY(-2px);
}

/* QUESTION PHOTO */
.question-photo-section {
  margin-top: 12px;
  margin-bottom: 12px;
}

.question-photo-preview {
  position: relative;
  display: inline-block;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid rgba(0,255,68,0.2);
}

.question-photo-preview img {
  width: 200px;
  height: 150px;
  object-fit: cover;
  display: block;
  cursor: zoom-in;
}

.question-photo-delete {
  position: absolute;
  top: 8px;
  right: 8px;
  background: rgba(239,68,68,0.95);
  color: white;
  border: none;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  transition: 0.3s;
}

.question-photo-delete:hover {
  background: var(--danger);
  transform: scale(1.1);
}

.add-question-photo-btn {
  background: rgba(0,255,68,0.08);
  border: 1px dashed rgba(0,255,68,0.3);
  color: var(--primary);
  padding: 8px 16px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 700;
  transition: 0.3s;
  display: inline-block;
}

.add-question-photo-btn:hover {
  background: rgba(0,255,68,0.15);
  border-color: var(--primary);
}

/* QUIZ QUESTION PHOTO */
.quiz-question-photo {
  margin-top: 15px;
  margin-bottom: 15px;
  text-align: center;
}

.quiz-question-photo img {
  max-width: 100%;
  max-height: 300px;
  border-radius: 12px;
  border: 1px solid rgba(0,255,68,0.2);
  cursor: zoom-in;
  transition: 0.3s;
}

.quiz-question-photo img:hover {
  transform: scale(1.02);
  border-color: var(--primary);
  box-shadow: 0 0 20px rgba(0,255,68,0.3);
}

/* LIGHTBOX */
.lightbox {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.95);
  z-index: 3000;
  display: none;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(10px);
}

.lightbox.active {
  display: flex;
}

.lightbox-img {
  max-width: 90%;
  max-height: 85vh;
  border-radius: 8px;
  box-shadow: 0 0 50px rgba(0,255,68,0.3);
}

.lightbox-close {
  position: absolute;
  top: 30px;
  right: 30px;
  font-size: 40px;
  color: white;
  cursor: pointer;
  opacity: 0.7;
  transition: 0.3s;
  z-index: 3001;
}

.lightbox-close:hover {
  opacity: 1;
  color: var(--danger);
  transform: rotate(90deg);
}

/* TEST CARDS */
.tests-grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
  margin-bottom: 40px;
}

.test-card {
  background: var(--card-bg);
  border: 1px solid rgba(0,255,68,0.15);
  border-radius: 20px;
  padding: 28px;
  width: 320px;
  backdrop-filter: blur(10px);
  transition: all 0.4s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.test-card:hover {
  border-color: var(--primary);
  transform: translateY(-5px);
  box-shadow: 0 10px 40px rgba(0,255,68,0.2);
}

.test-card .emoji {
  font-size: 48px;
  margin-bottom: 15px;
  display: block;
}

.test-card h3 {
  font-size: 17px;
  font-weight: 800;
  margin-bottom: 8px;
  color: white;
}

.test-card p {
  font-size: 12px;
  color: var(--text-gray);
  margin-bottom: 15px;
  line-height: 1.5;
}

.test-meta {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.meta-tag {
  font-size: 10px;
  padding: 5px 10px;
  border-radius: 8px;
  font-weight: 700;
  background: rgba(0,255,68,0.1);
  color: var(--primary);
  border: 1px solid rgba(0,255,68,0.2);
}

/* INTRO CARD */
.intro-card {
  max-width: 600px;
  margin: 40px auto;
  background: var(--card-bg);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 40px;
  text-align: center;
  backdrop-filter: blur(10px);
  position: relative;
  overflow: hidden;
}

.intro-card .emoji {
  font-size: 64px;
  margin-bottom: 20px;
  display: block;
}

.intro-card h2 {
  font-size: 24px;
  font-weight: 900;
  margin-bottom: 10px;
}

.intro-card p {
  color: var(--text-gray);
  font-size: 13px;
  margin-bottom: 8px;
}

/* QUIZ */
.quiz-container {
  max-width: 700px;
  margin: 20px auto;
}

.quiz-progress-bar {
  width: 100%;
  height: 6px;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  margin-bottom: 25px;
  overflow: hidden;
}

.quiz-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), #00ff88);
  border-radius: 10px;
  transition: width 0.5s ease;
  box-shadow: 0 0 10px var(--primary-glow);
}

.quiz-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 10px;
}

.quiz-timer {
  font-size: 28px;
  font-weight: 900;
  color: var(--warning);
  text-shadow: 0 0 15px var(--warning-glow);
}

.quiz-timer.danger {
  color: var(--danger);
  text-shadow: 0 0 15px var(--danger-glow);
  animation: pulse 0.5s infinite;
}

.quiz-question {
  background: var(--card-bg);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
  padding: 30px;
  margin-bottom: 20px;
  backdrop-filter: blur(10px);
}

.quiz-question h3 {
  font-size: 18px;
  font-weight: 800;
  margin-bottom: 5px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.quiz-answers {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 20px;
}

.answer-btn {
  background: rgba(255,255,255,0.03);
  border: 2px solid rgba(255,255,255,0.08);
  border-radius: 14px;
  padding: 16px 20px;
  color: white;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  text-align: left;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  gap: 12px;
}

.answer-btn:hover {
  border-color: var(--primary);
  background: rgba(0,255,68,0.05);
  transform: translateX(5px);
}

.answer-btn.selected {
  border-color: var(--primary);
  background: rgba(0,255,68,0.1);
  box-shadow: 0 0 20px rgba(0,255,68,0.15);
}

.answer-letter {
  width: 32px;
  height: 32px;
  border-radius: 10px;
  background: rgba(255,255,255,0.05);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 13px;
  color: var(--text-gray);
  flex-shrink: 0;
  border: 1px solid rgba(255,255,255,0.1);
  transition: 0.3s;
}

.answer-btn.selected .answer-letter {
  background: var(--primary);
  color: black;
  border-color: var(--primary);
  box-shadow: 0 0 10px var(--primary-glow);
}

/* BUTTONS */
.btn {
  padding: 14px 28px;
  border: none;
  border-radius: 14px;
  font-weight: 800;
  font-size: 13px;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.btn:active {
  transform: scale(0.96);
}

.btn-primary {
  background: var(--primary);
  color: black;
  box-shadow: 0 4px 15px rgba(0,255,68,0.3);
}

.btn-primary:hover {
  background: var(--primary-bright);
  box-shadow: 0 6px 25px rgba(0,255,68,0.5);
  transform: translateY(-2px);
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: rgba(0,255,68,0.2);
}

.btn-secondary {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.15);
  color: white;
}

.btn-secondary:hover {
  border-color: var(--primary);
  color: var(--primary-bright);
  background: rgba(0,255,68,0.08);
  transform: translateY(-2px);
}

.btn-danger {
  background: rgba(239,68,68,0.1);
  border: 1px solid var(--danger);
  color: var(--danger);
}

.btn-danger:hover {
  background: var(--danger);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--danger-glow);
}

.btn-warning {
  background: rgba(251,191,36,0.1);
  border: 1px solid var(--warning);
  color: var(--warning);
}

.btn-warning:hover {
  background: var(--warning);
  color: black;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--warning-glow);
}

.btn-info {
  background: rgba(59,130,246,0.1);
  border: 1px solid var(--info);
  color: var(--info);
}

.btn-info:hover {
  background: var(--info);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--info-glow);
}

.btn-group {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 25px;
  flex-wrap: wrap;
}

/* FORMS */
.form-card {
  background: var(--card-bg);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
  padding: 30px;
  backdrop-filter: blur(10px);
  margin-bottom: 20px;
}

.form-row {
  margin-bottom: 18px;
}

.form-label {
  display: block;
  font-size: 11px;
  color: var(--primary);
  margin-bottom: 8px;
  text-transform: uppercase;
  font-weight: 800;
  letter-spacing: 1px;
}

.form-input {
  width: 100%;
  background: rgba(0,0,0,0.4);
  border: 1px solid rgba(255,255,255,0.1);
  color: white;
  padding: 14px;
  border-radius: 12px;
  font-size: 14px;
  outline: none;
  font-family: inherit;
  transition: 0.3s;
}

.form-input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 15px rgba(0,255,68,0.15);
}

.form-row-inline {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.form-hint {
  font-size: 11px;
  color: var(--text-gray);
  margin-top: 8px;
  font-weight: 600;
}

/* RESPONSIVE */
@media(max-width: 768px) {
  .stats-row {
    grid-template-columns: 1fr 1fr;
  }
  
  .test-card {
    width: 100%;
    max-width: 400px;
  }
  
  .form-row-inline {
    grid-template-columns: 1fr;
  }
  
  .btn-group {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
  }
}

@media(max-width: 480px) {
  .stats-row {
    grid-template-columns: 1fr;
  }
  
  header {
    flex-direction: column;
    gap: 10px;
  }
}

/* –î–û–î–ê–¢–ö–û–í–Ü –°–¢–ò–õ–Ü */
.result-detail {
  background: var(--card-bg);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 16px;
  padding: 18px;
  margin-bottom: 10px;
  text-align: left;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.result-detail .mark {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
  font-weight: 900;
}

.mark.ok {
  background: rgba(0,255,68,0.15);
  color: var(--primary);
}

.mark.no {
  background: rgba(239,68,68,0.15);
  color: var(--danger);
}

.mark.pend {
  background: rgba(251,191,36,0.15);
  color: var(--warning);
}

.result-circle {
  width: 160px;
  height: 160px;
  border-radius: 50%;
  margin: 0 auto 25px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border: 4px solid;
  position: relative;
}

.result-circle.pass {
  border-color: var(--primary);
  box-shadow: 0 0 40px var(--primary-glow);
  animation: glow 2s infinite;
}

.result-circle.fail {
  border-color: var(--danger);
  box-shadow: 0 0 40px var(--danger-glow);
}

.result-score {
  font-size: 36px;
  font-weight: 900;
}

.result-max {
  font-size: 12px;
  color: var(--text-gray);
  font-weight: 700;
}

.result-status {
  font-size: 28px;
  font-weight: 900;
  margin-bottom: 10px;
}

.result-status.pass {
  color: var(--primary);
  text-shadow: 0 0 20px var(--primary-glow);
}

.result-status.fail {
  color: var(--danger);
  text-shadow: 0 0 20px var(--danger-glow);
}

.results-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  overflow-x: auto;
  display: block;
}

.results-table table {
  width: 100%;
  min-width: 600px;
}

.results-table th {
  text-align: left;
  padding: 12px 15px;
  font-size: 10px;
  color: var(--primary);
  text-transform: uppercase;
  letter-spacing: 1px;
  border-bottom: 2px solid var(--glass-border);
  font-weight: 800;
}

.results-table td {
  padding: 12px 15px;
  font-size: 13px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}

.results-table tr:hover td {
  background: rgba(0,255,68,0.03);
}

.status-badge {
  padding: 4px 12px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 800;
  text-transform: uppercase;
  white-space: nowrap;
}

.st-pass {
  background: rgba(16,185,129,0.15);
  color: var(--success);
  border: 1px solid rgba(16,185,129,0.3);
}

.st-fail {
  background: rgba(239,68,68,0.15);
  color: var(--danger);
  border: 1px solid rgba(239,68,68,0.3);
}

.st-pending {
  background: rgba(251,191,36,0.15);
  color: var(--warning);
  border: 1px solid rgba(251,191,36,0.3);
}

.st-approved {
  background: rgba(0,255,68,0.15);
  color: var(--primary);
  border: 1px solid rgba(0,255,68,0.3);
}

.st-rejected {
  background: rgba(239,68,68,0.15);
  color: var(--danger);
  border: 1px solid rgba(239,68,68,0.3);
}

.q-block {
  background: var(--card-bg);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 15px;
  transition: 0.3s;
}

.q-block:hover {
  border-color: rgba(0,255,68,0.2);
}

.q-block.error {
  border-color: var(--danger) !important;
  animation: shake 0.5s;
  box-shadow: 0 0 20px var(--danger-glow);
}

.q-block-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.q-num {
  font-size: 12px;
  font-weight: 800;
  color: var(--primary);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.q-del {
  background: none;
  border: none;
  color: var(--danger);
  cursor: pointer;
  font-size: 18px;
  opacity: 0.5;
  transition: 0.3s;
}

.q-del:hover {
  opacity: 1;
  transform: scale(1.2);
}

.opt-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.opt-radio {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.2);
  cursor: pointer;
  transition: 0.3s;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.opt-radio:hover {
  border-color: var(--primary);
}

.opt-radio.checked {
  border-color: var(--primary);
  background: var(--primary);
  box-shadow: 0 0 10px var(--primary-glow);
}

.opt-radio.checked::after {
  content: '‚úì';
  color: black;
  font-size: 12px;
  font-weight: 900;
}

.opt-input {
  flex: 1;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.08);
  color: white;
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 13px;
  outline: none;
  font-family: inherit;
  transition: 0.3s;
}

.opt-input:focus {
  border-color: var(--primary);
}

.opt-del {
  background: none;
  border: none;
  color: var(--danger);
  cursor: pointer;
  font-size: 14px;
  opacity: 0.4;
  transition: 0.3s;
}

.opt-del:hover {
  opacity: 1;
}

.add-opt-btn {
  background: none;
  border: 1px dashed rgba(255,255,255,0.1);
  color: var(--text-gray);
  padding: 8px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 12px;
  width: 100%;
  transition: 0.3s;
  font-weight: 600;
}

.add-opt-btn:hover {
  border-color: var(--primary);
  color: var(--primary);
}

.free-toggle-create,
.table-toggle-create {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  cursor: pointer;
  font-size: 12px;
  color: var(--text-gray);
  font-weight: 600;
  transition: 0.3s;
}

.free-toggle-create:hover,
.table-toggle-create:hover {
  color: var(--primary);
}

.toggle-switch {
  width: 36px;
  height: 20px;
  border-radius: 12px;
  background: rgba(255,255,255,0.1);
  position: relative;
  transition: 0.3s;
  flex-shrink: 0;
}

.toggle-switch.on {
  background: var(--primary);
}

.toggle-switch::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: white;
  transition: 0.3s;
}

.toggle-switch.on::after {
  left: 18px;
}

.table-builder {
  margin-top: 15px;
  padding: 15px;
  background: rgba(0,255,68,0.03);
  border: 1px solid rgba(0,255,68,0.15);
  border-radius: 12px;
}

.table-builder-head {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.table-col-input {
  flex: 1;
  min-width: 100px;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.1);
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  outline: none;
  font-family: inherit;
}

.table-col-input:focus {
  border-color: var(--primary);
}

.table-builder-rows {
  margin-top: 10px;
}

.table-row-builder {
  display: flex;
  gap: 10px;
  margin-bottom: 8px;
  align-items: center;
}

.table-cell-input {
  flex: 1;
  min-width: 100px;
  background: rgba(0,0,0,0.4);
  border: 1px solid rgba(255,255,255,0.08);
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  outline: none;
  font-family: inherit;
}

.table-cell-input:focus {
  border-color: var(--primary);
}

.answer-table-wrapper {
  overflow-x: auto;
  margin-bottom: 15px;
}

.answer-table {
  width: 100%;
  border-collapse: collapse;
  background: rgba(0,0,0,0.3);
  border-radius: 12px;
  overflow: hidden;
}

.answer-table th {
  background: rgba(0,255,68,0.1);
  color: var(--primary);
  padding: 12px;
  text-align: left;
  font-size: 12px;
  font-weight: 800;
  text-transform: uppercase;
  border-bottom: 2px solid rgba(0,255,68,0.2);
}

.answer-table td {
  padding: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  font-size: 13px;
}

.answer-table tr:hover td {
  background: rgba(0,255,68,0.03);
}

.table-radio {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.2);
  cursor: pointer;
  transition: 0.3s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  vertical-align: middle;
}

.table-radio:hover {
  border-color: var(--primary);
}

.table-radio.checked {
  border-color: var(--primary);
  background: var(--primary);
  box-shadow: 0 0 10px var(--primary-glow);
}

.table-radio.checked::after {
  content: '‚úì';
  color: black;
  font-size: 12px;
  font-weight: 900;
}

.free-answer-area {
  margin-top: 15px;
}

.free-answer-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px dashed rgba(255,255,255,0.1);
  background: rgba(255,255,255,0.02);
  transition: 0.3s;
  font-size: 13px;
  color: var(--text-gray);
  font-weight: 600;
}

.free-answer-toggle:hover {
  border-color: var(--primary);
  color: var(--primary-bright);
  background: rgba(0,255,68,0.05);
}

.free-answer-toggle.active {
  border-color: var(--primary);
  color: var(--primary);
  background: rgba(0,255,68,0.08);
}

.free-input {
  width: 100%;
  margin-top: 10px;
  background: rgba(0,0,0,0.4);
  border: 1px solid rgba(255,255,255,0.1);
  color: white;
  padding: 14px;
  border-radius: 12px;
  font-size: 14px;
  outline: none;
  font-family: inherit;
  resize: vertical;
  min-height: 80px;
  transition: 0.3s;
}

.free-input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 15px rgba(0,255,68,0.2);
}

.reviewer-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(0,255,68,0.1);
  border: 1px solid rgba(0,255,68,0.2);
  color: var(--primary-bright);
  padding: 6px 12px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 700;
  margin: 3px;
}

.reviewer-chip button {
  background: none;
  border: none;
  color: var(--danger);
  cursor: pointer;
  font-size: 14px;
  margin-left: 4px;
}

.people-dropdown {
  position: relative;
}

.people-list {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: rgba(10,15,25,0.98);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  display: none;
  box-shadow: 0 10px 40px rgba(0,0,0,0.8);
}

.people-list.show {
  display: block;
  animation: slideDown 0.2s ease;
}

.people-item {
  padding: 10px 15px;
  cursor: pointer;
  font-size: 13px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: 0.2s;
}

.people-item:hover {
  background: rgba(0,255,68,0.08);
}

.review-card {
  background: var(--card-bg);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 18px;
  padding: 25px;
  margin-bottom: 15px;
}

.review-q {
  margin-bottom: 15px;
  padding: 15px;
  background: rgba(255,255,255,0.02);
  border-radius: 12px;
  border-left: 3px solid;
}

.review-q.auto-ok {
  border-color: var(--primary);
}

.review-q.auto-fail {
  border-color: var(--danger);
}

.review-q.pending {
  border-color: var(--warning);
}

.review-q .q-title {
  font-size: 13px;
  font-weight: 700;
  margin-bottom: 6px;
  word-wrap: break-word;
}

.review-q .q-answer {
  font-size: 12px;
  color: var(--text-light);
  word-wrap: break-word;
}

.review-q .q-correct {
  font-size: 11px;
  color: var(--primary);
  margin-top: 4px;
}

.review-q .q-points {
  font-size: 11px;
  font-weight: 800;
  margin-top: 4px;
}

.setting-block {
  background: var(--card-bg);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 16px;
  padding: 22px;
  margin-bottom: 15px;
}

.setting-block h4 {
  font-size: 13px;
  font-weight: 800;
  color: var(--primary-bright);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.admin-list-panel {
  background: var(--card-bg);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 16px;
  padding: 22px;
  margin-bottom: 15px;
}

.manage-card {
  background: var(--card-bg);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 14px;
  padding: 18px 20px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: 0.3s;
  flex-wrap: wrap;
  gap: 15px;
}

.manage-card:hover {
  border-color: var(--glass-border);
  background: rgba(0,255,68,0.03);
}
</style>
</head>
<body>
  <header>
  <a href="cabinet.html" class="logo-box">‚öî –î–®–í</a>
  <div class="header-right">
    <div class="nav-tabs" id="navTabs"></div>
    <span class="user-name-header" id="headerName">...</span>
    <span class="role-badge" id="headerRole">...</span>
  </div>
</header>

<div class="main-wrap">
  
  <!-- HOME -->
  <div class="view active" id="viewHome">
    <div class="stats-row" id="statsRow"></div>
    <div class="section-title">üìã –î–æ—Å—Ç—É–ø–Ω—ñ —ñ—Å–ø–∏—Ç–∏</div>
    <div class="tests-grid" id="testsGrid"></div>
    <div class="section-title">üìä –ú–æ—ó —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏</div>
    <div id="myResults"></div>
  </div>

  <!-- INTRO -->
  <div class="view" id="viewIntro">
    <div class="intro-card" id="introCard"></div>
  </div>

  <!-- QUIZ -->
  <div class="view" id="viewQuiz">
    <div class="quiz-container" id="quizContainer"></div>
  </div>

  <!-- RESULT -->
  <div class="view" id="viewResult">
    <div class="result-screen" id="resultScreen"></div>
  </div>

  <!-- CREATE / EDIT -->
  <div class="view" id="viewCreate">
    <div class="section-title" id="createTitle">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ—Å–ø–∏—Ç</div>
    <div id="createForm"></div>
  </div>

  <!-- REVIEW -->
  <div class="view" id="viewReview">
    <div class="section-title">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</div>
    <div id="reviewList"></div>
  </div>

  <!-- MANAGE -->
  <div class="view" id="viewManage">
    <div class="section-title">‚öôÔ∏è –ö–µ—Ä—É–≤–∞–Ω–Ω—è —ñ—Å–ø–∏—Ç–∞–º–∏</div>
    <div id="manageList"></div>
  </div>

  <!-- SETTINGS -->
  <div class="view" id="viewSettings">
    <div class="section-title">üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div id="settingsContent"></div>
  </div>

  <!-- ADMIN LIST -->
  <div class="view" id="viewAdminList">
    <div class="section-title">üëë –ê–¥–º—ñ–Ω –ø—Ä–∞–≤–∞ –≤ —ñ—Å–ø–∏—Ç–∞—Ö</div>
    <div id="adminListContent"></div>
  </div>

</div>

<!-- LIGHTBOX -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
  <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
  <img id="lightboxImg" class="lightbox-img" src="">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, collection, updateDoc, addDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyATUpLUHSp1VbyxkJXhMS-2R71zNOBGC00",
  authDomain: "dsv-gta.firebaseapp.com",
  projectId: "dsv-gta",
  storageBucket: "dsv-gta.firebasestorage.app",
  messagingSenderId: "661591588818",
  appId: "1:661591588818:web:a8e8dca3d061447e24d20b"
});

const auth = getAuth(app);
const db = getFirestore(app);

/* ===== STATE ===== */
let ME = {name: '–ù–µ–≤—ñ–¥–æ–º–∏–π', role: 'fighter', uid: ''};
let allUsers = [];
let tests = [];
let results = JSON.parse(localStorage.getItem('isput_results') || '[]');
let reviewers = JSON.parse(localStorage.getItem('isput_reviewers') || '[]');
let adminList = JSON.parse(localStorage.getItem('isput_admins') || '[]');
let webhookUrl = localStorage.getItem('isput_webhook') || '';
let currentTest = null;
let currentQ = 0;
let answers = {};
let timer = null;
let timeLeft = 30;
let editingTestId = null;
let agreementAccepted = false;
let currentTestPhotos = [];
let currentQuestionPhotos = []; // –î–ª—è —Ñ–æ—Ç–æ –ø–∏—Ç–∞–Ω—å

const save = () => {
  localStorage.setItem('isput_results', JSON.stringify(results));
  localStorage.setItem('isput_reviewers', JSON.stringify(reviewers));
  localStorage.setItem('isput_admins', JSON.stringify(adminList));
  localStorage.setItem('isput_webhook', webhookUrl);
};

const letters = '–ê–ë–í–ì“ê–î–ï–ñ–ó–ò';
const isAdmin = () => ME.role === 'admin' || adminList.includes(ME.name);
const isReviewer = () => isAdmin() || reviewers.includes(ME.name);
const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
const now = () => {
  const d = new Date();
  return d.toLocaleDateString('uk') + ' ' + d.toLocaleTimeString('uk', {hour: '2-digit', minute: '2-digit'});
};

/* ===== FIREBASE AUTH ===== */
onAuthStateChanged(auth, async u => {
  if (!u) {
    window.location.href = 'index.html';
    return;
  }
  
  ME.uid = u.uid;
  
  try {
    const snap = await getDoc(doc(db, 'users', u.uid));
    if (snap.exists()) {
      const d = snap.data();
      ME.name = d.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π';
      ME.role = d.role || 'fighter';
    }
    
    const all = await getDocs(collection(db, 'users'));
    allUsers = [];
    all.forEach(s => {
      const d = s.data();
      allUsers.push({uid: s.id, name: d.name || '---', role: d.role || 'fighter'});
    });

    loadTestsFromFirebase();
    
  } catch (e) {
    console.log('Firebase err:', e);
  }

  document.getElementById('headerName').textContent = ME.name;
  const rb = document.getElementById('headerRole');
  
  if (ME.role === 'admin') {
    rb.textContent = '–ê–î–ú–Ü–ù';
    rb.className = 'role-badge role-admin';
  } else if (ME.role === 'instructor') {
    rb.textContent = '–Ü–ù–°–¢–†–£–ö–¢–û–†';
    rb.className = 'role-badge role-instructor';
  } else {
    rb.textContent = '–ë–Ü–Ñ–¶–¨';
    rb.className = 'role-badge role-fighter';
  }

  buildNav();
  showView('home');
});

/* ===== FIREBASE TESTS ===== */
function loadTestsFromFirebase() {
  const q = query(collection(db, 'tests'), orderBy('createdAt', 'desc'));
  
  onSnapshot(q, snapshot => {
    tests = [];
    snapshot.forEach(docSnap => {
      tests.push({id: docSnap.id, ...docSnap.data()});
    });
    
    const activeView = document.querySelector('.view.active');
    if (activeView) {
      if (activeView.id === 'viewHome') renderHome();
      if (activeView.id === 'viewManage') renderManage();
    }
  });
}

async function saveTestToFirebase(testObj) {
  try {
    if (editingTestId) {
      await updateDoc(doc(db, 'tests', editingTestId), testObj);
      addNotif(`üìù –Ü—Å–ø–∏—Ç "${testObj.name}" –æ–Ω–æ–≤–ª–µ–Ω–æ!`);
    } else {
      await addDoc(collection(db, 'tests'), {
        ...testObj,
        createdAt: serverTimestamp()
      });
      addNotif(`üìù –Ü—Å–ø–∏—Ç "${testObj.name}" —Å—Ç–≤–æ—Ä–µ–Ω–æ!`);
    }
    return true;
  } catch (e) {
    console.error('Save error:', e);
    alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + e.message);
    return false;
  }
}

async function deleteTestFromFirebase(id) {
  try {
    await deleteDoc(doc(db, 'tests', id));
    results = results.filter(r => r.testId !== id);
    save();
    addNotif('üóë –Ü—Å–ø–∏—Ç –≤–∏–¥–∞–ª–µ–Ω–æ');
    return true;
  } catch (e) {
    alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + e.message);
    return false;
  }
}

/* ===== NOTIFICATIONS ===== */
let notifs = JSON.parse(localStorage.getItem('isput_notifs') || '[]');

function addNotif(text) {
  notifs.unshift({text, time: now(), read: false});
  if (notifs.length > 20) notifs.pop();
  localStorage.setItem('isput_notifs', JSON.stringify(notifs));
}

/* ===== NAVIGATION ===== */
function buildNav() {
  const tabs = document.getElementById('navTabs');
  let html = '<button class="nav-btn active" onclick="showView(\'home\')">üè† –ì–æ–ª–æ–≤–Ω–∞</button>';
  
  if (isAdmin()) {
    html += '<button class="nav-btn" onclick="showView(\'create\')">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</button>';
    html += '<button class="nav-btn" onclick="showView(\'manage\')">‚öôÔ∏è –ö–µ—Ä—É–≤–∞—Ç–∏</button>';
    html += '<button class="nav-btn" onclick="showView(\'settings\')">üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>';
    html += '<button class="nav-btn" onclick="showView(\'adminList\')">üëë –ê–¥–º—ñ–Ω–∏</button>';
  }
  
  if (isReviewer()) {
    html += '<button class="nav-btn" onclick="showView(\'review\')">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞</button>';
  }
  
  tabs.innerHTML = html;
}

window.showView = v => {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.getElementById('view' + v.charAt(0).toUpperCase() + v.slice(1)).classList.add('active');
  
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const btns = document.querySelectorAll('.nav-btn');
  const map = {home: 0, create: 1, manage: 2, settings: 3, adminList: 4, review: isAdmin() ? 5 : 1};
  if (btns[map[v]]) btns[map[v]].classList.add('active');

  if (v === 'home') renderHome();
  if (v === 'create') renderCreateForm();
  if (v === 'review') renderReview();
  if (v === 'manage') renderManage();
  if (v === 'settings') renderSettings();
  if (v === 'adminList') renderAdminList();
};

/* ===== HOME ===== */
function renderHome() {
  const myRes = results.filter(r => r.userId === ME.uid);
  const passed = myRes.filter(r => {
    const t = tests.find(x => x.id === r.testId);
    return r.status === 'approved' || (r.status === 'auto' && t && r.score >= t.passScore);
  }).length;
  
  const failed = myRes.filter(r => {
    const t = tests.find(x => x.id === r.testId);
    return r.status === 'rejected' || (r.status === 'auto' && t && r.score < t.passScore);
  }).length;
  
  const pending = myRes.filter(r => r.status === 'pending').length;

  document.getElementById('statsRow').innerHTML = `
    <div class="stat-card">
      <div class="stat-num">${tests.length}</div>
      <div class="stat-label">–Ü—Å–ø–∏—Ç—ñ–≤</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--success)">${passed}</div>
      <div class="stat-label">–°–∫–ª–∞–¥–µ–Ω–æ</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--danger)">${failed}</div>
      <div class="stat-label">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--warning)">${pending}</div>
      <div class="stat-label">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</div>
    </div>
  `;

  if (tests.length === 0) {
    document.getElementById('testsGrid').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px;width:100%">–Ü—Å–ø–∏—Ç—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>';
  } else {
    document.getElementById('testsGrid').innerHTML = tests.map(t => {
      const pps = t.maxScore > 0 ? Math.round(t.maxScore / t.questions.length * 10) / 10 : 0;
      let totalTime = 0;
      t.questions.forEach(q => {totalTime += (q.timeLimit || 30)});
      
      return `<div class="test-card" onclick="startIntro('${t.id}')">
        <span class="emoji">${t.emoji || 'üìù'}</span>
        <h3>${t.name}</h3>
        <p>${t.description || '–ë–µ–∑ –æ–ø–∏—Å—É'}</p>
        <div class="test-meta">
          <span class="meta-tag">‚ùì ${t.questions.length} –ø–∏—Ç–∞–Ω—å</span>
          <span class="meta-tag">üéØ ${t.passScore}/${t.maxScore} –±.</span>
          <span class="meta-tag">‚è± ${totalTime}—Å</span>
        </div>
      </div>`;
    }).join('');
  }

  if (myRes.length === 0) {
    document.getElementById('myResults').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:30px;font-size:13px">–í–∏ —â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —ñ—Å–ø–∏—Ç–∏</div>';
  } else {
    let rows = myRes.map(r => {
      const t = tests.find(x => x.id === r.testId);
      const tname = t ? t.name : '–í–∏–¥–∞–ª–µ–Ω–∏–π';
      const passS = t ? t.passScore : 0;
      let st, stc;
      
      if (r.status === 'pending') {
        st = '–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ';
        stc = 'st-pending';
      } else if (r.status === 'approved') {
        st = '–°—Ö–≤–∞–ª–µ–Ω–æ';
        stc = 'st-approved';
      } else if (r.status === 'rejected') {
        st = '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ';
        stc = 'st-rejected';
      } else {
        const p = r.score >= passS;
        st = p ? '–°–∫–ª–∞–¥–µ–Ω–æ' : '–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ';
        stc = p ? 'st-pass' : 'st-fail';
      }
      
      return `<tr>
        <td>${tname}</td>
        <td><b>${r.score}</b> / ${t ? t.maxScore : '?'}</td>
        <td><span class="status-badge ${stc}">${st}</span></td>
        <td>${r.reviewer || 'SYSTEM'}</td>
        <td>${r.date}</td>
      </tr>`;
    }).join('');
    
    document.getElementById('myResults').innerHTML = `
      <div class="results-table">
        <table>
          <thead>
            <tr>
              <th>–Ü—Å–ø–∏—Ç</th>
              <th>–ë–∞–ª–∏</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π</th>
              <th>–î–∞—Ç–∞</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }
}

/* ===== INTRO ===== */
window.startIntro = id => {
  const t = tests.find(x => x.id === id);
  if (!t) return;

  const myResults = results.filter(r => r.testId === id && r.userId === ME.uid);
  const hasPending = myResults.find(r => r.status === 'pending');
  const hasAutoNotReviewed = myResults.find(r => r.status === 'auto' && !r.reviewedByHuman);
  
  if (hasPending || hasAutoNotReviewed) {
    alert('‚ö†Ô∏è –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —ñ—Å–ø–∏—Ç —â–µ –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ –ª—é–¥–∏–Ω–æ—é! –î–æ—á–µ–∫–∞–π—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.');
    return;
  }

  currentTest = t;
  agreementAccepted = false;
  
  const pps = t.maxScore > 0 ? Math.round(t.maxScore / t.questions.length * 10) / 10 : 0;
  let totalTime = 0;
  t.questions.forEach(q => {totalTime += (q.timeLimit || 30)});

  let photosHtml = '';
  if (t.photos && t.photos.length > 0) {
    photosHtml = `
      <div style="margin:25px 0">
        <h4 style="font-size:14px;font-weight:800;margin-bottom:15px;color:var(--primary-bright)">üì∏ –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ —ñ—Å–ø–∏—Ç—É</h4>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px">
          ${t.photos.map((p, i) => `
            <img src="${p.url}" 
                 style="width:100%;height:100px;object-fit:cover;border-radius:12px;cursor:zoom-in;border:1px solid rgba(255,255,255,0.1)" 
                 onclick="openLightbox('${p.url}')">
          `).join('')}
        </div>
      </div>
    `;
  }

  let agreementHtml = '';
  if (t.agreementText && t.agreementText.trim()) {
    agreementHtml = `
      <div class="agreement-box">
        <label class="agreement-check">
          <input type="checkbox" id="agreementCheckbox" onchange="toggleAgreement()">
          <div class="agreement-text">
            <strong>üìú –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∞ —É–≥–æ–¥–∞:</strong><br>
            ${t.agreementText}
          </div>
        </label>
      </div>
    `;
  } else {
    agreementAccepted = true;
  }

  document.getElementById('introCard').innerHTML = `
    <span class="emoji">${t.emoji || 'üìù'}</span>
    <h2>${t.name}</h2>
    <p>${t.description || ''}</p>
    
    ${photosHtml}
    
    <div style="margin:25px 0;display:grid;grid-template-columns:1fr 1fr;gap:10px;text-align:center">
      <div style="background:rgba(0,255,68,0.05);border:1px solid rgba(0,255,68,0.15);border-radius:12px;padding:15px">
        <div style="font-size:22px;font-weight:900;color:var(--primary)">${t.questions.length}</div>
        <div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ü–ò–¢–ê–ù–¨</div>
      </div>
      <div style="background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.15);border-radius:12px;padding:15px">
        <div style="font-size:22px;font-weight:900;color:var(--warning)">${t.passScore}/${t.maxScore}</div>
        <div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ü–†–û–•–Ü–î–ù–ò–ô –ë–ê–õ</div>
      </div>
      <div style="background:rgba(59,130,246,0.05);border:1px solid rgba(59,130,246,0.15);border-radius:12px;padding:15px">
        <div style="font-size:22px;font-weight:900;color:var(--info)">‚è± ${totalTime}—Å</div>
        <div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ó–ê–ì–ê–õ–¨–ù–ò–ô –ß–ê–°</div>
      </div>
      <div style="background:rgba(16,185,129,0.05);border:1px solid rgba(16,185,129,0.15);border-radius:12px;padding:15px">
        <div style="font-size:22px;font-weight:900;color:var(--success)">${pps}</div>
        <div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ë–ê–õ–Ü–í –ó–ê –ü–ò–¢–ê–ù–ù–Ø</div>
      </div>
    </div>

    ${agreementHtml}

    <div class="btn-group">
      <button class="btn btn-primary" onclick="beginQuiz()" id="startQuizBtn" ${!agreementAccepted ? 'disabled' : ''}>
        üöÄ –†–û–ó–ü–û–ß–ê–¢–ò –Ü–°–ü–ò–¢
      </button>
      <button class="btn btn-secondary" onclick="showView('home')">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
  `;

  showView('intro');
};

window.toggleAgreement = () => {
  const checkbox = document.getElementById('agreementCheckbox');
  agreementAccepted = checkbox.checked;
  
  const btn = document.getElementById('startQuizBtn');
  btn.disabled = !agreementAccepted;
};

/* ===== LIGHTBOX ===== */
window.openLightbox = url => {
  const lb = document.getElementById('lightbox');
  const img = document.getElementById('lightboxImg');
  img.src = url;
  lb.classList.add('active');
  document.body.style.overflow = 'hidden';
};

window.closeLightbox = () => {
  const lb = document.getElementById('lightbox');
  lb.classList.remove('active');
  document.body.style.overflow = 'auto';
};

/* ===== QUIZ ===== */
window.beginQuiz = () => {
  if (!agreementAccepted) {
    alert('‚ö†Ô∏è –ü–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–∏–π–Ω—è—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—É —É–≥–æ–¥—É!');
    return;
  }
  currentQ = 0;
  answers = {};
  showView('quiz');
  renderQuestion();
};

function renderQuestion() {
  if (!currentTest) return;
  
  const q = currentTest.questions[currentQ];
  const total = currentTest.questions.length;
  const pps = currentTest.maxScore > 0 ? Math.round(currentTest.maxScore / total * 10) / 10 : 0;
  const progress = ((currentQ) / total) * 100;

  clearInterval(timer);
  timeLeft = q.timeLimit || 30;

  // –§–æ—Ç–æ –ø–∏—Ç–∞–Ω–Ω—è
  let qPhotoHtml = '';
  if (q.photo) {
    qPhotoHtml = `<div class="quiz-question-photo">
      <img src="${q.photo}" onclick="openLightbox('${q.photo}')" alt="–§–æ—Ç–æ –ø–∏—Ç–∞–Ω–Ω—è">
    </div>`;
  }

  let answersHtml = '';
  if (q.answerType === 'table') {
    const cols = q.tableData.columns;
    const rows = q.tableData.rows;
    answersHtml = `<div class="answer-table-wrapper"><table class="answer-table">
      <thead><tr>${cols.map(c => `<th>${c}</th>`).join('')}<th style="width:60px">–í–∏–±—ñ—Ä</th></tr></thead>
      <tbody>${rows.map((row, ri) => `<tr>${cols.map((c, ci) => `<td>${row[ci] || ''}</td>`).join('')}<td style="text-align:center"><div class="table-radio${answers[currentQ]?.value === ri ? ' checked' : ''}" onclick="selectTableAnswer(${ri})"></div></td></tr>`).join('')}</tbody>
    </table></div>`;
  } else {
    answersHtml = `<div class="quiz-answers">${q.options.map((o, i) => {
      const sel = answers[currentQ]?.type === 'choice' && answers[currentQ]?.value === i;
      return `<div class="answer-btn${sel ? ' selected' : ''}" onclick="selectAnswer(${i})">
        <div class="answer-letter">${letters[i] || i + 1}</div>
        <div>${o.text}</div>
      </div>`;
    }).join('')}</div>`;
  }

  const hasFree = q.allowFree;
  const freeActive = answers[currentQ]?.type === 'free';
  const freeVal = freeActive ? answers[currentQ]?.value : '';

  document.getElementById('quizContainer').innerHTML = `
    <div class="quiz-progress-bar">
      <div class="quiz-progress-fill" style="width:${progress}%"></div>
    </div>
    <div class="quiz-header">
      <div class="quiz-q-num">–ü–∏—Ç–∞–Ω–Ω—è ${currentQ + 1} –∑ ${total} ‚Ä¢ <span style="color:var(--primary)">${pps} –±.</span></div>
      <div class="quiz-timer" id="timerDisplay">${timeLeft}</div>
    </div>
    <div class="quiz-question">
      <h3>${q.text}</h3>
      ${qPhotoHtml}
    </div>
    ${answersHtml}
    ${hasFree ? `<div class="free-answer-area">
      <div class="free-answer-toggle${freeActive ? ' active' : ''}" onclick="toggleFreeAnswer()">‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç–∏ —Å–≤—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç</div>
      ${freeActive ? `<textarea class="free-input" id="freeInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å...">${freeVal}</textarea>` : ''}
    </div>` : ''}
    <div class="btn-group">
      ${currentQ > 0 ? '<button class="btn btn-secondary" onclick="prevQuestion()">‚Üê –ù–∞–∑–∞–¥</button>' : ''}
      <button class="btn btn-primary" onclick="nextQuestion()">${currentQ === total - 1 ? 'üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç–∏' : '–î–∞–ª—ñ ‚Üí'}</button>
    </div>
  `;

  startTimer();
}

function startTimer() {
  const el = () => document.getElementById('timerDisplay');
  timer = setInterval(() => {
    timeLeft--;
    const d = el();
    if (d) {
      d.textContent = timeLeft;
      if (timeLeft <= 10) d.classList.add('danger');
      else d.classList.remove('danger');
    }
    if (timeLeft <= 0) {
      clearInterval(timer);
      nextQuestion();
    }
  }, 1000);
}

window.selectAnswer = i => {
  answers[currentQ] = {type: 'choice', value: i};
  renderQuestion();
};

window.selectTableAnswer = i => {
  answers[currentQ] = {type: 'choice', value: i};
  renderQuestion();
};

window.toggleFreeAnswer = () => {
  if (answers[currentQ]?.type === 'free') {
    delete answers[currentQ];
  } else {
    answers[currentQ] = {type: 'free', value: ''};
  }
  renderQuestion();
};

window.prevQuestion = () => {
  if (currentQ > 0) {
    clearInterval(timer);
    currentQ--;
    renderQuestion();
  }
};

window.nextQuestion = () => {
  const fi = document.getElementById('freeInput');
  if (fi && answers[currentQ]?.type === 'free') {
    answers[currentQ].value = fi.value;
  }

  clearInterval(timer);

  if (currentQ >= currentTest.questions.length - 1) {
    finishQuiz();
  } else {
    currentQ++;
    renderQuestion();
  }
};

/* ===== FINISH QUIZ ===== */
function finishQuiz() {
  const t = currentTest;
  const total = t.questions.length;
  const pps = t.maxScore > 0 ? t.maxScore / total : 0;
  
  let score = 0;
  let details = [];
  let hasFreeAnswers = false;

  t.questions.forEach((q, i) => {
    const ans = answers[i];
    let d = {
      qText: q.text,
      answered: false,
      correct: false,
      points: 0,
      userAnswer: '',
      correctAnswer: '',
      isFree: false,
      status: 'wrong'
    };

    let correctIdx = -1;

    if (q.answerType === 'table') {
      correctIdx = q.tableData.correctRowIndex;
      const rows = q.tableData.rows;
      const cols = q.tableData.columns;
      d.correctAnswer = correctIdx >= 0 ? rows[correctIdx].join(' | ') : '‚Äî';
    } else {
      correctIdx = q.options.findIndex(o => o.correct);
      d.correctAnswer = correctIdx >= 0 ? q.options[correctIdx].text : '‚Äî';
    }

    if (!ans) {
      d.userAnswer = '–ë–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ';
      d.status = 'wrong';
    } else if (ans.type === 'choice') {
      if (q.answerType === 'table') {
        const rows = q.tableData.rows;
        d.userAnswer = rows[ans.value] ? rows[ans.value].join(' | ') : '‚Äî';
      } else {
        d.userAnswer = q.options[ans.value]?.text || '‚Äî';
      }
      d.answered = true;
      
      if (ans.value === correctIdx) {
        d.correct = true;
        d.points = pps;
        score += pps;
        d.status = 'correct';
      } else {
        d.status = 'wrong';
      }
    } else if (ans.type === 'free') {
      d.userAnswer = ans.value || '–ü–æ—Ä–æ–∂–Ω—å–æ';
      d.answered = true;
      d.isFree = true;
      d.status = 'pending';
      hasFreeAnswers = true;
    }

    details.push(d);
  });

  score = Math.round(score * 100) / 100;
  const needsReview = hasFreeAnswers;
  const status = needsReview ? 'pending' : 'auto';

  const result = {
    id: genId(),
    testId: t.id,
    testName: t.name,
    userId: ME.uid,
    userName: ME.name,
    score,
    maxScore: t.maxScore,
    passScore: t.passScore,
    details,
    date: now(),
    status,
    reviewer: needsReview ? null : 'SYSTEM',
    reviewedByHuman: false
  };

  results.push(result);
  save();

  if (!needsReview) {
    if (score >= t.passScore) {
      addNotif(`‚úÖ –Ü—Å–ø–∏—Ç "${t.name}" –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ: ${score}/${t.maxScore}. –û—á—ñ–∫—É–π—Ç–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ª—é–¥–∏–Ω–æ—é.`);
    } else {
      addNotif(`‚ùå –Ü—Å–ø–∏—Ç "${t.name}" –Ω–µ —Å–∫–ª–∞–¥–µ–Ω–æ: ${score}/${t.maxScore}. –û—á—ñ–∫—É–π—Ç–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ª—é–¥–∏–Ω–æ—é.`);
    }
  } else {
    addNotif(`‚è≥ –Ü—Å–ø–∏—Ç "${t.name}" –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É`);
  }

  renderResult(result);
  showView('result');
}

/* ===== RESULT ===== */
function renderResult(r) {
  const t = tests.find(x => x.id === r.testId);
  const passScore = t ? t.passScore : 0;
  const isPending = r.status === 'pending' || (r.status === 'auto' && !r.reviewedByHuman);
  const passed = !isPending && r.score >= passScore && r.reviewedByHuman;

  let detailsHtml = r.details.map((d, i) => {
    let markClass = d.status === 'correct' ? 'ok' : d.status === 'pending' ? 'pend' : 'no';
    let markIcon = d.status === 'correct' ? '‚úì' : d.status === 'pending' ? '?' : '‚úó';
    let pointsText = d.status === 'correct' ? `+${Math.round(d.points * 10) / 10} –±.` : d.status === 'pending' ? '–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ' : '0 –±.';

    return `<div class="result-detail">
      <div class="mark ${markClass}">${markIcon}</div>
      <div style="flex:1">
        <div style="font-size:13px;font-weight:700;margin-bottom:4px;word-wrap:break-word">${i + 1}. ${d.qText}</div>
        <div style="font-size:12px;color:var(--text-light);word-wrap:break-word">–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: <b>${d.userAnswer}</b></div>
        ${d.status !== 'pending' ? `<div style="font-size:11px;color:var(--primary);margin-top:2px;word-wrap:break-word">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${d.correctAnswer}</div>` : ''}
        <div style="font-size:11px;font-weight:800;color:${d.status === 'correct' ? 'var(--primary)' : d.status === 'pending' ? 'var(--warning)' : 'var(--danger)'};margin-top:3px">${pointsText}</div>
      </div>
    </div>`;
  }).join('');

  const el = document.getElementById('resultScreen');
  el.innerHTML = `
    <div class="result-circle ${isPending ? '' : passed ? 'pass' : 'fail'}">
      <div class="result-score" style="color:${isPending ? 'var(--warning)' : passed ? 'var(--primary)' : 'var(--danger)'}">${r.score}</div>
      <div class="result-max">–∑ ${r.maxScore} –±–∞–ª—ñ–≤</div>
    </div>
    <div class="result-status ${isPending ? '' : passed ? 'pass' : 'fail'}">${isPending ? '‚è≥ –ù–ê –ü–ï–†–ï–í–Ü–†–¶–Ü' : passed ? '‚úÖ –Ü–°–ü–ò–¢ –°–ö–õ–ê–î–ï–ù–û' : '‚ùå –ù–ï –°–ö–õ–ê–î–ï–ù–û'}</div>
    <p style="color:var(--text-gray);font-size:13px;margin-bottom:25px">${isPending ? '–û—á—ñ–∫—É–π—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ª—é–¥–∏–Ω–æ—é' : '–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª: ' + passScore + ' –±–∞–ª—ñ–≤'}</p>
    <div style="text-align:left">${detailsHtml}</div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="startIntro('${r.testId}')" ${isPending ? 'disabled' : ''} style="${isPending ? 'opacity:0.5;cursor:not-allowed' : ''}">
        ${isPending ? '‚è≥ –û—á—ñ–∫—É–π—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏' : 'üîÑ –ü—Ä–æ–π—Ç–∏ –∑–Ω–æ–≤—É'}
      </button>
      <button class="btn btn-secondary" onclick="showView('home')">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</button>
    </div>
  `;
}

/* ===== CREATE / EDIT ===== */
function renderCreateForm(testData) {
  editingTestId = testData ? testData.id : null;
  document.getElementById('createTitle').innerHTML = editingTestId ? '‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —ñ—Å–ø–∏—Ç' : '‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ—Å–ø–∏—Ç';

  const t = testData || {
    name: '',
    description: '',
    emoji: 'üìù',
    maxScore: 12,
    passScore: 8,
    questions: [],
    photos: [],
    agreementText: '–Ø –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–∏–π –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —ñ—Å–ø–∏—Ç—É —Ç–∞ –∑–æ–±–æ–≤\'—è–∑—É—é—Å—å –¥–æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏—Å—å —ó—Ö.'
  };

  currentTestPhotos = t.photos || [];
  
  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –º–∞—Å–∏–≤ —Ñ–æ—Ç–æ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–Ω—è
  currentQuestionPhotos = (t.questions || []).map(q => q.photo || null);

  const qs = t.questions.length > 0 ? t.questions : [{
    text: '',
    options: [{text: '', correct: false}, {text: '', correct: false}, {text: '', correct: false}, {text: '', correct: false}],
    allowFree: false,
    timeLimit: 30,
    answerType: 'normal',
    photo: null
  }];

  let photosHtml = '';
  if (currentTestPhotos.length > 0) {
    photosHtml = `<div class="test-photo-grid">
      ${currentTestPhotos.map((photo, pi) => `
        <div class="test-photo-item">
          <img src="${photo.url}" alt="–§–æ—Ç–æ ${pi + 1}">
          <button class="photo-delete-mini" onclick="deleteTestPhoto(${pi})">‚úï</button>
        </div>
      `).join('')}
    </div>`;
  }

  let qBlocks = qs.map((q, qi) => {
    // –§–æ—Ç–æ –ø–∏—Ç–∞–Ω–Ω—è
    let qPhotoHtml = '';
    if (q.photo) {
      qPhotoHtml = `<div class="question-photo-section">
        <div class="question-photo-preview">
          <img src="${q.photo}" alt="–§–æ—Ç–æ –ø–∏—Ç–∞–Ω–Ω—è">
          <button class="question-photo-delete" onclick="deleteQuestionPhoto(${qi})">‚úï</button>
        </div>
      </div>`;
    } else {
      qPhotoHtml = `<div class="question-photo-section">
        <input type="file" id="qPhotoInput-${qi}" accept="image/*" style="display:none" onchange="handleQuestionPhoto(this, ${qi})">
        <button class="add-question-photo-btn" onclick="document.getElementById('qPhotoInput-${qi}').click()">üì∑ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –¥–æ –ø–∏—Ç–∞–Ω–Ω—è</button>
      </div>`;
    }

    let opts = '';
    if (q.answerType === 'table') {
      const cols = q.tableData?.columns || [];
      const rows = q.tableData?.rows || [];
      const correctRow = q.tableData?.correctRowIndex || 0;
      
      opts = `<div class="table-builder">
        <div style="font-size:11px;font-weight:700;color:var(--primary);margin-bottom:8px">–°–¢–û–í–ü–¶–Ü –¢–ê–ë–õ–ò–¶–Ü</div>
        <div class="table-builder-head" id="tableCols-${qi}">
          ${cols.map((c, ci) => `<input class="table-col-input" placeholder="–°—Ç–æ–≤–ø–µ—Ü—å ${ci + 1}" value="${c}" data-qi="${qi}" data-ci="${ci}">`).join('')}
        </div>
        <button class="add-opt-btn" onclick="addTableColumn(${qi})" style="margin-bottom:10px">+ –î–æ–¥–∞—Ç–∏ —Å—Ç–æ–≤–ø–µ—Ü—å</button>
        <div style="font-size:11px;font-weight:700;color:var(--primary);margin-bottom:8px">–†–Ø–î–ö–ò –¢–ê–ë–õ–ò–¶–Ü</div>
        <div class="table-builder-rows" id="tableRows-${qi}">
          ${rows.map((row, ri) => `<div class="table-row-builder">
            <div class="opt-radio${ri === correctRow ? ' checked' : ''}" onclick="toggleTableCorrect(${qi},${ri})"></div>
            ${cols.map((c, ci) => `<input class="table-cell-input" placeholder="${c}" value="${row[ci] || ''}" data-qi="${qi}" data-ri="${ri}" data-ci="${ci}">`).join('')}
            <button class="opt-del" onclick="delTableRow(${qi},${ri})">‚úï</button>
          </div>`).join('')}
        </div>
        <button class="add-opt-btn" onclick="addTableRow(${qi})">+ –î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫</button>
      </div>`;
    } else {
      opts = q.options.map((o, oi) => `<div class="opt-row">
        <div class="opt-radio${o.correct ? ' checked' : ''}" onclick="toggleCorrect(${qi},${oi})"></div>
        <input class="opt-input" placeholder="–í–∞—Ä—ñ–∞–Ω—Ç ${letters[oi] || oi + 1}" value="${o.text.replace(/"/g, '&quot;')}" data-qi="${qi}" data-oi="${oi}">
        <button class="opt-del" onclick="delOption(${qi},${oi})">‚úï</button>
      </div>`).join('');
      opts += `<button class="add-opt-btn" onclick="addOption(${qi})">+ –î–æ–¥–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç</button>`;
    }

    return `<div class="q-block" id="qblock-${qi}">
      <div class="q-block-head">
        <span class="q-num">–ü–∏—Ç–∞–Ω–Ω—è ${qi + 1}</span>
        <button class="q-del" onclick="delQuestion(${qi})">üóë</button>
      </div>
      <textarea class="form-input" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Ç–∞–Ω–Ω—è..." id="qtext-${qi}" style="margin-bottom:12px;min-height:80px;resize:vertical">${q.text.replace(/"/g, '&quot;')}</textarea>
      ${qPhotoHtml}
      <div style="margin-bottom:10px">
        <label class="form-label">–ß–∞—Å –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è (—Å–µ–∫—É–Ω–¥)</label>
        <input class="form-input" type="number" id="qtime-${qi}" value="${q.timeLimit || 30}" min="5" max="600">
      </div>
      <div class="table-toggle-create" onclick="toggleTableMode(${qi})">
        <div class="toggle-switch${q.answerType === 'table' ? '
                                   ' on' : ''}" id="tableSwitch-${qi}"></div>
        –†–µ–∂–∏–º —Ç–∞–±–ª–∏—Ü—ñ
      </div>
      <div id="opts-${qi}" style="margin-top:12px">${opts}</div>
      <div class="free-toggle-create" onclick="toggleFreeCreate(${qi})">
        <div class="toggle-switch${q.allowFree ? ' on' : ''}" id="freeSwitch-${qi}"></div>
        –î–æ–∑–≤–æ–ª–∏—Ç–∏ –≤—ñ–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
      </div>
    </div>`;
  }).join('');

  document.getElementById('createForm').innerHTML = `
    <div class="form-card">
      <div class="form-row-inline">
        <div class="form-row">
          <label class="form-label">–ù–∞–∑–≤–∞ —ñ—Å–ø–∏—Ç—É</label>
          <input class="form-input" id="testName" value="${t.name.replace(/"/g, '&quot;')}" placeholder="–ù–∞–∑–≤–∞...">
        </div>
        <div class="form-row">
          <label class="form-label">–ï–º–æ–¥–∑—ñ</label>
          <input class="form-input" id="testEmoji" value="${t.emoji}" placeholder="üìù" style="text-align:center;font-size:24px">
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">–û–ø–∏—Å</label>
        <textarea class="form-input" id="testDesc" rows="2" placeholder="–û–ø–∏—Å —ñ—Å–ø–∏—Ç—É...">${t.description || ''}</textarea>
      </div>
      <div class="form-row-inline">
        <div class="form-row">
          <label class="form-label">–ú–∞–∫—Å. –±–∞–ª</label>
          <input class="form-input" id="testMaxScore" type="number" value="${t.maxScore}" min="1">
        </div>
        <div class="form-row">
          <label class="form-label">–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª</label>
          <input class="form-input" id="testPassScore" type="number" value="${t.passScore}" min="0">
        </div>
      </div>
      <div class="form-hint" id="scoreHint">üíé –ó–∞ –∫–æ–∂–Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è: ${qs.length > 0 ? Math.round(t.maxScore / qs.length * 100) / 100 : 0} –±–∞–ª—ñ–≤</div>
    </div>

    <!-- –§–û–¢–û–ì–ê–õ–ï–†–ï–Ø -->
    <div class="form-card test-photos-section">
      <h4 style="font-size:13px;font-weight:800;color:var(--primary-bright);margin-bottom:12px">üì∏ –§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è —Ç–µ—Å—Ç—É</h4>
      <p style="font-size:11px;color:var(--text-gray);margin-bottom:15px">–î–æ–¥–∞–π—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è, —è–∫—ñ –±—É–¥—É—Ç—å –ø–æ–∫–∞–∑–∞–Ω—ñ –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º —ñ—Å–ø–∏—Ç—É</p>
      ${photosHtml}
      <input type="file" id="testPhotoInput" accept="image/*" style="display:none" onchange="handleTestPhoto(this)">
      <button class="upload-photo-btn" onclick="document.getElementById('testPhotoInput').click()">üì∑ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</button>
    </div>

    <!-- –ö–û–†–ò–°–¢–£–í–ê–¶–¨–ö–ê –£–ì–û–î–ê -->
    <div class="form-card">
      <h4 style="font-size:13px;font-weight:800;color:var(--primary-bright);margin-bottom:12px">üìú –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∞ —É–≥–æ–¥–∞</h4>
      <p style="font-size:11px;color:var(--text-gray);margin-bottom:10px">–¢–µ–∫—Å—Ç, —è–∫–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ–≤–∏–Ω–µ–Ω –ø—Ä–∏–π–Ω—è—Ç–∏ –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º</p>
      <textarea class="form-input" id="agreementText" rows="3" placeholder="–Ø –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–∏–π –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏...">${t.agreementText || ''}</textarea>
    </div>

    <div class="section-title">üìã –ü–∏—Ç–∞–Ω–Ω—è</div>
    <div id="questionsContainer">${qBlocks}</div>
    <button class="btn btn-secondary" onclick="addQuestion()" style="width:100%;margin-bottom:20px">+ –î–æ–¥–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è</button>

    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveTest()">üíæ ${editingTestId ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ—Å–ø–∏—Ç'}</button>
      <button class="btn btn-secondary" onclick="showView('home')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
  `;

  document.getElementById('testMaxScore').addEventListener('input', updateScoreHint);
}

function updateScoreHint() {
  const ms = parseInt(document.getElementById('testMaxScore').value) || 0;
  const cnt = document.querySelectorAll('.q-block').length;
  document.getElementById('scoreHint').textContent = `üíé –ó–∞ –∫–æ–∂–Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è: ${cnt > 0 ? Math.round(ms / cnt * 100) / 100 : 0} –±–∞–ª—ñ–≤`;
}

/* ===== PHOTO HANDLING ===== */
window.handleTestPhoto = input => {
  if (input.files && input.files[0]) {
    processTestImage(input.files[0]);
  }
};

function processTestImage(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height, max = 800;
      if (w > h) {
        if (w > max) { h *= max / w; w = max; }
      } else {
        if (h > max) { w *= max / h; h = max; }
      }
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      const base64 = canvas.toDataURL('image/jpeg', 0.7);
      
      currentTestPhotos.push({url: base64});
      renderCreateForm({
        name: document.getElementById('testName').value,
        description: document.getElementById('testDesc').value,
        emoji: document.getElementById('testEmoji').value,
        maxScore: parseInt(document.getElementById('testMaxScore').value),
        passScore: parseInt(document.getElementById('testPassScore').value),
        photos: currentTestPhotos,
        agreementText: document.getElementById('agreementText').value,
        questions: getFormQuestions()
      });
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

window.deleteTestPhoto = pi => {
  currentTestPhotos.splice(pi, 1);
  renderCreateForm({
    name: document.getElementById('testName').value,
    description: document.getElementById('testDesc').value,
    emoji: document.getElementById('testEmoji').value,
    maxScore: parseInt(document.getElementById('testMaxScore').value),
    passScore: parseInt(document.getElementById('testPassScore').value),
    photos: currentTestPhotos,
    agreementText: document.getElementById('agreementText').value,
    questions: getFormQuestions()
  });
};

/* ===== QUESTION PHOTO HANDLING ===== */
window.handleQuestionPhoto = (input, qi) => {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height, max = 600;
        if (w > h) {
          if (w > max) { h *= max / w; w = max; }
        } else {
          if (h > max) { w *= max / h; h = max; }
        }
        canvas.width = w;
        canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        const base64 = canvas.toDataURL('image/jpeg', 0.7);
        
        const qs = getFormQuestions();
        qs[qi].photo = base64;
        
        renderCreateForm({
          name: document.getElementById('testName').value,
          description: document.getElementById('testDesc').value,
          emoji: document.getElementById('testEmoji').value,
          maxScore: parseInt(document.getElementById('testMaxScore').value),
          passScore: parseInt(document.getElementById('testPassScore').value),
          photos: currentTestPhotos,
          agreementText: document.getElementById('agreementText').value,
          questions: qs
        });
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
  }
};

window.deleteQuestionPhoto = qi => {
  const qs = getFormQuestions();
  qs[qi].photo = null;
  
  renderCreateForm({
    name: document.getElementById('testName').value,
    description: document.getElementById('testDesc').value,
    emoji: document.getElementById('testEmoji').value,
    maxScore: parseInt(document.getElementById('testMaxScore').value),
    passScore: parseInt(document.getElementById('testPassScore').value),
    photos: currentTestPhotos,
    agreementText: document.getElementById('agreementText').value,
    questions: qs
  });
};

/* ===== QUESTION BUILDER ===== */
function getFormQuestions() {
  const blocks = document.querySelectorAll('.q-block');
  let qs = [];
  
  blocks.forEach((b, qi) => {
    const text = document.getElementById('qtext-' + qi)?.value || '';
    const timeLimit = parseInt(document.getElementById('qtime-' + qi)?.value) || 30;
    const tableMode = document.getElementById('tableSwitch-' + qi)?.classList.contains('on') || false;
    
    let opts = [];
    let tableData = null;

    if (tableMode) {
      const colInputs = document.querySelectorAll(`#tableCols-${qi} .table-col-input`);
      const cols = Array.from(colInputs).map(inp => inp.value);
      const rowDivs = document.querySelectorAll(`#tableRows-${qi} .table-row-builder`);
      const rows = [];
      let correctRowIndex = 0;
      
      rowDivs.forEach((div, ri) => {
        const radio = div.querySelector('.opt-radio');
        if (radio.classList.contains('checked')) correctRowIndex = ri;
        const cells = div.querySelectorAll('.table-cell-input');
        rows.push(Array.from(cells).map(c => c.value));
      });
      
      tableData = {columns: cols, rows, correctRowIndex};
    } else {
      const optRows = b.querySelectorAll('.opt-row');
      optRows.forEach((r, oi) => {
        const inp = r.querySelector('.opt-input');
        const radio = r.querySelector('.opt-radio');
        opts.push({text: inp.value, correct: radio.classList.contains('checked')});
      });
    }

    const sw = document.getElementById('freeSwitch-' + qi);
    
    // –û—Ç—Ä–∏–º—É—î–º–æ —Ñ–æ—Ç–æ –ø–∏—Ç–∞–Ω–Ω—è –∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –º–∞—Å–∏–≤—É –∞–±–æ –∑ DOM
    let qPhoto = null;
    const existingPhoto = b.querySelector('.question-photo-preview img');
    if (existingPhoto) {
      qPhoto = existingPhoto.src;
    }
    
    qs.push({
      text,
      options: opts,
      allowFree: sw?.classList.contains('on') || false,
      timeLimit,
      answerType: tableMode ? 'table' : 'normal',
      tableData,
      photo: qPhoto
    });
  });

  return qs;
}

window.toggleCorrect = (qi, oi) => {
  const qs = getFormQuestions();
  qs[qi].options.forEach((o, i) => o.correct = i === oi);
  rebuildQuestions(qs);
};

window.delOption = (qi, oi) => {
  const qs = getFormQuestions();
  qs[qi].options.splice(oi, 1);
  rebuildQuestions(qs);
};

window.addOption = qi => {
  const qs = getFormQuestions();
  qs[qi].options.push({text: '', correct: false});
  rebuildQuestions(qs);
};

window.delQuestion = qi => {
  const qs = getFormQuestions();
  qs.splice(qi, 1);
  rebuildQuestions(qs);
  updateScoreHint();
};

window.addQuestion = () => {
  const qs = getFormQuestions();
  qs.push({
    text: '',
    options: [{text: '', correct: false}, {text: '', correct: false}, {text: '', correct: false}, {text: '', correct: false}],
    allowFree: false,
    timeLimit: 30,
    answerType: 'normal',
    photo: null
  });
  rebuildQuestions(qs);
  updateScoreHint();
};

window.toggleFreeCreate = qi => {
  const qs = getFormQuestions();
  qs[qi].allowFree = !qs[qi].allowFree;
  rebuildQuestions(qs);
};

window.toggleTableMode = qi => {
  const qs = getFormQuestions();
  if (qs[qi].answerType === 'table') {
    qs[qi].answerType = 'normal';
    qs[qi].tableData = null;
    if (qs[qi].options.length === 0) {
      qs[qi].options = [{text: '', correct: false}, {text: '', correct: false}, {text: '', correct: false}, {text: '', correct: false}];
    }
  } else {
    qs[qi].answerType = 'table';
    qs[qi].tableData = {columns: ['–ö–æ–¥', '–û–ø–∏—Å'], rows: [['', ''], ['', '']], correctRowIndex: 0};
    qs[qi].options = [];
  }
  rebuildQuestions(qs);
};

window.addTableColumn = qi => {
  const qs = getFormQuestions();
  qs[qi].tableData.columns.push('');
  qs[qi].tableData.rows.forEach(r => r.push(''));
  rebuildQuestions(qs);
};

window.addTableRow = qi => {
  const qs = getFormQuestions();
  const colCount = qs[qi].tableData.columns.length;
  qs[qi].tableData.rows.push(new Array(colCount).fill(''));
  rebuildQuestions(qs);
};

window.delTableRow = (qi, ri) => {
  const qs = getFormQuestions();
  qs[qi].tableData.rows.splice(ri, 1);
  if (qs[qi].tableData.correctRowIndex >= qs[qi].tableData.rows.length) {
    qs[qi].tableData.correctRowIndex = Math.max(0, qs[qi].tableData.rows.length - 1);
  }
  rebuildQuestions(qs);
};

window.toggleTableCorrect = (qi, ri) => {
  const qs = getFormQuestions();
  qs[qi].tableData.correctRowIndex = ri;
  rebuildQuestions(qs);
};

function rebuildQuestions(qs) {
  const currentData = {
    name: document.getElementById('testName').value,
    description: document.getElementById('testDesc').value,
    emoji: document.getElementById('testEmoji').value,
    maxScore: parseInt(document.getElementById('testMaxScore').value),
    passScore: parseInt(document.getElementById('testPassScore').value),
    photos: currentTestPhotos,
    agreementText: document.getElementById('agreementText').value,
    questions: qs
  };
  
  renderCreateForm(currentData);
}

/* ===== SAVE TEST ===== */
window.saveTest = async () => {
  const name = document.getElementById('testName').value.trim();
  const desc = document.getElementById('testDesc').value.trim();
  const emoji = document.getElementById('testEmoji').value.trim() || 'üìù';
  const maxScore = parseInt(document.getElementById('testMaxScore').value) || 12;
  const passScore = parseInt(document.getElementById('testPassScore').value) || 8;
  const agreementText = document.getElementById('agreementText').value.trim();
  const qs = getFormQuestions();

  if (!name) {
    alert('‚ùå –í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —ñ—Å–ø–∏—Ç—É!');
    return;
  }

  for (let i = 0; i < qs.length; i++) {
    if (!qs[i].text.trim()) {
      const el = document.getElementById('qblock-' + i);
      if (el) {
        el.classList.add('error');
        el.scrollIntoView({behavior: 'smooth', block: 'center'});
        setTimeout(() => el.classList.remove('error'), 2000);
      }
      alert(`‚ùå –ü–∏—Ç–∞–Ω–Ω—è ${i + 1} –Ω–µ –º–∞—î —Ç–µ–∫—Å—Ç—É!`);
      return;
    }

    if (qs[i].answerType === 'table') {
      if (!qs[i].tableData || qs[i].tableData.rows.length === 0) {
        alert(`‚ùå –ü–∏—Ç–∞–Ω–Ω—è ${i + 1}: –¥–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–∏–Ω —Ä—è–¥–æ–∫ —É —Ç–∞–±–ª–∏—Ü—é!`);
        return;
      }
    } else {
      const hasCorrect = qs[i].options.some(o => o.correct);
      if (!hasCorrect && !qs[i].allowFree) {
        alert(`‚ùå –ü–∏—Ç–∞–Ω–Ω—è ${i + 1}: –æ–±–µ—Ä—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞–±–æ —É–≤—ñ–º–∫–Ω—ñ—Ç—å –≤—ñ–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å!`);
        return;
      }
    }
  }

  const testObj = {
    name,
    description: desc,
    emoji,
    maxScore,
    passScore,
    questions: qs,
    photos: currentTestPhotos,
    agreementText,
    createdBy: ME.name
  };

  const success = await saveTestToFirebase(testObj);
  
  if (success) {
    alert('‚úÖ –Ü—Å–ø–∏—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
    editingTestId = null;
    currentTestPhotos = [];
    currentQuestionPhotos = [];
    showView('home');
  }
};

/* ===== REVIEW ===== */
function renderReview() {
  const pending = results.filter(r => r.status === 'pending' || (r.status === 'auto' && !r.reviewedByHuman));

  if (pending.length === 0) {
    document.getElementById('reviewList').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px">–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ ‚úì</div>';
    return;
  }

  document.getElementById('reviewList').innerHTML = pending.map(r => {
    const t = tests.find(x => x.id === r.testId);

    let questionsHtml = r.details.map((d, i) => {
      let cls = d.status === 'correct' ? 'auto-ok' : d.status === 'pending' ? 'pending' : 'auto-fail';
      let pts = d.status === 'correct' ? `<span class="q-points" style="color:var(--primary)">+${Math.round(d.points * 10) / 10} –±.</span>` :
                d.status === 'wrong' ? `<span class="q-points" style="color:var(--danger)">0 –±.</span>` :
                `<span class="q-points" style="color:var(--warning)">? –±. ‚Äî –ø–æ—Ç—Ä—ñ–±–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞</span>`;

      return `<div class="review-q ${cls}">
        <div class="q-title">${i + 1}. ${d.qText}</div>
        <div class="q-answer">–í—ñ–¥–ø–æ–≤—ñ–¥—å: <b>${d.userAnswer}</b></div>
        ${d.status !== 'pending' ? `<div class="q-correct">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${d.correctAnswer}</div>` : ''}
        <div>${pts}</div>
      </div>`;
    }).join('');

    const hasFreeQ = r.details.some(d => d.status === 'pending');

    return `<div class="review-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px">
        <div>
          <h3 style="font-size:16px;font-weight:800">${r.userName}</h3>
          <div style="font-size:12px;color:var(--text-gray)">${r.testName || '–Ü—Å–ø–∏—Ç'} ‚Ä¢ ${r.date}</div>
        </div>
        <div style="font-size:18px;font-weight:900;color:var(--primary)">${r.score} / ${r.maxScore} –±.</div>
      </div>
      ${questionsHtml}
      ${hasFreeQ ? `<div style="margin-top:15px;padding:15px;background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.15);border-radius:12px">
        <div style="font-size:12px;font-weight:800;color:var(--warning);margin-bottom:10px">‚ö†Ô∏è –í—ñ–ª—å–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</div>
        <div class="btn-group" style="margin-top:10px">
          <button class="btn btn-primary" onclick="approveResult('${r.id}')">‚úÖ –°—Ö–≤–∞–ª–∏—Ç–∏</button>
          <button class="btn btn-danger" onclick="rejectResult('${r.id}')">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
        </div>
      </div>` : `<div class="btn-group">
        <button class="btn btn-primary" onclick="approveResult('${r.id}')">‚úÖ –°—Ö–≤–∞–ª–∏—Ç–∏</button>
        <button class="btn btn-danger" onclick="rejectResult('${r.id}')">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
      </div>`}
    </div>`;
  }).join('');
}

window.approveResult = id => {
  const r = results.find(x => x.id === id);
  if (!r) return;
  
  const t = tests.find(x => x.id === r.testId);
  const pps = t ? t.maxScore / t.questions.length : 0;

  r.details.forEach(d => {
    if (d.status === 'pending') {
      d.status = 'correct';
      d.points = pps;
      r.score += pps;
    }
  });

  r.score = Math.round(r.score * 100) / 100;
  r.status = 'approved';
  r.reviewer = ME.name;
  r.reviewedByHuman = true;
  save();

  addNotif(`‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç ${r.userName} —Å—Ö–≤–∞–ª–µ–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–º ${ME.name}`);
  renderReview();
};

window.rejectResult = id => {
  const r = results.find(x => x.id === id);
  if (!r) return;

  r.details.forEach(d => {
    if (d.status === 'pending') {
      d.status = 'wrong';
      d.points = 0;
    }
  });

  r.status = 'rejected';
  r.reviewer = ME.name;
  r.reviewedByHuman = true;
  save();

  addNotif(`‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç ${r.userName} –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–º ${ME.name}`);
  renderReview();
};

/* ===== MANAGE ===== */
function renderManage() {
  if (tests.length === 0) {
    document.getElementById('manageList').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px">–ù–µ–º–∞—î —ñ—Å–ø–∏—Ç—ñ–≤</div>';
    return;
  }

  document.getElementById('manageList').innerHTML = tests.map(t => {
    const res = results.filter(r => r.testId === t.id);
    const passed = res.filter(r => (r.status === 'approved' || r.status === 'auto') && r.score >= t.passScore && r.reviewedByHuman).length;

    return `<div class="manage-card">
      <div>
        <b style="font-size:15px">${t.emoji} ${t.name}</b><br>
        <span style="font-size:11px;color:var(--text-gray)">–ü–∏—Ç–∞–Ω—å: ${t.questions.length} ‚Ä¢ –ú–∞–∫—Å: ${t.maxScore}–± ‚Ä¢ –ü—Ä–æ—Ö—ñ–¥: ${t.passScore}–± ‚Ä¢ –ü—Ä–æ–π—à–ª–∏: ${passed}/${res.length}</span>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-info" onclick="editTest('${t.id}')" style="padding:8px 14px;font-size:11px">‚úèÔ∏è</button>
        <button class="btn btn-warning" onclick="clearTestResults('${t.id}')" style="padding:8px 14px;font-size:11px">üßπ</button>
        <button class="btn btn-danger" onclick="deleteTest('${t.id}')" style="padding:8px 14px;font-size:11px">üóë</button>
      </div>
    </div>`;
  }).join('');
}

window.editTest = id => {
  const t = tests.find(x => x.id === id);
  if (t) {
    renderCreateForm(t);
    showView('create');
  }
};

window.clearTestResults = id => {
  if (confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ü—å–æ–≥–æ —ñ—Å–ø–∏—Ç—É?')) {
    results = results.filter(r => r.testId !== id);
    save();
    renderManage();
  }
};

window.deleteTest = async id => {
  if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å–ø–∏—Ç?')) {
    const success = await deleteTestFromFirebase(id);
    if (success) {
      renderManage();
    }
  }
};

/* ===== SETTINGS ===== */
function renderSettings() {
  document.getElementById('settingsContent').innerHTML = `
    <div class="setting-block">
      <h4>üîó Discord Webhook</h4>
      <div class="form-row">
        <input class="form-input" id="webhookInput" value="${webhookUrl}" placeholder="https://discord.com/api/webhooks/...">
      </div>
      <div class="btn-group" style="justify-content:flex-start">
        <button class="btn btn-primary" onclick="saveWebhook()" style="padding:10px 20px;font-size:12px">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <button class="btn btn-info" onclick="sendTestWebhook()" style="padding:10px 20px;font-size:12px">üß™ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</button>
      </div>
    </div>

    <div class="setting-block">
      <h4>üîç –ü–µ—Ä–µ–≤—ñ—Ä—é–≤–∞—á—ñ —ñ—Å–ø–∏—Ç—ñ–≤</h4>
      <div id="reviewersList" style="margin-bottom:12px">
        ${reviewers.map(r => `<span class="reviewer-chip">${r}<button onclick="removeReviewer('${r}')">‚úï</button></span>`).join('') || '<span style="color:var(--text-gray);font-size:12px">–ù–µ –¥–æ–¥–∞–Ω–æ</span>'}
      </div>
      <div class="people-dropdown">
        <input class="form-input" id="reviewerSearch" placeholder="–ü–æ—à—É–∫ –ª—é–¥–∏–Ω–∏..." oninput="filterPeople('reviewer')" onfocus="filterPeople('reviewer')">
        <div class="people-list" id="reviewerDropdown"></div>
      </div>
    </div>
  `;
}

window.saveWebhook = () => {
  webhookUrl = document.getElementById('webhookInput').value.trim();
  save();
  alert('‚úÖ Webhook –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
};

window.sendTestWebhook = async () => {
  const url = document.getElementById('webhookInput').value.trim();
  if (!url) {
    alert('‚ùå –í–≤–µ–¥—ñ—Ç—å Webhook URL —Å–ø–æ—á–∞—Ç–∫—É!');
    return;
  }

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        embeds: [{
          title: 'üß™ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è',
          description: 'Webhook –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ! ‚úÖ',
          color: 0x00ff44,
          fields: [
            {name: '–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫', value: ME.name, inline: true},
            {name: '–†–æ–ª—å', value: ME.role, inline: true},
            {name: '–ß–∞—Å', value: now(), inline: false}
          ],
          footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'}
        }]
      })
    });

    if (response.ok) {
      alert('‚úÖ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Discord!');
    } else {
      alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: ' + response.status);
    }
  } catch (e) {
    alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message);
  }
};

window.removeReviewer = n => {
  reviewers = reviewers.filter(r => r !== n);
  save();
  renderSettings();
};

window.filterPeople = type => {
  const input = document.getElementById(type + 'Search');
  const drop = document.getElementById(type + 'Dropdown');
  const val = input.value.toLowerCase();

  const list = type === 'reviewer' ? 
    allUsers.filter(u => !reviewers.includes(u.name)) : 
    allUsers.filter(u => !adminList.includes(u.name));

  const filtered = val ? list.filter(u => u.name.toLowerCase().includes(val)) : list;

  if (filtered.length === 0) {
    drop.innerHTML = '<div style="padding:15px;text-align:center;color:var(--text-gray);font-size:12px">–ù—ñ–∫–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
    drop.classList.add('show');
    return;
  }

  drop.innerHTML = filtered.map(u => {
    const roleLabel = u.role === 'admin' ? '–ê–¥–º—ñ–Ω' : u.role === 'instructor' ? '–Ü–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä' : '–ë—ñ—î—Ü—å';
    const roleColor = u.role === 'admin' ? 'var(--primary)' : u.role === 'instructor' ? 'var(--warning)' : 'var(--text-gray)';
    
    return `<div class="people-item" onclick="selectPerson('${type}','${u.name}')">
      <span>${u.name}</span>
      <span style="font-size:10px;color:${roleColor};font-weight:700">${roleLabel}</span>
    </div>`;
  }).join('');

  drop.classList.add('show');
};

window.selectPerson = (type, name) => {
  if (type === 'reviewer' && !reviewers.includes(name)) {
    reviewers.push(name);
    save();
    renderSettings();
  }
  if (type === 'admin' && !adminList.includes(name)) {
    adminList.push(name);
    save();
    renderAdminList();
    buildNav();
  }
  document.querySelectorAll('.people-list').forEach(d => d.classList.remove('show'));
};

document.addEventListener('click', e => {
  if (!e.target.closest('.people-dropdown')) {
    document.querySelectorAll('.people-list').forEach(d => d.classList.remove('show'));
  }
});

/* ===== ADMIN LIST ===== */
function renderAdminList() {
  document.getElementById('adminListContent').innerHTML = `
    <div class="admin-list-panel">
      <h4 style="font-size:13px;font-weight:800;color:var(--primary-bright);margin-bottom:15px">üëë –õ—é–¥–∏ –∑ –∞–¥–º—ñ–Ω –ø—Ä–∞–≤–∞–º–∏ –≤ —ñ—Å–ø–∏—Ç–∞—Ö</h4>
      <p style="font-size:11px;color:var(--text-gray);margin-bottom:15px">–¶—ñ –ª—é–¥–∏ –º–∞—é—Ç—å –ø–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è, —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —ñ—Å–ø–∏—Ç—ñ–≤</p>
      <div id="adminChips" style="margin-bottom:15px">
        ${adminList.map(n => `<span class="reviewer-chip" style="background:rgba(251,191,36,0.1);border-color:rgba(251,191,36,0.3);color:var(--warning)">${n}<button onclick="removeAdmin('${n}')">‚úï</button></span>`).join('') || '<span style="color:var(--text-gray);font-size:12px">–ù–µ –¥–æ–¥–∞–Ω–æ</span>'}
      </div>
      <div class="people-dropdown">
        <input class="form-input" id="adminSearch" placeholder="–ü–æ—à—É–∫ –ª—é–¥–∏–Ω–∏..." oninput="filterPeople('admin')" onfocus="filterPeople('admin')">
        <div class="people-list" id="adminDropdown"></div>
      </div>
    </div>
  `;
}

window.removeAdmin = n => {
  adminList = adminList.filter(a => a !== n);
  save();
  renderAdminList();
  buildNav();
};

/* ===== INIT ===== */
console.log('üöÄ –î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2.0 - –ì–æ—Ç–æ–≤–∏–π!');

/* ===== SECURITY ===== */
document.onkeydown = e => {
  if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && [73, 74, 67].includes(e.keyCode)) || (e.ctrlKey && e.keyCode === 85)) {
    return false;
  }
};

</script>
</body>
</html>
