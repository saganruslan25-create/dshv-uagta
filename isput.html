<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–î–®–í | –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
--primary: #00ff44;
--primary-bright: #e0ffe8;
--primary-glow: rgba(0,255,68,0.7);
--primary-dim: rgba(0,255,68,0.15);
--bg: #030507;
--card-bg: rgba(10,12,16,0.85);
--glass-border: rgba(0,255,68,0.3);
--danger: #ef4444;
--danger-glow: rgba(239,68,68,0.6);
--warning: #fbbf24;
--warning-glow: rgba(251,191,36,0.5);
--info: #3b82f6;
--info-glow: rgba(59,130,246,0.5);
--text-gray: #94a3b8;
--text-light: #cbd5e1;
--success: #10b981;
--card-hover: rgba(0,255,68,0.08);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
background: var(--bg);
color: white;
font-family: 'Inter', sans-serif;
min-height: 100vh;
overflow-x: hidden;
user-select: none;
-webkit-user-select: none;
}
body::before {
content: '';
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
background:
radial-gradient(ellipse at 15% 50%, rgba(0,255,68,0.18), transparent 55%),
radial-gradient(ellipse at 85% 20%, rgba(0,255,68,0.15), transparent 55%),
radial-gradient(ellipse at 50% 80%, rgba(0,255,68,0.12), transparent 55%);
pointer-events: none;
z-index: 0;
animation: bgPulse 10s ease-in-out infinite;
}
@keyframes bgPulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.75; }
}
input, textarea {
user-select: text !important;
-webkit-user-select: text !important;
}
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #0a0d12; }
::-webkit-scrollbar-thumb {
background: var(--primary);
border-radius: 10px;
box-shadow: 0 0 8px var(--primary);
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}
@keyframes slideDown {
from { opacity: 0; transform: translateY(-15px); }
to { opacity: 1; transform: translateY(0); }
}
@keyframes slideUp {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}
@keyframes pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}
@keyframes glow {
0%, 100% { box-shadow: 0 0 5px var(--primary-glow); }
50% { box-shadow: 0 0 25px var(--primary-glow), 0 0 50px rgba(0,255,68,0.2); }
}
@keyframes shake {
0%, 100% { transform: translateX(0); }
20%, 60% { transform: translateX(-8px); }
40%, 80% { transform: translateX(8px); }
}
header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 15px 5%;
background: rgba(3,5,7,0.9);
border-bottom: 1px solid var(--glass-border);
position: sticky;
top: 0;
z-index: 1000;
backdrop-filter: blur(20px);
}
header.hidden { display: none; }
.logo-box {
background: var(--primary);
color: black;
padding: 8px 16px;
border-radius: 10px;
font-weight: 900;
text-decoration: none;
font-size: 14px;
text-transform: uppercase;
box-shadow: 0 0 20px var(--primary-glow);
transition: 0.3s;
letter-spacing: 1px;
}
.logo-box:hover {
box-shadow: 0 0 30px var(--primary-glow);
transform: translateY(-2px);
}
.header-right {
display: flex;
align-items: center;
gap: 12px;
flex-wrap: wrap;
}
.user-name-header {
font-family: 'Inter', sans-serif;
font-weight: 700;
font-size: 13px;
color: var(--primary-bright);
letter-spacing: 0.3px;
}
.role-badge {
padding: 6px 14px;
border-radius: 8px;
font-size: 11px;
font-weight: 900;
text-transform: uppercase;
letter-spacing: 1px;
border: 1px solid;
}
.role-admin {
background: rgba(0,255,68,0.15);
color: var(--primary);
border-color: var(--primary);
box-shadow: 0 0 15px rgba(0,255,68,0.3);
}
.role-instructor {
background: rgba(251,191,36,0.15);
color: var(--warning);
border-color: var(--warning);
box-shadow: 0 0 15px rgba(251,191,36,0.3);
}
.role-fighter {
background: rgba(59,130,246,0.15);
color: var(--info);
border-color: var(--info);
box-shadow: 0 0 15px rgba(59,130,246,0.3);
}
.nav-tabs { display: flex; gap: 6px; flex-wrap: wrap; }
.nav-btn {
background: rgba(255,255,255,0.03);
border: 1px solid rgba(255,255,255,0.1);
color: var(--text-light);
padding: 10px 18px;
border-radius: 12px;
font-weight: 700;
cursor: pointer;
font-size: 12px;
position: relative;
overflow: hidden;
transition: all 0.3s ease;
text-transform: uppercase;
letter-spacing: 0.5px;
}
.nav-btn:hover {
border-color: var(--primary);
color: var(--primary-bright);
background: rgba(0,255,68,0.08);
transform: translateY(-2px);
}
.nav-btn.active {
background: var(--primary);
color: black;
border-color: var(--primary);
box-shadow: 0 0 20px var(--primary-glow);
font-weight: 900;
}
.main-wrap {
max-width: 1200px;
margin: 0 auto;
padding: 30px 20px;
}
.view {
display: none;
animation: fadeIn 0.5s ease;
}
.view.active { display: block; }
.stats-row {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 15px;
margin-bottom: 30px;
}
.stat-card {
background: var(--card-bg);
border: 1px solid rgba(0,255,68,0.15);
border-radius: 16px;
padding: 22px;
text-align: center;
backdrop-filter: blur(10px);
transition: all 0.3s ease;
}
.stat-card:hover {
border-color: var(--primary);
transform: translateY(-3px);
box-shadow: 0 8px 30px rgba(0,255,68,0.15);
}
.stat-num {
font-size: 32px;
font-weight: 900;
color: var(--primary);
text-shadow: 0 0 15px var(--primary-glow);
margin-bottom: 4px;
}
.stat-label {
font-size: 10px;
font-weight: 700;
color: var(--text-gray);
text-transform: uppercase;
letter-spacing: 1.5px;
}
.section-title {
font-size: 18px;
font-weight: 900;
color: var(--primary-bright);
margin-bottom: 20px;
display: flex;
align-items: center;
gap: 10px;
text-transform: uppercase;
letter-spacing: 1px;
}
.tests-grid {
display: flex;
flex-wrap: wrap;
justify-content: center;
gap: 20px;
margin-bottom: 40px;
}
.test-card {
background: var(--card-bg);
border: 1px solid rgba(0,255,68,0.15);
border-radius: 20px;
padding: 28px;
width: 320px;
backdrop-filter: blur(10px);
transition: all 0.4s ease;
cursor: pointer;
position: relative;
}
.test-card:hover {
border-color: var(--primary);
transform: translateY(-5px);
box-shadow: 0 10px 40px rgba(0,255,68,0.2);
}
.test-card .emoji {
font-size: 48px;
margin-bottom: 15px;
display: block;
}
.test-card h3 {
font-size: 17px;
font-weight: 800;
margin-bottom: 8px;
color: white;
}
.test-card p {
font-size: 12px;
color: var(--text-gray);
margin-bottom: 15px;
line-height: 1.5;
}
.test-meta {
display: flex;
gap: 8px;
flex-wrap: wrap;
}
.meta-tag {
font-size: 10px;
padding: 5px 10px;
border-radius: 8px;
font-weight: 700;
background: rgba(0,255,68,0.1);
color: var(--primary);
border: 1px solid rgba(0,255,68,0.2);
}
.context-menu {
position: fixed;
background: rgba(10, 15, 25, 0.98);
border: 1px solid var(--glass-border);
border-radius: 12px;
padding: 8px;
min-width: 220px;
z-index: 2000;
display: none;
backdrop-filter: blur(20px);
box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
animation: slideDown 0.2s ease;
}
.context-menu.active { display: block; }
.context-menu-item {
padding: 12px 16px;
cursor: pointer;
border-radius: 8px;
font-size: 13px;
font-weight: 600;
display: flex;
align-items: center;
gap: 10px;
transition: all 0.2s ease;
color: var(--text-light);
}
.context-menu-item:hover {
background: rgba(0, 255, 68, 0.1);
color: var(--primary-bright);
transform: translateX(3px);
}
.context-menu-item.danger:hover {
background: rgba(239, 68, 68, 0.1);
color: var(--danger);
}
.context-menu-item.warning:hover {
background: rgba(251, 191, 36, 0.1);
color: var(--warning);
}
.context-menu-divider {
height: 1px;
background: rgba(255, 255, 255, 0.1);
margin: 6px 0;
}
.public-link-copied {
position: fixed;
bottom: 30px;
right: 30px;
background: var(--primary);
color: black;
padding: 15px 25px;
border-radius: 12px;
font-weight: 800;
font-size: 13px;
z-index: 3000;
box-shadow: 0 10px 40px var(--primary-glow);
animation: slideUp 0.3s ease;
display: none;
}
.public-link-copied.show { display: block; }
.agreement-box {
background: rgba(251,191,36,0.05);
border: 1px solid rgba(251,191,36,0.3);
border-radius: 16px;
padding: 20px;
margin-bottom: 25px;
}
.agreement-check {
display: flex;
align-items: flex-start;
gap: 12px;
cursor: pointer;
user-select: none;
}
.agreement-check input[type="checkbox"] {
width: 22px;
height: 22px;
cursor: pointer;
accent-color: var(--primary);
flex-shrink: 0;
margin-top: 2px;
}
.agreement-text {
font-size: 13px;
color: var(--text-light);
line-height: 1.6;
user-select: text;
}
.agreement-text strong {
color: var(--warning);
font-weight: 800;
}
.public-form-card {
max-width: 500px;
margin: 40px auto;
background: var(--card-bg);
border: 1px solid var(--glass-border);
border-radius: 24px;
padding: 40px;
backdrop-filter: blur(10px);
}
.public-form-card h2 {
font-size: 22px;
font-weight: 900;
margin-bottom: 8px;
color: var(--primary-bright);
text-align: center;
}
.public-form-card .subtitle {
font-size: 13px;
color: var(--text-gray);
text-align: center;
margin-bottom: 30px;
}
.intro-card {
max-width: 600px;
margin: 40px auto;
background: var(--card-bg);
border: 1px solid var(--glass-border);
border-radius: 24px;
padding: 40px;
text-align: center;
backdrop-filter: blur(10px);
}
.intro-card .emoji {
font-size: 64px;
margin-bottom: 20px;
display: block;
}
.intro-card h2 {
font-size: 24px;
font-weight: 900;
margin-bottom: 10px;
}
.intro-card p {
color: var(--text-gray);
font-size: 13px;
margin-bottom: 8px;
}
.quiz-container {
max-width: 700px;
margin: 20px auto;
}
.quiz-progress-bar {
width: 100%;
height: 6px;
background: rgba(255,255,255,0.05);
border-radius: 10px;
margin-bottom: 25px;
overflow: hidden;
}
.quiz-progress-fill {
height: 100%;
background: linear-gradient(90deg, var(--primary), #00ff88);
border-radius: 10px;
transition: width 0.5s ease;
box-shadow: 0 0 10px var(--primary-glow);
}
.quiz-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
flex-wrap: wrap;
gap: 10px;
}
.quiz-timer {
font-size: 28px;
font-weight: 900;
color: var(--warning);
text-shadow: 0 0 15px var(--warning-glow);
}
.quiz-timer.danger {
color: var(--danger);
text-shadow: 0 0 15px var(--danger-glow);
animation: pulse 0.5s infinite;
}
.quiz-question {
background: var(--card-bg);
border: 1px solid var(--glass-border);
border-radius: 20px;
padding: 30px;
margin-bottom: 20px;
backdrop-filter: blur(10px);
}
.quiz-question h3 {
font-size: 18px;
font-weight: 800;
margin-bottom: 5px;
line-height: 1.6;
white-space: pre-wrap;
word-wrap: break-word;
}
.quiz-answers {
display: flex;
flex-direction: column;
gap: 10px;
margin-bottom: 20px;
}
.answer-btn {
background: rgba(255,255,255,0.03);
border: 2px solid rgba(255,255,255,0.08);
border-radius: 14px;
padding: 16px 20px;
color: white;
font-size: 14px;
font-weight: 600;
cursor: pointer;
text-align: left;
transition: all 0.3s ease;
display: flex;
align-items: center;
gap: 12px;
}
.answer-btn:hover {
border-color: var(--primary);
background: rgba(0,255,68,0.05);
transform: translateX(5px);
}
.answer-btn.selected {
border-color: var(--primary);
background: rgba(0,255,68,0.1);
box-shadow: 0 0 20px rgba(0,255,68,0.15);
}
.answer-letter {
width: 32px;
height: 32px;
border-radius: 10px;
background: rgba(255,255,255,0.05);
display: flex;
align-items: center;
justify-content: center;
font-weight: 900;
font-size: 13px;
color: var(--text-gray);
flex-shrink: 0;
border: 1px solid rgba(255,255,255,0.1);
transition: 0.3s;
}
.answer-btn.selected .answer-letter {
background: var(--primary);
color: black;
border-color: var(--primary);
box-shadow: 0 0 10px var(--primary-glow);
}
.btn {
padding: 14px 28px;
border: none;
border-radius: 14px;
font-weight: 800;
font-size: 13px;
cursor: pointer;
text-transform: uppercase;
letter-spacing: 0.5px;
transition: all 0.3s ease;
}
.btn:active { transform: scale(0.96); }
.btn-primary {
background: var(--primary);
color: black;
box-shadow: 0 4px 15px rgba(0,255,68,0.3);
}
.btn-primary:hover {
background: var(--primary-bright);
box-shadow: 0 6px 25px rgba(0,255,68,0.5);
transform: translateY(-2px);
}
.btn-primary:disabled {
opacity: 0.5;
cursor: not-allowed;
background: rgba(0,255,68,0.2);
}
.btn-secondary {
background: rgba(255,255,255,0.05);
border: 1px solid rgba(255,255,255,0.15);
color: white;
}
.btn-secondary:hover {
border-color: var(--primary);
color: var(--primary-bright);
background: rgba(0,255,68,0.08);
transform: translateY(-2px);
}
.btn-danger {
background: rgba(239,68,68,0.1);
border: 1px solid var(--danger);
color: var(--danger);
}
.btn-danger:hover {
background: var(--danger);
color: white;
transform: translateY(-2px);
box-shadow: 0 6px 20px var(--danger-glow);
}
.btn-warning {
background: rgba(251,191,36,0.1);
border: 1px solid var(--warning);
color: var(--warning);
}
.btn-warning:hover {
background: var(--warning);
color: black;
transform: translateY(-2px);
box-shadow: 0 6px 20px var(--warning-glow);
}
.btn-info {
background: rgba(59,130,246,0.1);
border: 1px solid var(--info);
color: var(--info);
}
.btn-info:hover {
background: var(--info);
color: white;
transform: translateY(-2px);
box-shadow: 0 6px 20px var(--info-glow);
}
.btn-group {
display: flex;
gap: 10px;
justify-content: center;
margin-top: 25px;
flex-wrap: wrap;
}
.form-card {
background: var(--card-bg);
border: 1px solid var(--glass-border);
border-radius: 20px;
padding: 30px;
backdrop-filter: blur(10px);
margin-bottom: 20px;
}
.form-row { margin-bottom: 18px; }
.form-label {
display: block;
font-size: 11px;
color: var(--primary);
margin-bottom: 8px;
text-transform: uppercase;
font-weight: 800;
letter-spacing: 1px;
}
.form-input {
width: 100%;
background: rgba(0,0,0,0.4);
border: 1px solid rgba(255,255,255,0.1);
color: white;
padding: 14px;
border-radius: 12px;
font-size: 14px;
outline: none;
font-family: inherit;
transition: 0.3s;
}
.form-input:focus {
border-color: var(--primary);
box-shadow: 0 0 15px rgba(0,255,68,0.15);
}
.form-row-inline {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 15px;
}
.form-hint {
font-size: 11px;
color: var(--text-gray);
margin-top: 8px;
font-weight: 600;
}
.result-detail {
background: var(--card-bg);
border: 1px solid rgba(255,255,255,0.05);
border-radius: 16px;
padding: 18px;
margin-bottom: 10px;
text-align: left;
display: flex;
align-items: flex-start;
gap: 12px;
}
.result-detail .mark {
width: 28px;
height: 28px;
border-radius: 8px;
display: flex;
align-items: center;
justify-content: center;
font-size: 14px;
flex-shrink: 0;
font-weight: 900;
}
.mark.ok {
background: rgba(0,255,68,0.15);
color: var(--primary);
}
.mark.no {
background: rgba(239,68,68,0.15);
color: var(--danger);
}
.mark.pend {
background: rgba(251,191,36,0.15);
color: var(--warning);
}
.result-circle {
width: 160px;
height: 160px;
border-radius: 50%;
margin: 0 auto 25px;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
border: 4px solid;
}
.result-circle.pass {
border-color: var(--primary);
box-shadow: 0 0 40px var(--primary-glow);
animation: glow 2s infinite;
}
.result-circle.fail {
border-color: var(--danger);
box-shadow: 0 0 40px var(--danger-glow);
}
.result-score {
font-size: 36px;
font-weight: 900;
}
.result-max {
font-size: 12px;
color: var(--text-gray);
font-weight: 700;
}
.result-status {
font-size: 28px;
font-weight: 900;
margin-bottom: 10px;
}
.result-status.pass {
color: var(--primary);
text-shadow: 0 0 20px var(--primary-glow);
}
.result-status.fail {
color: var(--danger);
text-shadow: 0 0 20px var(--danger-glow);
}
.results-table {
width: 100%;
border-collapse: collapse;
margin-top: 15px;
overflow-x: auto;
display: block;
}
.results-table table {
width: 100%;
min-width: 600px;
}
.results-table th {
text-align: left;
padding: 12px 15px;
font-size: 10px;
color: var(--primary);
text-transform: uppercase;
letter-spacing: 1px;
border-bottom: 2px solid var(--glass-border);
font-weight: 800;
}
.results-table td {
padding: 12px 15px;
font-size: 13px;
border-bottom: 1px solid rgba(255,255,255,0.04);
}
.results-table tr:hover td {
background: rgba(0,255,68,0.03);
}
.status-badge {
padding: 4px 12px;
border-radius: 8px;
font-size: 10px;
font-weight: 800;
text-transform: uppercase;
white-space: nowrap;
}
.st-pass {
background: rgba(16,185,129,0.15);
color: var(--success);
border: 1px solid rgba(16,185,129,0.3);
}
.st-fail {
background: rgba(239,68,68,0.15);
color: var(--danger);
border: 1px solid rgba(239,68,68,0.3);
}
.st-pending {
background: rgba(251,191,36,0.15);
color: var(--warning);
border: 1px solid rgba(251,191,36,0.3);
}
.st-approved {
background: rgba(0,255,68,0.15);
color: var(--primary);
border: 1px solid rgba(0,255,68,0.3);
}
.st-rejected {
background: rgba(239,68,68,0.15);
color: var(--danger);
border: 1px solid rgba(239,68,68,0.3);
}
.test-photo-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
gap: 12px;
margin-top: 15px;
}
.test-photo-item {
position: relative;
border-radius: 12px;
overflow: hidden;
cursor: zoom-in;
border: 1px solid rgba(255,255,255,0.1);
transition: 0.3s;
}
.test-photo-item:hover {
transform: scale(1.05);
border-color: var(--primary);
box-shadow: 0 0 20px rgba(0,255,68,0.3);
}
.test-photo-item img {
width: 100%;
height: 120px;
object-fit: cover;
}
.photo-delete-mini {
position: absolute;
top: 5px;
right: 5px;
background: rgba(239,68,68,0.9);
color: white;
border: none;
width: 24px;
height: 24px;
border-radius: 50%;
cursor: pointer;
font-size: 14px;
display: flex;
align-items: center;
justify-content: center;
font-weight: 900;
}
.upload-photo-btn {
background: rgba(0,255,68,0.1);
border: 2px dashed var(--primary);
color: var(--primary);
padding: 12px 24px;
border-radius: 12px;
cursor: pointer;
font-weight: 700;
font-size: 13px;
transition: 0.3s;
margin-top: 15px;
width: 100%;
}
.upload-photo-btn:hover {
background: rgba(0,255,68,0.2);
transform: translateY(-2px);
}
.question-photo-section {
margin-top: 12px;
margin-bottom: 12px;
}
.question-photo-preview {
position: relative;
display: inline-block;
border-radius: 12px;
overflow: hidden;
border: 1px solid rgba(0,255,68,0.2);
}
.question-photo-preview img {
width: 200px;
height: 150px;
object-fit: cover;
display: block;
cursor: zoom-in;
}
.question-photo-delete {
position: absolute;
top: 8px;
right: 8px;
background: rgba(239,68,68,0.95);
color: white;
border: none;
width: 28px;
height: 28px;
border-radius: 50%;
cursor: pointer;
font-size: 16px;
display: flex;
align-items: center;
justify-content: center;
font-weight: 900;
}
.add-question-photo-btn {
background: rgba(0,255,68,0.08);
border: 1px dashed rgba(0,255,68,0.3);
color: var(--primary);
padding: 8px 16px;
border-radius: 10px;
cursor: pointer;
font-size: 12px;
font-weight: 700;
transition: 0.3s;
}
.add-question-photo-btn:hover {
background: rgba(0,255,68,0.15);
border-color: var(--primary);
}
.quiz-question-photo {
margin-top: 15px;
margin-bottom: 15px;
text-align: center;
}
.quiz-question-photo img {
max-width: 100%;
max-height: 300px;
border-radius: 12px;
border: 1px solid rgba(0,255,68,0.2);
cursor: zoom-in;
transition: 0.3s;
}
.quiz-question-photo img:hover {
transform: scale(1.02);
border-color: var(--primary);
box-shadow: 0 0 20px rgba(0,255,68,0.3);
}
.lightbox {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.95);
z-index: 3000;
display: none;
justify-content: center;
align-items: center;
backdrop-filter: blur(10px);
}
.lightbox.active { display: flex; }
.lightbox-img {
max-width: 90%;
max-height: 85vh;
border-radius: 8px;
box-shadow: 0 0 50px rgba(0,255,68,0.3);
}
.lightbox-close {
position: absolute;
top: 30px;
right: 30px;
font-size: 40px;
color: white;
cursor: pointer;
opacity: 0.7;
transition: 0.3s;
z-index: 3001;
}
.lightbox-close:hover {
opacity: 1;
color: var(--danger);
transform: rotate(90deg);
}
.q-block {
background: var(--card-bg);
border: 1px solid rgba(255,255,255,0.08);
border-radius: 16px;
padding: 20px;
margin-bottom: 15px;
transition: 0.3s;
}
.q-block:hover {
border-color: rgba(0,255,68,0.2);
}
.q-block.error {
border-color: var(--danger) !important;
animation: shake 0.5s;
box-shadow: 0 0 20px var(--danger-glow);
}
.q-block-head {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 12px;
}
.q-num {
font-size: 12px;
font-weight: 800;
color: var(--primary);
text-transform: uppercase;
letter-spacing: 1px;
}
.q-del {
background: none;
border: none;
color: var(--danger);
cursor: pointer;
font-size: 18px;
opacity: 0.5;
transition: 0.3s;
}
.q-del:hover {
opacity: 1;
transform: scale(1.2);
}
.opt-row {
display: flex;
align-items: center;
gap: 10px;
margin-bottom: 8px;
}
.opt-radio {
width: 22px;
height: 22px;
border-radius: 50%;
border: 2px solid rgba(255,255,255,0.2);
cursor: pointer;
transition: 0.3s;
flex-shrink: 0;
display: flex;
align-items: center;
justify-content: center;
}
.opt-radio:hover {
border-color: var(--primary);
}
.opt-radio.checked {
border-color: var(--primary);
background: var(--primary);
box-shadow: 0 0 10px var(--primary-glow);
}
.opt-radio.checked::after {
content: '‚úì';
color: black;
font-size: 12px;
font-weight: 900;
}
.opt-input {
flex: 1;
background: rgba(0,0,0,0.3);
border: 1px solid rgba(255,255,255,0.08);
color: white;
padding: 10px 14px;
border-radius: 10px;
font-size: 13px;
outline: none;
font-family: inherit;
transition: 0.3s;
}
.opt-input:focus {
border-color: var(--primary);
}
.opt-del {
background: none;
border: none;
color: var(--danger);
cursor: pointer;
font-size: 14px;
opacity: 0.4;
transition: 0.3s;
}
.opt-del:hover {
opacity: 1;
}
.add-opt-btn {
background: none;
border: 1px dashed rgba(255,255,255,0.1);
color: var(--text-gray);
padding: 8px;
border-radius: 10px;
cursor: pointer;
font-size: 12px;
width: 100%;
transition: 0.3s;
font-weight: 600;
}
.add-opt-btn:hover {
border-color: var(--primary);
color: var(--primary);
}
.free-toggle-create,
.table-toggle-create {
display: flex;
align-items: center;
gap: 8px;
margin-top: 10px;
cursor: pointer;
font-size: 12px;
color: var(--text-gray);
font-weight: 600;
transition: 0.3s;
}
.free-toggle-create:hover,
.table-toggle-create:hover {
color: var(--primary);
}
.toggle-switch {
width: 36px;
height: 20px;
border-radius: 12px;
background: rgba(255,255,255,0.1);
position: relative;
transition: 0.3s;
flex-shrink: 0;
}
.toggle-switch.on {
background: var(--primary);
}
.toggle-switch::after {
content: '';
position: absolute;
top: 2px;
left: 2px;
width: 16px;
height: 16px;
border-radius: 50%;
background: white;
transition: 0.3s;
}
.toggle-switch.on::after {
left: 18px;
}
.table-builder {
margin-top: 15px;
padding: 15px;
background: rgba(0,255,68,0.03);
border: 1px solid rgba(0,255,68,0.15);
border-radius: 12px;
}
.table-builder-head {
display: flex;
gap: 10px;
margin-bottom: 10px;
flex-wrap: wrap;
}
.table-col-input {
flex: 1;
min-width: 100px;
background: rgba(0,0,0,0.3);
border: 1px solid rgba(255,255,255,0.1);
color: white;
padding: 8px 12px;
border-radius: 8px;
font-size: 12px;
outline: none;
font-family: inherit;
}
.table-col-input:focus {
border-color: var(--primary);
}
.table-builder-rows {
margin-top: 10px;
}
.table-row-builder {
display: flex;
gap: 10px;
margin-bottom: 8px;
align-items: center;
}
.table-cell-input {
flex: 1;
min-width: 100px;
background: rgba(0,0,0,0.4);
border: 1px solid rgba(255,255,255,0.08);
color: white;
padding: 8px 12px;
border-radius: 8px;
font-size: 12px;
outline: none;
font-family: inherit;
}
.table-cell-input:focus {
border-color: var(--primary);
}
.answer-table-wrapper {
overflow-x: auto;
margin-bottom: 15px;
}
.answer-table {
width: 100%;
border-collapse: collapse;
background: rgba(0,0,0,0.3);
border-radius: 12px;
overflow: hidden;
}
.answer-table th {
background: rgba(0,255,68,0.1);
color: var(--primary);
padding: 12px;
text-align: left;
font-size: 12px;
font-weight: 800;
text-transform: uppercase;
border-bottom: 2px solid rgba(0,255,68,0.2);
}
.answer-table td {
padding: 12px;
border-bottom: 1px solid rgba(255,255,255,0.05);
font-size: 13px;
}
.answer-table tr:hover td {
background: rgba(0,255,68,0.03);
}
.table-radio {
width: 24px;
height: 24px;
border-radius: 50%;
border: 2px solid rgba(255,255,255,0.2);
cursor: pointer;
transition: 0.3s;
display: inline-flex;
align-items: center;
justify-content: center;
vertical-align: middle;
}
.table-radio:hover {
border-color: var(--primary);
}
.table-radio.checked {
border-color: var(--primary);
background: var(--primary);
box-shadow: 0 0 10px var(--primary-glow);
}
.table-radio.checked::after {
content: '‚úì';
color: black;
font-size: 12px;
font-weight: 900;
}
.free-answer-area {
margin-top: 15px;
}
.free-answer-toggle {
display: flex;
align-items: center;
gap: 10px;
cursor: pointer;
padding: 12px 16px;
border-radius: 12px;
border: 1px dashed rgba(255,255,255,0.1);
background: rgba(255,255,255,0.02);
transition: 0.3s;
font-size: 13px;
color: var(--text-gray);
font-weight: 600;
}
.free-answer-toggle:hover {
border-color: var(--primary);
color: var(--primary-bright);
background: rgba(0,255,68,0.05);
}
.free-answer-toggle.active {
border-color: var(--primary);
color: var(--primary);
background: rgba(0,255,68,0.08);
}
.free-input {
width: 100%;
margin-top: 10px;
background: rgba(0,0,0,0.4);
border: 1px solid rgba(255,255,255,0.1);
color: white;
padding: 14px;
border-radius: 12px;
font-size: 14px;
outline: none;
font-family: inherit;
resize: vertical;
min-height: 80px;
transition: 0.3s;
}
.free-input:focus {
border-color: var(--primary);
box-shadow: 0 0 15px rgba(0,255,68,0.2);
}
.reviewer-chip {
display: inline-flex;
align-items: center;
gap: 6px;
background: rgba(0,255,68,0.1);
border: 1px solid rgba(0,255,68,0.2);
color: var(--primary-bright);
padding: 6px 12px;
border-radius: 10px;
font-size: 12px;
font-weight: 700;
margin: 3px;
}
.reviewer-chip button {
background: none;
border: none;
color: var(--danger);
cursor: pointer;
font-size: 14px;
margin-left: 4px;
}
.people-dropdown {
position: relative;
}
.people-list {
position: absolute;
top: 100%;
left: 0;
right: 0;
background: rgba(10,15,25,0.98);
border: 1px solid var(--glass-border);
border-radius: 12px;
max-height: 200px;
overflow-y: auto;
z-index: 100;
display: none;
box-shadow: 0 10px 40px rgba(0,0,0,0.8);
}
.people-list.show {
display: block;
animation: slideDown 0.2s ease;
}
.people-item {
padding: 10px 15px;
cursor: pointer;
font-size: 13px;
display: flex;
justify-content: space-between;
align-items: center;
transition: 0.2s;
}
.people-item:hover {
background: rgba(0,255,68,0.08);
}
.review-card {
background: var(--card-bg);
border: 1px solid rgba(255,255,255,0.06);
border-radius: 18px;
padding: 25px;
margin-bottom: 15px;
}
.review-q {
margin-bottom: 15px;
padding: 15px;
background: rgba(255,255,255,0.02);
border-radius: 12px;
border-left: 3px solid;
}
.review-q.auto-ok {
border-color: var(--primary);
}
.review-q.auto-fail {
border-color: var(--danger);
}
.review-q.pending {
border-color: var(--warning);
}
.review-q .q-title {
font-size: 13px;
font-weight: 700;
margin-bottom: 6px;
word-wrap: break-word;
}
.review-q .q-answer {
font-size: 12px;
color: var(--text-light);
word-wrap: break-word;
}
.review-q .q-correct {
font-size: 11px;
color: var(--primary);
margin-top: 4px;
}
.review-q .q-points {
font-size: 11px;
font-weight: 800;
margin-top: 4px;
}
.points-control {
display: flex;
align-items: center;
gap: 8px;
margin-top: 8px;
}
.points-btn {
width: 28px;
height: 28px;
border-radius: 8px;
border: 1px solid;
background: none;
cursor: pointer;
font-size: 16px;
font-weight: 900;
transition: 0.3s;
display: flex;
align-items: center;
justify-content: center;
}
.points-btn.plus {
border-color: var(--primary);
color: var(--primary);
}
.points-btn.plus:hover {
background: var(--primary);
color: black;
box-shadow: 0 0 15px var(--primary-glow);
}
.points-btn.minus {
border-color: var(--danger);
color: var(--danger);
}
.points-btn.minus:hover {
background: var(--danger);
color: white;
box-shadow: 0 0 15px var(--danger-glow);
}
.points-display {
font-size: 14px;
font-weight: 800;
color: var(--primary);
min-width: 60px;
text-align: center;
padding: 4px 12px;
background: rgba(0,255,68,0.1);
border-radius: 8px;
border: 1px solid rgba(0,255,68,0.2);
}
.setting-block {
background: var(--card-bg);
border: 1px solid rgba(255,255,255,0.05);
border-radius: 16px;
padding: 22px;
margin-bottom: 15px;
}
.setting-block h4 {
font-size: 13px;
font-weight: 800;
color: var(--primary-bright);
margin-bottom: 12px;
display: flex;
align-items: center;
gap: 8px;
}
.admin-list-panel {
background: var(--card-bg);
border: 1px solid rgba(255,255,255,0.06);
border-radius: 16px;
padding: 22px;
margin-bottom: 15px;
}
.manage-card {
background: var(--card-bg);
border: 1px solid rgba(255,255,255,0.05);
border-radius: 14px;
padding: 18px 20px;
margin-bottom: 10px;
display: flex;
justify-content: space-between;
align-items: center;
transition: 0.3s;
flex-wrap: wrap;
gap: 15px;
}
.manage-card:hover {
border-color: var(--glass-border);
background: rgba(0,255,68,0.03);
}
.history-table-wrapper {
overflow-x: auto;
margin-top: 20px;
}
.history-table {
width: 100%;
border-collapse: collapse;
background: var(--card-bg);
border-radius: 12px;
overflow: hidden;
min-width: 800px;
}
.history-table th {
background: rgba(0,255,68,0.1);
color: var(--primary);
padding: 14px 12px;
text-align: left;
font-size: 11px;
font-weight: 800;
text-transform: uppercase;
letter-spacing: 1px;
border-bottom: 2px solid var(--glass-border);
}
.history-table td {
padding: 14px 12px;
font-size: 13px;
border-bottom: 1px solid rgba(255,255,255,0.04);
}
.history-table tr:hover td {
background: rgba(0,255,68,0.05);
}
.history-filters {
display: flex;
gap: 10px;
margin-bottom: 20px;
flex-wrap: wrap;
}
.filter-input {
flex: 1;
min-width: 150px;
background: rgba(0,0,0,0.4);
border: 1px solid rgba(255,255,255,0.1);
color: white;
padding: 10px 14px;
border-radius: 10px;
font-size: 13px;
outline: none;
font-family: inherit;
}
.filter-input:focus {
border-color: var(--primary);
box-shadow: 0 0 10px rgba(0,255,68,0.15);
}
.filter-select {
background: rgba(0,0,0,0.4);
border: 1px solid rgba(255,255,255,0.1);
color: white;
padding: 10px 14px;
border-radius: 10px;
font-size: 13px;
outline: none;
font-family: inherit;
cursor: pointer;
}
.filter-select:focus {
border-color: var(--primary);
}
@media(max-width: 768px) {
.stats-row {
grid-template-columns: 1fr 1fr;
}
.test-card {
width: 100%;
max-width: 400px;
}
.form-row-inline {
grid-template-columns: 1fr;
}
.btn-group {
flex-direction: column;
}
.btn {
width: 100%;
}
.history-table {
font-size: 11px;
}
.history-table th,
.history-table td {
padding: 10px 8px;
}
}
@media(max-width: 480px) {
.stats-row {
grid-template-columns: 1fr;
}
header {
flex-direction: column;
gap: 10px;
}
}
</style>
</head>
<body>
<header id="mainHeader">
<a href="cabinet.html" class="logo-box">‚öî –î–®–í</a>
<div class="header-right">
<div class="nav-tabs" id="navTabs"></div>
<span class="user-name-header" id="headerName">...</span>
<span class="role-badge" id="headerRole">...</span>
</div>
</header>

<div class="main-wrap">
<div class="view" id="viewPublicForm">
<div class="public-form-card">
<h2>üìù –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–∞ —ñ—Å–ø–∏—Ç</h2>
<p class="subtitle">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ñ–æ—Ä–º—É –¥–ª—è –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —ñ—Å–ø–∏—Ç—É</p>
<div class="form-row">
<label class="form-label">–í–∞—à–µ —ñ–º'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ</label>
<input class="form-input" id="publicName" placeholder="–Ü–≤–∞–Ω –Ü–≤–∞–Ω–µ–Ω–∫–æ">
</div>
<div class="form-row">
<label class="form-label">–ù–∞ —è–∫–∏–π –∫–ª–∞—Å –∑–¥–∞—î—Ç–µ</label>
<input class="form-input" id="publicClass" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –°–µ—Ä–∂–∞–Ω—Ç">
</div>
<div class="form-row">
<label class="form-label">–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª</label>
<input class="form-input" id="publicUnit" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 1-—à–∞ –±—Ä–∏–≥–∞–¥–∞">
</div>
<div class="btn-group">
<button class="btn btn-primary" onclick="submitPublicForm()">üöÄ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –¥–æ —ñ—Å–ø–∏—Ç—É</button>
</div>
</div>
</div>

<div class="view active" id="viewHome">
<div class="stats-row" id="statsRow"></div>
<div class="section-title">üìã –î–æ—Å—Ç—É–ø–Ω—ñ —ñ—Å–ø–∏—Ç–∏</div>
<div class="tests-grid" id="testsGrid"></div>
<div class="section-title">üìä –ú–æ—ó —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏</div>
<div id="myResults"></div>
</div>

<div class="view" id="viewIntro">
<div class="intro-card" id="introCard"></div>
</div>

<div class="view" id="viewQuiz">
<div class="quiz-container" id="quizContainer"></div>
</div>

<div class="view" id="viewResult">
<div class="result-screen" id="resultScreen"></div>
</div>

<div class="view" id="viewCreate">
<div class="section-title" id="createTitle">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ—Å–ø–∏—Ç</div>
<div id="createForm"></div>
</div>

<div class="view" id="viewReview">
<div class="section-title">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</div>
<div id="reviewList"></div>
</div>

<div class="view" id="viewManage">
<div class="section-title">‚öôÔ∏è –ö–µ—Ä—É–≤–∞–Ω–Ω—è —ñ—Å–ø–∏—Ç–∞–º–∏</div>
<div id="manageList"></div>
</div>

<div class="view" id="viewSettings">
<div class="section-title">üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
<div id="settingsContent"></div>
</div>

<div class="view" id="viewHistory">
<div class="section-title">üìä –°–ø–∏—Å–∫–∏ —Ç–∞ —ñ—Å—Ç–æ—Ä—ñ—è</div>
<div id="historyContent"></div>
</div>

<div class="view" id="viewAdminList">
<div class="section-title">üëë –ê–¥–º—ñ–Ω –ø—Ä–∞–≤–∞ –≤ —ñ—Å–ø–∏—Ç–∞—Ö</div>
<div id="adminListContent"></div>
</div>
</div>

<div id="lightbox" class="lightbox" onclick="closeLightbox()">
<span class="lightbox-close" onclick="closeLightbox()">&times;</span>
<img id="lightboxImg" class="lightbox-img" src="">
</div>

<div id="contextMenu" class="context-menu">
<div class="context-menu-item" onclick="contextEdit()">
<span>‚úèÔ∏è</span>
<span>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</span>
</div>
<div class="context-menu-item warning" onclick="contextClear()">
<span>üßπ</span>
<span>–û—á–∏—Å—Ç–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏</span>
</div>
<div class="context-menu-item" onclick="contextCopyLink()">
<span>üîó</span>
<span>–ü—É–±–ª—ñ—á–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</span>
</div>
<div class="context-menu-divider"></div>
<div class="context-menu-item danger" onclick="contextDelete()">
<span>üóë</span>
<span>–í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å–ø–∏—Ç</span>
</div>
</div>

<div id="linkCopiedNotif" class="public-link-copied">
üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, collection, updateDoc, addDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const app = initializeApp({
apiKey: "AIzaSyATUpLUHSp1VbyxkJXhMS-2R71zNOBGC00",
authDomain: "dsv-gta.firebaseapp.com",
projectId: "dsv-gta",
storageBucket: "dsv-gta.firebasestorage.app",
messagingSenderId: "661591588818",
appId: "1:661591588818:web:a8e8dca3d061447e24d20b"
});

const auth = getAuth(app);
const db = getFirestore(app);

let IS_PUBLIC_MODE = false;
let PUBLIC_TEST_ID = null;
let PUBLIC_USER_DATA = null;
let ME = {name: '–ù–µ–≤—ñ–¥–æ–º–∏–π', role: 'fighter', uid: ''};
let allUsers = [];
let tests = [];
let results = [];
let reviewers = [];
let adminList = [];
let webhookUrl = '';
let currentTest = null;
let currentQ = 0;
let answers = {};
let timer = null;
let timeLeft = 30;
let editingTestId = null;
let agreementAccepted = false;
let currentTestPhotos = [];
let contextMenuTestId = null;

const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has('id')) {
IS_PUBLIC_MODE = true;
PUBLIC_TEST_ID = urlParams.get('id');
console.log('üîì –ü—É–±–ª—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º:', PUBLIC_TEST_ID);
}

// –í–ò–ü–†–ê–í–õ–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø save - —Ç–µ–ø–µ—Ä async
const save = async () => {
localStorage.setItem('isput_reviewers', JSON.stringify(reviewers));
localStorage.setItem('isput_admins', JSON.stringify(adminList));
localStorage.setItem('isput_webhook', webhookUrl);
console.log('üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Firebase, webhook:', webhookUrl ? '–Ñ' : '–ù–ï–ú–ê–Ñ');
await saveSettingsToFirebase();
};

const letters = '–ê–ë–í–ì“ê–î–ï–ñ–ó–ò';
const isAdmin = () => !IS_PUBLIC_MODE && (ME.role === 'admin' || adminList.includes(ME.name));
const isReviewer = () => !IS_PUBLIC_MODE && (isAdmin() || reviewers.includes(ME.name));
const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
const now = () => {
const d = new Date();
return d.toLocaleDateString('uk') + ' ' + d.toLocaleTimeString('uk', {hour: '2-digit', minute: '2-digit'});
};

window.submitPublicForm = () => {
const name = document.getElementById('publicName').value.trim();
const classLevel = document.getElementById('publicClass').value.trim();
const unit = document.getElementById('publicUnit').value.trim();

if (!name || !classLevel || !unit) {
alert('‚ùå –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è!');
return;
}

PUBLIC_USER_DATA = {name, classLevel, unit};
ME.name = name + ' (' + classLevel + ', ' + unit + ')';
ME.uid = 'public_' + genId();
loadPublicTest();
};

async function loadPublicTest() {
try {
const testDoc = await getDoc(doc(db, 'tests', PUBLIC_TEST_ID));
if (!testDoc.exists()) {
alert('‚ùå –¢–µ—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
return;
}
const testData = {id: testDoc.id, ...testDoc.data()};
tests = [testData];
startIntro(PUBLIC_TEST_ID);
} catch (e) {
console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ—Å—Ç—É:', e);
alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ—Å—Ç—É');
}
}

// Context Menu
window.showContextMenu = (event, testId) => {
if (!isAdmin()) return;
event.preventDefault();
event.stopPropagation();
contextMenuTestId = testId;
const menu = document.getElementById('contextMenu');
menu.style.left = event.pageX + 'px';
menu.style.top = event.pageY + 'px';
menu.classList.add('active');
};

window.contextEdit = () => {
hideContextMenu();
if (contextMenuTestId) editTest(contextMenuTestId);
};

window.contextClear = async () => {
hideContextMenu();
if (contextMenuTestId) await clearTestResults(contextMenuTestId);
};

window.contextDelete = async () => {
hideContextMenu();
if (contextMenuTestId) await deleteTest(contextMenuTestId);
};

window.contextCopyLink = () => {
hideContextMenu();
if (contextMenuTestId) {
const url = window.location.origin + window.location.pathname + '?id=' + contextMenuTestId;
navigator.clipboard.writeText(url).then(() => {
const notif = document.getElementById('linkCopiedNotif');
notif.classList.add('show');
setTimeout(() => notif.classList.remove('show'), 3000);
});
}
};

function hideContextMenu() {
document.getElementById('contextMenu').classList.remove('active');
}

document.addEventListener('click', (e) => {
if (!e.target.closest('.context-menu')) hideContextMenu();
if (!e.target.closest('.people-dropdown')) {
document.querySelectorAll('.people-list').forEach(d => d.classList.remove('show'));
}
});

document.addEventListener('contextmenu', (e) => {
if (e.target.closest('.test-card') && isAdmin()) e.preventDefault();
});

// Discord Notifications
async function sendDiscordNotification(type, data) {
console.log('üîî sendDiscordNotification –≤–∏–∫–ª–∏–∫–∞–Ω–æ:', type);
console.log('üì¶ –î–∞–Ω—ñ:', data);
console.log('üîó Webhook URL:', webhookUrl ? '–Ñ (' + webhookUrl.substring(0, 50) + '...)' : '–í–Ü–î–°–£–¢–ù–Ü–ô');

if (!webhookUrl) {
console.error('‚ùå Webhook URL –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ!');
return;
}

let embed = {};
const timestamp = new Date().toISOString();

switch(type) {
case 'NEW_TEST':
embed = {
title: 'üìù –ù–æ–≤–∏–π —ñ—Å–ø–∏—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ!',
color: 0x00ff44,
fields: [
{name: 'üìã –ù–∞–∑–≤–∞', value: data.testName, inline: false},
{name: 'üë§ –°—Ç–≤–æ—Ä–∏–≤', value: data.createdBy, inline: true},
{name: '‚ùì –ü–∏—Ç–∞–Ω—å', value: data.questionCount.toString(), inline: true},
{name: 'üéØ –ú–∞–∫—Å. –±–∞–ª', value: data.maxScore.toString(), inline: true},
{name: '‚úÖ –ü—Ä–æ—Ö—ñ–¥–Ω–∏–π', value: data.passScore.toString(), inline: true},
{name: '‚è± –ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Å', value: data.totalTime + '—Å', inline: true},
{name: 'üìÖ –î–∞—Ç–∞', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'TEST_UPDATED':
embed = {
title: '‚úèÔ∏è –Ü—Å–ø–∏—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ!',
color: 0xfbbf24,
fields: [
{name: 'üìã –ù–∞–∑–≤–∞', value: data.testName, inline: false},
{name: 'üë§ –†–µ–¥–∞–≥—É–≤–∞–≤', value: data.editedBy, inline: true},
{name: '‚ùì –ü–∏—Ç–∞–Ω—å', value: data.questionCount.toString(), inline: true},
{name: 'üéØ –ë–∞–ª–∏', value: data.passScore + '/' + data.maxScore, inline: true},
{name: 'üìÖ –î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'TEST_DELETED':
embed = {
title: 'üóë –Ü—Å–ø–∏—Ç –≤–∏–¥–∞–ª–µ–Ω–æ!',
color: 0xef4444,
fields: [
{name: 'üìã –ù–∞–∑–≤–∞', value: data.testName, inline: true},
{name: 'üë§ –í–∏–¥–∞–ª–∏–≤', value: data.deletedBy, inline: true},
{name: 'üìÖ –î–∞—Ç–∞', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'QUIZ_COMPLETED':
const statusEmoji = data.status === 'pending' ? '‚è≥' : data.passed ? '‚úÖ' : '‚ùå';
const statusText = data.status === 'pending' ? '–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ' : data.passed ? '–°–ö–õ–ê–î–ï–ù–û' : '–ù–ï –°–ö–õ–ê–î–ï–ù–û';
const statusColor = data.status === 'pending' ? 0xfbbf24 : data.passed ? 0x10b981 : 0xef4444;
embed = {
title: statusEmoji + ' –Ü—Å–ø–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ' + data.testName,
color: statusColor,
description: '**' + data.userName + '** –∑–∞–≤–µ—Ä—à–∏–≤ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —ñ—Å–ø–∏—Ç—É',
fields: [
{name: 'üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', value: data.userName, inline: true},
{name: 'üéñ –ó–≤–∞–Ω–Ω—è', value: data.userRole, inline: true},
{name: 'üìä –†–µ–∑—É–ª—å—Ç–∞—Ç', value: '**' + data.score + '** / ' + data.maxScore + ' –±–∞–ª—ñ–≤', inline: true},
{name: 'üéØ –ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª', value: data.passScore.toString(), inline: true},
{name: 'üìà –í—ñ–¥—Å–æ—Ç–æ–∫', value: Math.round((data.score / data.maxScore) * 100) + '%', inline: true},
{name: '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö', value: data.correctAnswers + ' / ' + data.totalQuestions, inline: true},
{name: 'üìÖ –î–∞—Ç–∞', value: data.date, inline: false},
{name: 'üîç –°—Ç–∞—Ç—É—Å', value: statusText, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'RESULT_APPROVED':
embed = {
title: '‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ö–≤–∞–ª–µ–Ω–æ!',
color: 0x00ff44,
description: '–ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π **' + data.reviewer + '** —Å—Ö–≤–∞–ª–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç',
fields: [
{name: 'üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', value: data.userName, inline: true},
{name: 'üìã –Ü—Å–ø–∏—Ç', value: data.testName, inline: true},
{name: 'üìä –§—ñ–Ω–∞–ª—å–Ω–∏–π –±–∞–ª', value: '**' + data.finalScore + '** / ' + data.maxScore, inline: true},
{name: 'üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤', value: data.reviewer, inline: true},
{name: 'üìÖ –î–∞—Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'RESULT_REJECTED':
embed = {
title: '‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ!',
color: 0xef4444,
description: '–ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π **' + data.reviewer + '** –≤—ñ–¥—Ö–∏–ª–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç',
fields: [
{name: 'üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', value: data.userName, inline: true},
{name: 'üìã –Ü—Å–ø–∏—Ç', value: data.testName, inline: true},
{name: 'üìä –ë–∞–ª', value: data.score + ' / ' + data.maxScore, inline: true},
{name: 'üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤', value: data.reviewer, inline: true},
{name: 'üìÖ –î–∞—Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'RESULTS_CLEARED':
embed = {
title: 'üßπ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ—á–∏—â–µ–Ω–æ!',
color: 0xfbbf24,
fields: [
{name: 'üìã –Ü—Å–ø–∏—Ç', value: data.testName, inline: true},
{name: 'üë§ –û—á–∏—Å—Ç–∏–≤', value: data.clearedBy, inline: true},
{name: 'üóë –í–∏–¥–∞–ª–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤', value: data.count.toString(), inline: true},
{name: 'üìÖ –î–∞—Ç–∞', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'REVIEWER_ADDED':
embed = {
title: 'üîç –î–æ–¥–∞–Ω–æ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—á–æ–≥–æ!',
color: 0x3b82f6,
fields: [
{name: 'üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', value: data.reviewerName, inline: true},
{name: '‚ûï –î–æ–¥–∞–≤', value: data.addedBy, inline: true},
{name: 'üìÖ –î–∞—Ç–∞', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

case 'ADMIN_ADDED':
embed = {
title: 'üëë –î–æ–¥–∞–Ω–æ –Ω–æ–≤–æ–≥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞!',
color: 0x00ff44,
fields: [
{name: 'üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', value: data.adminName, inline: true},
{name: '‚ûï –î–æ–¥–∞–≤', value: data.addedBy, inline: true},
{name: 'üîë –ü—Ä–∞–≤–∞', value: '–ü–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ —Å–∏—Å—Ç–µ–º–∏', inline: false},
{name: 'üìÖ –î–∞—Ç–∞', value: data.date, inline: true}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: timestamp
};
break;

default:
console.error('‚ùå –ù–µ–≤—ñ–¥–æ–º–∏–π —Ç–∏–ø notification:', type);
return;
}

const payload = {embeds: [embed]};
console.log('üì§ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ Discord...');

try {
const response = await fetch(webhookUrl, {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify(payload)
});

console.log('üì° –í—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ Discord:', response.status);

if (response.ok) {
console.log('‚úÖ Discord notification –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!');
} else {
const errorText = await response.text();
console.error('‚ùå Discord webhook –ø–æ–º–∏–ª–∫–∞:', response.status);
console.error('‚ùå –¢–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏:', errorText);
}
} catch (e) {
console.error('‚ùå Exception –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –≤ Discord:', e);
}
}

let notifs = [];
function addNotif(text) {
if (IS_PUBLIC_MODE) return;
notifs.unshift({text, time: now(), read: false});
if (notifs.length > 20) notifs.pop();
localStorage.setItem('isput_notifs', JSON.stringify(notifs));
}

// Auth State
onAuthStateChanged(auth, async u => {
if (IS_PUBLIC_MODE) {
document.getElementById('mainHeader').classList.add('hidden');
showView('publicForm');
return;
}

if (!u) {
window.location.href = 'index.html';
return;
}
ME.uid = u.uid;

try {
const snap = await getDoc(doc(db, 'users', u.uid));
if (snap.exists()) {
const d = snap.data();
ME.name = d.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π';
ME.role = d.role || 'fighter';
}

const all = await getDocs(collection(db, 'users'));
allUsers = [];
all.forEach(s => {
const d = s.data();
allUsers.push({uid: s.id, name: d.name || '---', role: d.role || 'fighter'});
});

// ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ó–ê–í–ê–ù–¢–ê–ñ–£–Ñ–ú–û –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ü–ï–†–ï–î –í–°–Ü–ú –Ü–ù–®–ò–ú
await loadSettingsFromFirebase();

loadTestsFromFirebase();
loadResultsFromFirebase();
} catch (e) {
console.log('Firebase err:', e);
}

document.getElementById('headerName').textContent = ME.name;
const rb = document.getElementById('headerRole');
if (ME.role === 'admin') {
    rb.textContent = '–ê–î–ú–Ü–ù';
    rb.className = 'role-badge role-admin';
} else if (ME.role === 'instructor') {
    rb.textContent = '–Ü–ù–°–¢–†–£–ö–¢–û–†';
    rb.className = 'role-badge role-instructor';
} else {
    rb.textContent = '–ë–Ü–Ñ–¶–¨';
    rb.className = 'role-badge role-fighter';
}

buildNav();
showView('home');

// –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å —Ç–µ—Å—Ç—É
const savedQuiz = sessionStorage.getItem('quizInProgress');
if (savedQuiz) {
    try {
        const quizData = JSON.parse(savedQuiz);
        currentTest = quizData.testData;
        currentQ = quizData.currentQ;
        answers = quizData.answers;
        
        if (confirm('üîÑ –ó–Ω–∞–π–¥–µ–Ω–æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–π —ñ—Å–ø–∏—Ç "' + currentTest.name + '". –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?')) {
            showView('quiz');
            renderQuestion();
        } else {
            sessionStorage.removeItem('quizInProgress');
        }
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É:', e);
        sessionStorage.removeItem('quizInProgress');
    }
}
});

function loadTestsFromFirebase() {
const q = query(collection(db, 'tests'), orderBy('createdAt', 'desc'));
onSnapshot(q, snapshot => {
tests = [];
snapshot.forEach(docSnap => {
tests.push({id: docSnap.id, ...docSnap.data()});
});

const activeView = document.querySelector('.view.active');
if (activeView) {
if (activeView.id === 'viewHome') renderHome();
if (activeView.id === 'viewManage') renderManage();
if (activeView.id === 'viewHistory') renderHistory();
}
});
}

function loadResultsFromFirebase() {
const q = query(collection(db, 'results'), orderBy('createdAt', 'desc'));
onSnapshot(q, snapshot => {
results = [];
snapshot.forEach(docSnap => {
results.push({id: docSnap.id, ...docSnap.data()});
});

console.log('‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –∑ Firebase:', results.length);

const activeView = document.querySelector('.view.active');
if (activeView) {
if (activeView.id === 'viewHome') renderHome();
if (activeView.id === 'viewReview') renderReview();
if (activeView.id === 'viewHistory') renderHistory();
}
});
}

// ‚úÖ –ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∑ Firebase
async function loadSettingsFromFirebase() {
try {
console.log('üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∑ Firebase...');
const settingsDoc = await getDoc(doc(db, 'settings', 'config'));
if (settingsDoc.exists()) {
const data = settingsDoc.data();
reviewers = data.reviewers || [];
adminList = data.adminList || [];
webhookUrl = data.webhookUrl || '';
console.log('‚úÖ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:', {
reviewers: reviewers.length + ' –æ—Å—ñ–±',
adminList: adminList.length + ' –æ—Å—ñ–±',
webhookUrl: webhookUrl ? webhookUrl.substring(0, 50) + '...' : '–í–Ü–î–°–£–¢–ù–Ü–ô'
});
} else {
console.log('‚ö†Ô∏è –î–æ–∫—É–º–µ–Ω—Ç –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –Ω–µ —ñ—Å–Ω—É—î, —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π');
const settingsRef = doc(db, 'settings', 'config');
await setDoc(settingsRef, {
reviewers: [],
adminList: [],
webhookUrl: ''
});
}
} catch (e) {
console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å:', e);
}
}

// ‚úÖ –ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –≤ Firebase
async function saveSettingsToFirebase() {
try {
const settingsRef = doc(db, 'settings', 'config');
await setDoc(settingsRef, {
reviewers: reviewers,
adminList: adminList,
webhookUrl: webhookUrl
}, { merge: true });
console.log('‚úÖ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ Firebase:', {
webhookUrl: webhookUrl ? '–Ñ (' + webhookUrl.substring(0, 30) + '...)' : '–ù–ï–ú–ê–Ñ'
});
} catch (e) {
console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å:', e);
}
}
  // –ü—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –∫–æ–¥—É –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —á–∞—Å—Ç–∏–Ω–∏...

async function saveTestToFirebase(testObj) {
try {
let totalTime = 0;
testObj.questions.forEach(q => {totalTime += (q.timeLimit || 30)});

if (editingTestId) {
await updateDoc(doc(db, 'tests', editingTestId), testObj);
addNotif('üìù –Ü—Å–ø–∏—Ç "' + testObj.name + '" –æ–Ω–æ–≤–ª–µ–Ω–æ!');
await sendDiscordNotification('TEST_UPDATED', {
testName: testObj.name,
editedBy: ME.name,
questionCount: testObj.questions.length,
maxScore: testObj.maxScore,
passScore: testObj.passScore,
date: now()
});
} else {
const docRef = await addDoc(collection(db, 'tests'), {
...testObj,
createdAt: serverTimestamp()
});
console.log('‚úÖ –ù–æ–≤–∏–π —Ç–µ—Å—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ –∑ ID:', docRef.id);
addNotif('üìù –Ü—Å–ø–∏—Ç "' + testObj.name + '" —Å—Ç–≤–æ—Ä–µ–Ω–æ!');
await sendDiscordNotification('NEW_TEST', {
testName: testObj.name,
createdBy: testObj.createdBy,
questionCount: testObj.questions.length,
maxScore: testObj.maxScore,
passScore: testObj.passScore,
totalTime: totalTime,
date: now()
});
}
return true;
} catch (e) {
console.error('Save error:', e);
alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + e.message);
return false;
}
}

async function deleteTestFromFirebase(id) {
try {
const t = tests.find(x => x.id === id);
const testName = t ? t.name : '–ù–µ–≤—ñ–¥–æ–º–∏–π —ñ—Å–ø–∏—Ç';

await deleteDoc(doc(db, 'tests', id));
addNotif('üóë –Ü—Å–ø–∏—Ç –≤–∏–¥–∞–ª–µ–Ω–æ');

await sendDiscordNotification('TEST_DELETED', {
testName: testName,
deletedBy: ME.name,
date: now()
});
return true;
} catch (e) {
alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + e.message);
return false;
}
}

function buildNav() {
if (IS_PUBLIC_MODE) return;

const tabs = document.getElementById('navTabs');
let html = '<button class="nav-btn active" onclick="showView(\'home\')">üè† –ì–æ–ª–æ–≤–Ω–∞</button>';

if (isAdmin()) {
html += '<button class="nav-btn" onclick="showView(\'create\')">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</button>';
html += '<button class="nav-btn" onclick="showView(\'manage\')">‚öôÔ∏è –ö–µ—Ä—É–≤–∞—Ç–∏</button>';
html += '<button class="nav-btn" onclick="showView(\'history\')">üìä –°–ø–∏—Å–∫–∏</button>';
html += '<button class="nav-btn" onclick="showView(\'settings\')">üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>';
html += '<button class="nav-btn" onclick="showView(\'adminList\')">üëë –ê–¥–º—ñ–Ω–∏</button>';
}

if (isReviewer()) {
html += '<button class="nav-btn" onclick="showView(\'review\')">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞</button>';
}

tabs.innerHTML = html;
}

window.showView = v => {
document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
document.getElementById('view' + v.charAt(0).toUpperCase() + v.slice(1)).classList.add('active');

if (!IS_PUBLIC_MODE) {
document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
const btns = document.querySelectorAll('.nav-btn');
const map = {home: 0, create: 1, manage: 2, history: 3, settings: 4, adminList: 5, review: isAdmin() ? 6 : 1};
if (btns[map[v]]) btns[map[v]].classList.add('active');
}

if (v === 'home') renderHome();
if (v === 'create' && !editingTestId) renderCreateForm();
if (v === 'review') renderReview();
if (v === 'manage') renderManage();
if (v === 'settings') renderSettings();
if (v === 'adminList') renderAdminList();
if (v === 'history') renderHistory();
};

function renderHome() {
if (IS_PUBLIC_MODE) return;

const myRes = results.filter(r => r.userId === ME.uid);
const passed = myRes.filter(r => {
const t = tests.find(x => x.id === r.testId);
return r.status === 'approved' || (r.status === 'auto' && t && r.score >= t.passScore && r.reviewedByHuman);
}).length;

const failed = myRes.filter(r => {
const t = tests.find(x => x.id === r.testId);
return r.status === 'rejected' || (r.status === 'auto' && t && r.score < t.passScore && r.reviewedByHuman);
}).length;

const pending = myRes.filter(r => r.status === 'pending' || (r.status === 'auto' && !r.reviewedByHuman)).length;

document.getElementById('statsRow').innerHTML = 
'<div class="stat-card"><div class="stat-num">' + tests.length + '</div><div class="stat-label">–Ü—Å–ø–∏—Ç—ñ–≤</div></div>' +
'<div class="stat-card"><div class="stat-num" style="color:var(--success)">' + passed + '</div><div class="stat-label">–°–∫–ª–∞–¥–µ–Ω–æ</div></div>' +
'<div class="stat-card"><div class="stat-num" style="color:var(--danger)">' + failed + '</div><div class="stat-label">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div></div>' +
'<div class="stat-card"><div class="stat-num" style="color:var(--warning)">' + pending + '</div><div class="stat-label">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</div></div>';

if (tests.length === 0) {
document.getElementById('testsGrid').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px;width:100%">–Ü—Å–ø–∏—Ç—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>';
} else {
document.getElementById('testsGrid').innerHTML = tests.map(t => {
let totalTime = 0;
t.questions.forEach(q => {totalTime += (q.timeLimit || 30)});
const contextAttr = isAdmin() ? 'oncontextmenu="showContextMenu(event, \'' + t.id + '\')"' : '';
return '<div class="test-card" onclick="startIntro(\'' + t.id + '\')" ' + contextAttr + '>' +
'<span class="emoji">' + (t.emoji || 'üìù') + '</span>' +
'<h3>' + t.name + '</h3>' +
'<p>' + (t.description || '–ë–µ–∑ –æ–ø–∏—Å—É') + '</p>' +
'<div class="test-meta">' +
'<span class="meta-tag">‚ùì ' + t.questions.length + ' –ø–∏—Ç–∞–Ω—å</span>' +
'<span class="meta-tag">üéØ ' + t.passScore + '/' + t.maxScore + ' –±.</span>' +
'<span class="meta-tag">‚è± ' + totalTime + '—Å</span>' +
'</div></div>';
}).join('');
}

if (myRes.length === 0) {
document.getElementById('myResults').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:30px;font-size:13px">–í–∏ —â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —ñ—Å–ø–∏—Ç–∏</div>';
} else {
let rows = myRes.map(r => {
const t = tests.find(x => x.id === r.testId);
const tname = t ? t.name : '–í–∏–¥–∞–ª–µ–Ω–∏–π';
const passS = t ? t.passScore : 0;
let st, stc;

if (r.status === 'pending') {
st = '–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ'; stc = 'st-pending';
} else if (r.status === 'approved') {
st = '–°—Ö–≤–∞–ª–µ–Ω–æ'; stc = 'st-approved';
} else if (r.status === 'rejected') {
st = '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ'; stc = 'st-rejected';
} else {
const p = r.score >= passS && r.reviewedByHuman;
st = p ? '–°–∫–ª–∞–¥–µ–Ω–æ' : r.reviewedByHuman ? '–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ' : '–û—á—ñ–∫—É—î –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏';
stc = p ? 'st-pass' : r.reviewedByHuman ? 'st-fail' : 'st-pending';
}

return '<tr><td>' + tname + '</td><td><b>' + r.score + '</b> / ' + (t ? t.maxScore : '?') + '</td>' +
'<td><span class="status-badge ' + stc + '">' + st + '</span></td>' +
'<td>' + (r.reviewer || 'SYSTEM') + '</td><td>' + r.date + '</td></tr>';
}).join('');

document.getElementById('myResults').innerHTML = '<div class="results-table"><table><thead><tr>' +
'<th>–Ü—Å–ø–∏—Ç</th><th>–ë–∞–ª–∏</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π</th><th>–î–∞—Ç–∞</th>' +
'</tr></thead><tbody>' + rows + '</tbody></table></div>';
}
}

function renderCreateForm(testData = null) {
    console.log('renderCreateForm –≤–∏–∫–ª–∏–∫–∞–Ω–æ –∑ –¥–∞–Ω–∏–º–∏:', testData);
    
    editingTestId = testData ? testData.id : null;
    currentTestPhotos = testData && testData.photos ? testData.photos : [];
    
    const isEdit = !!testData;
    document.getElementById('createTitle').textContent = isEdit ? '‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —ñ—Å–ø–∏—Ç' : '‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ—Å–ø–∏—Ç';
    
    let questionsHtml = '';
    if (testData && testData.questions) {
        testData.questions.forEach((q, idx) => {
            questionsHtml += buildQuestionBlock(idx, q);
        });
    } else {
        questionsHtml = buildQuestionBlock(0);
    }
    
    let photosHtml = '';
    if (currentTestPhotos.length > 0) {
        photosHtml = '<div class="test-photo-grid">';
        currentTestPhotos.forEach((p, i) => {
            photosHtml += '<div class="test-photo-item">' +
                '<img src="' + p.url + '" onclick="openLightbox(\'' + p.url + '\')">' +
                '<button class="photo-delete-mini" onclick="deleteTestPhoto(' + i + ')">‚úï</button></div>';
        });
        photosHtml += '</div>';
    }
    
    const testName = testData && testData.name ? testData.name : '';
    const testDesc = testData && testData.description ? testData.description : '';
    const testEmoji = testData && testData.emoji ? testData.emoji : 'üìù';
    const testPassScore = testData && testData.passScore ? testData.passScore : 80;
    const testMaxScore = testData && testData.maxScore ? testData.maxScore : 100;
    const testAgreement = testData && testData.agreementText ? testData.agreementText : '';
    
    document.getElementById('createForm').innerHTML = 
        '<div class="form-card">' +
        '<div class="form-row"><label class="form-label">–ù–∞–∑–≤–∞ —ñ—Å–ø–∏—Ç—É</label>' +
        '<input class="form-input" id="testName" value="' + testName + '" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –¢–∞–∫—Ç–∏—á–Ω–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞"></div>' +
        '<div class="form-row"><label class="form-label">–û–ø–∏—Å (–Ω–µ–æ–±–æ–≤\'—è–∑–∫–æ–≤–æ)</label>' +
        '<input class="form-input" id="testDesc" value="' + testDesc + '" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å —ñ—Å–ø–∏—Ç—É"></div>' +
        '<div class="form-row"><label class="form-label">–ï–º–æ–¥–∑—ñ</label>' +
        '<input class="form-input" id="testEmoji" value="' + testEmoji + '" placeholder="üìù"></div>' +
        '<div class="form-row-inline">' +
        '<div><label class="form-label">–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª</label><input class="form-input" id="testPassScore" type="number" value="' + testPassScore + '"></div>' +
        '<div><label class="form-label">–ú–∞–∫—Å. –±–∞–ª</label><input class="form-input" id="testMaxScore" type="number" value="' + testMaxScore + '"></div></div>' +
        '<div class="form-row"><label class="form-label">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∞ —É–≥–æ–¥–∞ (–Ω–µ–æ–±–æ–≤\'—è–∑–∫–æ–≤–æ)</label>' +
        '<textarea class="form-input" id="testAgreement" rows="3" placeholder="–¢–µ–∫—Å—Ç —É–≥–æ–¥–∏...">' + testAgreement + '</textarea></div>' +
        '<div class="form-row"><label class="form-label">üì∏ –§–æ—Ç–æ –¥–æ —ñ—Å–ø–∏—Ç—É</label>' + photosHtml +
        '<input type="file" id="testPhotoInput" accept="image/*" style="display:none" onchange="uploadTestPhoto()">' +
        '<button class="upload-photo-btn" onclick="document.getElementById(\'testPhotoInput\').click()">üì∏ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</button></div></div>' +
        '<div class="section-title" style="margin-top:30px">‚ùì –ü–∏—Ç–∞–Ω–Ω—è</div>' +
        '<div id="questionsContainer">' + questionsHtml + '</div>' +
        '<div class="btn-group" style="margin-top:20px">' +
        '<button class="btn btn-secondary" onclick="addQuestion()">‚ûï –î–æ–¥–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è</button>' +
        '<button class="btn btn-primary" onclick="saveTest()">üíæ ' + (isEdit ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ—Å–ø–∏—Ç') + '</button>' +
        '<button class="btn btn-secondary" onclick="cancelCreate()">‚Üê –°–∫–∞—Å—É–≤–∞—Ç–∏</button></div>';
}

function buildQuestionBlock(idx, qData = null) {
    const q = qData || {text: '', options: [{text: '', correct: false}, {text: '', correct: false}], timeLimit: 30, allowFree: false, answerType: 'normal', tableData: null, photo: null};
    
    let optionsHtml = '';
    q.options.forEach((opt, i) => {
        optionsHtml += '<div class="opt-row">' +
            '<div class="opt-radio ' + (opt.correct ? 'checked' : '') + '" onclick="toggleCorrect(' + idx + ',' + i + ')"></div>' +
            '<input class="opt-input" data-q="' + idx + '" data-opt="' + i + '" value="' + opt.text + '" placeholder="–í–∞—Ä—ñ–∞–Ω—Ç ' + letters[i] + '">' +
            (q.options.length > 2 ? '<button class="opt-del" onclick="deleteOption(' + idx + ',' + i + ')">‚úï</button>' : '') +
            '</div>';
    });
    
    let photoHtml = '';
    if (q.photo) {
        photoHtml = '<div class="question-photo-section"><div class="question-photo-preview">' +
            '<img src="' + q.photo + '" onclick="openLightbox(\'' + q.photo + '\')">' +
            '<button class="question-photo-delete" onclick="deleteQuestionPhoto(' + idx + ')">‚úï</button></div></div>';
    }
    
    return '<div class="q-block" data-q="' + idx + '">' +
        '<div class="q-block-head"><span class="q-num">–ü–∏—Ç–∞–Ω–Ω—è ' + (idx + 1) + '</span>' +
        '<button class="q-del" onclick="deleteQuestion(' + idx + ')">üóë</button></div>' +
        '<div class="form-row"><textarea class="form-input" data-q="' + idx + '" data-field="text" rows="2" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Ç–∞–Ω–Ω—è">' + q.text + '</textarea></div>' +
        photoHtml +
        '<input type="file" id="qPhoto' + idx + '" accept="image/*" style="display:none" onchange="uploadQuestionPhoto(' + idx + ')">' +
        '<button class="add-question-photo-btn" onclick="document.getElementById(\'qPhoto' + idx + '\').click()">üì∏ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –¥–æ –ø–∏—Ç–∞–Ω–Ω—è</button>' +
        '<div class="form-row"><label class="form-label">–í–∞—Ä—ñ–∞–Ω—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</label>' + optionsHtml +
        '<button class="add-opt-btn" onclick="addOption(' + idx + ')">+ –î–æ–¥–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç</button></div>' +
        '<div class="form-row"><label class="form-label">–ß–∞—Å –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è (—Å–µ–∫)</label>' +
        '<input class="form-input" type="number" data-q="' + idx + '" data-field="timeLimit" value="' + q.timeLimit + '"></div>' +
        '<div class="free-toggle-create" onclick="toggleFreeCreate(' + idx + ')">' +
        '<div class="toggle-switch ' + (q.allowFree ? 'on' : '') + '"></div><span>–î–æ–∑–≤–æ–ª–∏—Ç–∏ –≤—ñ–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å</span></div></div>';
}

window.addQuestion = () => {
    const container = document.getElementById('questionsContainer');
    const count = document.querySelectorAll('.q-block').length;
    container.insertAdjacentHTML('beforeend', buildQuestionBlock(count));
};

window.deleteQuestion = idx => {
    const blocks = document.querySelectorAll('.q-block');
    if (blocks.length <= 1) {
        alert('‚ùå –ú–∞—î –±—É—Ç–∏ —Ö–æ—á–∞ –± –æ–¥–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è!');
        return;
    }
    blocks[idx].remove();
    document.querySelectorAll('.q-block').forEach((block, i) => {
        block.querySelector('.q-num').textContent = '–ü–∏—Ç–∞–Ω–Ω—è ' + (i + 1);
        block.setAttribute('data-q', i);
    });
};

window.addOption = idx => {
    const block = document.querySelectorAll('.q-block')[idx];
    if (!block) return;
    
    const opts = block.querySelectorAll('.opt-row');
    if (opts.length >= 10) {
        alert('‚ùå –ú–∞–∫—Å–∏–º—É–º 10 –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤!');
        return;
    }
    
    const i = opts.length;
    const html = '<div class="opt-row">' +
        '<div class="opt-radio" onclick="toggleCorrect(' + idx + ',' + i + ')"></div>' +
        '<input class="opt-input" data-q="' + idx + '" data-opt="' + i + '" placeholder="–í–∞—Ä—ñ–∞–Ω—Ç ' + letters[i] + '">' +
        '<button class="opt-del" onclick="deleteOption(' + idx + ',' + i + ')">‚úï</button></div>';
    
    const container = block.querySelector('.opt-row:last-of-type');
    if (container) {
        container.insertAdjacentHTML('afterend', html);
    }
};

window.deleteOption = (qIdx, optIdx) => {
    const block = document.querySelectorAll('.q-block')[qIdx];
    if (!block) return;
    
    const opts = block.querySelectorAll('.opt-row');
    if (opts.length <= 2) {
        alert('‚ùå –ú–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 2 –≤–∞—Ä—ñ–∞–Ω—Ç–∏!');
        return;
    }
    
    if (!opts[optIdx]) return;
    opts[optIdx].remove();
    
    // –ü–µ—Ä–µ–±—É–¥–æ–≤—É—î–º–æ –≤—Å—ñ –æ–ø—Ü—ñ—ó –∑ –Ω–æ–≤–∏–º–∏ —ñ–Ω–¥–µ–∫—Å–∞–º–∏
    const newOpts = block.querySelectorAll('.opt-row');
    newOpts.forEach((row, i) => {
        const radio = row.querySelector('.opt-radio');
        const input = row.querySelector('.opt-input');
        const delBtn = row.querySelector('.opt-del');
        
        // –û–Ω–æ–≤–ª—é—î–º–æ onclick –¥–ª—è radio
        radio.setAttribute('onclick', 'toggleCorrect(' + qIdx + ',' + i + ')');
        
        // –û–Ω–æ–≤–ª—é—î–º–æ data –∞—Ç—Ä–∏–±—É—Ç–∏ –¥–ª—è input
        input.setAttribute('data-opt', i);
        input.setAttribute('placeholder', '–í–∞—Ä—ñ–∞–Ω—Ç ' + letters[i]);
        
        // –û–Ω–æ–≤–ª—é—î–º–æ onclick –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
        if (delBtn) {
            delBtn.setAttribute('onclick', 'deleteOption(' + qIdx + ',' + i + ')');
        }
    });
};

window.toggleCorrect = (qIdx, optIdx) => {
    const block = document.querySelectorAll('.q-block')[qIdx];
    block.querySelectorAll('.opt-radio').forEach(r => r.classList.remove('checked'));
    block.querySelectorAll('.opt-radio')[optIdx].classList.add('checked');
};

window.toggleFreeCreate = idx => {
    const block = document.querySelectorAll('.q-block')[idx];
    const toggle = block.querySelector('.toggle-switch');
    toggle.classList.toggle('on');
};

window.uploadTestPhoto = async () => {
    const input = document.getElementById('testPhotoInput');
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = e => {
        currentTestPhotos.push({url: e.target.result});
        renderCreateForm({
            id: editingTestId,
            name: document.getElementById('testName').value,
            description: document.getElementById('testDesc').value,
            emoji: document.getElementById('testEmoji').value,
            passScore: parseInt(document.getElementById('testPassScore').value) || 80,
            maxScore: parseInt(document.getElementById('testMaxScore').value) || 100,
            agreementText: document.getElementById('testAgreement').value,
            photos: currentTestPhotos,
            questions: collectQuestions()
        });
    };
    reader.readAsDataURL(file);
};

window.deleteTestPhoto = idx => {
    currentTestPhotos.splice(idx, 1);
    renderCreateForm({
        id: editingTestId,
        name: document.getElementById('testName').value,
        description: document.getElementById('testDesc').value,
        emoji: document.getElementById('testEmoji').value,
        passScore: parseInt(document.getElementById('testPassScore').value) || 80,
        maxScore: parseInt(document.getElementById('testMaxScore').value) || 100,
        agreementText: document.getElementById('testAgreement').value,
        photos: currentTestPhotos,
        questions: collectQuestions()
    });
};

window.uploadQuestionPhoto = idx => {
    const input = document.getElementById('qPhoto' + idx);
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = e => {
        const questions = collectQuestions();
        questions[idx].photo = e.target.result;
        renderCreateForm({
            id: editingTestId,
            name: document.getElementById('testName').value,
            description: document.getElementById('testDesc').value,
            emoji: document.getElementById('testEmoji').value,
            passScore: parseInt(document.getElementById('testPassScore').value) || 80,
            maxScore: parseInt(document.getElementById('testMaxScore').value) || 100,
            agreementText: document.getElementById('testAgreement').value,
            photos: currentTestPhotos,
            questions: questions
        });
    };
    reader.readAsDataURL(file);
};

window.deleteQuestionPhoto = idx => {
    const questions = collectQuestions();
    questions[idx].photo = null;
    renderCreateForm({
        id: editingTestId,
        name: document.getElementById('testName').value,
        description: document.getElementById('testDesc').value,
        emoji: document.getElementById('testEmoji').value,
        passScore: parseInt(document.getElementById('testPassScore').value) || 80,
        maxScore: parseInt(document.getElementById('testMaxScore').value) || 100,
        agreementText: document.getElementById('testAgreement').value,
        photos: currentTestPhotos,
        questions: questions
    });
};

function collectQuestions() {
    const questions = [];
    document.querySelectorAll('.q-block').forEach((block, idx) => {
        const text = block.querySelector('[data-field="text"]').value.trim();
        const timeLimit = parseInt(block.querySelector('[data-field="timeLimit"]').value) || 30;
        const allowFree = block.querySelector('.toggle-switch').classList.contains('on');
        
        const options = [];
        block.querySelectorAll('.opt-row').forEach((row, i) => {
            const input = row.querySelector('.opt-input');
            const radio = row.querySelector('.opt-radio');
            options.push({
                text: input.value.trim(),
                correct: radio.classList.contains('checked')
            });
        });
        
        const photoInput = document.getElementById('qPhoto' + idx);
        const existingPhoto = block.querySelector('.question-photo-preview img');
        
        questions.push({
            text,
            options,
            timeLimit,
            allowFree,
            answerType: 'normal',
            tableData: null,
            photo: existingPhoto ? existingPhoto.src : null
        });
    });
    return questions;
}

window.saveTest = async () => {
    const name = document.getElementById('testName').value.trim();
    const description = document.getElementById('testDesc').value.trim();
    const emoji = document.getElementById('testEmoji').value.trim() || 'üìù';
    const passScore = parseInt(document.getElementById('testPassScore').value) || 80;
    const maxScore = parseInt(document.getElementById('testMaxScore').value) || 100;
    const agreementText = document.getElementById('testAgreement').value.trim();
    
    if (!name) {
        alert('‚ùå –í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —ñ—Å–ø–∏—Ç—É!');
        return;
    }
    
    const questions = collectQuestions();
    
    if (questions.length === 0) {
        alert('‚ùå –î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è!');
        return;
    }
    
    let hasErrors = false;
    questions.forEach((q, i) => {
        if (!q.text) {
            alert('‚ùå –ü–∏—Ç–∞–Ω–Ω—è ' + (i + 1) + ' –Ω–µ –º–∞—î —Ç–µ–∫—Å—Ç—É!');
            hasErrors = true;
            return;
        }
        if (!q.options.some(o => o.correct) && !q.allowFree) {
            alert('‚ùå –ü–∏—Ç–∞–Ω–Ω—è ' + (i + 1) + ' –Ω–µ –º–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ!');
            document.querySelectorAll('.q-block')[i].classList.add('error');
            hasErrors = true;
            return;
        }
    });
    
    if (hasErrors) return;
    
    const testObj = {
        name,
        description,
        emoji,
        passScore,
        maxScore,
        questions,
        agreementText,
        photos: currentTestPhotos,
        createdBy: ME.name,
        createdByUid: ME.uid
    };
    
    const success = await saveTestToFirebase(testObj);
    if (success) {
        editingTestId = null;
        currentTestPhotos = [];
        showView('manage');
    }
};

window.cancelCreate = () => {
    editingTestId = null;
    currentTestPhotos = [];
    showView('home');
};

window.startIntro = id => {
const t = tests.find(x => x.id === id);
if (!t) return;

if (!IS_PUBLIC_MODE) {
const myResults = results.filter(r => r.testId === id && r.userId === ME.uid);
const hasPending = myResults.find(r => r.status === 'pending' || (r.status === 'auto' && !r.reviewedByHuman));
if (hasPending) {
alert('‚ö†Ô∏è –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —ñ—Å–ø–∏—Ç —â–µ –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ –ª—é–¥–∏–Ω–æ—é! –î–æ—á–µ–∫–∞–π—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.');
return;
}
}

currentTest = t;
agreementAccepted = false;

let totalTime = 0;
t.questions.forEach(q => {totalTime += (q.timeLimit || 30)});
const pps = t.maxScore > 0 ? Math.round(t.maxScore / t.questions.length * 10) / 10 : 0;

let photosHtml = '';
if (t.photos && t.photos.length > 0) {
photosHtml = '<div style="margin:25px 0"><h4 style="font-size:14px;font-weight:800;margin-bottom:15px;color:var(--primary-bright)">üì∏ –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ —ñ—Å–ø–∏—Ç—É</h4>' +
'<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px">';
t.photos.forEach(p => {
photosHtml += '<img src="' + p.url + '" style="width:100%;height:100px;object-fit:cover;border-radius:12px;cursor:zoom-in;border:1px solid rgba(255,255,255,0.1)" onclick="openLightbox(\'' + p.url + '\')">';
});
photosHtml += '</div></div>';
}

let agreementHtml = '';
if (t.agreementText && t.agreementText.trim()) {
agreementHtml = '<div class="agreement-box"><label class="agreement-check">' +
'<input type="checkbox" id="agreementCheckbox" onchange="toggleAgreement()">' +
'<div class="agreement-text"><strong>üìú –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∞ —É–≥–æ–¥–∞:</strong><br>' + t.agreementText + '</div></label></div>';
} else {
agreementAccepted = true;
}

document.getElementById('introCard').innerHTML = 
'<span class="emoji">' + (t.emoji || 'üìù') + '</span><h2>' + t.name + '</h2><p>' + (t.description || '') + '</p>' + photosHtml +
'<div style="margin:25px 0;display:grid;grid-template-columns:1fr 1fr;gap:10px;text-align:center">' +
'<div style="background:rgba(0,255,68,0.05);border:1px solid rgba(0,255,68,0.15);border-radius:12px;padding:15px">' +
'<div style="font-size:22px;font-weight:900;color:var(--primary)">' + t.questions.length + '</div>' +
'<div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ü–ò–¢–ê–ù–¨</div></div>' +
'<div style="background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.15);border-radius:12px;padding:15px">' +
'<div style="font-size:22px;font-weight:900;color:var(--warning)">' + t.passScore + '/' + t.maxScore + '</div>' +
'<div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ü–†–û–•–Ü–î–ù–ò–ô –ë–ê–õ</div></div>' +
'<div style="background:rgba(59,130,246,0.05);border:1px solid rgba(59,130,246,0.15);border-radius:12px;padding:15px">' +
'<div style="font-size:22px;font-weight:900;color:var(--info)">‚è± ' + totalTime + '—Å</div>' +
'<div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ó–ê–ì–ê–õ–¨–ù–ò–ô –ß–ê–°</div></div>' +
'<div style="background:rgba(16,185,129,0.05);border:1px solid rgba(16,185,129,0.15);border-radius:12px;padding:15px">' +
'<div style="font-size:22px;font-weight:900;color:var(--success)">' + pps + '</div>' +
'<div style="font-size:10px;color:var(--text-gray);margin-top:4px">–ë–ê–õ–Ü–í –ó–ê –ü–ò–¢–ê–ù–ù–Ø</div></div></div>' +
agreementHtml +
'<div class="btn-group">' +
'<button class="btn btn-primary" onclick="beginQuiz()" id="startQuizBtn" ' + (!agreementAccepted ? 'disabled' : '') + '>üöÄ –†–û–ó–ü–û–ß–ê–¢–ò –Ü–°–ü–ò–¢</button>' +
(!IS_PUBLIC_MODE ? '<button class="btn btn-secondary" onclick="showView(\'home\')">‚Üê –ù–∞–∑–∞–¥</button>' : '') +
'</div>';

showView('intro');
};

window.toggleAgreement = () => {
const checkbox = document.getElementById('agreementCheckbox');
agreementAccepted = checkbox.checked;
document.getElementById('startQuizBtn').disabled = !agreementAccepted;
};

window.openLightbox = url => {
const lb = document.getElementById('lightbox');
document.getElementById('lightboxImg').src = url;
lb.classList.add('active');
document.body.style.overflow = 'hidden';
};

window.closeLightbox = () => {
document.getElementById('lightbox').classList.remove('active');
document.body.style.overflow = 'auto';
};

window.beginQuiz = () => {
    if (!agreementAccepted) {
        alert('‚ö†Ô∏è –ü–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–∏–π–Ω—è—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—É —É–≥–æ–¥—É!');
        return;
    }
    currentQ = 0;
    answers = {};
    
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç–µ—Å—Ç –≤ sessionStorage
    sessionStorage.setItem('quizInProgress', JSON.stringify({
        testId: currentTest.id,
        testData: currentTest,
        currentQ: 0,
        answers: {}
    }));
    
    showView('quiz');
    renderQuestion();
};

function renderQuestion() {
if (!currentTest || currentQ >= currentTest.questions.length) {
finishQuiz();
return;
}

const q = currentTest.questions[currentQ];
const progress = ((currentQ + 1) / currentTest.questions.length) * 100;
timeLeft = q.timeLimit || 30;

let questionPhotoHtml = '';
if (q.photo) {
questionPhotoHtml = '<div class="quiz-question-photo"><img src="' + q.photo + '" onclick="openLightbox(\'' + q.photo + '\')"></div>';
}

let answersHtml = '';
if (q.answerType === 'table' && q.tableData) {
const cols = q.tableData.columns;
const rows = q.tableData.rows;
answersHtml = '<div class="answer-table-wrapper"><table class="answer-table"><thead><tr><th style="width:50px"></th>';
cols.forEach(col => { answersHtml += '<th>' + col + '</th>'; });
answersHtml += '</tr></thead><tbody>';
rows.forEach((row, ri) => {
answersHtml += '<tr onclick="selectTableAnswer(' + ri + ')" style="cursor:pointer"><td><div class="table-radio" id="table-radio-' + ri + '"></div></td>';
row.forEach(cell => { answersHtml += '<td>' + cell + '</td>'; });
answersHtml += '</tr>';
});
answersHtml += '</tbody></table></div>';
} else {
answersHtml = '<div class="quiz-answers">';
q.options.forEach((opt, i) => {
answersHtml += '<div class="answer-btn" onclick="selectAnswer(' + i + ')">' +
'<div class="answer-letter" id="ans-' + i + '">' + (letters[i] || (i + 1)) + '</div><div>' + opt.text + '</div></div>';
});
answersHtml += '</div>';
}

let freeHtml = '';
if (q.allowFree) {
freeHtml = '<div class="free-answer-area">' +
'<div class="free-answer-toggle" id="freeToggle" onclick="toggleFreeAnswer()"><div style="font-size:20px">‚úçÔ∏è</div><div>–ê–±–æ –¥–∞—Ç–∏ –≤—ñ–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å</div></div>' +
'<textarea class="free-input" id="freeInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å..." style="display:none"></textarea></div>';
}

document.getElementById('quizContainer').innerHTML = 
'<div class="quiz-progress-bar"><div class="quiz-progress-fill" style="width:' + progress + '%"></div></div>' +
'<div class="quiz-header">' +
'<div style="font-size:14px;font-weight:800;color:var(--primary)">–ü–∏—Ç–∞–Ω–Ω—è ' + (currentQ + 1) + ' –∑ ' + currentTest.questions.length + '</div>' +
'<div class="quiz-timer" id="timer">' + timeLeft + '—Å</div></div>' +
'<div class="quiz-question"><h3>' + q.text + '</h3>' + questionPhotoHtml + '</div>' +
answersHtml + freeHtml +
'<div class="btn-group"><button class="btn btn-primary" onclick="nextQuestion()">' +
(currentQ === currentTest.questions.length - 1 ? '‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —ñ—Å–ø–∏—Ç' : '–î–∞–ª—ñ ‚û°') + '</button></div>';

if (timer) clearInterval(timer);
timer = setInterval(updateTimer, 1000);

if (answers[currentQ]) {
const ans = answers[currentQ];
if (ans.type === 'free') {
document.getElementById('freeToggle').classList.add('active');
document.getElementById('freeInput').style.display = 'block';
document.getElementById('freeInput').value = ans.answer;
} else if (ans.type === 'table') {
const radio = document.getElementById('table-radio-' + ans.answer);
if (radio) radio.classList.add('checked');
} else {
const btn = document.querySelectorAll('.answer-btn')[ans.answer];
if (btn) btn.classList.add('selected');
}
}
}

function updateTimer() {
timeLeft--;
const timerEl = document.getElementById('timer');
if (timerEl) {
timerEl.textContent = timeLeft + '—Å';
if (timeLeft <= 10) timerEl.classList.add('danger');
}
if (timeLeft <= 0) {
clearInterval(timer);
nextQuestion();
}
}

window.selectAnswer = i => {
    document.querySelectorAll('.answer-btn').forEach(b => b.classList.remove('selected'));
    document.querySelectorAll('.answer-btn')[i].classList.add('selected');
    answers[currentQ] = {type: 'normal', answer: i};
    const freeToggle = document.getElementById('freeToggle');
    const freeInput = document.getElementById('freeInput');
    if (freeToggle) {
        freeToggle.classList.remove('active');
        freeInput.style.display = 'none';
        freeInput.value = '';
    }
    sessionStorage.setItem('quizInProgress', JSON.stringify({
        testId: currentTest.id,
        testData: currentTest,
        currentQ: currentQ,
        answers: answers
    }));
};

window.selectTableAnswer = ri => {
    document.querySelectorAll('.table-radio').forEach(r => r.classList.remove('checked'));
    document.getElementById('table-radio-' + ri).classList.add('checked');
    answers[currentQ] = {type: 'table', answer: ri};
    const freeToggle = document.getElementById('freeToggle');
    const freeInput = document.getElementById('freeInput');
    if (freeToggle) {
        freeToggle.classList.remove('active');
        freeInput.style.display = 'none';
        freeInput.value = '';
    }
    sessionStorage.setItem('quizInProgress', JSON.stringify({
        testId: currentTest.id,
        testData: currentTest,
        currentQ: currentQ,
        answers: answers
    }));
};

window.toggleFreeAnswer = () => {
const toggle = document.getElementById('freeToggle');
const input = document.getElementById('freeInput');
toggle.classList.toggle('active');
const isActive = toggle.classList.contains('active');
input.style.display = isActive ? 'block' : 'none';
if (isActive) {
input.focus();
document.querySelectorAll('.answer-btn').forEach(b => b.classList.remove('selected'));
document.querySelectorAll('.table-radio').forEach(r => r.classList.remove('checked'));
}
};

let nextQuestionLocked = false;

window.nextQuestion = () => {
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
    if (nextQuestionLocked) {
        return;
    }
    
    const freeInput = document.getElementById('freeInput');
    if (freeInput && freeInput.style.display !== 'none' && freeInput.value.trim()) {
        answers[currentQ] = {type: 'free', answer: freeInput.value.trim()};
    }

    if (!answers[currentQ]) {
        if (!confirm('‚ö†Ô∏è –í–∏ –Ω–µ –≤–∏–±—Ä–∞–ª–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å! –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –±–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ?')) return;
        answers[currentQ] = {type: 'none', answer: null};
    }

    // –ë–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫—É –Ω–∞ 2 —Å–µ–∫—É–Ω–¥–∏
    nextQuestionLocked = true;
    
    clearInterval(timer);
    currentQ++;
clearInterval(timer);
    currentQ++;
    
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å
    sessionStorage.setItem('quizInProgress', JSON.stringify({
        testId: currentTest.id,
        testData: currentTest,
        currentQ: currentQ,
        answers: answers
    }));
    
    renderQuestion();
    
    // –†–æ–∑–±–ª–æ–∫—É—î–º–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏
    setTimeout(() => {
        nextQuestionLocked = false;
    }, 2000);
};

async function finishQuiz() {
clearInterval(timer);

let score = 0;
let correctCount = 0;
let details = [];
const pointsPerQuestion = currentTest.maxScore / currentTest.questions.length;

currentTest.questions.forEach((q, i) => {
const userAns = answers[i];
let isCorrect = false;
let status = 'wrong';
let userAnswer = '–ë–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ';
let correctAnswer = '';
let points = 0;

if (!userAns || userAns.type === 'none') {
userAnswer = '–ë–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ';
status = 'wrong';
} else if (userAns.type === 'free') {
userAnswer = userAns.answer;
status = 'pending';
points = pointsPerQuestion;
} else if (userAns.type === 'table') {
const correctIdx = q.tableData.correctRowIndex;
isCorrect = userAns.answer === correctIdx;
status = isCorrect ? 'correct' : 'wrong';
userAnswer = '–†—è–¥–æ–∫ ' + (userAns.answer + 1);
correctAnswer = '–†—è–¥–æ–∫ ' + (correctIdx + 1);
if (isCorrect) {
score += pointsPerQuestion;
correctCount++;
points = pointsPerQuestion;
}
} else {
const selectedOpt = q.options[userAns.answer];
isCorrect = selectedOpt && selectedOpt.correct;
status = isCorrect ? 'correct' : 'wrong';
userAnswer = selectedOpt ? selectedOpt.text : '–ù–µ–≤—ñ–¥–æ–º–æ';
const correctOpt = q.options.find(o => o.correct);
correctAnswer = correctOpt ? correctOpt.text : '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
if (isCorrect) {
score += pointsPerQuestion;
correctCount++;
points = pointsPerQuestion;
}
}

details.push({
qText: q.text,
userAnswer,
correctAnswer,
status,
points: Math.round(points * 100) / 100
});
});

score = Math.round(score * 100) / 100;
const hasPendingQuestions = details.some(d => d.status === 'pending');
const resultStatus = hasPendingQuestions ? 'pending' : 'auto';
const userName = ME.name;
const userRole = IS_PUBLIC_MODE ? '–ü—É–±–ª—ñ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á' : (ME.role === 'admin' ? '–ê–¥–º—ñ–Ω' : ME.role === 'instructor' ? '–Ü–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä' : '–ë—ñ—î—Ü—å');

const result = {
testId: currentTest.id,
testName: currentTest.name,
userId: ME.uid,
userName: userName,
userRole: userRole,
score,
maxScore: currentTest.maxScore,
passScore: currentTest.passScore,
details,
status: resultStatus,
date: now(),
reviewer: null,
reviewedByHuman: false,
isPublic: IS_PUBLIC_MODE
};

try {
const docRef = await addDoc(collection(db, 'results'), {
...result,
createdAt: serverTimestamp()
});
result.id = docRef.id;
console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ Firebase –∑ ID:', docRef.id);

await sendDiscordNotification('QUIZ_COMPLETED', {
testName: currentTest.name,
userName: userName,
userRole: userRole,
score,
maxScore: currentTest.maxScore,
passScore: currentTest.passScore,
correctAnswers: correctCount,
totalQuestions: currentTest.questions.length,
status: resultStatus,
passed: score >= currentTest.passScore,
date: now()
});
console.log('‚úÖ Discord notification –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');

if (!IS_PUBLIC_MODE) {
addNotif('üìù –í–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —ñ—Å–ø–∏—Ç "' + currentTest.name + '" –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º ' + score + '/' + currentTest.maxScore);
}
} catch (e) {
console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É:', e);
alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É: ' + e.message);
return;
}

showResult(result);
  // –û—á–∏—â–∞—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å
sessionStorage.removeItem('quizInProgress');
}

function showResult(result) {
const passed = result.score >= result.passScore;
const statusClass = passed ? 'pass' : 'fail';
const statusText = passed ? '‚úÖ –°–ö–õ–ê–î–ï–ù–û' : '‚ùå –ù–ï –°–ö–õ–ê–î–ï–ù–û';

if (result.status === 'pending') {
document.getElementById('resultScreen').innerHTML = 
'<div class="intro-card"><span class="emoji">‚è≥</span><h2>–Ü—Å–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É</h2>' +
'<p style="margin:20px 0;font-size:14px">–í–∞—à—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –º—ñ—Å—Ç—è—Ç—å –≤—ñ–ª—å–Ω—ñ –ø–∏—Ç–∞–Ω–Ω—è, —è–∫—ñ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å —Ä—É—á–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–º.</p>' +
'<div style="margin:25px 0;text-align:center"><div style="font-size:32px;font-weight:900;color:var(--warning)">' + result.score + ' / ' + result.maxScore + '</div>' +
'<div style="font-size:12px;color:var(--text-gray);margin-top:8px">–ü–û–ü–ï–†–ï–î–ù–Ü–ô –ë–ê–õ</div></div>' +
'<p style="font-size:13px;color:var(--text-gray)">–û—á—ñ–∫—É–π—Ç–µ –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏.</p>' +
(IS_PUBLIC_MODE ? '<div class="btn-group"><button class="btn btn-primary" onclick="location.reload()">üè† –ó–∞–≤–µ—Ä—à–∏—Ç–∏</button></div>' : 
'<div class="btn-group"><button class="btn btn-primary" onclick="showView(\'home\')">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</button></div>') + '</div>';
} else {
let detailsHtml = '';
result.details.forEach((d, i) => {
const mark = d.status === 'correct' ? 'ok' : d.status === 'pending' ? 'pend' : 'no';
const icon = d.status === 'correct' ? '‚úì' : d.status === 'pending' ? '?' : '‚úï';
detailsHtml += '<div class="result-detail"><div class="mark ' + mark + '">' + icon + '</div><div style="flex:1">' +
'<div style="font-size:13px;font-weight:700;margin-bottom:4px">' + (i + 1) + '. ' + d.qText + '</div>' +
'<div style="font-size:12px;color:var(--text-light)">–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: <b>' + d.userAnswer + '</b></div>' +
(d.status !== 'pending' ? '<div style="font-size:11px;color:var(--primary);margin-top:2px">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ' + d.correctAnswer + '</div>' : '') +
'</div></div>';
});

document.getElementById('resultScreen').innerHTML = 
'<div class="intro-card"><div class="result-circle ' + statusClass + '">' +
'<div class="result-score">' + result.score + '</div><div class="result-max">–∑ ' + result.maxScore + '</div></div>' +
'<div class="result-status ' + statusClass + '">' + statusText + '</div>' +
'<p style="margin-bottom:20px;color:var(--text-gray);font-size:13px">–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π: <b>' + 
result.details.filter(d => d.status === 'correct').length + '</b> –∑ ' + result.details.length + '</p>' +
detailsHtml +
(IS_PUBLIC_MODE ? '<div class="btn-group"><button class="btn btn-primary" onclick="location.reload()">üè† –ó–∞–≤–µ—Ä—à–∏—Ç–∏</button></div>' : 
'<div class="btn-group"><button class="btn btn-primary" onclick="showView(\'home\')">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</button></div>') + '</div>';
}

showView('result');
}

console.log('‚úÖ –ß–∞—Å—Ç–∏–Ω–∞ 2 –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ - Quiz —Ç–∞ Results');
  // –ß–ê–°–¢–ò–ù–ê 4, 5, 6 - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è, –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, —ñ—Å—Ç–æ—Ä—ñ—è

function renderReview() {
const pending = results.filter(r => r.status === 'pending' || (r.status === 'auto' && !r.reviewedByHuman));
if (pending.length === 0) {
document.getElementById('reviewList').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px">–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ ‚úì</div>';
return;
}

let html = '';
pending.forEach(r => {
const t = tests.find(x => x.id === r.testId);
let questionsHtml = '';
r.details.forEach((d, i) => {
let cls = d.status === 'correct' ? 'auto-ok' : d.status === 'pending' ? 'pending' : 'auto-fail';
let pts = d.status === 'correct' ? '<span class="q-points" style="color:var(--primary)">+' + Math.round(d.points * 10) / 10 + ' –±.</span>' :
d.status === 'wrong' ? '<span class="q-points" style="color:var(--danger)">0 –±.</span>' :
'<span class="q-points" style="color:var(--warning)">? –±. ‚Äî –ø–æ—Ç—Ä—ñ–±–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞</span>';

let pointsControl = '';
if (d.status === 'pending') {
const maxPts = t ? Math.round(t.maxScore / t.questions.length * 10) / 10 : 1;
pointsControl = '<div class="points-control">' +
'<button class="points-btn minus" onclick="adjustPoints(\'' + r.id + '\', ' + i + ', -0.5)">‚àí</button>' +
'<span class="points-display" id="points-' + r.id + '-' + i + '">' + d.points.toFixed(1) + ' –±.</span>' +
'<button class="points-btn plus" onclick="adjustPoints(\'' + r.id + '\', ' + i + ', 0.5)">+</button>' +
'<button class="btn btn-primary" style="padding:6px 12px;font-size:11px;margin-left:8px" onclick="setMaxPoints(\'' + r.id + '\', ' + i + ', ' + maxPts + ')">MAX</button>' +
'<button class="btn btn-secondary" style="padding:6px 12px;font-size:11px" onclick="setMaxPoints(\'' + r.id + '\', ' + i + ', 0)">0</button></div>';
}

questionsHtml += '<div class="review-q ' + cls + '"><div class="q-title">' + (i + 1) + '. ' + d.qText + '</div>' +
'<div class="q-answer">–í—ñ–¥–ø–æ–≤—ñ–¥—å: <b>' + d.userAnswer + '</b></div>' +
(d.status !== 'pending' ? '<div class="q-correct">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ' + d.correctAnswer + '</div>' : '') +
'<div>' + pts + '</div>' + pointsControl + '</div>';
});

const hasFreeQ = r.details.some(d => d.status === 'pending');
const currentTotal = r.details.reduce((sum, d) => sum + d.points, 0).toFixed(1);

html += '<div class="review-card">' +
'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px">' +
'<div><h3 style="font-size:16px;font-weight:800">' + r.userName + '</h3>' +
'<div style="font-size:12px;color:var(--text-gray)">' + (r.testName || '–Ü—Å–ø–∏—Ç') + ' ‚Ä¢ ' + r.date + '</div></div>' +
'<div style="font-size:18px;font-weight:900;color:var(--primary)" id="totalScore-' + r.id + '">' + currentTotal + ' / ' + r.maxScore + ' –±.</div></div>' +
questionsHtml +
(hasFreeQ ? '<div style="margin-top:15px;padding:15px;background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.15);border-radius:12px">' +
'<div style="font-size:12px;font-weight:800;color:var(--warning);margin-bottom:10px">‚ö†Ô∏è –í—ñ–ª—å–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</div>' +
'<div class="btn-group" style="margin-top:10px">' +
'<button class="btn btn-primary" onclick="approveResult(\'' + r.id + '\')">‚úÖ –°—Ö–≤–∞–ª–∏—Ç–∏ –∑ –ø–æ—Ç–æ—á–Ω–∏–º–∏ –±–∞–ª–∞–º–∏</button>' +
'<button class="btn btn-danger" onclick="rejectResult(\'' + r.id + '\')">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏ (0 –±–∞–ª—ñ–≤ –∑–∞ –≤—ñ–ª—å–Ω—ñ)</button></div></div>' : 
'<div class="btn-group">' +
'<button class="btn btn-primary" onclick="approveResult(\'' + r.id + '\')">‚úÖ –°—Ö–≤–∞–ª–∏—Ç–∏</button>' +
'<button class="btn btn-danger" onclick="rejectResult(\'' + r.id + '\')">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button></div>') +
'</div>';
});
document.getElementById('reviewList').innerHTML = html;
}

window.adjustPoints = (resultId, qIndex, delta) => {
const r = results.find(x => x.id === resultId);
if (!r) return;
const d = r.details[qIndex];
if (d.status !== 'pending') return;
const t = tests.find(x => x.id === r.testId);
const maxPts = t ? Math.round(t.maxScore / t.questions.length * 10) / 10 : 10;
d.points = Math.max(0, Math.min(maxPts, d.points + delta));
d.points = Math.round(d.points * 10) / 10;
const pointsEl = document.getElementById('points-' + resultId + '-' + qIndex);
if (pointsEl) pointsEl.textContent = d.points.toFixed(1) + ' –±.';
const newTotal = r.details.reduce((sum, detail) => sum + detail.points, 0).toFixed(1);
const totalEl = document.getElementById('totalScore-' + resultId);
if (totalEl) totalEl.textContent = newTotal + ' / ' + r.maxScore + ' –±.';
updateDoc(doc(db, 'results', resultId), {details: r.details}).catch(e => console.error('Update error:', e));
};

window.setMaxPoints = (resultId, qIndex, points) => {
const r = results.find(x => x.id === resultId);
if (!r) return;
const d = r.details[qIndex];
if (d.status !== 'pending') return;
d.points = points;
const pointsEl = document.getElementById('points-' + resultId + '-' + qIndex);
if (pointsEl) pointsEl.textContent = d.points.toFixed(1) + ' –±.';
const newTotal = r.details.reduce((sum, detail) => sum + detail.points, 0).toFixed(1);
const totalEl = document.getElementById('totalScore-' + resultId);
if (totalEl) totalEl.textContent = newTotal + ' / ' + r.maxScore + ' –±.';
updateDoc(doc(db, 'results', resultId), {details: r.details}).catch(e => console.error('Update error:', e));
};

window.approveResult = async (id) => {
const r = results.find(x => x.id === id);
if (!r) return;
r.score = 0;
r.details.forEach(d => {
if (d.status === 'pending') d.status = 'correct';
r.score += d.points;
});
r.score = Math.round(r.score * 100) / 100;
r.status = 'approved';
r.reviewer = ME.name;
r.reviewedByHuman = true;
try {
await updateDoc(doc(db, 'results', id), {score: r.score, details: r.details, status: 'approved', reviewer: ME.name, reviewedByHuman: true});
console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ –≤ Firebase');
} catch (e) {
console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:', e);
}
addNotif('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç ' + r.userName + ' —Å—Ö–≤–∞–ª–µ–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–º ' + ME.name);
await sendDiscordNotification('RESULT_APPROVED', {userName: r.userName, testName: r.testName, finalScore: r.score, maxScore: r.maxScore, reviewer: ME.name, status: 'approved', date: now()});
renderReview();
};

window.rejectResult = async (id) => {
const r = results.find(x => x.id === id);
if (!r) return;
r.details.forEach(d => {
if (d.status === 'pending') {
d.status = 'wrong';
d.points = 0;
}
});
r.score = r.details.reduce((sum, d) => sum + d.points, 0);
r.score = Math.round(r.score * 100) / 100;
r.status = 'rejected';
r.reviewer = ME.name;
r.reviewedByHuman = true;
try {
await updateDoc(doc(db, 'results', id), {score: r.score, details: r.details, status: 'rejected', reviewer: ME.name, reviewedByHuman: true});
console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ –≤ Firebase');
} catch (e) {
console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:', e);
}
addNotif('‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç ' + r.userName + ' –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–º ' + ME.name);
await sendDiscordNotification('RESULT_REJECTED', {userName: r.userName, testName: r.testName, score: r.score, maxScore: r.maxScore, reviewer: ME.name, date: now()});
renderReview();
};

function renderManage() {
if (tests.length === 0) {
document.getElementById('manageList').innerHTML = '<div style="color:var(--text-gray);text-align:center;padding:40px;font-size:14px">–ù–µ–º–∞—î —ñ—Å–ø–∏—Ç—ñ–≤</div>';
return;
}
let html = '';
tests.forEach(t => {
const res = results.filter(r => r.testId === t.id);
const passed = res.filter(r => (r.status === 'approved' || r.status === 'auto') && r.score >= t.passScore && r.reviewedByHuman).length;
html += '<div class="manage-card"><div>' +
'<b style="font-size:15px">' + t.emoji + ' ' + t.name + '</b><br>' +
'<span style="font-size:11px;color:var(--text-gray)">–ü–∏—Ç–∞–Ω—å: ' + t.questions.length + ' ‚Ä¢ –ú–∞–∫—Å: ' + t.maxScore + '–± ‚Ä¢ –ü—Ä–æ—Ö—ñ–¥: ' + t.passScore + '–± ‚Ä¢ –ü—Ä–æ–π—à–ª–∏: ' + passed + '/' + res.length + '</span>' +
'</div><div style="display:flex;gap:8px;flex-wrap:wrap">' +
'<button class="btn btn-info" onclick="editTest(\'' + t.id + '\')" style="padding:8px 14px;font-size:11px">‚úèÔ∏è</button>' +
'<button class="btn btn-warning" onclick="clearTestResults(\'' + t.id + '\')" style="padding:8px 14px;font-size:11px">üßπ</button>' +
'<button class="btn btn-danger" onclick="deleteTest(\'' + t.id + '\')" style="padding:8px 14px;font-size:11px">üóë</button>' +
'</div></div>';
});
document.getElementById('manageList').innerHTML = html;
}

window.editTest = id => {
    const t = tests.find(x => x.id === id);
    if (!t) {
        alert('‚ùå –¢–µ—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
        return;
    }
    
    console.log('–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–µ—Å—Ç—É:', t);
    
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ ID –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    editingTestId = t.id;
    currentTestPhotos = t.photos || [];
    
    // –ü–µ—Ä–µ–¥–∞—î–º–æ –ø–æ–≤–Ω—ñ –¥–∞–Ω—ñ —Ç–µ—Å—Ç—É
    renderCreateForm({
        id: t.id,
        name: t.name || '',
        description: t.description || '',
        emoji: t.emoji || 'üìù',
        passScore: t.passScore || 80,
        maxScore: t.maxScore || 100,
        agreementText: t.agreementText || '',
        photos: t.photos || [],
        questions: t.questions || []
    });
    
    showView('create');
};

window.clearTestResults = async (id) => {
if (confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ü—å–æ–≥–æ —ñ—Å–ø–∏—Ç—É?')) {
const t = tests.find(x => x.id === id);
const testName = t ? t.name : '–ù–µ–≤—ñ–¥–æ–º–∏–π —ñ—Å–ø–∏—Ç';
const toDelete = results.filter(r => r.testId === id);
for (let res of toDelete) {
try {
await deleteDoc(doc(db, 'results', res.id));
} catch (e) {
console.error('Delete error:', e);
}
}
await sendDiscordNotification('RESULTS_CLEARED', {testName: testName, clearedBy: ME.name, count: toDelete.length, date: now()});
renderManage();
}
};

window.deleteTest = async id => {
if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å–ø–∏—Ç?')) {
const success = await deleteTestFromFirebase(id);
if (success) renderManage();
}
};

function renderHistory() {
const allResults = [...results];
const uniqueTests = [...new Set(allResults.map(r => r.testName))];
const totalAttempts = allResults.length;
const totalPassed = allResults.filter(r => r.score >= r.passScore && r.reviewedByHuman).length;
const totalFailed = allResults.filter(r => (r.score < r.passScore && r.reviewedByHuman) || r.status === 'rejected').length;
const totalPending = allResults.filter(r => r.status === 'pending' || !r.reviewedByHuman).length;

let tableRows = '';
if (allResults.length === 0) {
tableRows = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-gray)">–ù–µ–º–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</td></tr>';
} else {
allResults.forEach(r => {
const isPassed = r.score >= r.passScore && r.reviewedByHuman;
const isFailed = (r.score < r.passScore && r.reviewedByHuman) || r.status === 'rejected';
const isPending = r.status === 'pending' || !r.reviewedByHuman;
let statusBadge = '';
if (isPending) statusBadge = '<span class="status-badge st-pending">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</span>';
else if (isPassed) statusBadge = '<span class="status-badge st-pass">–°–∫–ª–∞–¥–µ–Ω–æ</span>';
else if (isFailed) statusBadge = '<span class="status-badge st-fail">–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ</span>';
const percentage = r.maxScore > 0 ? Math.round((r.score / r.maxScore) * 100) : 0;
tableRows += '<tr><td>' + r.userName + '</td><td>' + r.testName + '</td>' +
'<td><b>' + r.score + '</b> / ' + r.maxScore + '</td><td>' + percentage + '%</td>' +
'<td>' + statusBadge + '</td><td>' + (r.reviewer || 'SYSTEM') + '</td><td>' + r.date + '</td></tr>';
});
}

let testOptions = '';
uniqueTests.forEach(name => { testOptions += '<option value="' + name + '">' + name + '</option>'; });

document.getElementById('historyContent').innerHTML = 
'<div class="form-card">' +
'<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px">' +
'<div style="text-align:center;padding:15px;background:rgba(0,255,68,0.05);border-radius:12px;border:1px solid rgba(0,255,68,0.15)">' +
'<div style="font-size:24px;font-weight:900;color:var(--primary)">' + totalAttempts + '</div>' +
'<div style="font-size:10px;color:var(--text-gray);margin-top:4px;text-transform:uppercase">–í—Å—å–æ–≥–æ —Å–ø—Ä–æ–±</div></div>' +
'<div style="text-align:center;padding:15px;background:rgba(16,185,129,0.05);border-radius:12px;border:1px solid rgba(16,185,129,0.15)">' +
'<div style="font-size:24px;font-weight:900;color:var(--success)">' + totalPassed + '</div>' +
'<div style="font-size:10px;color:var(--text-gray);margin-top:4px;text-transform:uppercase">–°–∫–ª–∞–¥–µ–Ω–æ</div></div>' +
'<div style="text-align:center;padding:15px;background:rgba(239,68,68,0.05);border-radius:12px;border:1px solid rgba(239,68,68,0.15)">' +
'<div style="font-size:24px;font-weight:900;color:var(--danger)">' + totalFailed + '</div>' +
'<div style="font-size:10px;color:var(--text-gray);margin-top:4px;text-transform:uppercase">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div></div>' +
'<div style="text-align:center;padding:15px;background:rgba(251,191,36,0.05);border-radius:12px;border:1px solid rgba(251,191,36,0.15)">' +
'<div style="font-size:24px;font-weight:900;color:var(--warning)">' + totalPending + '</div>' +
'<div style="font-size:10px;color:var(--text-gray);margin-top:4px;text-transform:uppercase">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</div></div></div>' +
'<div class="history-filters">' +
'<input class="filter-input" id="filterUserInput" placeholder="üîç –ü–æ—à—É–∫ –ø–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É..." onchange="applyHistoryFilters()">' +
'<select class="filter-select" id="filterTestSelect" onchange="applyHistoryFilters()"><option value="">–í—Å—ñ —ñ—Å–ø–∏—Ç–∏</option>' + testOptions + '</select>' +
'<select class="filter-select" id="filterStatusSelect" onchange="applyHistoryFilters()">' +
'<option value="all">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option><option value="pass">–°–∫–ª–∞–¥–µ–Ω–æ</option><option value="fail">–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ</option><option value="pending">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</option></select>' +
'<button class="btn btn-secondary" onclick="resetHistoryFilters()" style="padding:10px 20px;font-size:12px">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>' +
'<button class="btn btn-primary" onclick="exportHistory()" style="padding:10px 20px;font-size:12px">üì• –ï–∫—Å–ø–æ—Ä—Ç</button></div>' +
'<div class="history-table-wrapper"><table class="history-table"><thead><tr>' +
'<th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th><th>–Ü—Å–ø–∏—Ç</th><th>–ë–∞–ª–∏</th><th>%</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π</th><th>–î–∞—Ç–∞</th></tr></thead>' +
'<tbody id="historyTableBody">' + tableRows + '</tbody></table></div></div>';
}

window.applyHistoryFilters = () => {
const userInput = document.getElementById('filterUserInput').value.toLowerCase();
const testSelect = document.getElementById('filterTestSelect').value;
const statusSelect = document.getElementById('filterStatusSelect').value;
const allResults = [...results];
let filtered = allResults.filter(r => {
if (userInput && !r.userName.toLowerCase().includes(userInput)) return false;
if (testSelect && r.testName !== testSelect) return false;
if (statusSelect !== 'all') {
const isPassed = r.score >= r.passScore && r.reviewedByHuman;
const isFailed = (r.score < r.passScore && r.reviewedByHuman) || r.status === 'rejected';
const isPending = r.status === 'pending' || !r.reviewedByHuman;
if (statusSelect === 'pass' && !isPassed) return false;
if (statusSelect === 'fail' && !isFailed) return false;
if (statusSelect === 'pending' && !isPending) return false;
}
return true;
});

let tableRows = '';
if (filtered.length === 0) {
tableRows = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-gray)">–ù–µ–º–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –∑–∞ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏</td></tr>';
} else {
filtered.forEach(r => {
const isPassed = r.score >= r.passScore && r.reviewedByHuman;
const isFailed = (r.score < r.passScore && r.reviewedByHuman) || r.status === 'rejected';
const isPending = r.status === 'pending' || !r.reviewedByHuman;
let statusBadge = '';
if (isPending) statusBadge = '<span class="status-badge st-pending">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</span>';
else if (isPassed) statusBadge = '<span class="status-badge st-pass">–°–∫–ª–∞–¥–µ–Ω–æ</span>';
else if (isFailed) statusBadge = '<span class="status-badge st-fail">–ù–µ —Å–∫–ª–∞–¥–µ–Ω–æ</span>';
const percentage = r.maxScore > 0 ? Math.round((r.score / r.maxScore) * 100) : 0;
tableRows += '<tr><td>' + r.userName + '</td><td>' + r.testName + '</td>' +
'<td><b>' + r.score + '</b> / ' + r.maxScore + '</td><td>' + percentage + '%</td>' +
'<td>' + statusBadge + '</td><td>' + (r.reviewer || 'SYSTEM') + '</td><td>' + r.date + '</td></tr>';
});
}
document.getElementById('historyTableBody').innerHTML = tableRows;
};

window.resetHistoryFilters = () => {
document.getElementById('filterUserInput').value = '';
document.getElementById('filterTestSelect').value = '';
document.getElementById('filterStatusSelect').value = 'all';
applyHistoryFilters();
};

window.exportHistory = () => {
const filtered = results;
let text = '–Ü–°–¢–û–†–Ü–Ø –Ü–°–ü–ò–¢–Ü–í –î–®–í\n' + '='.repeat(80) + '\n\n';
filtered.forEach(r => {
const status = r.status === 'pending' || !r.reviewedByHuman ? '–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ' : r.score >= r.passScore && r.reviewedByHuman ? '–°–ö–õ–ê–î–ï–ù–û' : '–ù–ï –°–ö–õ–ê–î–ï–ù–û';
text += '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ' + r.userName + '\n–Ü—Å–ø–∏—Ç: ' + r.testName + '\n–ë–∞–ª–∏: ' + r.score + ' / ' + r.maxScore + '\n' +
'–°—Ç–∞—Ç—É—Å: ' + status + '\n–ü–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏–π: ' + (r.reviewer || 'SYSTEM') + '\n–î–∞—Ç–∞: ' + r.date + '\n' + '-'.repeat(80) + '\n';
});
const blob = new Blob([text], {type: 'text/plain'});
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'history_' + Date.now() + '.txt';
a.click();
URL.revokeObjectURL(url);
};

function renderSettings() {
let reviewersHtml = '';
if (reviewers.length > 0) {
reviewers.forEach(r => {
reviewersHtml += '<span class="reviewer-chip">' + r + '<button onclick="removeReviewer(\'' + r + '\')">‚úï</button></span>';
});
} else {
reviewersHtml = '<span style="color:var(--text-gray);font-size:12px">–ù–µ –¥–æ–¥–∞–Ω–æ</span>';
}

document.getElementById('settingsContent').innerHTML = 
'<div class="setting-block"><h4>üîó Discord Webhook</h4><div class="form-row">' +
'<input class="form-input" id="webhookInput" value="' + webhookUrl + '" placeholder="https://discord.com/api/webhooks/..."></div>' +
'<div class="btn-group" style="justify-content:flex-start">' +
'<button class="btn btn-primary" onclick="saveWebhook()" style="padding:10px 20px;font-size:12px">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>' +
'<button class="btn btn-info" onclick="sendTestWebhook()" style="padding:10px 20px;font-size:12px">üß™ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</button></div></div>' +
'<div class="setting-block"><h4>üîç –ü–µ—Ä–µ–≤—ñ—Ä—é–≤–∞—á—ñ —ñ—Å–ø–∏—Ç—ñ–≤</h4>' +
'<div id="reviewersList" style="margin-bottom:12px">' + reviewersHtml + '</div>' +
'<div class="people-dropdown">' +
'<input class="form-input" id="reviewerSearch" placeholder="–ü–æ—à—É–∫ –ª—é–¥–∏–Ω–∏..." oninput="filterPeople(\'reviewer\')" onfocus="filterPeople(\'reviewer\')">' +
'<div class="people-list" id="reviewerDropdown"></div></div></div>';
}

window.saveWebhook = async () => {
webhookUrl = document.getElementById('webhookInput').value.trim();
await save();
alert('‚úÖ Webhook –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
};

window.sendTestWebhook = async () => {
const url = document.getElementById('webhookInput').value.trim();
if (!url) {
alert('‚ùå –í–≤–µ–¥—ñ—Ç—å Webhook URL —Å–ø–æ—á–∞—Ç–∫—É!');
return;
}
try {
const response = await fetch(url, {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({
embeds: [{
title: 'üß™ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è',
description: 'Webhook –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ! ‚úÖ',
color: 0x00ff44,
fields: [
{name: '–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫', value: ME.name, inline: true},
{name: '–†–æ–ª—å', value: ME.role, inline: true},
{name: '–ß–∞—Å', value: now(), inline: false}
],
footer: {text: '–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2'},
timestamp: new Date().toISOString()
}]
})
});
if (response.ok) {
alert('‚úÖ –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Discord!');
} else {
alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: ' + response.status);
}
} catch (e) {
alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message);
}
};

window.removeReviewer = async (n) => {
reviewers = reviewers.filter(r => r !== n);
await save();
renderSettings();
};

window.filterPeople = type => {
const input = document.getElementById(type + 'Search');
const drop = document.getElementById(type + 'Dropdown');
const val = input.value.toLowerCase();
const list = type === 'reviewer' ? allUsers.filter(u => !reviewers.includes(u.name)) : allUsers.filter(u => !adminList.includes(u.name));
const filtered = val ? list.filter(u => u.name.toLowerCase().includes(val)) : list;

if (filtered.length === 0) {
drop.innerHTML = '<div style="padding:15px;text-align:center;color:var(--text-gray);font-size:12px">–ù—ñ–∫–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
drop.classList.add('show');
return;
}

let html = '';
filtered.forEach(u => {
const roleLabel = u.role === 'admin' ? '–ê–¥–º—ñ–Ω' : u.role === 'instructor' ? '–Ü–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä' : '–ë—ñ—î—Ü—å';
const roleColor = u.role === 'admin' ? 'var(--primary)' : u.role === 'instructor' ? 'var(--warning)' : 'var(--text-gray)';
html += '<div class="people-item" onclick="selectPerson(\'' + type + '\',\'' + u.name + '\')">' +
'<span>' + u.name + '</span><span style="font-size:10px;color:' + roleColor + ';font-weight:700">' + roleLabel + '</span></div>';
});
drop.innerHTML = html;
drop.classList.add('show');
};

window.selectPerson = async (type, name) => {
if (type === 'reviewer' && !reviewers.includes(name)) {
reviewers.push(name);
await save();
await sendDiscordNotification('REVIEWER_ADDED', {reviewerName: name, addedBy: ME.name, date: now()});
renderSettings();
}
if (type === 'admin' && !adminList.includes(name)) {
adminList.push(name);
await save();
await sendDiscordNotification('ADMIN_ADDED', {adminName: name, addedBy: ME.name, date: now()});
renderAdminList();
buildNav();
}
document.querySelectorAll('.people-list').forEach(d => d.classList.remove('show'));
};

function renderAdminList() {
let adminChipsHtml = '';
if (adminList.length > 0) {
adminList.forEach(n => {
adminChipsHtml += '<span class="reviewer-chip" style="background:rgba(251,191,36,0.1);border-color:rgba(251,191,36,0.3);color:var(--warning)">' + 
n + '<button onclick="removeAdmin(\'' + n + '\')">‚úï</button></span>';
});
} else {
adminChipsHtml = '<span style="color:var(--text-gray);font-size:12px">–ù–µ –¥–æ–¥–∞–Ω–æ</span>';
}

document.getElementById('adminListContent').innerHTML = 
'<div class="admin-list-panel">' +
'<h4 style="font-size:13px;font-weight:800;color:var(--primary-bright);margin-bottom:15px">üëë –õ—é–¥–∏ –∑ –∞–¥–º—ñ–Ω –ø—Ä–∞–≤–∞–º–∏ –≤ —ñ—Å–ø–∏—Ç–∞—Ö</h4>' +
'<p style="font-size:11px;color:var(--text-gray);margin-bottom:15px">–¶—ñ –ª—é–¥–∏ –º–∞—é—Ç—å –ø–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è, —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —ñ—Å–ø–∏—Ç—ñ–≤</p>' +
'<div id="adminChips" style="margin-bottom:15px">' + adminChipsHtml + '</div>' +
'<div class="people-dropdown">' +
'<input class="form-input" id="adminSearch" placeholder="–ü–æ—à—É–∫ –ª—é–¥–∏–Ω–∏..." oninput="filterPeople(\'admin\')" onfocus="filterPeople(\'admin\')">' +
'<div class="people-list" id="adminDropdown"></div></div></div>';
}

window.removeAdmin = async n => {
adminList = adminList.filter(a => a !== n);
await save();
renderAdminList();
buildNav();
};

document.onkeydown = e => {
if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && [73, 74, 67].includes(e.keyCode)) || (e.ctrlKey && e.keyCode === 85)) {
return false;
}
};

console.log('‚úÖ –î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† v2.2 - –ü–û–í–ù–Ü–°–¢–Æ –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–û!');
console.log('‚úÖ –í—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –∞–∫—Ç–∏–≤–æ–≤–∞–Ω—ñ:');
console.log(' ‚úì –ü—É–±–ª—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º');
console.log(' ‚úì Firebase —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è');
console.log(' ‚úì Discord notifications (–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ!)');
console.log(' ‚úì –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑ –±–∞–ª–∞–º–∏');
console.log(' ‚úì –Ü—Å—Ç–æ—Ä—ñ—è —Ç–∞ —Å–ø–∏—Å–∫–∏');
console.log(' ‚úì –í—Å—ñ –∞–¥–º—ñ–Ω —Ñ—É–Ω–∫—Ü—ñ—ó');
</script>
</body>
</html>
