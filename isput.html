<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–î–®–í | –Ü–°–ü–ò–¢ –¶–ï–ù–¢–†</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{--primary:#00ff44;--primary-bright:#e0ffe8;--primary-glow:rgba(0,255,68,0.7);--bg:#030507;--card-bg:rgba(10,12,16,0.6);--glass-border:rgba(0,255,68,0.3);--danger:#ef4444;--danger-glow:rgba(239,68,68,0.6);--warning:#fbbf24;--text-gray:#94a3b8}
*{box-sizing:border-box;margin:0;padding:0}
body{background-color:var(--bg);background-image:radial-gradient(circle at 15% 50%,rgba(0,255,68,0.25),transparent 50%),radial-gradient(circle at 85% 30%,rgba(0,255,68,0.25),transparent 50%);background-attachment:fixed;color:#fff;font-family:'Inter',sans-serif;min-height:100vh;overflow-x:hidden;user-select:none;-webkit-user-select:none}
::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#05070a}::-webkit-scrollbar-thumb{background:var(--primary);border-radius:10px;box-shadow:0 0 10px var(--primary)}
input,textarea,select{user-select:text!important;-webkit-user-select:text!important}
a{text-decoration:none;color:inherit}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes modalPop{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes pulse{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(239,68,68,0.7)}70%{transform:scale(1.1);box-shadow:0 0 0 10px rgba(239,68,68,0)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(239,68,68,0)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 20px var(--primary-glow)}50%{box-shadow:0 0 40px var(--primary-glow),0 0 60px rgba(0,255,68,0.3)}}

/* HEADER */
header{display:flex;justify-content:space-between;align-items:center;padding:15px 5%;background:rgba(3,5,7,0.8);border-bottom:1px solid var(--glass-border);position:sticky;top:0;z-index:1000;box-shadow:0 0 20px rgba(0,255,102,0.2)}
.logo-box{background:var(--primary);color:#000;padding:6px 14px;border-radius:8px;font-weight:900;font-size:15px;text-transform:uppercase;box-shadow:0 0 20px var(--primary);cursor:pointer;transition:0.2s}
.logo-box:hover{transform:translateY(-1px);box-shadow:0 0 30px var(--primary)}
.header-right{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.btn-h{background:rgba(255,255,255,0.05);border:1px solid var(--primary);color:var(--primary-bright);padding:8px 15px;border-radius:10px;font-weight:900;cursor:pointer;font-size:12px;transition:0.2s}
.btn-h:hover{background:var(--primary);color:#000;box-shadow:0 0 15px var(--primary)}
.btn-h.active{background:var(--primary);color:#000;box-shadow:0 0 15px var(--primary)}
.btn-back{background:rgba(255,255,255,0.05);border:1px solid var(--warning);color:var(--warning);padding:8px 15px;border-radius:10px;font-weight:900;cursor:pointer;font-size:12px;transition:0.2s}
.btn-back:hover{background:var(--warning);color:#000}
.user-badge{color:var(--primary-bright);font-weight:800;font-size:13px}
.role-badge{font-size:10px;padding:3px 8px;border-radius:6px;font-weight:900;text-transform:uppercase}
.role-admin{background:var(--primary);color:#000}
.role-instructor{background:var(--warning);color:#000}
.role-fighter{background:rgba(255,255,255,0.1);color:var(--text-gray);border:1px solid rgba(255,255,255,0.2)}

/* NOTIFICATIONS */
.notif-wrap{position:relative;cursor:pointer;padding:5px;z-index:2001}
.bell{font-size:24px;color:var(--warning);filter:drop-shadow(0 0 8px var(--warning))}
.bell-badge{position:absolute;top:-2px;right:-2px;background:var(--danger);color:#fff;font-size:10px;font-weight:900;padding:2px 5px;border-radius:50%;border:2px solid var(--bg);display:none;animation:pulse 1.5s infinite}
#notifDrop{position:absolute;top:70px;right:5%;width:340px;background:rgba(10,15,25,0.95);border:1px solid var(--glass-border);border-radius:15px;display:none;flex-direction:column;z-index:2000;box-shadow:0 0 40px rgba(0,0,0,0.9);overflow:hidden}
.notif-head{padding:12px 15px;background:rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-border)}
.notif-item{padding:12px 15px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:12px;cursor:pointer;transition:0.2s}
.notif-item:hover{background:rgba(255,255,255,0.05)}
.notif-item.read{opacity:0.4}

/* VIEWS */
.view{display:none;padding:30px 5%;max-width:1200px;margin:0 auto;animation:fadeIn 0.4s ease}
.view.active{display:block}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:30px}
.stat-card{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:15px;padding:20px;text-align:center;backdrop-filter:blur(10px)}
.stat-card span{font-size:10px;font-weight:800;color:var(--primary-bright);text-transform:uppercase;display:block;margin-bottom:8px;text-shadow:0 0 8px var(--primary)}
.stat-card h2{font-size:28px;font-weight:900}

/* TEST CARDS ‚Äî CENTERED */
.tests-grid{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;margin-bottom:30px}
.test-card{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:20px;padding:25px;width:320px;backdrop-filter:blur(10px);cursor:pointer;transition:0.3s;position:relative;overflow:hidden}
.test-card:hover{transform:translateY(-3px);border-color:var(--primary);box-shadow:0 0 30px var(--primary-glow)}
.test-card .emoji{font-size:40px;margin-bottom:12px;display:block}
.test-card h3{font-size:16px;font-weight:900;margin-bottom:8px}
.test-card p{font-size:12px;color:var(--text-gray);margin-bottom:12px;line-height:1.5}
.test-card .meta{display:flex;justify-content:space-between;align-items:center;font-size:11px}
.badge{padding:3px 10px;border-radius:6px;font-weight:800;font-size:10px}
.badge-g{background:rgba(0,255,68,0.15);color:var(--primary);border:1px solid rgba(0,255,68,0.3)}
.badge-y{background:rgba(251,191,36,0.15);color:var(--warning);border:1px solid rgba(251,191,36,0.3)}

/* SECTION TITLE */
.section-title{font-size:14px;font-weight:900;color:var(--primary-bright);text-transform:uppercase;margin-bottom:20px;letter-spacing:2px;text-shadow:0 0 10px var(--primary)}

/* RESULTS LIST */
.result-item{background:var(--card-bg);border:1px solid rgba(255,255,255,0.05);border-radius:15px;padding:18px 20px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;transition:0.2s}
.result-item:hover{border-color:var(--glass-border)}
.result-status{padding:5px 12px;border-radius:8px;font-weight:900;font-size:11px}
.status-pass{background:rgba(0,255,68,0.15);color:var(--primary)}
.status-fail{background:rgba(239,68,68,0.15);color:var(--danger)}
.status-pending{background:rgba(251,191,36,0.15);color:var(--warning)}

/* INTRO */
.intro-box{background:var(--card-bg);border:1px solid var(--primary);border-radius:25px;padding:40px;max-width:600px;margin:50px auto;text-align:center;box-shadow:0 0 40px rgba(0,255,68,0.2)}
.intro-box h2{font-size:24px;font-weight:900;margin-bottom:10px}
.intro-box .desc{color:var(--text-gray);font-size:13px;margin-bottom:25px;line-height:1.6}
.intro-info{display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:25px}
.intro-info div{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px}
.intro-info span{font-size:10px;color:var(--text-gray);display:block;margin-bottom:4px;text-transform:uppercase;font-weight:700}
.intro-info b{font-size:16px}
.btn-start{background:var(--primary);color:#000;border:none;padding:15px 40px;border-radius:12px;font-weight:900;font-size:14px;cursor:pointer;text-transform:uppercase;transition:0.2s}
.btn-start:hover{box-shadow:0 0 25px var(--primary);transform:translateY(-2px)}

/* TAKE TEST */
.test-container{max-width:700px;margin:30px auto}
.progress-bar-wrap{background:rgba(255,255,255,0.05);border-radius:10px;height:8px;margin-bottom:20px;overflow:hidden}
.progress-bar-fill{height:100%;background:var(--primary);border-radius:10px;transition:width 0.4s ease;box-shadow:0 0 10px var(--primary)}
.q-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.q-counter{font-size:12px;color:var(--text-gray);font-weight:700}
.timer{font-size:14px;font-weight:900;color:var(--warning);text-shadow:0 0 10px var(--warning)}
.timer.danger{color:var(--danger);text-shadow:0 0 10px var(--danger);animation:shake 0.3s infinite}
.q-text{font-size:18px;font-weight:800;margin-bottom:25px;line-height:1.5}
.answers-list{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
.answer-btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:15px 20px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:0.2s;text-align:left;display:flex;align-items:center;gap:12px}
.answer-btn:hover{border-color:var(--primary);background:rgba(0,255,68,0.05)}
.answer-btn.selected{border-color:var(--primary);background:rgba(0,255,68,0.15);box-shadow:0 0 15px rgba(0,255,68,0.2)}
.answer-btn.correct{border-color:var(--primary);background:rgba(0,255,68,0.2)}
.answer-btn.wrong{border-color:var(--danger);background:rgba(239,68,68,0.2)}
.answer-letter{background:rgba(255,255,255,0.1);width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;flex-shrink:0}
.free-input{width:100%;background:#000;border:1px solid #333;color:#fff;padding:15px;border-radius:12px;font-size:14px;font-family:inherit;outline:none;resize:vertical;min-height:80px;transition:0.3s}
.free-input:focus{border-color:var(--primary);box-shadow:0 0 15px var(--primary-glow)}
.btn-next{background:var(--primary);color:#000;border:none;padding:14px 30px;border-radius:10px;font-weight:900;font-size:13px;cursor:pointer;transition:0.2s;float:right}
.btn-next:hover{box-shadow:0 0 20px var(--primary)}
.btn-next:disabled{opacity:0.3;cursor:not-allowed}

/* RESULT SCREEN */
.result-screen{max-width:700px;margin:30px auto;text-align:center}
.result-circle{width:150px;height:150px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:36px;font-weight:900;animation:pulseGlow 2s infinite}
.result-pass{border:3px solid var(--primary);color:var(--primary);box-shadow:0 0 30px var(--primary-glow)}
.result-fail{border:3px solid var(--danger);color:var(--danger);box-shadow:0 0 30px var(--danger-glow)}
.result-pending{border:3px solid var(--warning);color:var(--warning);box-shadow:0 0 30px rgba(251,191,36,0.5)}
.result-details{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:15px;padding:20px;margin-top:20px;text-align:left}
.detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px}
.detail-row:last-child{border:none}

/* CREATE/EDIT FORM */
.form-box{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:20px;padding:30px;max-width:800px;margin:20px auto;backdrop-filter:blur(10px)}
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:11px;color:var(--text-gray);margin-bottom:8px;text-transform:uppercase;font-weight:700}
.form-input{width:100%;background:#000;border:1px solid #333;color:#fff;padding:12px;border-radius:10px;font-size:14px;outline:none;font-family:inherit;transition:0.3s}
.form-input:focus{border-color:var(--primary);box-shadow:0 0 15px var(--primary-glow)}
.q-block{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.08);border-radius:15px;padding:20px;margin-bottom:15px;position:relative}
.q-block h4{font-size:13px;font-weight:800;color:var(--primary-bright);margin-bottom:12px}
.opt-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.opt-row input[type="text"]{flex:1;background:#0a0a0a;border:1px solid #222;color:#fff;padding:10px;border-radius:8px;font-size:13px;outline:none}
.opt-row input[type="text"]:focus{border-color:var(--primary)}
.opt-row input[type="radio"]{accent-color:var(--primary);width:18px;height:18px;cursor:pointer}
.btn-sm{padding:8px 14px;border-radius:8px;font-weight:800;font-size:11px;cursor:pointer;border:none;transition:0.2s}
.btn-add{background:rgba(0,255,68,0.1);color:var(--primary);border:1px solid var(--glass-border)}
.btn-add:hover{background:var(--primary);color:#000}
.btn-del{background:rgba(239,68,68,0.1);color:var(--danger);border:1px solid rgba(239,68,68,0.3)}
.btn-del:hover{background:var(--danger);color:#fff}
.btn-save{background:var(--primary);color:#000;border:none;padding:15px 30px;border-radius:12px;font-weight:900;font-size:14px;cursor:pointer;width:100%;margin-top:10px}
.btn-save:hover{box-shadow:0 0 20px var(--primary)}
.toggle-row{display:flex;align-items:center;gap:10px;margin-top:8px;font-size:12px;color:var(--text-gray)}
.toggle-row input[type="checkbox"]{accent-color:var(--primary);width:16px;height:16px}

/* MANAGE TABLE */
.manage-table{width:100%;border-collapse:collapse}
.manage-table th{text-align:left;font-size:11px;color:var(--text-gray);text-transform:uppercase;padding:10px 15px;border-bottom:1px solid var(--glass-border)}
.manage-table td{padding:12px 15px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px}
.manage-table tr:hover td{background:rgba(255,255,255,0.02)}
.btn-tbl{padding:6px 12px;border-radius:6px;font-weight:800;font-size:10px;cursor:pointer;border:none;transition:0.2s}
.btn-tbl-g{background:var(--primary);color:#000}.btn-tbl-g:hover{box-shadow:0 0 10px var(--primary)}
.btn-tbl-r{background:rgba(239,68,68,0.15);color:var(--danger);border:1px solid rgba(239,68,68,0.3)}.btn-tbl-r:hover{background:var(--danger);color:#fff}
.btn-tbl-y{background:rgba(251,191,36,0.15);color:var(--warning);border:1px solid rgba(251,191,36,0.3)}.btn-tbl-y:hover{background:var(--warning);color:#000}

/* SETTINGS */
.settings-box{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:20px;padding:25px;margin-bottom:20px}
.settings-box h3{font-size:14px;font-weight:900;color:var(--primary-bright);margin-bottom:15px}
.reviewer-tag{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,0.05);border:1px solid var(--glass-border);padding:6px 12px;border-radius:8px;font-size:12px;margin:4px}
.reviewer-tag button{background:none;border:none;color:var(--danger);cursor:pointer;font-size:14px;font-weight:900}
.people-dropdown{position:relative}
.people-list{position:absolute;top:100%;left:0;right:0;background:#0a0f15;border:1px solid var(--glass-border);border-radius:10px;max-height:200px;overflow-y:auto;z-index:100;display:none}
.people-list.open{display:block}
.people-opt{padding:10px 15px;cursor:pointer;font-size:13px;display:flex;justify-content:space-between;align-items:center;transition:0.15s}
.people-opt:hover{background:rgba(0,255,68,0.1)}
.people-opt .r{font-size:10px;color:var(--text-gray)}

/* REVIEW */
.review-card{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:15px;padding:20px;margin-bottom:15px}
.review-card h4{font-size:14px;font-weight:800;margin-bottom:5px}
.review-q{background:rgba(255,255,255,0.02);border-radius:10px;padding:12px;margin:8px 0;font-size:13px}
.review-q .label{font-size:10px;color:var(--text-gray);text-transform:uppercase;font-weight:700;margin-bottom:4px}
.review-actions{display:flex;gap:10px;margin-top:15px}
.btn-approve{background:var(--primary);color:#000;border:none;padding:10px 20px;border-radius:10px;font-weight:900;font-size:12px;cursor:pointer}
.btn-reject{background:none;border:1px solid var(--danger);color:var(--danger);padding:10px 20px;border-radius:10px;font-weight:900;font-size:12px;cursor:pointer}

/* MODAL */
.modal-ov{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;justify-content:center;align-items:center;z-index:3000}
.modal-box{background:#0f1115;border:1px solid var(--glass-border);padding:30px;border-radius:20px;width:90%;max-width:500px;position:relative;box-shadow:0 0 60px rgba(0,255,68,0.4);animation:modalPop 0.3s ease;max-height:90vh;overflow-y:auto}
.modal-close{position:absolute;top:15px;right:20px;background:none;border:none;color:#555;font-size:24px;cursor:pointer}
.modal-close:hover{color:#fff;transform:rotate(90deg)}

/* RESPONSIVE */
@media(max-width:768px){
.stats-row{grid-template-columns:1fr 1fr}
.test-card{width:100%}
.intro-info{grid-template-columns:1fr}
header{padding:12px 15px}
.header-right{gap:8px}
.btn-h{padding:6px 10px;font-size:10px}
}
@media(max-width:480px){
.stats-row{grid-template-columns:1fr}
}
</style>
</head>
<body>

<header>
<a href="cabinet.html" class="logo-box">–î–®–í</a>
<div class="header-right">
<button class="btn-h" onclick="nav('home')" id="navHome">üè† –ì–û–õ–û–í–ù–ê</button>
<button class="btn-h" onclick="nav('create')" id="navCreate" style="display:none">‚ûï –°–¢–í–û–†–ò–¢–ò</button>
<button class="btn-h" onclick="nav('manage')" id="navManage" style="display:none">‚öô –ö–ï–†–£–í–ê–¢–ò</button>
<button class="btn-h" onclick="nav('review')" id="navReview" style="display:none">üìã –ü–ï–†–ï–í–Ü–†–ö–ê</button>
<button class="btn-h" onclick="nav('settings')" id="navSettings" style="display:none">üîß –ù–ê–°–¢–†–û–ô–ö–ò</button>
<div class="notif-wrap" onclick="toggleNotif(event)">
<span class="bell">üîî</span>
<div id="bellBadge" class="bell-badge">0</div>
</div>
<div id="notifDrop">
<div class="notif-head">
<span style="color:var(--primary-bright);font-size:12px;font-weight:800">–°–ü–û–í–Ü–©–ï–ù–ù–Ø</span>
<button onclick="clearNotifs()" style="background:none;border:none;color:var(--text-gray);font-size:10px;cursor:pointer;font-weight:700">–û–ß–ò–°–¢–ò–¢–ò</button>
</div>
<div id="notifList"><div style="color:var(--text-gray);text-align:center;padding:20px;font-size:12px">–ù–µ–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω—å</div></div>
</div>
<span class="user-badge" id="myNameBadge">...</span>
<span class="role-badge role-fighter" id="myRoleBadge">...</span>
<button class="btn-back" onclick="window.location.href='cabinet.html'">‚Üê –ö–ê–ë–Ü–ù–ï–¢</button>
</div>
</header>

<!-- HOME -->
<div class="view active" id="viewHome">
<div class="stats-row" id="statsRow"></div>
<div class="section-title">üìö –î–û–°–¢–£–ü–ù–Ü –¢–ï–°–¢–ò</div>
<div class="tests-grid" id="testsGrid"></div>
<div class="section-title" style="margin-top:30px">üìä –ú–û–á –†–ï–ó–£–õ–¨–¢–ê–¢–ò</div>
<div id="myResults"></div>
</div>

<!-- INTRO -->
<div class="view" id="viewIntro">
<div class="intro-box" id="introBox"></div>
</div>

<!-- TAKE TEST -->
<div class="view" id="viewTake">
<div class="test-container" id="takeContainer"></div>
</div>

<!-- RESULT -->
<div class="view" id="viewResult">
<div class="result-screen" id="resultScreen"></div>
</div>

<!-- CREATE/EDIT -->
<div class="view" id="viewCreate">
<div class="section-title" id="formTitle">‚ûï –°–¢–í–û–†–ò–¢–ò –¢–ï–°–¢</div>
<div class="form-box" id="formBox"></div>
</div>

<!-- MANAGE -->
<div class="view" id="viewManage">
<div class="section-title">‚öô –ö–ï–†–£–í–ê–ù–ù–Ø –¢–ï–°–¢–ê–ú–ò</div>
<div class="form-box"><table class="manage-table" id="manageTable"><thead><tr><th>–ù–∞–∑–≤–∞</th><th>–ü–∏—Ç–∞–Ω—å</th><th>–ú–∞–∫—Å. –±–∞–ª</th><th>–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π</th><th>–î—ñ—ó</th></tr></thead><tbody id="manageBody"></tbody></table></div>
<div class="section-title" style="margin-top:30px">üìä –í–°–Ü –†–ï–ó–£–õ–¨–¢–ê–¢–ò</div>
<div id="allResults"></div>
</div>

<!-- REVIEW -->
<div class="view" id="viewReview">
<div class="section-title">üìã –ü–ï–†–ï–í–Ü–†–ö–ê –í–Ü–õ–¨–ù–ò–• –í–Ü–î–ü–û–í–Ü–î–ï–ô</div>
<div id="reviewList"></div>
</div>

<!-- SETTINGS -->
<div class="view" id="viewSettings">
<div class="section-title">üîß –ù–ê–°–¢–†–û–ô–ö–ò</div>
<div class="settings-box">
<h3>üîó Discord Webhook</h3>
<div class="form-group"><label class="form-label">URL –í–µ–±—Ö—É–∫–∞</label><input type="text" class="form-input" id="webhookInput" placeholder="https://discord.com/api/webhooks/..."></div>
<button class="btn-sm btn-add" onclick="saveWebhook()">–ó–ë–ï–†–ï–ì–¢–ò</button>
</div>
<div class="settings-box">
<h3>üë• –ü–ï–†–ï–í–Ü–†–Æ–í–ê–ß–Ü</h3>
<div id="reviewersList" style="margin-bottom:15px"></div>
<div class="people-dropdown">
<input type="text" class="form-input" id="searchPeople" placeholder="–ü–æ—à—É–∫ –ª—é–¥–∏–Ω–∏..." oninput="filterPeople()" onfocus="document.getElementById('peopleDropList').classList.add('open')">
<div class="people-list" id="peopleDropList"></div>
</div>
</div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-ov" id="confirmModal">
<div class="modal-box">
<button class="modal-close" onclick="closeConfirm()">&times;</button>
<h3 style="color:var(--primary-bright);text-align:center;margin-bottom:15px" id="confirmTitle">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h3>
<p style="text-align:center;color:var(--text-gray);margin-bottom:20px" id="confirmText"></p>
<div style="display:flex;gap:10px;justify-content:center">
<button class="btn-start" id="confirmYes" style="padding:12px 25px;font-size:12px">–¢–ê–ö</button>
<button class="btn-sm btn-del" id="confirmNo" onclick="closeConfirm()" style="padding:12px 25px">–°–ö–ê–°–£–í–ê–¢–ò</button>
</div>
</div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import{getAuth,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import{getFirestore,doc,getDoc,collection,getDocs}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyATUpLUHSp1VbyxkJXhMS-2R71zNOBGC00",authDomain:"dsv-gta.firebaseapp.com",projectId:"dsv-gta",storageBucket:"dsv-gta.firebasestorage.app",messagingSenderId:"661591588818",appId:"1:661591588818:web:a8e8dca3d061447e24d20b"};
const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app);

/* ===== STATE ===== */
let currentUser={name:'–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...',role:'fighter',uid:null};
let allUsers=[];
let tests=JSON.parse(localStorage.getItem('isput_tests')||'[]');
let results=JSON.parse(localStorage.getItem('isput_results')||'[]');
let reviewers=JSON.parse(localStorage.getItem('isput_reviewers')||'[]');
let webhookUrl=localStorage.getItem('isput_webhook')||'';
let notifications=JSON.parse(localStorage.getItem('isput_notifs')||'[]');
let currentTest=null,currentQ=0,currentAnswers=[],timerInterval=null,editingTestId=null;

const save=()=>{localStorage.setItem('isput_tests',JSON.stringify(tests));localStorage.setItem('isput_results',JSON.stringify(results))};
const saveReviewers=()=>localStorage.setItem('isput_reviewers',JSON.stringify(reviewers));
const saveNotifs=()=>localStorage.setItem('isput_notifs',JSON.stringify(notifications));
const isAdmin=()=>currentUser.role==='admin';
const isReviewer=()=>isAdmin()||reviewers.includes(currentUser.name);
const letters=['–ê','–ë','–í','–ì','–î','–ï','–Ñ','–ñ','–ó','–ò'];

/* ===== FIREBASE AUTH & USERS ===== */
onAuthStateChanged(auth,async(user)=>{
if(!user){window.location.href='index.html';return}
currentUser.uid=user.uid;
try{
const userDoc=await getDoc(doc(db,"users",user.uid));
if(userDoc.exists()){const d=userDoc.data();currentUser.name=d.name||'–ù–µ–≤—ñ–¥–æ–º–∏–π';currentUser.role=d.role||'fighter'}
const snap=await getDocs(collection(db,"users"));
allUsers=[];snap.forEach(s=>{const d=s.data();allUsers.push({uid:s.id,name:d.name||'–ù–µ–≤—ñ–¥–æ–º–∏–π',role:d.role||'fighter'})});
}catch(e){console.error('Firebase error:',e)}
updateUserUI();renderHome();updateNavButtons();
});

function updateUserUI(){
document.getElementById('myNameBadge').textContent=currentUser.name;
const rb=document.getElementById('myRoleBadge');
rb.className='role-badge';
if(currentUser.role==='admin'){rb.classList.add('role-admin');rb.textContent='–ê–î–ú–Ü–ù'}
else if(currentUser.role==='instructor'){rb.classList.add('role-instructor');rb.textContent='–Ü–ù–°–¢–†–£–ö–¢–û–†'}
else{rb.classList.add('role-fighter');rb.textContent='–ë–Ü–Ñ–¶–¨'}
}
function updateNavButtons(){
const a=isAdmin(),r=isReviewer();
document.getElementById('navCreate').style.display=a?'inline-block':'none';
document.getElementById('navManage').style.display=a?'inline-block':'none';
document.getElementById('navReview').style.display=r?'inline-block':'none';
document.getElementById('navSettings').style.display=a?'inline-block':'none';
renderNotifBadge();
}

/* ===== NOTIFICATIONS ===== */
function addNotif(text){notifications.unshift({text,time:new Date().toLocaleString('uk-UA'),read:false});saveNotifs();renderNotifBadge()}
function renderNotifBadge(){
const unread=notifications.filter(n=>!n.read).length;
const b=document.getElementById('bellBadge');
if(unread>0){b.style.display='block';b.textContent=unread}else{b.style.display='none'}
}
function renderNotifs(){
const list=document.getElementById('notifList');
if(!notifications.length){list.innerHTML='<div style="color:var(--text-gray);text-align:center;padding:20px;font-size:12px">–ù–µ–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω—å</div>';return}
list.innerHTML=notifications.map((n,i)=>`<div class="notif-item${n.read?' read':''}" onclick="markRead(${i})"><div style="font-size:12px;margin-bottom:3px">${n.text}</div><div style="font-size:10px;color:var(--text-gray)">${n.time}</div></div>`).join('')
}
window.toggleNotif=(e)=>{e&&e.stopPropagation();const d=document.getElementById('notifDrop');d.style.display=d.style.display==='flex'?'none':'flex';renderNotifs()};
window.markRead=(i)=>{notifications[i].read=true;saveNotifs();renderNotifs();renderNotifBadge()};
window.clearNotifs=()=>{notifications=[];saveNotifs();renderNotifs();renderNotifBadge()};
document.onclick=(e)=>{if(!e.target.closest('.notif-wrap')&&!e.target.closest('#notifDrop'))document.getElementById('notifDrop').style.display='none'};

/* ===== DISCORD WEBHOOK ===== */
async function sendWebhook(data){
if(!webhookUrl)return;
try{await fetch(webhookUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({embeds:[{title:'üìù –Ü–°–ü–ò–¢ –¶–ï–ù–¢–† ‚Äî –ù–æ–≤–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç',color:data.passed?65280:16711680,fields:[{name:'üë§ –ë–æ—î—Ü—å',value:data.name,inline:true},{name:'üìÖ –î–∞—Ç–∞',value:new Date().toLocaleString('uk-UA'),inline:true},{name:'üìä –ë–∞–ª–∏',value:`${data.score} / ${data.maxScore}`,inline:true},{name:'üìù –¢–µ—Å—Ç',value:data.testName,inline:true},{name:'‚úÖ –°—Ç–∞—Ç—É—Å',value:data.passed?'–°–ö–õ–ê–í':'–ù–ï –°–ö–õ–ê–í',inline:true},{name:'üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤',value:data.reviewer||'SYSTEM',inline:true}],footer:{text:'–î–®–í –Ü–°–ü–ò–¢ –¶–ï–ù–¢–†'}}]})})}catch(e){console.error('Webhook error:',e)}
}

/* ===== NAV ===== */
window.nav=(v)=>{
document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
document.getElementById('view'+v.charAt(0).toUpperCase()+v.slice(1)).classList.add('active');
document.querySelectorAll('.btn-h').forEach(b=>b.classList.remove('active'));
const nb=document.getElementById('nav'+v.charAt(0).toUpperCase()+v.slice(1));
if(nb)nb.classList.add('active');
if(v==='home')renderHome();
if(v==='manage')renderManage();
if(v==='review')renderReview();
if(v==='settings')renderSettings();
if(v==='create'&&!editingTestId)renderCreateForm(null);
};

/* ===== HOME ===== */
function renderHome(){
const myRes=results.filter(r=>r.userName===currentUser.name);
const passed=myRes.filter(r=>r.status==='passed').length;
const failed=myRes.filter(r=>r.status==='failed').length;
const pending=myRes.filter(r=>r.status==='pending').length;
const avg=myRes.length?Math.round(myRes.reduce((a,r)=>a+r.score,0)/myRes.length):0;
document.getElementById('statsRow').innerHTML=`
<div class="stat-card"><span>–¢–µ—Å—Ç—ñ–≤</span><h2>${tests.length}</h2></div>
<div class="stat-card"><span>–°–∫–ª–∞–¥–µ–Ω–æ</span><h2 style="color:var(--primary)">${passed}</h2></div>
<div class="stat-card"><span>–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</span><h2 style="color:var(--danger)">${failed}</h2></div>
<div class="stat-card"><span>–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</span><h2 style="color:var(--warning)">${pending}</h2></div>`;
document.getElementById('testsGrid').innerHTML=tests.length?tests.map(t=>`
<div class="test-card" onclick="showIntro('${t.id}')">
<span class="emoji">${t.emoji||'üìù'}</span>
<h3>${t.name}</h3>
<p>${t.desc||'–ë–µ–∑ –æ–ø–∏—Å—É'}</p>
<div class="meta">
<span class="badge badge-g">${t.questions.length} –ø–∏—Ç–∞–Ω—å</span>
<span class="badge badge-y">–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π: ${t.passScore}/${t.maxScore} –±.</span>
</div>
</div>`).join(''):'<div style="color:var(--text-gray);text-align:center;width:100%;padding:50px;font-size:14px">–¢–µ—Å—Ç—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>';
document.getElementById('myResults').innerHTML=myRes.length?myRes.map(r=>`
<div class="result-item">
<div><b>${r.testName}</b><br><small style="color:var(--text-gray)">${r.date} | –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤: ${r.reviewer||'SYSTEM'}</small></div>
<div style="display:flex;align-items:center;gap:15px">
<span style="font-weight:900">${r.score}/${r.maxScore}</span>
<span class="result-status ${r.status==='passed'?'status-pass':r.status==='failed'?'status-fail':'status-pending'}">${r.status==='passed'?'–°–ö–õ–ê–í':r.status==='failed'?'–ù–ï –°–ö–õ–ê–í':'–ù–ê –ü–ï–†–ï–í–Ü–†–¶–Ü'}</span>
</div></div>`).join(''):'<div style="color:var(--text-gray);text-align:center;padding:30px;font-size:13px">–í–∏ —â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Ç–µ—Å—Ç–∏</div>';
}

/* ===== INTRO ===== */
window.showIntro=(id)=>{
const t=tests.find(x=>x.id===id);if(!t)return;currentTest=t;
nav('intro');
document.getElementById('introBox').innerHTML=`
<span style="font-size:50px;display:block;margin-bottom:15px">${t.emoji||'üìù'}</span>
<h2>${t.name}</h2>
<div class="desc">${t.desc||''}</div>
<div class="intro-info">
<div><span>–ü–∏—Ç–∞–Ω—å</span><b>${t.questions.length}</b></div>
<div><span>–ú–∞–∫—Å. –±–∞–ª</span><b>${t.maxScore}</b></div>
<div><span>–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª</span><b>${t.passScore}</b></div>
</div>
<button class="btn-start" onclick="startTest()">–†–û–ó–ü–û–ß–ê–¢–ò –¢–ï–°–¢</button>`;
};
window.startTest=()=>{currentQ=0;currentAnswers=currentTest.questions.map(()=>({selected:null,free:''}));nav('take');renderQuestion()};

/* ===== TAKE TEST ===== */
function renderQuestion(){
if(!currentTest)return;
const q=currentTest.questions[currentQ],total=currentTest.questions.length;
const pct=((currentQ)/total*100);
let html=`<div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
<div class="q-header"><span class="q-counter">–ü–∏—Ç–∞–Ω–Ω—è ${currentQ+1} –∑ ${total}</span><span class="timer" id="timer">‚è± 30</span></div>
<div class="q-text">${q.text}</div><div class="answers-list">`;
if(q.options&&q.options.length){
q.options.forEach((o,i)=>{html+=`<button class="answer-btn${currentAnswers[currentQ].selected===i?' selected':''}" onclick="selectAnswer(${i})"><span class="answer-letter">${letters[i]||i+1}</span><span>${o.text}</span></button>`});
}
if(q.allowFree){html+=`<div style="margin-top:10px"><label class="form-label">–ê–±–æ –Ω–∞–ø–∏—à—ñ—Ç—å —Å–≤–æ—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å:</label><textarea class="free-input" oninput="freeInput(this.value)" placeholder="–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å...">${currentAnswers[currentQ].free||''}</textarea></div>`}
html+=`</div><div style="display:flex;justify-content:space-between;align-items:center">`;
if(currentQ>0)html+=`<button class="btn-sm btn-add" onclick="prevQ()">‚Üê –ù–ê–ó–ê–î</button>`;else html+=`<div></div>`;
const isLast=currentQ===total-1;
html+=`<button class="btn-next" onclick="${isLast?'finishTest()':'nextQ()'}">` +(isLast?'–ó–ê–í–ï–†–®–ò–¢–ò ‚Üí':'–î–ê–õ–Ü ‚Üí')+`</button></div>`;
document.getElementById('takeContainer').innerHTML=html;
startTimer();
}
window.selectAnswer=(i)=>{currentAnswers[currentQ].selected=i;renderQuestion()};
window.freeInput=(v)=>{currentAnswers[currentQ].free=v};
window.nextQ=()=>{if(currentQ<currentTest.questions.length-1){currentQ++;renderQuestion()}};
window.prevQ=()=>{if(currentQ>0){currentQ--;renderQuestion()}};

function startTimer(){
clearInterval(timerInterval);let sec=30;
const el=document.getElementById('timer');
timerInterval=setInterval(()=>{sec--;el.textContent='‚è± '+sec;
if(sec<=5)el.classList.add('danger');else el.classList.remove('danger');
if(sec<=0){clearInterval(timerInterval);nextQ()}
},1000)
}

/* ===== FINISH ===== */
window.finishTest=()=>{
clearInterval(timerInterval);
let score=0,hasFree=false,details=[];
currentTest.questions.forEach((q,i)=>{
const a=currentAnswers[i],pts=q.points||0;
let earned=0,status='wrong',userAnswer='';
if(q.allowFree&&a.free&&a.free.trim()){hasFree=true;status='pending';userAnswer=a.free.trim()}
if(q.options&&q.options.length&&a.selected!==null){
userAnswer=q.options[a.selected].text;
const correct=q.options.findIndex(o=>o.correct);
if(a.selected===correct){earned=pts;status='correct'}
}
if(status==='correct')score+=earned;
details.push({question:q.text,userAnswer,correctAnswer:q.options?q.options.find(o=>o.correct)?.text||'‚Äî':'–í—ñ–ª—å–Ω–∞',status,points:earned,maxPoints:pts});
});
const passed=!hasFree&&score>=currentTest.passScore;
const finalStatus=hasFree?'pending':(passed?'passed':'failed');
const result={id:Date.now().toString(),testId:currentTest.id,testName:currentTest.name,userName:currentUser.name,score,maxScore:currentTest.maxScore,passScore:currentTest.passScore,status:finalStatus,reviewer:hasFree?null:'SYSTEM',date:new Date().toLocaleString('uk-UA'),details,answers:currentAnswers};
results.push(result);save();
if(!hasFree){sendWebhook({name:currentUser.name,testName:currentTest.name,score,maxScore:currentTest.maxScore,passed,reviewer:'SYSTEM'})}
else{addNotif(`üìã ${currentUser.name} –∑–¥–∞–≤ —Ç–µ—Å—Ç "${currentTest.name}" ‚Äî –ø–æ—Ç—Ä–µ–±—É—î –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏`)}
showResult(result);
};

/* ===== RESULT SCREEN ===== */
function showResult(r){
nav('result');
const circle=r.status==='passed'?'result-pass':r.status==='failed'?'result-fail':'result-pending';
const icon=r.status==='passed'?'‚úÖ':r.status==='failed'?'‚ùå':'‚è≥';
const text=r.status==='passed'?'–¢–ï–°–¢ –°–ö–õ–ê–î–ï–ù–û':r.status==='failed'?'–¢–ï–°–¢ –ù–ï –°–ö–õ–ê–î–ï–ù–û':'–ù–ê –ü–ï–†–ï–í–Ü–†–¶–Ü';
let html=`<div class="result-circle ${circle}">${icon}</div>
<h2 style="margin-bottom:5px">${text}</h2>
<p style="color:var(--text-gray);margin-bottom:5px">${r.testName}</p>
<h3 style="margin-bottom:20px">${r.score} / ${r.maxScore} –±–∞–ª—ñ–≤</h3>
<div style="margin-bottom:20px;font-size:13px;color:var(--text-gray)">–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª: ${r.passScore} | –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤: ${r.reviewer||'–û—á—ñ–∫—É—î'}</div>
<div class="result-details">`;
r.details.forEach((d,i)=>{
const c=d.status==='correct'?'var(--primary)':d.status==='pending'?'var(--warning)':'var(--danger)';
html+=`<div class="detail-row"><div><b style="color:${c}">Q${i+1}:</b> ${d.question}<br><small style="color:var(--text-gray)">–í—ñ–¥–ø–æ–≤—ñ–¥—å: ${d.userAnswer||'‚Äî'} | –ü—Ä–∞–≤–∏–ª—å–Ω–∞: ${d.correctAnswer}</small></div><div style="font-weight:900;color:${c}">${d.points}/${d.maxPoints}</div></div>`});
html+=`</div><div style="display:flex;gap:10px;justify-content:center;margin-top:25px">
<button class="btn-start" onclick="nav('home')" style="padding:12px 25px;font-size:12px">–ù–ê –ì–û–õ–û–í–ù–£</button>
<button class="btn-sm btn-add" onclick="showIntro('${r.testId}')" style="padding:12px 25px">–ü–†–û–ô–¢–ò –ó–ù–û–í–£</button></div>`;
document.getElementById('resultScreen').innerHTML=html;
}

/* ===== CREATE / EDIT ===== */
window.editTest=(id)=>{editingTestId=id;const t=tests.find(x=>x.id===id);renderCreateForm(t);nav('create')};
function renderCreateForm(t){
document.getElementById('formTitle').textContent=t?'‚úè –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –¢–ï–°–¢–£':'‚ûï –°–¢–í–û–†–ò–¢–ò –¢–ï–°–¢';
const qs=t?t.questions:[{text:'',options:[{text:'',correct:true},{text:'',correct:false}],allowFree:false}];
let html=`
<div class="form-group"><label class="form-label">–ù–∞–∑–≤–∞ —Ç–µ—Å—Ç—É</label><input type="text" class="form-input" id="fName" value="${t?t.name:''}"></div>
<div class="form-group"><label class="form-label">–û–ø–∏—Å</label><textarea class="form-input" id="fDesc" style="min-height:60px">${t?t.desc:''}</textarea></div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px">
<div class="form-group"><label class="form-label">Emoji</label><input type="text" class="form-input" id="fEmoji" value="${t?t.emoji:'üìù'}" maxlength="4"></div>
<div class="form-group"><label class="form-label">–ú–∞–∫—Å. –±–∞–ª—ñ–≤</label><input type="number" class="form-input" id="fMaxScore" value="${t?t.maxScore:12}" min="1" oninput="recalcPoints()"></div>
<div class="form-group"><label class="form-label">–ü—Ä–æ—Ö—ñ–¥–Ω–∏–π –±–∞–ª</label><input type="number" class="form-input" id="fPassScore" value="${t?t.passScore:8}" min="1"></div>
</div>
<div class="toggle-row" style="margin-bottom:20px"><input type="checkbox" id="fAutoPoints" checked onchange="recalcPoints()"><label>–ê–≤—Ç–æ-—Ä–æ–∑–ø–æ–¥—ñ–ª –±–∞–ª—ñ–≤ –ø–æ –ø–∏—Ç–∞–Ω–Ω—è—Ö</label></div>
<div class="section-title" style="margin-top:10px">–ü–ò–¢–ê–ù–ù–Ø</div>
<div id="questionsContainer"></div>
<button class="btn-sm btn-add" onclick="addQuestion()" style="margin-top:10px;padding:10px 20px">+ –î–û–î–ê–¢–ò –ü–ò–¢–ê–ù–ù–Ø</button>
<button class="btn-save" onclick="saveTest()">${t?'–ó–ë–ï–†–ï–ì–¢–ò –ó–ú–Ü–ù–ò':'–°–¢–í–û–†–ò–¢–ò –¢–ï–°–¢'}</button>`;
document.getElementById('formBox').innerHTML=html;
window._formQuestions=JSON.parse(JSON.stringify(qs));
renderFormQuestions();
setTimeout(recalcPoints,100);
}
function renderFormQuestions(){
const c=document.getElementById('questionsContainer');
c.innerHTML=window._formQuestions.map((q,qi)=>{
let opts=q.options?q.options.map((o,oi)=>`
<div class="opt-row">
<input type="radio" name="correct_${qi}" ${o.correct?'checked':''} onchange="setCorrectOpt(${qi},${oi})">
<span style="font-weight:900;font-size:12px;color:var(--primary);min-width:20px">${letters[oi]||oi+1}</span>
<input type="text" value="${o.text}" oninput="updateOpt(${qi},${oi},this.value)" placeholder="–í–∞—Ä—ñ–∞–Ω—Ç ${letters[oi]||oi+1}">
<button class="btn-sm btn-del" onclick="removeOpt(${qi},${oi})">‚úï</button>
</div>`).join(''):'';
return`<div class="q-block">
<div style="display:flex;justify-content:space-between;align-items:center">
<h4>–ü–∏—Ç–∞–Ω–Ω—è ${qi+1} <span style="color:var(--text-gray);font-size:11px" id="qPts_${qi}">(0 –±.)</span></h4>
<button class="btn-sm btn-del" onclick="removeQuestion(${qi})">–í–ò–î–ê–õ–ò–¢–ò</button>
</div>
<div class="form-group"><input type="text" class="form-input" value="${q.text}" oninput="updateQText(${qi},this.value)" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Ç–∞–Ω–Ω—è"></div>
<div id="opts_${qi}">${opts}</div>
<div style="display:flex;gap:8px;margin-top:8px">
<button class="btn-sm btn-add" onclick="addOpt(${qi})">+ –í–ê–†–Ü–ê–ù–¢</button>
</div>
<div class="toggle-row"><input type="checkbox" ${q.allowFree?'checked':''} onchange="toggleFree(${qi},this.checked)"><label>–î–æ–∑–≤–æ–ª–∏—Ç–∏ –≤—ñ–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å</label></div>
</div>`}).join('');
}
window.addQuestion=()=>{window._formQuestions.push({text:'',options:[{text:'',correct:true},{text:'',correct:false}],allowFree:false});renderFormQuestions();recalcPoints()};
window.removeQuestion=(i)=>{window._formQuestions.splice(i,1);renderFormQuestions();recalcPoints()};
window.updateQText=(i,v)=>{window._formQuestions[i].text=v};
window.addOpt=(qi)=>{if(!window._formQuestions[qi].options)window._formQuestions[qi].options=[];window._formQuestions[qi].options.push({text:'',correct:false});renderFormQuestions()};
window.removeOpt=(qi,oi)=>{window._formQuestions[qi].options.splice(oi,1);renderFormQuestions()};
window.setCorrectOpt=(qi,oi)=>{window._formQuestions[qi].options.forEach((o,i)=>o.correct=i===oi)};
window.updateOpt=(qi,oi,v)=>{window._formQuestions[qi].options[oi].text=v};
window.toggleFree=(qi,v)=>{window._formQuestions[qi].allowFree=v};
window.recalcPoints=()=>{
const maxS=parseInt(document.getElementById('fMaxScore')?.value)||12;
const auto=document.getElementById('fAutoPoints')?.checked;
const qs=window._formQuestions;if(!qs||!qs.length)return;
const perQ=auto?Math.round((maxS/qs.length)*100)/100:0;
qs.forEach((q,i)=>{q.points=auto?perQ:(q.points||0);const el=document.getElementById('qPts_'+i);if(el)el.textContent=`(${q.points} –±.)`});
};
window.saveTest=()=>{
const name=document.getElementById('fName').value.trim();
if(!name){alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–µ—Å—Ç—É');return}
const maxScore=parseInt(document.getElementById('fMaxScore').value)||12;
const passScore=parseInt(document.getElementById('fPassScore').value)||8;
const emoji=document.getElementById('fEmoji').value||'üìù';
const desc=document.getElementById('fDesc').value;
const qs=window._formQuestions;
if(!qs.length){alert('–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è');return}
for(let i=0;i<qs.length;i++){if(!qs[i].text.trim()){alert(`–ü–∏—Ç–∞–Ω–Ω—è ${i+1} –Ω–µ –º–∞—î —Ç–µ–∫—Å—Ç—É`);return}}
const auto=document.getElementById('fAutoPoints').checked;
if(auto){const perQ=Math.round((maxScore/qs.length)*100)/100;qs.forEach(q=>q.points=perQ)}
const testData={id:editingTestId||Date.now().toString(),name,desc,emoji,maxScore,passScore,questions:qs};
if(editingTestId){const idx=tests.findIndex(t=>t.id===editingTestId);if(idx>=0)tests[idx]=testData;editingTestId=null}
else{tests.push(testData)}
save();nav('home');
};

/* ===== REVIEW ===== */
function renderReview(){
const pending=results.filter(r=>r.status==='pending');
if(!pending.length){document.getElementById('reviewList').innerHTML='<div style="color:var(--text-gray);text-align:center;padding:50px;font-size:14px">–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</div>';return}
document.getElementById('reviewList').innerHTML=pending.map(r=>{
let qs='';r.details.forEach((d,i)=>{
if(d.status==='pending')qs+=`<div class="review-q"><div class="label">–ü–∏—Ç–∞–Ω–Ω—è ${i+1}</div><b>${d.question}</b><div style="margin-top:8px;color:var(--warning)">–í—ñ–¥–ø–æ–≤—ñ–¥—å: ${d.userAnswer}</div></div>`});
return`<div class="review-card">
<h4>${r.userName} ‚Äî ${r.testName}</h4>
<small style="color:var(--text-gray)">${r.date}</small>
<div style="margin:10px 0;font-weight:800">–ê–≤—Ç–æ-–±–∞–ª–∏: ${r.score}/${r.maxScore}</div>
${qs}
<div class="review-actions">
<button class="btn-approve" onclick="reviewAction('${r.id}','approve')">‚úÖ –°–•–í–ê–õ–ò–¢–ò</button>
<button class="btn-reject" onclick="reviewAction('${r.id}','reject')">‚ùå –í–Ü–î–•–ò–õ–ò–¢–ò</button>
</div></div>`}).join('');
}
window.reviewAction=async(id,action)=>{
const r=results.find(x=>x.id===id);if(!r)return;
if(action==='approve'){
// Add pending question points
r.details.forEach(d=>{if(d.status==='pending'){d.points=d.maxPoints;d.status='correct';r.score+=d.maxPoints}});
r.status=r.score>=r.passScore?'passed':'failed';
}else{
r.details.forEach(d=>{if(d.status==='pending'){d.points=0;d.status='wrong'}});
r.status=r.score>=r.passScore?'passed':'failed';
}
r.reviewer=currentUser.name;
save();
sendWebhook({name:r.userName,testName:r.testName,score:r.score,maxScore:r.maxScore,passed:r.status==='passed',reviewer:currentUser.name});
addNotif(`${action==='approve'?'‚úÖ –°—Ö–≤–∞–ª–µ–Ω–æ':'‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ'}: ${r.userName} ‚Äî ${r.testName} | –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤: ${currentUser.name}`);
renderReview();
};

/* ===== MANAGE ===== */
function renderManage(){
document.getElementById('manageBody').innerHTML=tests.map(t=>`<tr>
<td><b>${t.emoji} ${t.name}</b></td><td>${t.questions.length}</td><td>${t.maxScore}</td><td>${t.passScore}</td>
<td style="display:flex;gap:5px">
<button class="btn-tbl btn-tbl-y" onclick="editTest('${t.id}')">‚úè</button>
<button class="btn-tbl btn-tbl-r" onclick="deleteTest('${t.id}')">üóë</button>
</td></tr>`).join('');
document.getElementById('allResults').innerHTML=results.length?results.map(r=>`
<div class="result-item">
<div><b>${r.testName}</b><br><small style="color:var(--text-gray)">${r.userName} | ${r.date} | –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤: ${r.reviewer||'‚Äî'}</small></div>
<div style="display:flex;align-items:center;gap:10px">
<span style="font-weight:900">${r.score}/${r.maxScore}</span>
<span class="result-status ${r.status==='passed'?'status-pass':r.status==='failed'?'status-fail':'status-pending'}">${r.status==='passed'?'–°–ö–õ–ê–í':r.status==='failed'?'–ù–ï –°–ö–õ–ê–í':'–ü–ï–†–ï–í–Ü–†–ö–ê'}</span>
<button class="btn-tbl btn-tbl-r" onclick="deleteResult('${r.id}')">‚úï</button>
</div></div>`).join(''):'<div style="color:var(--text-gray);text-align:center;padding:30px">–ù–µ–º–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</div>';
}
window.deleteTest=(id)=>{showConfirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ—Å—Ç?','–¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏',()=>{tests=tests.filter(t=>t.id!==id);save();renderManage()})};
window.deleteResult=(id)=>{results=results.filter(r=>r.id!==id);save();renderManage()};

/* ===== SETTINGS ===== */
function renderSettings(){
document.getElementById('webhookInput').value=webhookUrl;
document.getElementById('reviewersList').innerHTML=reviewers.length?reviewers.map(r=>`<span class="reviewer-tag">${r}<button onclick="removeReviewer('${r}')">&times;</button></span>`).join(''):'<div style="color:var(--text-gray);font-size:12px">–ù–µ–º–∞—î –ø–µ—Ä–µ–≤—ñ—Ä—é–≤–∞—á—ñ–≤</div>';
renderPeopleDropdown();
}
function renderPeopleDropdown(){
const list=document.getElementById('peopleDropList');
const search=(document.getElementById('searchPeople')?.value||'').toLowerCase();
const filtered=allUsers.filter(u=>!reviewers.includes(u.name)&&u.name.toLowerCase().includes(search));
list.innerHTML=filtered.length?filtered.map(u=>`<div class="people-opt" onclick="addReviewer('${u.name}')"><span>${u.name}</span><span class="r">${u.role==='admin'?'–ê–¥–º—ñ–Ω':u.role==='instructor'?'–Ü–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä':'–ë—ñ—î—Ü—å'}</span></div>`).join(''):'<div style="padding:15px;text-align:center;color:var(--text-gray);font-size:12px">–ù—ñ–∫–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
}
window.filterPeople=()=>{renderPeopleDropdown();document.getElementById('peopleDropList').classList.add('open')};
window.addReviewer=(name)=>{if(!reviewers.includes(name)){reviewers.push(name);saveReviewers();renderSettings();updateNavButtons()}document.getElementById('peopleDropList').classList.remove('open');document.getElementById('searchPeople').value=''};
window.removeReviewer=(name)=>{reviewers=reviewers.filter(r=>r!==name);saveReviewers();renderSettings();updateNavButtons()};
window.saveWebhook=()=>{webhookUrl=document.getElementById('webhookInput').value.trim();localStorage.setItem('isput_webhook',webhookUrl);alert('Webhook –∑–±–µ—Ä–µ–∂–µ–Ω–æ!')};
document.addEventListener('click',e=>{if(!e.target.closest('.people-dropdown'))document.getElementById('peopleDropList')?.classList.remove('open')});

/* ===== CONFIRM MODAL ===== */
window.showConfirm=(title,text,onYes)=>{document.getElementById('confirmTitle').textContent=title;document.getElementById('confirmText').textContent=text;document.getElementById('confirmYes').onclick=()=>{onYes();closeConfirm()};document.getElementById('confirmModal').style.display='flex'};
window.closeConfirm=()=>document.getElementById('confirmModal').style.display='none';

/* ===== INIT ===== */
if(!tests.length){
tests=[{id:'demo1',name:'–ë–∞–∑–æ–≤–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –î–®–í',desc:'–¢–µ—Å—Ç –Ω–∞ –∑–Ω–∞–Ω–Ω—è –æ—Å–Ω–æ–≤ –¥–µ—Å–∞–Ω—Ç–Ω–æ-—à—Ç—É—Ä–º–æ–≤–∏—Ö –≤—ñ–π—Å—å–∫',emoji:'ü™ñ',maxScore:12,passScore:8,questions:[
{text:'–©–æ –æ–∑–Ω–∞—á–∞—î –∞–±—Ä–µ–≤—ñ–∞—Ç—É—Ä–∞ –î–®–í?',options:[{text:'–î–µ—Å–∞–Ω—Ç–Ω–æ-—à—Ç—É—Ä–º–æ–≤—ñ –≤—ñ–π—Å—å–∫–∞',correct:true},{text:'–î–æ–±—Ä–æ–≤–æ–ª—å—á—ñ —à—Ç—É—Ä–º–æ–≤—ñ –≤–∑–≤–æ–¥–∏',correct:false},{text:'–î–µ—Ä–∂–∞–≤–Ω–∞ —à—Ç–∞–±–Ω–∞ –≤–∞—Ä—Ç–∞',correct:false},{text:'–î–∏–≤—ñ–∑—ñ–π–Ω—ñ —à—Ç—É—Ä–º–æ–≤—ñ –≤—ñ–π—Å—å–∫–∞',correct:false}],allowFree:false,points:4},
{text:'–Ø–∫–∏–π –∫–æ–ª—ñ—Ä –±–µ—Ä–µ—Ç–∞ —É –î–®–í?',options:[{text:'–ú–∞–ª–∏–Ω–æ–≤–∏–π',correct:true},{text:'–ß–æ—Ä–Ω–∏–π',correct:false},{text:'–ó–µ–ª–µ–Ω–∏–π',correct:false}],allowFree:false,points:4},
{text:'–ü–æ—è—Å–Ω—ñ—Ç—å –æ—Å–Ω–æ–≤–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è –î–®–í',options:[],allowFree:true,points:4}]}];save()}
</script>
</body>
</html>
